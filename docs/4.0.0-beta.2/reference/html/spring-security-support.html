<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>Spring Security Support</title>
<link rel="stylesheet" href="css/spring.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<style>
.hidden {
	display: none;
}

.switch {
	border-width: 1px 1px 0 1px;
	border-style: solid;
	border-color: #7a2518;
	display: inline-block;
}

.switch--item {
	padding: 10px;
	background-color: #ffffff;
	color: #7a2518;
	display: inline-block;
	cursor: pointer;
}

.switch--item:not(:first-child) {
	border-width: 0 0 0 1px;
	border-style: solid;
	border-color: #7a2518;
}

.switch--item.selected {
	background-color: #7a2519;
	color: #ffffff;
}

</style>
<script type="text/javascript">
function addBlockSwitches() {
	for (var primary of document.querySelectorAll('.primary')) {
		var switchItem = createSwitchItem(primary, createBlockSwitch(primary));
		switchItem.item.classList.add("selected");
		var title = primary.querySelector('.title')
		title.remove();
	}
	for (var secondary of document.querySelectorAll('.secondary')) {
		var primary = findPrimary(secondary);
		if (primary === null) {
			console.error("Found secondary block with no primary sibling");
		}
		else {
			var switchItem = createSwitchItem(secondary, primary.querySelector('.switch'));
			switchItem.content.classList.add("hidden");
			primary.append(switchItem.content);
			secondary.remove();
		}
	}
}

function createElementFromHtml(html) {
	var template = document.createElement('template');
    template.innerHTML = html;
    return template.content.firstChild;
}

function createBlockSwitch(primary) {
    var blockSwitch = createElementFromHtml('<div class="switch"></div>');
    primary.prepend(blockSwitch)
	return blockSwitch;
}

function findPrimary(secondary) {
	var candidate = secondary.previousElementSibling;
	while (candidate != null && !candidate.classList.contains('primary')) {
		candidate = candidate.previousElementSibling;
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	var blockName = block.querySelector('.title').textContent;
	var content = block.querySelectorAll('.content').item(0);
	var colist = nextSibling(block, '.colist');
	if (colist != null) {
		content.append(colist);
	}
	var item = createElementFromHtml('<div class="switch--item">' + blockName + '</div>');
	item.dataset.blockName = blockName;
	content.dataset.blockName = blockName;
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

function nextSibling(element, selector) {
	var sibling = element.nextElementSibling;
	while (sibling) {
		if (sibling.matches(selector)) {
			return sibling;
		}
		sibling = sibling.nextElementSibling;
	}
}

function globalSwitch() {
	document.querySelectorAll(".switch--item").forEach(function(item) {
		var blockId = blockIdForSwitchItem(item);
		var handler = function(event) {
			selectedText = event.target.textContent;
			window.localStorage.setItem(blockId, selectedText);
			for (var switchItem of document.querySelectorAll(".switch--item")) {
				if (blockIdForSwitchItem(switchItem) === blockId && switchItem.textContent === selectedText) {
					select(switchItem);
				}
			}
		}
		item.addEventListener("click", handler);
		if (item.textContent === window.localStorage.getItem(blockId)) {
			select(item);
		}
	});
}

function select(selected) {
	for (var child of selected.parentNode.children) {
		child.classList.remove("selected");
	}
	selected.classList.add("selected");
	for (var child of selected.parentNode.parentNode.children) {
		if (child.classList.contains("content")) {
			if (selected.dataset.blockName === child.dataset.blockName) {
				child.classList.remove("hidden");
			}
			else {
				child.classList.add("hidden");
			}
		}
	}	
}

function blockIdForSwitchItem(item) {
	idComponents = []
	for (var switchItem of item.parentNode.querySelectorAll(".switch--item")) {
		idComponents.push(switchItem.textContent.toLowerCase());
	}
	return idComponents.sort().join("-")
}

window.onload = function() {
	addBlockSwitches();
	globalSwitch();
};

</script>

</head>
<body class="book toc2 toc-left">
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_spring_security_support">Spring Security Support</a>
<ul class="sectlevel2">
<li><a href="#_spring_security_with_azure_ad">Spring Security with Azure AD</a></li>
<li><a href="#_spring_security_with_azure_ad_b2c">Spring Security with Azure AD B2C</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_spring_security_support"><a class="link" href="#_spring_security_support">Spring Security Support</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_spring_security_with_azure_ad"><a class="link" href="#_spring_security_with_azure_ad">Spring Security with Azure AD</a></h3>
<div class="sect3">
<h4 id="_dependency_setup"><a class="link" href="#_dependency_setup">Dependency Setup</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
	&lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
	&lt;artifactId&gt;spring-cloud-azure-starter-active-directory&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuration"><a class="link" href="#_configuration">Configuration</a></h4>
<div class="paragraph">
<p>This starter provides the following properties:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Properties</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.app-id-uri</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It used in resource server, used to validate the audience in access_token. access_token is valid only when the audience in access_token equal to client-id or app-id-uri</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.authorization-clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A map configure the resource APIs the application is going to visit. Each item corresponding to one resource API the application is going to visit. In Spring code, each item corresponding to one OAuth2AuthorizedClient object</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.authorization-clients.AZURE_CLIENT_NAME.scopes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">API permissions of a resource server that the application is going to acquire.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.authorization-clients.AZURE_CLIENT_NAME.on-demand</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is used for incremental consent. The default value is false. If it&#8217;s true, it&#8217;s not consent when user login, when application needs the additional permission, incremental consent is performed with one OAuth2 authorization code flow.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.authorization-clients.AZURE_CLIENT_NAME.authorization-grant-type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type of authorization client. Supported types are <a href="https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-auth-code-flow">authorization_code</a> (default type for webapp), <a href="https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-on-behalf-of-flow">on_behalf_of</a> (default type for resource-server), <a href="https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow">client_credentials</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.application-type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Refer to <a href="#property-example-1-application-type">Application type</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.base-uri</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base uri for authorization server, the default value is <code><a href="https://login.microsoftonline.com/" class="bare">https://login.microsoftonline.com/</a></code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.client-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Registered application ID in Azure AD.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.client-secret</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">client secret of the registered application.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.graph-membership-uri</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It&#8217;s used to load users' groups. The default value is <code><a href="https://graph.microsoft.com/v1.0/me/memberOf" class="bare">https://graph.microsoft.com/v1.0/me/memberOf</a></code>, this uri just get direct groups. To get all transitive membership, set it to <code><a href="https://graph.microsoft.com/v1.0/me/transitiveMemberOf" class="bare">https://graph.microsoft.com/v1.0/me/transitiveMemberOf</a></code>. The 2 uris are both Azure Global, check <code>Property example 1</code> if you want to use Azure China.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.post-logout-redirect-uri</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Redirect uri for posting log-out.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.resource-server.principal-claim-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Principal claim name. Default value is "sub".</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.resource-server.claim-to-authority-prefix-map</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Claim to authority prefix map. Default map is: "scp" -&gt; "SCOPE_", "roles" -&gt; <code>APPROLE_</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.tenant-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Tenant ID.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.user-group.allowed-group-names</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Users' group name can be use in <code>@PreAuthorize(&quot;hasRole(&#39;ROLE_group_name_1&#39;)&quot;)</code>. Not all group name will take effect, only group names configured in this property will take effect.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.user-group.allowed-group-ids</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Users' group id can be use in <code>@PreAuthorize(&quot;hasRole(&#39;ROLE_group_id_1&#39;)&quot;)</code>. Not all group id will take effect, only group id configured in this property will take effect. If this property&#8217;s value is <code>all</code>, then all group id will take effect.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.user-name-attribute</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Decide which claim to be principal&#8217;s name.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Here are some examples about how to use these properties:</p>
</div>
<div class="sect4">
<h5 id="property-example-1-application-type"><a class="link" href="#property-example-1-application-type">Property example 1: Application type</a></h5>
<div class="paragraph">
<p>This property(<code>spring.cloud.azure.active-directory.application-type</code>) is optional, its value can be inferred by dependencies, only <code>web_application_and_resource_server</code> must be configured manually: <code>spring.cloud.azure.active-directory.application-type=web_application_and_resource_server</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Has dependency: spring-security-oauth2-client</th>
<th class="tableblock halign-left valign-top">Has dependency: spring-security-oauth2-resource-server</th>
<th class="tableblock halign-left valign-top">Valid values of application type</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>web_application</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>web_application</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resource_server</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resource_server</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>web_application</code>,<code>resource_server</code>,<code>resource_server_with_obo</code>, <code>web_application_and_resource_server</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resource_server_with_obo</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_property_example_2_use_azure_china_instead_of_azure_global"><a class="link" href="#_property_example_2_use_azure_china_instead_of_azure_global">Property example 2: Use <a href="https://docs.microsoft.com/azure/china/resources-developer-guide#check-endpoints-in-azure">Azure China</a> instead of Azure Global.</a></h5>
<div class="ulist">
<ul>
<li>
<p>Step 1: Add property in application.yml</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      active-directory:
        base-uri: https://login.partner.microsoftonline.cn
        graph-base-uri: https://microsoftgraph.chinacloudapi.cn</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_property_example_3_use_group_name_or_group_id_to_protect_some_method_in_web_application"><a class="link" href="#_property_example_3_use_group_name_or_group_id_to_protect_some_method_in_web_application">Property example 3: Use <code>group name</code> or <code>group id</code> to protect some method in web application.</a></h5>
<div class="ulist">
<ul>
<li>
<p>Step 1: Add property in application.yml</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        user-group:
          allowed-group-names: group1_name_1, group2_name_2
          # 1. If allowed-group-ids == all, then all group id will take effect.
          # 2. If "all" is used, we should not configure other group ids.
          # 3. "all" is only supported for allowed-group-ids, not supported for allowed-group-names.
          allowed-group-ids: group_id_1, group_id_2</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 2: Add <code>@EnableGlobalMethodSecurity(prePostEnabled == true)</code> in web application:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled == true)
public class AADOAuth2LoginSecurityConfig extends AADWebSecurityConfigurerAdapter {

    /**
     * Add configuration logic as needed.
     */
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        super.configure(http);
        http.authorizeRequests()
                .anyRequest().authenticated();
        // Do some custom configuration
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we can protect the method by <code>@PreAuthorize</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Controller
public class RoleController {
    @GetMapping("group1")
    @ResponseBody
    @PreAuthorize("hasRole('ROLE_group1')")
    public String group1() {
        return "group1 message";
    }

    @GetMapping("group2")
    @ResponseBody
    @PreAuthorize("hasRole('ROLE_group2')")
    public String group2() {
        return "group2 message";
    }

    @GetMapping("group1Id")
    @ResponseBody
    @PreAuthorize("hasRole('ROLE_&lt;group1-id&gt;')")
    public String group1Id() {
        return "group1Id message";
    }

    @GetMapping("group2Id")
    @ResponseBody
    @PreAuthorize("hasRole('ROLE_&lt;group2-id&gt;')")
    public String group2Id() {
        return "group2Id message";
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_property_example_4_incremental_consent_in_web_application_visiting_resource_servers"><a class="link" href="#_property_example_4_incremental_consent_in_web_application_visiting_resource_servers">Property example 4: <a href="https://docs.microsoft.com/azure/active-directory/azuread-dev/azure-ad-endpoint-comparison#incremental-and-dynamic-consent">Incremental consent</a> in Web application visiting resource servers.</a></h5>
<div class="ulist">
<ul>
<li>
<p>Step 1: Add property in application.yml</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        authorization-clients:
          graph:
            scopes: https://graph.microsoft.com/Analytics.Read, email
          arm: # client registration id
            on-demand: true  # means incremental consent
            scopes: https://management.core.windows.net/user_impersonation</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 2: Write Java code:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After these steps. <code>arm&#8217;s scopes (<a href="https://management.core.windows.net/user_impersonation" class="bare">https://management.core.windows.net/user_impersonation</a>) doesn&#8217;t
need to be consented at login time. When user request `/arm</code> endpoint, user need to consent the
scope. That&#8217;s <code>incremental consent</code> means.</p>
</div>
<div class="paragraph">
<p>After the scopes have been consented, AAD server will remember that this user has already granted
the permission to the web application. So incremental consent will not happen anymore after user
consented.</p>
</div>
</div>
<div class="sect4">
<h5 id="_property_example_5_client_credential_flow_in_resource_server_visiting_resource_servers"><a class="link" href="#_property_example_5_client_credential_flow_in_resource_server_visiting_resource_servers">Property example 5: [Client credential flow] in resource server visiting resource servers.</a></h5>
<div class="ulist">
<ul>
<li>
<p>Step 1: Add property in application.yml</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        authorization-clients:
          webapiC:                          # When authorization-grant-type is null, on behalf of flow is used by default
            authorization-grant-type: client_credentials
            scopes:
                - &lt;Web-API-C-app-id-url&gt;/.default</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 2: Write Java code:</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_basic_usage"><a class="link" href="#_basic_usage">Basic Usage</a></h4>
<div class="sect4">
<h5 id="_usage_1accessing_a_web_application"><a class="link" href="#_usage_1accessing_a_web_application">Usage 1:Accessing a web application</a></h5>
<div class="paragraph">
<p>This scenario uses <a href="https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-auth-code-flow">The OAuth 2.0 authorization code grant</a> flow to log in a user with a Microsoft account.</p>
</div>
<div class="paragraph">
<p><strong>System diagram</strong>:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142617664-f1704adb-db64-49e0-b1b6-078c62b6945b.png" alt="Standalone Web Application"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 1: Make sure <code>redirect URI</code> has been set to <code>APPLICATION_BASE_URI/login/oauth2/code/</code>, for
example <code><a href="http://localhost:8080/login/oauth2/code/" class="bare">http://localhost:8080/login/oauth2/code/</a></code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
The tailing <code>/</code> cannot be omitted.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142617751-154c156c-9035-4641-9b79-b26380ddad72.png" alt="web-application-set-redirect-uri-1.png"></span>
<span class="image"><img src="https://user-images.githubusercontent.com/13167207/142617785-b4ca1afc-79f6-48ae-b7a3-99fba5856689.png" alt="web-application-set-redirect-uri-2.png"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 2: Add the following dependencies in your pom.xml.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
		&lt;artifactId&gt;spring-cloud-azure-starter-active-directory&lt;/artifactId&gt;
	&lt;/dependency&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
		&lt;artifactId&gt;spring-boot-starter-oauth2-client&lt;/artifactId&gt;
	&lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 3: Add properties in application.yml. These values should be got in <a href="https://github.com/Azure/azure-sdk-for-java/tree/main/sdk/spring/azure-spring-boot-starter-active-directory#prerequisites">prerequisite</a>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        tenant-id: ${AZURE_TENANT_ID}
        client-id: ${AZURE_CLIENT_ID}
        client-secret: ${AZURE_CLIENT_SECRET}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 4: Write your Java code:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>AADWebSecurityConfigurerAdapter</code> contains necessary web security configuration for <strong>aad-starter</strong>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_usage_2web_application_accessing_resource_servers"><a class="link" href="#_usage_2web_application_accessing_resource_servers">Usage 2:Web application accessing resource servers</a></h5>
<div class="paragraph">
<p><strong>System diagram</strong>:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142617853-0526205f-fdef-47f9-ac01-77963f8c34be.png" alt="web-application-visiting-resource-servers.png"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 1: Make sure <code>redirect URI</code> has been set, just like <a href="https://github.com/Azure/azure-sdk-for-java/tree/main/sdk/spring/azure-spring-boot-starter-active-directory#accessing-a-web-application">Accessing a web application</a>.</p>
</li>
<li>
<p>Step 2: Add the following dependencies in you pom.xml.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
		&lt;artifactId&gt;spring-cloud-azure-starter-active-directory&lt;/artifactId&gt;
	&lt;/dependency&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
		&lt;artifactId&gt;spring-boot-starter-oauth2-client&lt;/artifactId&gt;
	&lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 3: Add properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        tenant-id: ${AZURE_TENANT_ID}
        client-id: ${AZURE_CLIENT_ID}
        client-secret: ${AZURE_CLIENT_SECRET}
        authorization-clients:
          graph:
            scopes: https://graph.microsoft.com/Analytics.Read, email</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, <code>graph</code> is the name of <code>OAuth2AuthorizedClient</code>, <code>scopes</code> means the scopes need to consent when login.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 4: Write your Java code:</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_usage_3accessing_a_resource_server"><a class="link" href="#_usage_3accessing_a_resource_server">Usage 3:Accessing a resource server</a></h5>
<div class="paragraph">
<p>This scenario doesn&#8217;t support login, just protect the server by validating the access_token. If the access token is valid, the server serves the request.</p>
</div>
<div class="paragraph">
<p><strong>System diagram</strong>:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142617910-1ee3eb6a-ddc7-4b85-af4e-71344c91b248.png" alt="Standalone resource server usage"></span></p>
</div>
<div class="paragraph">
<p>To use <strong>aad-starter</strong> in this scenario, we need these steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 1: Add the following dependencies in you pom.xml.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;dependencies&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
		&lt;artifactId&gt;spring-cloud-azure-starter-active-directory&lt;/artifactId&gt;
	&lt;/dependency&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
		&lt;artifactId&gt;spring-boot-starter-oauth2-resource-server&lt;/artifactId&gt;
	&lt;/dependency&gt;
&lt;/dependencies&gt;</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 2: Add properties in application.yml:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142617979-167e7509-b82e-4475-99b7-91bcf0ec249c.png" alt="get-app-id-uri-1.png"></span>
<span class="image"><img src="https://user-images.githubusercontent.com/13167207/142618069-074289df-11aa-4d2c-ac8e-9a8a61c96288.png" alt="get-app-id-uri-2.png"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 3: Write Java code:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>AADResourceServerWebSecurityConfigurerAdapter</code> contains necessary web security configuration for resource server.</p>
</div>
</div>
<div class="sect4">
<h5 id="_usage_4resource_server_visiting_other_resource_servers"><a class="link" href="#_usage_4resource_server_visiting_other_resource_servers">Usage 4:Resource server visiting other resource servers</a></h5>
<div class="paragraph">
<p>This scenario support visit other resource servers in resource servers.</p>
</div>
<div class="paragraph">
<p><strong>System diagram</strong>:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142618294-aa546ced-d241-4fbd-97ac-fb06881503b1.png" alt="resource-server-visiting-other-resource-servers.png"></span></p>
</div>
<div class="paragraph">
<p>To use <strong>aad-starter</strong> in this scenario, we need these steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 1: Add the following dependencies in you pom.xml.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;dependencies&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
		&lt;artifactId&gt;spring-cloud-azure-starter-active-directory&lt;/artifactId&gt;
	&lt;/dependency&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
		&lt;artifactId&gt;spring-boot-starter-oauth2-resource-server&lt;/artifactId&gt;
	&lt;/dependency&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
		&lt;artifactId&gt;spring-boot-starter-oauth2-client&lt;/artifactId&gt;
	&lt;/dependency&gt;
&lt;/dependencies&gt;</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 2: Add properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        tenant-id: ${AZURE_TENANT_ID}
        client-id: ${AZURE_CLIENT_ID}
        client-secret: ${AZURE_CLIENT_SECRET}
        app-id-uri: ${WEB_API_ID_URI}
        authorization-clients:
          graph:
            scopes:
              - https://graph.microsoft.com/User.Read</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 3: Write Java code:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using <code>@RegisteredOAuth2AuthorizedClient</code> to access related resource server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class SampleController {
    @PreAuthorize("hasAuthority('SCOPE_Obo.Graph.Read')")
    @GetMapping("call-graph")
    public String callGraph(@RegisteredOAuth2AuthorizedClient("graph") OAuth2AuthorizedClient graph) {
        return callMicrosoftGraphMeEndpoint(graph);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_usage_5web_application_and_resource_server_in_one_application"><a class="link" href="#_usage_5web_application_and_resource_server_in_one_application">Usage 5:Web application and Resource server in one application</a></h5>
<div class="paragraph">
<p>This scenario supports <code>Web application</code> and <code>Resource server</code> in one application.</p>
</div>
<div class="paragraph">
<p>To use <strong>aad-starter</strong> in this scenario, we need these steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 1: Add the following dependencies in you pom.xml.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;dependencies&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
		&lt;artifactId&gt;spring-cloud-azure-starter-active-directory&lt;/artifactId&gt;
	&lt;/dependency&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
		&lt;artifactId&gt;spring-boot-starter-oauth2-resource-server&lt;/artifactId&gt;
	&lt;/dependency&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
		&lt;artifactId&gt;spring-boot-starter-oauth2-client&lt;/artifactId&gt;
	&lt;/dependency&gt;
&lt;/dependencies&gt;</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 2: Add properties in application.yml:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Set property <code>spring.cloud.azure.active-directory.application-type</code> to <code>web_application_and_resource_server</code>, and specify the authorization type for each authorization client.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        tenant-id: ${AZURE_TENANT_ID}
        client-id: ${AZURE_CLIENT_ID}
        client-secret: ${AZURE_CLIENT_SECRET}
        app-id-uri: ${WEB_API_ID_URI}
        application-type: web_application_and_resource_server  # This is required.
        authorization-clients:
          graph:
            authorizationGrantType: authorization_code # This is required.
            scopes:
              - https://graph.microsoft.com/User.Read
              - https://graph.microsoft.com/Directory.Read.All</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 3: Write Java code:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Configure multiple HttpSecurity instances, <code>AADOAuth2SecurityMultiConfig</code> contain two security configurations for resource server and web application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled == true)
public class AADWebApplicationAndResourceServerConfig {

    @Order(1)
    @Configuration
    public static class ApiWebSecurityConfigurationAdapter extends AADResourceServerWebSecurityConfigurerAdapter {
        protected void configure(HttpSecurity http) throws Exception {
            super.configure(http);
            // All the paths that match `/api/**`(configurable) work as `Resource Server`, other paths work as `Web application`.
            http.antMatcher("/api/**")
                .authorizeRequests().anyRequest().authenticated();
        }
    }

    @Configuration
    public static class HtmlWebSecurityConfigurerAdapter extends AADWebSecurityConfigurerAdapter {

        @Override
        protected void configure(HttpSecurity http) throws Exception {
            super.configure(http);
            // @formatter:off
            http.authorizeRequests()
                    .antMatchers("/login").permitAll()
                    .anyRequest().authenticated();
            // @formatter:on
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_samples"><a class="link" href="#_samples">Samples</a></h4>
<div class="paragraph">
<p><a href="https://github.com/Azure-Samples/azure-spring-boot-samples">Link to sample repo</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_spring_security_with_azure_ad_b2c"><a class="link" href="#_spring_security_with_azure_ad_b2c">Spring Security with Azure AD B2C</a></h3>
<div class="sect3">
<h4 id="_dependency_setup_2"><a class="link" href="#_dependency_setup_2">Dependency Setup</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
		&lt;artifactId&gt;spring-cloud-azure-starter-active-directory-b2c&lt;/artifactId&gt;
	&lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_2"><a class="link" href="#_configuration_2">Configuration</a></h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.azure.active-directory.b2c.base-uri</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base uri for authorization server, if both <code>tenant</code> and <code>baseUri</code> are configured at the same time, only <code>baseUri</code> takes effect.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.azure.active-directory.b2c.client-id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The registered application ID in Azure AD B2C.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.azure.active-directory.b2c.client-secret</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The client secret of a registered application.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.azure.active-directory.b2c.authorization-clients</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A map to list all authorization clients created on Azure Portal.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.azure.active-directory.b2c.login-flow</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The key name of sign in user flow.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.azure.active-directory.b2c.logout-success-url</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The target URL after a successful logout.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.azure.active-directory.b2c.tenant(Deprecated)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Azure AD B2C&#8217;s tenant name, this is only suitable for Global cloud.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.azure.active-directory.b2c.tenant-id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Azure AD B2C&#8217;s tenant id.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.azure.active-directory.b2c.user-flows</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A map to list all user flows defined on Azure Portal.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.azure.active-directory.b2c.user-name-attribute-name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The attribute name of the username.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For full configurations, check appendix.</p>
</div>
</div>
<div class="sect3">
<h4 id="_basic_usage_2"><a class="link" href="#_basic_usage_2">Basic Usage</a></h4>
<div class="paragraph">
<p>A <code>web application</code> is any web based application that allows user to login Azure AD, whereas a <code>resource server</code> will either
accept or deny access after validating access_token obtained from Azure AD. We will cover 4 scenarios in this guide:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Accessing a web application.</p>
</li>
<li>
<p>Web application accessing resource servers.</p>
</li>
<li>
<p>Accessing a resource server.</p>
</li>
<li>
<p>Resource server accessing other resource servers.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142620440-f970b572-2646-4f50-9f77-db62d6e965f1.png" alt="B2C Web application &amp; Web Api Overall"></span></p>
</div>
<div class="sect4">
<h5 id="_usage_1accessing_a_web_application_2"><a class="link" href="#_usage_1accessing_a_web_application_2">Usage 1:Accessing a web application</a></h5>
<div class="paragraph">
<p>This scenario uses <a href="https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-auth-code-flow">The OAuth 2.0 authorization code grant</a> flow to log in a user with your Azure AD B2C user.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 1: Select <strong>Azure AD B2C</strong> from the portal menu, click <strong>Applications</strong>, and then click <strong>Add</strong>.</p>
</li>
<li>
<p>Step 2: Specify your application <strong>Name</strong>, we call it <code>webapp</code>, add <code><a href="http://localhost:8080/login/oauth2/code/" class="bare">http://localhost:8080/login/oauth2/code/</a></code> for the <strong>Reply URL</strong>, record the
<strong>Application ID</strong> as your <code>WEB_APP_AZURE_CLIENT_ID</code> and then click <strong>Save</strong>.</p>
</li>
<li>
<p>Step 3: Select <strong>Keys</strong> from your application, click <strong>Generate key</strong> to generate <code>WEB_APP_AZURE_CLIENT_SECRET</code> and then <strong>Save</strong>.</p>
</li>
<li>
<p>Step 4: Select <strong>User flows</strong> on your left, and then Click <strong>New user flow</strong>.</p>
</li>
<li>
<p>Step 5: Choose <strong>Sign up or in</strong>, <strong>Profile editing</strong> and <strong>Password reset</strong> to create user flows
respectively. Specify your user flow <strong>Name</strong> and <strong>User attributes and claims</strong>, click <strong>Create</strong>.</p>
</li>
<li>
<p>Step 6: Select <strong>API permissions</strong> &gt; <strong>Add a permission</strong> &gt; <strong>Microsoft APIs</strong>, select <strong><em>Microsoft Graph</em></strong>,
select <strong>Delegated permissions</strong>, check <strong>offline_access</strong> and <strong>openid</strong> permissions, select <strong>Add permission</strong> to complete the process.</p>
</li>
<li>
<p>Step 7: Grant admin consent for <strong><em>Graph</em></strong> permissions.
<span class="image"><img src="https://user-images.githubusercontent.com/13167207/142620491-8c8a82ea-c920-43a8-aa0a-dd028f1b8553.png" alt="Add Graph permissions"></span></p>
</li>
<li>
<p>Step 8: Add the following dependencies in your <em>pom.xml</em>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
		&lt;artifactId&gt;azure-spring-boot-starter-active-directory-b2c&lt;/artifactId&gt;
	&lt;/dependency&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
		&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
	&lt;/dependency&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
		&lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;
	&lt;/dependency&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
		&lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
	&lt;/dependency&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;org.thymeleaf.extras&lt;/groupId&gt;
		&lt;artifactId&gt;thymeleaf-extras-springsecurity5&lt;/artifactId&gt;
	&lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 9: Add properties in <em>application.yml</em> using the values you created earlier, for example:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        b2c:
          authenticate-additional-parameters:
            domain_hint: xxxxxxxxx         # optional
            login_hint: xxxxxxxxx          # optional
            prompt: [login,none,consent]   # optional
          base-uri: ${BASE_URI}
          client-id: ${WEBAPP_AZURE_CLIENT_ID}
          client-secret: ${WEBAPP_AZURE_CLIENT_SECRET}
          login-flow: ${LOGIN_USER_FLOW_KEY}               # default to sign-up-or-sign-in, will look up the user-flows map with provided key.
          logout-success-url: ${LOGOUT_SUCCESS_URL}
          user-flows:
            ${YOUR_USER_FLOW_KEY}: ${USER_FLOW_NAME}
          user-name-attribute-name: ${USER_NAME_ATTRIBUTE_NAME}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 10: Write your Java code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Controller code can refer to the following:</p>
</div>
<div class="paragraph">
<p>Security configuration code can refer to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@EnableWebSecurity
public class WebSecurityConfiguration extends WebSecurityConfigurerAdapter {

    private final AADB2COidcLoginConfigurer configurer;

    public WebSecurityConfiguration(AADB2COidcLoginConfigurer configurer) {
        this.configurer == configurer;
    }

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        // @formatter:off
        http.authorizeRequests()
                .anyRequest().authenticated()
                .and()
            .apply(configurer);
        // @formatter:off
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy the <em>home.html</em> from <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/tag_azure-spring-boot_3.6.0/aad/azure-spring-boot-sample-active-directory-b2c-oidc/src/main/resources/templates">Azure AD B2C Spring Boot Sample</a>, and replace the <code>PROFILE_EDIT_USER_FLOW</code> and <code>PASSWORD_RESET_USER_FLOW</code> with your user flow name respectively that completed earlier.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 11: Build and test your app</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let <code>Webapp</code> run on port <em>8080</em>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_usage_2web_application_accessing_resource_servers_2"><a class="link" href="#_usage_2web_application_accessing_resource_servers_2">Usage 2:Web application accessing resource servers</a></h5>
<div class="paragraph">
<p>This scenario is based on <strong>Accessing a web application</strong> scenario to allow application to access other resources, that is [The OAuth 2.0 client credentials grant] flow.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 1: Select <strong>Azure AD B2C</strong> from the portal menu, click <strong>Applications</strong>, and then click <strong>Add</strong>.</p>
</li>
<li>
<p>Step 2: Specify your application <strong>Name</strong>, we call it <code>webApiA</code>, record the <strong>Application ID</strong> as your <code>WEB_API_A_AZURE_CLIENT_ID</code> and then click <strong>Save</strong>.</p>
</li>
<li>
<p>Step 3: Select <strong>Keys</strong> from your application, click <strong>Generate key</strong> to generate <code>WEB_API_A_AZURE_CLIENT_SECRET</code> and then <strong>Save</strong>.</p>
</li>
<li>
<p>Step 4: Select <strong>Expose an API</strong> on your left, and then Click the <strong>Set</strong> link,
record the <strong>Application ID URI</strong> as your <code>WEB_API_A_APP_ID_URL</code>, then <strong>Save</strong>.</p>
</li>
<li>
<p>Step 5: Select <strong>Manifest</strong> on your left, and then paste the below json segment into <code>appRoles</code> array,
record the <strong>Application ID URI</strong> as your <code>WEB_API_A_APP_ID_URL</code>, record the value of the app role as your <code>WEB_API_A_ROLE_VALUE</code>, then <strong>save</strong>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "allowedMemberTypes": [
    "Application"
  ],
  "description": "WebApiA.SampleScope",
  "displayName": "WebApiA.SampleScope",
  "id": "04989db0-3efe-4db6-b716-ae378517d2b7",
  "isEnabled": true,
  "value": "WebApiA.SampleScope"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142620567-59a91df7-7a97-4027-b525-1f422f25fb22.png" alt="Configure WebApiA appRoles"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 6: Select <strong>API permissions</strong> &gt; <strong>Add a permission</strong> &gt; <strong>My APIs</strong>, select <strong><em>WebApiA</em></strong> application name,
select <strong>Application Permissions</strong>, select <strong>WebApiA.SampleScope</strong> permission, select <strong>Add permission</strong> to complete the process.</p>
</li>
<li>
<p>Step 7: Grant admin consent for <strong><em>WebApiA</em></strong> permissions.
<span class="image"><img src="https://user-images.githubusercontent.com/13167207/142620601-660400fa-7cff-4989-9d7f-2b32a9aa1244.png" alt="Add WebApiA permission"></span></p>
</li>
<li>
<p>Step 8: Add the following dependency on the basis of <strong>Accessing a web application</strong> scenario.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-webflux&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 9: Add the following configuration on the basis of <strong>Accessing a web application</strong> scenario.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      active-directory:
        b2c:
          base-uri: ${BASE_URI}             # Such as: https://xxxxb2c.b2clogin.com
          tenant-id: ${AZURE_TENANT_ID}
          authorization-clients:
            ${RESOURCE_SERVER_A_NAME}:
              authorization-grant-type: client_credentials
              scopes: ${WEB_API_A_APP_ID_URL}/.default</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 10: Write your <code>Webapp</code> Java code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Controller code can refer to the following:</p>
</div>
<div class="paragraph">
<p>Security configuration code is the same with <strong>Accessing a web application</strong> scenario, another bean `webClient`is added as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class SampleConfiguration {
		@Bean
		public WebClient webClient(OAuth2AuthorizedClientManager oAuth2AuthorizedClientManager) {
				ServletOAuth2AuthorizedClientExchangeFilterFunction function =
						new ServletOAuth2AuthorizedClientExchangeFilterFunction(oAuth2AuthorizedClientManager);
				return WebClient.builder()
												.apply(function.oauth2Configuration())
												.build();
		}
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 11: Please refer to <strong>Accessing a resource server</strong> section to write your <code>WebApiA</code> Java code.</p>
</li>
<li>
<p>Step 12: Build and test your app</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let <code>Webapp</code> and <code>WebApiA</code> run on port <em>8080</em> and <em>8081</em> respectively.
 Start <code>Webapp</code> and <code>WebApiA</code> application, return to the home page after logging successfully, you can access <code><a href="http://localhost:8080/webapp/webApiA" class="bare">http://localhost:8080/webapp/webApiA</a></code> to get <strong>WebApiA</strong> resource response.</p>
</div>
</div>
<div class="sect4">
<h5 id="_usage_3accessing_a_resource_server_2"><a class="link" href="#_usage_3accessing_a_resource_server_2">Usage 3:Accessing a resource server</a></h5>
<div class="paragraph">
<p>This scenario not support login. Just protect the server by validating the access token, and if valid, serves the request.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 1: Refer to <a href="#usage-2web-application-accessing-resource-servers">Web application accessing resource servers</a> to build your <code>WebApiA</code> permission.</p>
</li>
<li>
<p>Step 2: Add <code>WebApiA</code> permission and grant admin consent for your web application.</p>
</li>
<li>
<p>Step 3: Add the following dependencies in your <em>pom.xml</em>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
		&lt;artifactId&gt;azure-spring-boot-starter-active-directory-b2c&lt;/artifactId&gt;
	&lt;/dependency&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
		&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
	&lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 4: Add the following configuration.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      active-directory:
        b2c:
          base-uri: ${BASE_URI}             # Such as: https://xxxxb2c.b2clogin.com
          tenant-id: ${AZURE_TENANT_ID}
          app-id-uri: ${APP_ID_URI}         # If you are using v1.0 token, please configure app-id-uri for `aud` verification
          client-id: ${AZURE_CLIENT_ID}           # If you are using v2.0 token, please configure client-id for `aud` verification</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 5: Write your Java code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Controller code can refer to the following:</p>
</div>
<div class="paragraph">
<p>Security configuration code can refer to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled == true)
public class ResourceServerConfiguration extends WebSecurityConfigurerAdapter {

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.authorizeRequests((requests) -&gt; requests.anyRequest().authenticated())
            .oauth2ResourceServer()
            .jwt()
            .jwtAuthenticationConverter(new AADJwtBearerTokenAuthenticationConverter());
    }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 6: Build and test your app</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let <code>WebApiA</code> run on port <em>8081</em>.
 Get the access token for <code>webApiA</code> resource and access <code><a href="http://localhost:8081/webApiA/sample" class="bare">http://localhost:8081/webApiA/sample</a></code>
 as the Bearer authorization header.</p>
</div>
</div>
<div class="sect4">
<h5 id="_usage_4resource_server_accessing_other_resource_servers"><a class="link" href="#_usage_4resource_server_accessing_other_resource_servers">Usage 4:Resource server accessing other resource servers</a></h5>
<div class="paragraph">
<p>This scenario is an upgrade of <strong>Accessing a resource server</strong>, supports access to other application resources, based on OAuth2 client credentials flow.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 1: Referring to the previous steps, we create a <code>WebApiB</code> application and expose an application permission <code>WebApiB.SampleScope</code>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>{
    "allowedMemberTypes": [
        "Application"
    ],
    "description": "WebApiB.SampleScope",
    "displayName": "WebApiB.SampleScope",
    "id": "04989db0-3efe-4db6-b716-ae378517d2b7",
    "isEnabled": true,
    "lang": null,
    "origin": "Application",
    "value": "WebApiB.SampleScope"
}</pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142620648-cfbf5220-9736-4050-a3ef-1370c522e672.png" alt="Configure WebApiB appRoles"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 2: Grant admin consent for <strong><em>WebApiB</em></strong> permissions.
<span class="image"><img src="https://user-images.githubusercontent.com/13167207/142620691-b1a7fcda-fc92-41af-9515-812139f26ee0.png" alt="Add WebApiB permission"></span></p>
</li>
<li>
<p>Step 3: On the basis of <strong>Accessing a resource server</strong>, add a dependency in your <em>pom.xml</em>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
 &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
 &lt;artifactId&gt;spring-boot-starter-webflux&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 4: Add the following configuration on the basis of <strong>Accessing a resource server</strong> scenario configuration.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      active-directory:
        b2c:
          client-secret: ${WEB_API_A_AZURE_CLIENT_SECRET}
          authorization-clients:
            ${RESOURCE_SERVER_B_NAME}:
              authorization-grant-type: client_credentials
              scopes: ${WEB_API_B_APP_ID_URL}/.default</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 5: Write your Java code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>WebApiA controller code can refer to the following:</p>
</div>
<div class="paragraph">
<p>WebApiB controller code can refer to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class SampleController {
		/**
		 * webApiB resource api for other web application
		 * @return test content
		 */
		@PreAuthorize("hasAuthority('APPROLE_WebApiB.SampleScope')")
		@GetMapping("/webApiB/sample")
		public String webApiBSample() {
				LOGGER.info("Call webApiBSample()");
				return "Request '/webApiB/sample'(WebApi B) returned successfully.";
		}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Security configuration code is the same with <strong>Accessing a resource server</strong> scenario, another bean `webClient`is added as follows</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 6: Build and test your app</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let <code>WebApiA</code> and <code>WebApiB</code> run on port <em>8081</em> and <em>8082</em> respectively.
 Start <code>WebApiA</code> and <code>WebApiB</code> application, get the access token for <code>webApiA</code> resource and access <code><a href="http://localhost:8081/webApiA/webApiB/sample" class="bare">http://localhost:8081/webApiA/webApiB/sample</a></code>
 as the Bearer authorization header.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_samples_2"><a class="link" href="#_samples_2">Samples</a></h4>
<div class="paragraph">
<p><a href="https://github.com/Azure-Samples/azure-spring-boot-samples">Link to sample repo</a></p>
</div>
</div>
</div>
</div>
</div>
</div>
<script type="text/javascript" src="js/tocbot/tocbot.min.js"></script>
<script type="text/javascript" src="js/toc.js"></script>
</body>
</html>