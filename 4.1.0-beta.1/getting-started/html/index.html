<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>Getting Started</title>
<link rel="stylesheet" href="css/spring.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="js/highlight/styles/github.min.css">
<script type="text/javascript"> (function(c,l,a,r,i,t,y){ c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)}; t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i; y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y); })(window, document, "clarity", "script", "b9g1q6wz23"); </script>

</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Getting Started</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#spring-boot">1. Spring Boot</a>
<ul class="sectlevel2">
<li><a href="#spring-boot-2">1.1. Spring Boot</a>
<ul class="sectlevel3">
<li><a href="#azure-support">1.1.1. Azure Support</a></li>
<li><a href="#azure-active-directory">1.1.2. Azure Active Directory</a></li>
<li><a href="#azure-key-vault">1.1.3. Azure Key Vault</a></li>
<li><a href="#azure-storage">1.1.4. Azure Storage</a></li>
<li><a href="#application-insights">1.1.5. Application Insights</a></li>
</ul>
</li>
<li><a href="#azure-storage-2">1.2. Azure Storage</a>
<ul class="sectlevel3">
<li><a href="#prerequisites">1.2.1. Prerequisites</a></li>
<li><a href="#create-an-azure-storage-account-and-blob-container-for-your-application">1.2.2. Create an Azure Storage Account and blob container for your application</a></li>
<li><a href="#create-a-simple-spring-boot-application-with-the-spring-initializr">1.2.3. Create a simple Spring Boot application with the Spring Initializr</a></li>
<li><a href="#configure-your-spring-boot-app-to-use-the-azure-storage-blob-starter">1.2.4. Configure your Spring Boot app to use the Azure Storage Blob starter</a>
<ul class="sectlevel4">
<li><a href="#add-dependency-in-pom-xml">Add dependency in pom.xml</a></li>
<li><a href="#configure-property-in-application-yml">Configure property in application.yml</a></li>
</ul>
</li>
<li><a href="#add-sample-code-to-implement-basic-azure-storage-functionality">1.2.5. Add sample code to implement basic Azure storage functionality</a>
<ul class="sectlevel4">
<li><a href="#add-a-blob-controller-class">Add a blob controller class</a></li>
</ul>
</li>
<li><a href="#summary">1.2.6. Summary</a></li>
<li><a href="#clean-up-resources">1.2.7. Clean up resources</a></li>
</ul>
</li>
<li><a href="#azure-key-vault-secrets">1.3. Azure Key Vault Secrets</a>
<ul class="sectlevel3">
<li><a href="#prerequisites-2">1.3.1. Prerequisites</a></li>
<li><a href="#create-a-new-azure-key-vault">1.3.2. Create a new Azure Key Vault</a>
<ul class="sectlevel4">
<li><a href="#sign-in-to-azure-and-set-your-subscription">Sign in to Azure and set your subscription</a></li>
<li><a href="#create-a-service-principal">Create a service principal</a></li>
<li><a href="#create-the-key-vault-instance">Create the Key Vault instance</a></li>
</ul>
</li>
<li><a href="#create-the-app-with-spring-initializr">1.3.3. Create the app with Spring Initializr</a></li>
<li><a href="#create-the-app-without-spring-initializr">1.3.4. Create the app without Spring Initializr</a></li>
<li><a href="#add-key-vault-configuration-to-the-app">1.3.5. Add Key Vault configuration to the app</a></li>
<li><a href="#deploy-to-azure-app-service">1.3.6. Deploy to Azure App Service</a></li>
<li><a href="#redeploy-to-azure-app-service-and-use-managed-identities-for-azure-resources">1.3.7. Redeploy to Azure App Service and use managed identities for Azure resources</a></li>
<li><a href="#deploy-to-azure-spring-cloud">1.3.8. Deploy to Azure Spring Cloud</a></li>
<li><a href="#summary-2">1.3.9. Summary</a></li>
<li><a href="#clean-up-resources-2">1.3.10. Clean up resources</a></li>
</ul>
</li>
<li><a href="#azure-key-vault-certificates">1.4. Azure Key Vault certificates</a>
<ul class="sectlevel3">
<li><a href="#prerequisites-3">1.4.1. Prerequisites</a></li>
<li><a href="#create-a-gnulinux-vm-with-system-assigned-managed-identity">1.4.2. Create a GNU/Linux VM with system-assigned managed identity</a></li>
<li><a href="#create-and-configure-an-azure-key-vault">1.4.3. Create and configure an Azure Key Vault</a></li>
<li><a href="#create-and-store-a-self-signed-tlsssl-certificate">1.4.4. Create and store a self-signed TLS/SSL certificate</a></li>
<li><a href="#run-a-spring-boot-application-with-secure-inbound-connections">1.4.5. Run a Spring Boot application with secure inbound connections</a>
<ul class="sectlevel4">
<li><a href="#enable-the-spring-boot-app-to-load-the-tlsssl-certificate">Enable the Spring Boot app to load the TLS/SSL certificate</a></li>
<li><a href="#create-a-spring-boot-rest-controller">Create a Spring Boot REST controller</a></li>
<li><a href="#run-the-app-on-the-server">Run the app on the server</a></li>
</ul>
</li>
<li><a href="#run-a-spring-boot-application-with-secure-outbound-connections">1.4.6. Run a Spring Boot application with secure outbound connections</a>
<ul class="sectlevel4">
<li><a href="#modify-the-ssltestapplication-to-illustrate-outbound-tls-connections">Modify the SsltestApplication to illustrate outbound TLS connections</a></li>
</ul>
</li>
<li><a href="#clean-up-resources-3">1.4.7. Clean up resources</a></li>
</ul>
</li>
<li><a href="#azure-service-bus">1.5. Azure Service Bus</a>
<ul class="sectlevel3">
<li><a href="#prerequisites-4">1.5.1. Prerequisites</a></li>
<li><a href="#use-the-azure-service-bus-jms-starter">1.5.2. Use the Azure Service Bus JMS starter</a></li>
<li><a href="#configure-the-app-for-your-service-bus">1.5.3. Configure the app for your service bus</a>
<ul class="sectlevel4">
<li><a href="#use-a-service-bus-queue">Use a Service Bus queue</a></li>
<li><a href="#use-service-bus-topic">Use Service Bus topic</a></li>
</ul>
</li>
<li><a href="#implement-basic-service-bus-functionality">1.5.4. Implement basic Service Bus functionality</a>
<ul class="sectlevel4">
<li><a href="#modify-the-main-application-class">Modify the main application class</a></li>
<li><a href="#define-a-test-java-class">Define a test Java class</a></li>
<li><a href="#create-a-new-class-for-the-message-send-controller">Create a new class for the message send controller</a></li>
<li><a href="#create-a-class-for-the-message-receive-controller">Create a class for the message receive controller</a></li>
</ul>
</li>
<li><a href="#optional-service-bus-functionality">1.5.5. Optional Service Bus Functionality</a>
<ul class="sectlevel4">
<li><a href="#set-the-content-type-of-messages">Set the content-type of messages</a></li>
<li><a href="#set-session-id-in-jmstemplate">Set session-id in JmsTemplate</a></li>
</ul>
</li>
<li><a href="#build-and-test-your-application">1.5.6. Build and test your application</a></li>
<li><a href="#clean-up-resources-4">1.5.7. Clean up resources</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#spring-data">2. Spring Data</a></li>
<li><a href="#spring-security">3. Spring Security</a></li>
<li><a href="#spring-cloud">4. Spring Cloud</a></li>
<li><a href="#azure-app-configuration">5. Azure App Configuration</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="spring-boot"><a class="anchor" href="#spring-boot"></a>1. Spring Boot</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="spring-boot-2"><a class="anchor" href="#spring-boot-2"></a>1.1. Spring Boot</h3>
<div class="paragraph">
<p>This article describes the various Spring Boot Starters for the <a href="https://start.spring.io/">Spring Initializr</a> that provide Java developers with integration features for working with Microsoft Azure.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/160522559-5922e09f-737b-4696-9329-f238adf9b150.png" alt="Configure Azure Spring Boot Starters with Initializr"></span></p>
</div>
<div class="paragraph">
<p>The following Spring Boot Starters are currently available for Azure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Azure Support</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Provides autoconfiguration support for Azure Services; e.g. Service Bus, Storage, Active Directory, etc.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Azure Active Directory</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Provides integration support for Spring Security with Azure Active Directory for authentication.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Azure Key Vault</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Provides Spring value annotation support for integration with Azure Key Vault Secrets.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Azure Storage</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Provides Spring Boot support for Azure Storage services.</p>
</div>
<div class="sect3">
<h4 id="azure-support"><a class="anchor" href="#azure-support"></a>1.1.1. Azure Support</h4>
<div class="paragraph">
<p>This Spring Boot Starter provides autoconfiguration support for Azure Services; for example: Service Bus, Storage, Active Directory, Cosmos DB, Key Vault, etc.</p>
</div>
<div class="paragraph">
<p>For examples of how to use the various Azure features that are provided by this starter, see the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <a href="https://github.com/Azure-Samples/azure-spring-boot-samples">azure-spring-boot-samples</a> repo on GitHub.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When you add this starter to a Spring Boot project, the following changes are made to the <em>pom.xml</em> file:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The following property is added to <code>&lt;properties&gt;</code> element:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;properties&gt;
    &lt;!-- Other properties will be listed here --&gt;
    &lt;java.version&gt;1.8&lt;/java.version&gt;
    &lt;spring.cloud.azure.version&gt;4.0.0&lt;/azure.version&gt;
&lt;/properties&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The default <code>spring-boot-starter</code> dependency is replaced with the following:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The following section is added to the file:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">   &lt;dependencyManagement&gt;
      &lt;dependencies&gt;
         &lt;dependency&gt;
            &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-azure-dependencies&lt;/artifactId&gt;
            &lt;version&gt;${version.spring.cloud.azure}&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
         &lt;/dependency&gt;
      &lt;/dependencies&gt;
   &lt;/dependencyManagement&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For more information about using this bom, see <a href="https://microsoft.github.io/spring-cloud-azure/current/reference/html/index.html#setting-up-dependencies">reference doc</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="azure-active-directory"><a class="anchor" href="#azure-active-directory"></a>1.1.2. Azure Active Directory</h4>
<div class="paragraph">
<p>This Spring Boot Starter provides autoconfiguration support for Spring Security in order to provide integration with Azure Active Directory for authentication.</p>
</div>
<div class="paragraph">
<p>For examples of how to use the Azure Active Directory features that are provided by this starter, see the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.0/aad/spring-cloud-azure-starter-active-directory">spring-cloud-azure-starter-active-directory samples</a> repo on GitHub.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When you add this starter to a Spring Boot project, the following changes are made to the <em>pom.xml</em> file:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The following property is added to <code>&lt;properties&gt;</code> element:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">   &lt;properties&gt;
      &lt;!-- Other properties will be listed here --&gt;
      &lt;java.version&gt;1.8&lt;/java.version&gt;
      &lt;version.spring.cloud.azure&gt;4.0.0&lt;/version.spring.cloud.azure&gt;
   &lt;/properties&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The default <code>spring-boot-starter</code> dependency is replaced with the following:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-active-directory&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The following section is added to the file:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">   &lt;dependencyManagement&gt;
      &lt;dependencies&gt;
         &lt;dependency&gt;
            &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-azure-dependencies&lt;/artifactId&gt;
            &lt;version&gt;${version.spring.cloud.azure}&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
         &lt;/dependency&gt;
      &lt;/dependencies&gt;
   &lt;/dependencyManagement&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For more information about using this starter, see <a href="https://microsoft.github.io/spring-cloud-azure/current/reference/html/index.html#spring-security-support">Spring Security Support</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="azure-key-vault"><a class="anchor" href="#azure-key-vault"></a>1.1.3. Azure Key Vault</h4>
<div class="paragraph">
<p>This Spring Boot Starter provides Spring value annotation support for integration with Azure Key Vault Secrets.</p>
</div>
<div class="paragraph">
<p>For examples of how to use the Azure Key Vault features that are provided by this starter, see the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.0/keyvault/spring-cloud-azure-starter-keyvault-secrets">spring-cloud-azure-starter-keyvault-secrets samples</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When you add this starter to a Spring Boot project, the following changes are made to the <em>pom.xml</em> file:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The following property is added to <code>&lt;properties&gt;</code> element:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">   &lt;properties&gt;
      &lt;!-- Other properties will be listed here --&gt;
      &lt;java.version&gt;1.8&lt;/java.version&gt;
      &lt;version.spring.cloud.azure&gt;4.0.0&lt;/version.spring.cloud.azure&gt;
   &lt;/properties&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The default <code>spring-boot-starter</code> dependency is replaced with the following:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-keyvault-secrets&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The following section is added to the file:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">   &lt;dependencyManagement&gt;
      &lt;dependencies&gt;
         &lt;dependency&gt;
            &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-azure-dependencies&lt;/artifactId&gt;
            &lt;version&gt;${version.spring.cloud.azure}&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
         &lt;/dependency&gt;
      &lt;/dependencies&gt;
   &lt;/dependencyManagement&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For more information about using this starter, see <a href="https://microsoft.github.io/spring-cloud-azure/current/reference/html/index.html#secret-management">Secret Management</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="azure-storage"><a class="anchor" href="#azure-storage"></a>1.1.4. Azure Storage</h4>
<div class="paragraph">
<p>This Spring Boot Starter provides Spring Boot integration support for Azure Storage services.</p>
</div>
<div class="paragraph">
<p>For examples of how to use the Azure Storage features that are provided by this starter, see the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.0/storage/spring-cloud-azure-starter-integration-storage-queue">spring-cloud-azure-starter-integration-storage-queue samples</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When you add this starter to a Spring Boot project, the following changes are made to the <em>pom.xml</em> file:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The following property is added to <code>properties</code> element:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">   &lt;properties&gt;
      &lt;!-- Other properties will be listed here --&gt;
      &lt;java.version&gt;1.8&lt;/java.version&gt;
      &lt;version.spring.cloud.azure&gt;4.0.0&lt;/version.spring.cloud.azure&gt;
   &lt;/properties&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The default <code>spring-boot-starter</code> dependency is replaced with the following:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-integration-storage-queue&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The following section is added to the file:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">   &lt;dependencyManagement&gt;
      &lt;dependencies&gt;
         &lt;dependency&gt;
            &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-azure-dependencies&lt;/artifactId&gt;
            &lt;version&gt;${version.spring.cloud.azure}&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
         &lt;/dependency&gt;
      &lt;/dependencies&gt;
   &lt;/dependencyManagement&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For more information about using this starter, see <a href="https://microsoft.github.io/spring-cloud-azure/current/reference/html/index.html#spring-integration-with-azure-storage-queue">Spring Integration with Azure Storage Queue</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="application-insights"><a class="anchor" href="#application-insights"></a>1.1.5. Application Insights</h4>
<div class="paragraph">
<p>Azure Monitor Application Insights can help you understand how your app is performing and how it&#8217;s being used. Application Insights uses the Java agent to enable the application monitor. There are no code changes needed, and you can enable the Java agent with just a couple of configuration changes. For instructions and more information, see <a href="/azure/azure-monitor/app/java-in-process-agent#configuration-options">Java codeless application monitoring Azure Monitor Application Insights</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="azure-storage-2"><a class="anchor" href="#azure-storage-2"></a>1.2. Azure Storage</h3>
<div class="paragraph">
<p>This article walks you through creating a custom application using the <strong>Spring Initializr</strong>, then adding the Azure Storage Blob starter to your application, and then using your application to upload a blob to your Azure storage account.</p>
</div>
<div class="sect3">
<h4 id="prerequisites"><a class="anchor" href="#prerequisites"></a>1.2.1. Prerequisites</h4>
<div class="paragraph">
<p>The following prerequisites are required in order to follow the steps in this article:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An Azure subscription; if you don&#8217;t already have an Azure subscription, you can activate your <a href="https://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/">MSDN subscriber benefits</a> or sign up for a <a href="https://azure.microsoft.com/pricing/free-trial/">free Azure account</a>.</p>
</li>
<li>
<p>The <a href="/cli/azure/index">Azure Command-Line Interface (CLI)</a>.</p>
</li>
<li>
<p>A supported Java Development Kit (JDK). For more information about the JDKs available for use when developing on Azure, see <a href="../fundamentals/java-support-on-azure.md">Java support on Azure and Azure Stack</a>.</p>
</li>
<li>
<p><a href="http://maven.apache.org/">Apache Maven</a>, version 3.0 or later.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Spring Boot version 2.5 or 2.6 is required to complete the steps in this article.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="create-an-azure-storage-account-and-blob-container-for-your-application"><a class="anchor" href="#create-an-azure-storage-account-and-blob-container-for-your-application"></a>1.2.2. Create an Azure Storage Account and blob container for your application</h4>
<div class="paragraph">
<p>The following procedure creates an Azure storage account and container in the portal.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Browse to the Azure portal at <a href="https://portal.azure.com/" class="bare">portal.azure.com/</a> and sign in.</p>
</li>
<li>
<p>Select <strong>Create a resource</strong>, then <strong>Get started</strong>, and then select <strong>Storage Account</strong>.</p>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/160536881-a9e3cb9d-bee6-40bd-80ce-634b4d198373.png" alt="Azure portal, create a resource, search for storage accounts."></span></p>
</div>
</li>
<li>
<p>On the <strong>Create storage account</strong> page, enter the following information:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Select <strong>Subscription</strong>.</p>
</li>
<li>
<p>Select <strong>Resource group</strong>, or create a new resource group.</p>
</li>
<li>
<p>Enter a unique <strong>Storage account name</strong>, which will become part of the URI for your storage account. For example: if you entered <strong>wingtiptoysstorage</strong> for the <strong>Name</strong>, the URI would be <em>wingtiptoysstorage.core.windows.net</em>.</p>
</li>
<li>
<p>Specify the <strong>Location</strong> for your storage account.</p>
</li>
</ol>
</div>
</li>
<li>
<p>When you have specified the options listed above, select <strong>Review + create</strong>.</p>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/160536965-b233f379-dfd3-4de0-be5c-28ff4420bb42.png" alt="Azure portal, create a storage account."></span></p>
</div>
</li>
<li>
<p>Review the specification, then select <strong>Create</strong> to create your storage account.</p>
</li>
<li>
<p>When the deployment is complete, select <strong>Go to resource</strong>.</p>
</li>
<li>
<p>Select <strong>Containers</strong>.</p>
</li>
<li>
<p>Select <strong>Container</strong>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Name the container.</p>
</li>
<li>
<p>Select <em>Blob</em> from the drop-down list.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/160537009-7dfb622f-8d38-4ef1-ba08-a60f38dd2af1.png" alt="Azure portal, storage account, containers, new container pane."></span></p>
</div>
</li>
<li>
<p>The Azure portal will list your blob container after is has been created.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can also use Azure CLI to create an Azure storage account and container using the following steps. Remember to replace the placeholder values (in angle brackets) with your own values.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open a command prompt.</p>
</li>
<li>
<p>Sign in to your Azure account:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">   az login</code></pre>
</div>
</div>
</li>
<li>
<p>If you don&#8217;t have a resource group, create one using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">   az group create \
      --name &lt;resource-group&gt; \
      --location &lt;location&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Create a storage account by using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">    az storage account create \
      --name &lt;storage-account-name&gt; \
      --resource-group &lt;resource-group&gt; \
      --location &lt;location&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>To create a container, use the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">    az storage container create \
      --account-name &lt;storage-account-name&gt; \
      --name &lt;container-name&gt; \
      --auth-mode login</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="create-a-simple-spring-boot-application-with-the-spring-initializr"><a class="anchor" href="#create-a-simple-spring-boot-application-with-the-spring-initializr"></a>1.2.3. Create a simple Spring Boot application with the Spring Initializr</h4>
<div class="paragraph">
<p>The following procedure creates the Spring boot application.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Browse to <a href="https://start.spring.io/" class="bare">start.spring.io/</a>.</p>
</li>
<li>
<p>Specify the following options:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Generate a <strong>Maven</strong> project.</p>
</li>
<li>
<p>Specify <strong>Java 11</strong>.</p>
</li>
<li>
<p>Specify a <strong>Spring Boot</strong> version that is equal to <strong>2.5.10</strong>.</p>
</li>
<li>
<p>Specify the <strong>Group</strong> and <strong>Artifact</strong> names for your application.</p>
</li>
<li>
<p>Add the <strong>Spring Web</strong> dependency.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/160537746-5ccdfcb8-9dbc-4d35-a78e-61875958bb8a.png" alt="Basic Spring Initializr options"></span>
NOTE: The Spring Initializr uses the <strong>Group</strong> and <strong>Artifact</strong> names to create the package name; for example: <strong>com.wingtiptoys.storage</strong>.</p>
</div>
</li>
<li>
<p>When you have specified the options listed above, select <strong>GENERATE</strong>.</p>
</li>
<li>
<p>When prompted, download the project to a path on your local computer.</p>
</li>
<li>
<p>After you have extracted the files on your local system, your simple Spring Boot application will be ready to edit.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="configure-your-spring-boot-app-to-use-the-azure-storage-blob-starter"><a class="anchor" href="#configure-your-spring-boot-app-to-use-the-azure-storage-blob-starter"></a>1.2.4. Configure your Spring Boot app to use the Azure Storage Blob starter</h4>
<div class="sect4">
<h5 id="add-dependency-in-pom-xml"><a class="anchor" href="#add-dependency-in-pom-xml"></a>Add dependency in pom.xml</h5>
<div class="paragraph">
<p>The following procedure configures the Spring boot application to use Azure storage.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Locate the <strong>pom.xml</strong> file in the root directory of your app; for example:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>C:\SpringBoot\storage\pom.xml</code></p>
</li>
<li>
<p><code>/users/example/home/storage/pom.xml</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Open the <strong>pom.xml</strong> file in a text editor, and add the Spring Cloud Azure Storage starter to the list of <code>&lt;dependencies&gt;</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">    &lt;dependency&gt;
      &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
      &lt;artifactId&gt;spring-cloud-azure-starter-storage-blob&lt;/artifactId&gt;
      &lt;version&gt;4.0.0&lt;/version&gt;
    &lt;/dependency&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Save and close the <strong>pom.xml</strong> file.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="configure-property-in-application-yml"><a class="anchor" href="#configure-property-in-application-yml"></a>Configure property in application.yml</h5>
<div class="paragraph">
<p>The following procedure configures the Spring boot application to use your Azure storage account.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Locate the <strong>application.yml</strong> in the <strong>resources</strong> directory of your app; for example:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>C:\SpringBoot\storage\src\main\resources\application.yml</code></p>
</li>
<li>
<p><code>/users/example/home/storage/src/main/resources/application.yml</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Open the <strong>application.yml</strong> file in a text editor, add the following lines, and then replace the sample values with the appropriate properties for your storage account:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  cloud:
    azure:
      storage:
        blob:
          account-name: [storage-account-name]
          account-key: [storage-account-access-key]
          endpoint: [storage-blob-service-endpoint]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Spring Cloud Azure Storage Blob Properties</caption>
<colgroup>
<col style="width: 44.4444%;">
<col style="width: 44.4444%;">
<col style="width: 11.1112%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.storage.blob.account-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the Azure Storage account.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.storage.blob.account-key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The access key of the Azure Storage account.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.storage.blob.endpoint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The blob endpoint URL of the Azure Storage account.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>Save and close the <em>application.yml</em> file.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="add-sample-code-to-implement-basic-azure-storage-functionality"><a class="anchor" href="#add-sample-code-to-implement-basic-azure-storage-functionality"></a>1.2.5. Add sample code to implement basic Azure storage functionality</h4>
<div class="paragraph">
<p>In this section, you will create the necessary Java classes for storing a blob in your Azure storage account.</p>
</div>
<div class="sect4">
<h5 id="add-a-blob-controller-class"><a class="anchor" href="#add-a-blob-controller-class"></a>Add a blob controller class</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a new Java file named <em>BlobController.java</em> in the package directory of your app; for example:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>C:\SpringBoot\storage\src\main\java\com\wingtiptoys\storage\BlobController.java</code></p>
</li>
<li>
<p><code>/users/example/home/storage/src/main/java/com/wingtiptoys/storage/BlobController.java</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Open <code>BlobController.java</code> in a text editor, and add the following lines to the file. Replace the <code>your-resource-group</code>, <code>your-artifact-name</code>, <code>your-container-name</code>, and <code>your-blob-name</code> placeholders with your values.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.&lt;your-resource-group&gt;.&lt;your-artifact-name&gt;;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.core.io.Resource;
import org.springframework.core.io.WritableResource;
import org.springframework.util.StreamUtils;
import org.springframework.web.bind.annotation.*;

import java.io.IOException;
import java.io.OutputStream;
import java.nio.charset.Charset;

@RestController
@RequestMapping("blob")
public class BlobController {
    @Value("azure-blob://&lt;your-container-name&gt;/&lt;your-blob-name&gt;")
    private Resource blobFile;

    @GetMapping("/readBlobFile")
    public String readBlobFile() throws IOException {
        return StreamUtils.copyToString(
                this.blobFile.getInputStream(),
                Charset.defaultCharset());
    }

    @PostMapping("/writeBlobFile")
    public String writeBlobFile(@RequestBody String data) throws IOException {
        try (OutputStream os = ((WritableResource) this.blobFile).getOutputStream()) {
            os.write(data.getBytes());
        }
        return "file was updated";
    }

}</code></pre>
</div>
</div>
</li>
<li>
<p>Save and close the blob controller Java file.</p>
</li>
<li>
<p>Open a command prompt and change directory to the folder where your <em>pom.xml</em> file is located; for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"> cd C:\SpringBoot\storage</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">   cd /users/example/home/storage</code></pre>
</div>
</div>
</li>
<li>
<p>Build your Spring Boot application with Maven and run it; for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">   mvn clean package
   mvn spring-boot:run</code></pre>
</div>
</div>
</li>
<li>
<p>Once your application is running, you can use <em>curl</em> to test your application; for example:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Send a POST request to update a file&#8217;s contents:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl http://localhost:8080/blob/writeBlobFile -d "new message" -H "Content-Type: text/plain"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see a response that  <code>file was updated</code>.</p>
</div>
</li>
<li>
<p>Send a GET request to verify the file&#8217;s contents:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -X GET http://localhost:8080/blob/readBlobFile</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see the "new message" text that you posted.</p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="summary"><a class="anchor" href="#summary"></a>1.2.6. Summary</h4>
<div class="paragraph">
<p>In this tutorial, you created a new Java application using the <strong>Spring Initializr</strong>, added the Azure Storage Blob starter to your application, and then configured your application to upload a blob to your Azure storage account.</p>
</div>
</div>
<div class="sect3">
<h4 id="clean-up-resources"><a class="anchor" href="#clean-up-resources"></a>1.2.7. Clean up resources</h4>
<div class="paragraph">
<p>When no longer needed, use the <a href="https://portal.azure.com/">Azure portal</a> to delete the resources created in this article to avoid unexpected charges.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="azure-key-vault-secrets"><a class="anchor" href="#azure-key-vault-secrets"></a>1.3. Azure Key Vault Secrets</h3>
<div class="paragraph">
<p>This tutorial shows you how to create a Spring Boot app that reads a value from Azure Key Vault. After creating the app, you&#8217;ll deploy it to Azure App Service and Azure Spring Cloud.</p>
</div>
<div class="paragraph">
<p>Spring Boot applications externalize sensitive information such as usernames and passwords. Externalizing sensitive information enables better maintainability, testability, and security. Storing secrets outside of the code is better than hard coding the information, or inlining it at build time.</p>
</div>
<div class="paragraph">
<p>In this tutorial, you learn how to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create an Azure Key Vault and store a secret</p>
</li>
<li>
<p>Create an app with Spring Initializr</p>
</li>
<li>
<p>Add Key Vault integration to the app</p>
</li>
<li>
<p>Deploy to Azure App Service</p>
</li>
<li>
<p>Redeploy to Azure App Service with managed identities for Azure resources</p>
</li>
<li>
<p>Deploy to Azure Spring Cloud</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="prerequisites-2"><a class="anchor" href="#prerequisites-2"></a>1.3.1. Prerequisites</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If you don&#8217;t have an <a href="https://docs.microsoft.com/azure/guides/developer/azure-developer-guide#understanding-accounts-subscriptions-and-billing">Azure subscription</a>, create a <a href="https://azure.microsoft.com/free/?ref=microsoft.com&amp;utm_source=microsoft.com&amp;utm_medium=docs&amp;utm_campaign=visualstudio">free account</a> before you begin.</p>
</li>
<li>
<p>The curl command. Most UNIX-like operating systems have this command pre-installed. OS-specific clients are available at <a href="https://curl.se/">the official curl website</a>.</p>
</li>
<li>
<p>The jq command. Most UNIX-like operating systems have this command pre-installed. OS-specific clients are available at <a href="https://stedolan.github.io/jq/">the official jq website</a>.</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli">Azure CLI</a>, version 2.14.1 or later</p>
</li>
<li>
<p>A supported Java Development Kit (JDK). For more information, see Java support on <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli">Azure and Azure Stack</a>.</p>
</li>
<li>
<p><a href="https://maven.apache.org/">Apache Maven</a>, version 3.0 or later.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Spring Boot version 2.5 or 2.6 is required to complete the steps in this article.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="create-a-new-azure-key-vault"><a class="anchor" href="#create-a-new-azure-key-vault"></a>1.3.2. Create a new Azure Key Vault</h4>
<div class="paragraph">
<p>The following sections show you how to sign in to Azure and create an Azure Key Vault.</p>
</div>
<div class="sect4">
<h5 id="sign-in-to-azure-and-set-your-subscription"><a class="anchor" href="#sign-in-to-azure-and-set-your-subscription"></a>Sign in to Azure and set your subscription</h5>
<div class="paragraph">
<p>First, use the following steps to authenticate using the Azure CLI.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Optionally, sign out and delete some authentication files to remove any lingering credentials:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az logout
rm ~/.azure/accessTokens.json
rm ~/.azure/azureProfile.json</code></pre>
</div>
</div>
</li>
<li>
<p>Sign in by using the Azure CLI:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">   az login</code></pre>
</div>
</div>
<div class="paragraph">
<p>Follow the instructions to complete the sign-in process.</p>
</div>
</li>
<li>
<p>List your subscriptions:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">   az account list</code></pre>
</div>
</div>
<div class="paragraph">
<p>Azure will return a list of your subscriptions. Copy the <code>id</code> value for the subscription that you want to use; for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "cloudName": "AzureCloud",
    "id": "ssssssss-ssss-ssss-ssss-ssssssssssss",
    "name": "Converted Windows Azure MSDN - Visual Studio Ultimate",
    "state": "Enabled",
    "tenantId": "tttttttt-tttt-tttt-tttt-tttttttttttt",
    "user": {
      "name": "contoso@microsoft.com",
      "type": "user"
    }
  }
]</code></pre>
</div>
</div>
</li>
<li>
<p>Specify the GUID for the subscription you want to use with Azure; for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az account set -s ssssssss-ssss-ssss-ssss-ssssssssssss</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="create-a-service-principal"><a class="anchor" href="#create-a-service-principal"></a>Create a service principal</h5>
<div class="paragraph">
<p>Azure AD <strong>service principals</strong> provide access to Azure resources within your subscription. You can think of a service principal as a user identity for a service. "Service" is any application, service, or platform that needs to access Azure resources. You can configure a service principal with access rights scoped only to those resources you specify. Then, configure your application or service to use the service principal&#8217;s credentials to access those resources.</p>
</div>
<div class="paragraph">
<p>To create a service principal, use the following command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az ad sp create-for-rbac –name contososp –role Contributor</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The value of the <code>--name</code> option must be unique within the Azure subscription. If you see an error log similar to <code>Found an existing instance of "&#8230;&#8203;", We will patch it. Insufficient privileges to complete operation</code>, that means the <code>name</code> value already exist in your subscription. Try another name.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Save aside the values returned from the command for use later in the tutorial. The return JSON will look similar to the following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
 "appId": "sample-app-id",
 "displayName": "contososp",
 "name": "http://contososp",
 "password": "sample-password",
 "tenant": "sample-tenant"
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="create-the-key-vault-instance"><a class="anchor" href="#create-the-key-vault-instance"></a>Create the Key Vault instance</h5>
<div class="paragraph">
<p>To create and initialize the Azure Key Vault, use the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Determine which Azure region will hold your resources.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>To see the list of regions and their locations, see [Azure geographies](<a href="https://azure.microsoft.com/regions/" class="bare">azure.microsoft.com/regions/</a>).</p>
</li>
<li>
<p>Use the <code>az account list-locations</code> command to find the correct <code>Name</code> for your chosen region.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az account list-locations --output table</code></pre>
</div>
</div>
<div class="paragraph">
<p>This tutorial uses <code>eastus</code>.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Create a resource group to hold the Key Vault and the App Service app. The value must be unique within the Azure subscription. This tutorial uses <code>contosorg</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az group create --name contosorg --location eastus</code></pre>
</div>
</div>
</li>
<li>
<p>Create a new Key Vault in the resource group.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az keyvault create \
    --resource-group contosorg \
    --name contosokv \
    --enabled-for-deployment true \
    --enabled-for-disk-encryption true \
    --enabled-for-template-deployment true \
    --location eastus \
    --query properties.vaultUri \
    --sku standard</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The value of the <code>--name</code> option must be unique within the Azure subscription. If you see an error log similar to <code>Found an existing instance of "&#8230;&#8203;", We will patch it. Insufficient privileges to complete operation</code>, that means the <code>name</code> value already exist in your subscription. Try another name.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can refer to <a href="https://docs.microsoft.com/en-us/cli/azure/keyvault?view=azure-cli-latest#az-keyvault-create">az keyvault create command</a> to get more information about each parameter.
The Azure CLI will display the URI for Key Vault, which you&#8217;ll use later; for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">"https://contosokv.vault.azure.net/"</code></pre>
</div>
</div>
</li>
<li>
<p>Configure the Key Vault to allow <code>get</code> and <code>list</code> operations from that managed identity. The value of the <code>object-id</code> is the <code>appId</code> from the <code>az ad sp create-for-rbac</code> command above.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az keyvault set-policy --name contosokv --spn http://contososp --secret-permissions get list</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output will be a JSON object full of information about the Key Vault. It will have a <code>type</code> entry with value <code>Microsoft.KeyVault/vaults</code>.
You can refer to <a href="https://docs.microsoft.com/cli/azure/keyvault?view=azure-cli-latest#az-keyvault-set-policy">az keyvault set-policy</a> to get more information about each parameter.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
While the principle of the least privilege recommends granting the smallest possible set of privileges to a resource, the design of the Key Vault integration requires at least <code>get</code> and <code>list</code>.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Store a secret in your new Key Vault. A common use case is to store a JDBC connection string. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">   az keyvault secret set --name "connectionString" \
       --vault-name "contosokv" \
       --value "jdbc:sqlserver://SERVER.database.windows.net:1433;database=DATABASE;"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can refer to <a href="https://docs.microsoft.com/en-us/cli/azure/keyvault/secret?view=azure-cli-latest#az-keyvault-secret-set">az keyvault secret set command</a> to get more information about each parameter.
The Azure CLI will display the results of your secret creation; for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "attributes": {
    "created": "2020-08-24T21:48:09+00:00",
    "enabled": true,
    "expires": null,
    "notBefore": null,
    "recoveryLevel": "Purgeable",
    "updated": "2020-08-24T21:48:09+00:00"
  },
  "contentType": null,
  "id": "https://contosokv.vault.azure.net/secrets/connectionString/sample-id",
  "kid": null,
  "managed": null,
  "tags": {
    "file-encoding": "utf-8"
  },
  "value": "jdbc:sqlserver://.database.windows.net:1433;database=DATABASE;"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that you&#8217;ve created a Key Vault and stored a secret, the next section will show you how to create an app with Spring Initializr.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-the-app-with-spring-initializr"><a class="anchor" href="#create-the-app-with-spring-initializr"></a>1.3.3. Create the app with Spring Initializr</h4>
<div class="paragraph">
<p>This section shows how to use Spring Initializr to create and run a Spring Boot web application with key vault secrets included.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Browse to <a href="https://start.spring.io/" class="bare">start.spring.io/</a>.</p>
</li>
<li>
<p>Select the choices as shown in the picture following this list.</p>
<div class="ulist">
<ul>
<li>
<p><strong>Project</strong>: <strong>Maven Project</strong></p>
</li>
<li>
<p><strong>Language</strong>: <strong>Java</strong></p>
</li>
<li>
<p><strong>Spring Boot</strong>: <strong>2.5.10</strong></p>
</li>
<li>
<p><strong>Group</strong>: <strong>com.contoso</strong> (You can put any valid Java package name here.)</p>
</li>
<li>
<p><strong>Artifact</strong>: <strong>keyvault</strong> (You can put any valid Java class name here.)</p>
</li>
<li>
<p><strong>Packaging</strong>: <strong>Jar</strong></p>
</li>
<li>
<p><strong>Java</strong>: <strong>11</strong> (You can choose 8, but this tutorial was validated with 11.)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Select <strong>Add Dependencies&#8230;&#8203;</strong>.</p>
</li>
<li>
<p>In the text field, type <strong>Spring Web</strong> and press Ctrl+Enter.</p>
</li>
<li>
<p>In the text field type <strong>Azure Key Vault</strong> and press Enter. Your screen should look like the following.
<span class="image"><img src="https://user-images.githubusercontent.com/13167207/160542739-62ae6857-0229-4b4b-8a98-38df37747a6d.png" alt="Basic Spring Initializr options"></span></p>
</li>
<li>
<p>At the bottom of the page, select <strong>Generate</strong>.</p>
</li>
<li>
<p>When prompted, download the project to a path on your local computer. This tutorial uses a <strong>keyvault</strong> directory in the current user&#8217;s home directory. The values above will give you a <strong>keyvault.zip</strong> file in that directory.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Use the following steps to examine the application and run it locally.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Unzip the <strong>keyvault.zip</strong> file. The file layout will look like the following. This tutorial ignores the <strong>test</strong> directory and its contents.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-txt hljs" data-lang="txt">├── HELP.md
├── mvnw
├── mvnw.cmd
├── pom.xml
└── src
   ├── main
   │   ├── java
   │   │   └── com
   │   │       └── contoso
   │   │           └── keyvault
   │   │               └── KeyvaultApplication.java
   │   └── resources
   │       ├── application.properties
   │       ├── static
   │       └── templates</code></pre>
</div>
</div>
</li>
<li>
<p>Open the <strong>KeyvaultApplication.java</strong> file in a text editor. Edit the file so that it has the following contents.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@SpringBootApplication
@RestController
public class KeyvaultApplication {

    public static void main(String[] args) {
        SpringApplication.run(KeyvaultApplication.class, args);
    }

    @GetMapping("get")
    public String get() {
        return connectionString;
    }

    private String connectionString = "defaultValue\n";

    public void run(String... varl) throws Exception {
        System.out.println(String.format("Connection String stored in Azure Key Vault:%s",connectionString));
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following list highlights some details about this code:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The class is annotated with <code>@RestController</code>. <code>@RestController</code> tells Spring Boot that the class can respond to RESTful HTTP requests.</p>
</li>
<li>
<p>The class has a method annotated with <code>@GetMapping(get)</code>. <code>@GetMapping</code> tells Spring Boot to send HTTP requests with the path <code>/get</code> to that method, allowing the response from that method to be returned to the HTTP client.</p>
</li>
<li>
<p>The class has a private instance variable <code>connectionString</code>. The value of this instance variable is returned from the <code>get()</code> method.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Open a Bash window and navigate to the top-level <strong>keyvault</strong> directory, where the <strong>pom.xml</strong> file is located.</p>
</li>
<li>
<p>Enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn spring-boot:run</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command outputs <code>Completed initialization</code>, which indicates that the server is ready.</p>
</div>
</li>
<li>
<p>In a separate Bash window, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl http://localhost:8080/get</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output will show <code>defaultValue</code>.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Kill the process that&#8217;s running from <code>mvn spring-boot:run</code>. You can type Ctrl-C, or you can use the <code>jps</code> command to get the pid of the <code>Launcher</code> process and kill it.</p>
</div>
</div>
<div class="sect3">
<h4 id="create-the-app-without-spring-initializr"><a class="anchor" href="#create-the-app-without-spring-initializr"></a>1.3.4. Create the app without Spring Initializr</h4>
<div class="paragraph">
<p>This section shows how to include Azure Key Vault secrets to your existing Spring Boot project without using Spring Initializr.</p>
</div>
<div class="paragraph">
<p>To manually add the same the configuration that Spring Initializr generates, add the following configuration to your <strong>pom.xml</strong> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;project&gt;
    &lt;properties&gt;
         &lt;version.spring.cloud.azure&gt;4.0.0&lt;/version.spring.cloud.azure&gt;
    &lt;/properties&gt;
    &lt;dependencies&gt;
         &lt;dependency&gt;
             &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
             &lt;artifactId&gt;spring-cloud-azure-starter-keyvault-secrets&lt;/artifactId&gt;
         &lt;/dependency&gt;
    &lt;/dependencies&gt;
    &lt;dependencyManagement&gt;
         &lt;dependencies&gt;
             &lt;dependency&gt;
                 &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
                 &lt;artifactId&gt;spring-cloud-azure-dependencies&lt;/artifactId&gt;
                 &lt;version&gt;${version.spring.cloud.azure}&lt;/version&gt;
                 &lt;type&gt;pom&lt;/type&gt;
                 &lt;scope&gt;import&lt;/scope&gt;
             &lt;/dependency&gt;
         &lt;/dependencies&gt;
    &lt;/dependencyManagement&gt;
&lt;/project&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="add-key-vault-configuration-to-the-app"><a class="anchor" href="#add-key-vault-configuration-to-the-app"></a>1.3.5. Add Key Vault configuration to the app</h4>
<div class="paragraph">
<p>This section shows you how to add Key Vault configuration to your locally running application by modifying the Spring Boot application <code>KeyvaultApplication</code>.</p>
</div>
<div class="paragraph">
<p>Just as Key Vault allows externalizing secrets from application code, Spring configuration allows externalizing configuration from code. The simplest form of Spring configuration is the <strong>application.properties</strong> file. In a Maven project, this file is located at <strong>src/main/resources/application.properties</strong>. Spring Initializr helpfully includes a zero length file at this location. Use the following steps to add the necessary configuration to this file.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Edit the <strong>src/main/resources/application.properties</strong> file so that it has the following contents, adjusting the values for your Azure subscription.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">spring.cloud.azure.keyvault.secret.property-source-enabled=true
spring.cloud.azure.keyvault.secret.property-sources[0].credential.client-id=&lt;your client ID&gt;
spring.cloud.azure.keyvault.secret.property-sources[0].credential.client-secret=&lt;your client key&gt;
spring.cloud.azure.keyvault.secret.property-sources[0].endpoint=https://contosokv.vault.azure.net/
spring.cloud.azure.keyvault.secret.property-sources[0].profile.tenant-id=&lt;your tenant ID&gt;</code></pre>
</div>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>spring.cloud.azure.keyvault.secret.property-source-enabled. Whether enable the property source feature of spring-cloud-azure-starter-keyvault-secrets. Default value is false.</p>
</li>
<li>
<p>spring.cloud.azure.keyvault.secret.property-sources[0].credential.client-id. The <code>appId</code> from the return JSON from <code>az ad sp create-for-rbac</code>.</p>
</li>
<li>
<p>spring.cloud.azure.keyvault.secret.property-sources[0].credential.client-secret. The <code>password</code> from the return JSON from <code>az ad sp create-for-rbac</code>.</p>
</li>
<li>
<p>spring.cloud.azure.keyvault.secret.property-sources[0].endpoint. The value output from the <code>az keyvault create</code> command above.</p>
</li>
<li>
<p>spring.cloud.azure.keyvault.secret.property-sources[0].profile.tenant-id. The <code>tenant</code> from the return JSON from <code>az ad sp create-for-rbac</code>.|.
For the complete list of properties, see [Spring Cloud Azure Reference doc appendix](<a href="https://microsoft.github.io/spring-cloud-azure/current/reference/html/appendix.html#_configuration_properties" class="bare">microsoft.github.io/spring-cloud-azure/current/reference/html/appendix.html#_configuration_properties</a>).</p>
</li>
</ol>
</div>
</li>
<li>
<p>Save the file and close it.</p>
</li>
<li>
<p>Open <strong>src/main/java/com/contoso/keyvault/KeyvaultApplication.java</strong> in an editor.</p>
</li>
<li>
<p>Add the following <code>import</code> statement.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.springframework.beans.factory.annotation.Value;</code></pre>
</div>
</div>
</li>
<li>
<p>Add the following annotation to the <code>connectionString</code> instance variable.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">   @Value("${connectionString}")
   private String connectionString;</code></pre>
</div>
</div>
</li>
<li>
<p>Open a Bash window and navigate to the top-level <strong>keyvault</strong> directory, where the <strong>pom.xml</strong> file is located.</p>
</li>
<li>
<p>Enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn clean package spring-boot:run</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command outputs <code>initialization completed</code>, which indicates that the server is ready.</p>
</div>
</li>
<li>
<p>In a separate Bash window, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl http://localhost:8080/get</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output will show <code>jdbc:sqlserver://SERVER.database.windows.net:1433;database=DATABASE</code> instead of <code>defaultValue</code>.</p>
</div>
</li>
<li>
<p>Kill the process that&#8217;s running from <code>mvn spring-boot:run</code>. You can type Ctrl-C, or you can use the <code>jps</code> command to get the pid of the <code>Launcher</code> process and kill it.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="deploy-to-azure-app-service"><a class="anchor" href="#deploy-to-azure-app-service"></a>1.3.6. Deploy to Azure App Service</h4>
<div class="paragraph">
<p>The following steps show you how to deploy the <code>KeyvaultApplication</code> to Azure App Service.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the top-level <strong>keyvault</strong> directory, open the <strong>pom.xml</strong> file.</p>
</li>
<li>
<p>In the <code>&lt;build&gt;&lt;plugins&gt;</code> section, add the <code>azure-webapp-maven-plugin</code> by inserting the following XML.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;plugin&gt;
    &lt;groupId&gt;com.microsoft.azure&lt;/groupId&gt;
    &lt;artifactId&gt;azure-webapp-maven-plugin&lt;/artifactId&gt;
    &lt;version&gt;2.2.2&lt;/version&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Don&#8217;t worry about the formatting. The <code>azure-webapp-maven-plugin</code> will reformat the entire POM during this process.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Save and close the <strong>pom.xml</strong> file</p>
</li>
<li>
<p>At a command line, use the following command to invoke the <code>config</code> goal of the newly added plugin.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn azure-webapp:config</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Maven plugin will ask you some questions and edit the <strong>pom.xml</strong> file based on the answers. Use the following values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For <strong>Subscription</strong>, ensure you&#8217;ve selected the same subscription ID with the Key Vault you created.</p>
</li>
<li>
<p>For <strong>Web App</strong>, you can either select an existing Web App or select <code>&lt;create&gt;</code> to create a new one. If you select an existing Web App, it will jump directly to the last <strong>confirm</strong> step.</p>
</li>
<li>
<p>For <strong>OS</strong>, ensure <strong>linux</strong> is selected.</p>
</li>
<li>
<p>For <strong>javaVersion</strong>, ensure you select the Java version you chose in Spring Initializr. This tutorial uses version 11.</p>
</li>
<li>
<p>Accept the defaults for the remaining questions.</p>
</li>
<li>
<p>When asked to confirm, answer Y to continue or N to start answering the questions again. When the plugin completes running, you&#8217;re ready to edit the POM.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Next, open the modified <strong>pom.xml</strong> in an editor. The contents of the file should be similar to the following XML. Replace the following placeholders with the specified values if you didn&#8217;t already provide the value in the previous step.</p>
<div class="ulist">
<ul>
<li>
<p><code>YOUR_SUBSCRIPTION_ID</code>: This placeholder shows the location of the ID provided previously.</p>
</li>
<li>
<p><code>YOUR_RESOURCE_GROUP_NAME</code>: Replace this placeholder with the value that you specified when you created the Key Vault.</p>
</li>
<li>
<p><code>YOUR_APP_NAME</code>: Replace this placeholder with a sensible value that&#8217;s unique within your subscription.</p>
</li>
<li>
<p><code>YOUR_REGION</code>: Replace this placeholder with the value that you specified when you created the Key Vault.</p>
</li>
<li>
<p><code>APP_SETTINGS</code>: Copy the indicated <code>&lt;appSettings&gt;</code> element from the example and paste it into that location in your <strong>pom.xml</strong> file. This setting causes the server to listen on TCP port 80.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;plugins&gt;
  &lt;plugin&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
  &lt;/plugin&gt;
  &lt;plugin&gt;
    &lt;groupId&gt;com.microsoft.azure&lt;/groupId&gt;
    &lt;artifactId&gt;azure-webapp-maven-plugin&lt;/artifactId&gt;
    &lt;version&gt;2.2.2&lt;/version&gt;
    &lt;configuration&gt;
      &lt;schemaVersion&gt;V2&lt;/schemaVersion&gt;
      &lt;subscriptionId&gt;YOUR_SUBSCRIPTION_ID&lt;/subscriptionId&gt;
      &lt;resourceGroup&gt;YOUR_RESOURCE_GROUP_NAME&lt;/resourceGroup&gt;
      &lt;appName&gt;YOUR_APP_NAME&lt;/appName&gt;
      &lt;pricingTier&gt;P1v2&lt;/pricingTier&gt;
      &lt;region&gt;YOUR_REGION&lt;/region&gt;
      &lt;runtime&gt;
        &lt;os&gt;linux&lt;/os&gt;
        &lt;javaVersion&gt;java 11&lt;/javaVersion&gt;
        &lt;webContainer&gt;Java SE&lt;/webContainer&gt;
      &lt;/runtime&gt;
      &lt;!-- start of APP_SETTINGS --&gt;
      &lt;appSettings&gt;
        &lt;property&gt;
          &lt;name&gt;JAVA_OPTS&lt;/name&gt;
          &lt;value&gt;-Dserver.port=80&lt;/value&gt;
        &lt;/property&gt;
      &lt;/appSettings&gt;
      &lt;!-- end of APP_SETTINGS --&gt;
      &lt;deployment&gt;
        &lt;resources&gt;
          &lt;resource&gt;
            &lt;directory&gt;${project.basedir}/target&lt;/directory&gt;
            &lt;includes&gt;
              &lt;include&gt;*.jar&lt;/include&gt;
            &lt;/includes&gt;
          &lt;/resource&gt;
        &lt;/resources&gt;
      &lt;/deployment&gt;
    &lt;/configuration&gt;
  &lt;/plugin&gt;
&lt;/plugins&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Save and close the POM.</p>
</li>
<li>
<p>Use the following command to deploy the app to Azure App Service.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn -DskipTests clean package azure-webapp:deploy</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command may take several minutes, depending on many factors beyond your control. When you see output similar to the following example, you know your app has been successfully deployed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-tExt hljs" data-lang="tExt">[INFO] Deploying the zip package contosokeyvault-22b7c1a3-b41b-4082-a9f0-9339723fa36a11893059035499017844.zip...
[INFO] Successfully deployed the artifact to https://contosokeyvault.azurewebsites.net
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  01:45 min
[INFO] Finished at: 2020-08-16T22:47:48-04:00
[INFO] ------------------------------------------------------------------------</code></pre>
</div>
</div>
</li>
<li>
<p>Wait three to five minutes to allow the deployment to complete. Then you may access the deployment with a <code>curl</code> command similar to the one shown previously, but this time using the hostname shown in your <code>BUILD SUCCESS</code> output. The following example uses <code>contosokeyvault</code> as shown in the output above.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl https://contosokeyvault.azurewebsites.net/get</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following output indicates success.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-txt hljs" data-lang="txt">jdbc:sqlserver://SERVER.database.windows.net:1433;database=DATABASE;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ve now deployed your app to Azure App Service.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="redeploy-to-azure-app-service-and-use-managed-identities-for-azure-resources"><a class="anchor" href="#redeploy-to-azure-app-service-and-use-managed-identities-for-azure-resources"></a>1.3.7. Redeploy to Azure App Service and use managed identities for Azure resources</h4>
<div class="paragraph">
<p>This section describes how to associate an identity with the Azure resource for the app. This association is required so that Azure can apply security and track access.</p>
</div>
<div class="paragraph">
<p>One of the foundational principles of cloud computing is to pay for only the resources you use. Such fine-grained resource tracking is only possible if every resource is associated with an identity. Azure App Service and Azure Key Vault are two of the many Azure services that take advantage of managed identities for Azure resources. For more information about this important technology, see [What are managed identities for Azure resources?](/azure/active-directory/managed-identities-azure-resources/overview)</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
"Managed identities for Azure resources" is the new name for the service formerly known as Managed Service Identity (MSI).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Use the following steps to create the managed identity for the Azure App Service app and then allow that identity to access the Key Vault.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a managed identity for the App Service app. Replace the <code>&lt;your resource group name&gt;</code> and <code>&lt;your app name&gt;</code> placeholders with the values of the <code>&lt;resourceGroup&gt;</code> and <code>&lt;appName&gt;</code> elements from your <strong>pom.xml</strong> file.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az webapp identity assign --resource-group &lt;your resource group name&gt; --name &lt;your app name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output will be similar to the following example. Note down the value of <code>principalId</code> for the next step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "principalId": "&lt;your principal ID&gt;",
  "tenantId": "&lt;your tenant ID&gt;",
  "type": "SystemAssigned",
  "userAssignedIdentities": null
}</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <strong>application.properties</strong> so that it names the managed identity for Azure resources created in the preceding step.</p>
<div class="ulist">
<ul>
<li>
<p>Remove the <code>spring.cloud.azure.keyvault.secret.property-sources[0].credential.client-secret</code>.</p>
</li>
<li>
<p>Update the <code>spring.cloud.azure.keyvault.secret.property-sources[0].credential.client-id</code> to have the value of the <code>principalId</code> from the preceding step. The completed file should now look like the following example.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">spring.cloud.azure.keyvault.secret.property-source-enabled=true
spring.cloud.azure.keyvault.secret.property-sources[0].credential.client-id=&lt;your principal ID&gt;
spring.cloud.azure.keyvault.secret.property-sources[0].credential.managed-identity-enabled=true
spring.cloud.azure.keyvault.secret.property-sources[0].profile.tenant-id=&lt;your tenant ID&gt;
spring.cloud.azure.keyvault.secret.property-sources[0].endpoint=https://contosokv.vault.azure.net/</code></pre>
</div>
</div>
</li>
<li>
<p>Configure the Key Vault to allow <code>get</code> and <code>list</code> operations from the managed identity. The value of the <code>object-id</code> is the <code>principalId</code> from the preceding output.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az keyvault set-policy \
    --name &lt;your Key Vault name&gt; \
    --object-id &lt;your principal ID&gt; \
    --secret-permissions get list</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output will be a JSON object full of information about the Key Vault. It will have a <code>type</code> entry with value <code>Microsoft.KeyVault/vaults</code>. Here is the explanation of each property:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>name: The name of the Key Vault.</p>
</li>
<li>
<p>object-id: The <code>principalId</code> from the preceding command.</p>
</li>
<li>
<p>secret-permissions: The list of operations to allow from the named principal.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Package and redeploy the application.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn -DskipTests clean package azure-webapp:deploy</code></pre>
</div>
</div>
</li>
<li>
<p>For good measure, wait a few more minutes to allow the deployment to settle down. Then you may contact the deployment with a <code>curl</code> command similar to the one shown previously, but this time using the hostname shown in your <code>BUILD SUCCESS</code> output. The following example uses <code>contosokeyvault</code> as shown in the <code>BUILD SUCCESS</code> output from the previous section.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl https://contosokeyvault.azurewebsites.net/get</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following output indicates success.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">jdbc:sqlserver://SERVER.database.windows.net:1433;database=DATABASE;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of returning <code>defaultValue</code>, the app gets <code>connectionString</code> from the Key Vault.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="deploy-to-azure-spring-cloud"><a class="anchor" href="#deploy-to-azure-spring-cloud"></a>1.3.8. Deploy to Azure Spring Cloud</h4>
<div class="paragraph">
<p>In this section, you&#8217;ll deploy the app to Azure Spring Cloud.</p>
</div>
<div class="paragraph">
<p>Azure Spring Cloud is a fully managed platform for deploying and running your Spring Boot applications in Azure. For an overview of Azure Spring Cloud, see [What is Azure Spring Cloud?](/azure/spring-cloud/overview).</p>
</div>
<div class="paragraph">
<p>This section will use the Spring Boot app and Key Vault that you created previously with a new instance of Azure Spring Cloud.</p>
</div>
<div class="paragraph">
<p>The following steps will show how to create an Azure Spring Cloud resource and deploy the app to it. Make sure you&#8217;ve installed the Azure CLI extension for Azure Spring Cloud as shown in the [Prerequisites](#prerequisites).</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Decide on a name for the service instance. To use Azure Spring Cloud within your Azure subscription, you must create an Azure resource of type Azure Spring Cloud. As with all other Azure resources, the service instance must stay within a resource group. Use the resource group you already created to hold the service instance, and choose a name for your Azure Spring Cloud instance. Create the service instance with the following command.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az spring-cloud create --resource-group &lt;your resource group name&gt; --name &lt;your Azure Spring Cloud instance name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command takes several minutes to complete.</p>
</div>
</li>
<li>
<p>Create a Spring Cloud App within the service.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az spring-cloud app create \
    --resource-group &lt;your resource group name&gt; \
    --service &lt;your Azure Spring Cloud instance name&gt; \
    --name &lt;your app name&gt; \
    --assign-identity \
    --is-public true \
    --runtime-version Java_11 \</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the explanation of each property:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>resource-group: The name of the resource group where you created the existing service instance.</p>
</li>
<li>
<p>service: The name of the existing service.</p>
</li>
<li>
<p>name: The name of the app.</p>
</li>
<li>
<p>assign-identity:  Causes the service to create an identity for managed identities for Azure resources.</p>
</li>
<li>
<p>is-public:  Assign a public DNS domain name to the service.</p>
</li>
<li>
<p>runtime-version:  The Java runtime version. The value must match the value chosen in Spring Initializr above.</p>
<div class="paragraph">
<p>To understand the difference between <strong>service</strong> and <strong>app</strong>, see [App and deployment in Azure Spring Cloud](/azure/spring-cloud/concept-understand-app-and-deployment).</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Use the following command to get the managed identity for the Azure resource and use it to configure the existing Key Vault to allow access from this App.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">SERVICE_IDENTITY=$(az spring-cloud app show --resource-group "contosorg" --name "contosoascsapp" --service "contososvc" | jq -r '.identity.principalId')

az keyvault set-policy \
    --name &lt;your Key Vault name&gt; \
    --object-id &lt;the value of the environment variable SERVICE_IDENTITY&gt; \
    --secret-permissions set get list</code></pre>
</div>
</div>
</li>
<li>
<p>Because the existing Spring Boot app already has an <strong>application.properties</strong> file with the necessary configuration, we can deploy this app directly to Spring Cloud using the following command. Run the command in the directory containing the POM.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az spring-cloud app deploy \
    --resource-group &lt;your resource group name&gt; \
    --name &lt;your Spring Cloud app name&gt; \
    --jar-path target/keyvault-0.0.1-SNAPSHOT.jar \
    --service &lt;your Azure Spring Cloud instance name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command creates a <strong>Deployment</strong> within the app, within the service. For more details on the concepts of service instances, apps, and Deployments see [App and deployment in Azure Spring Cloud](/azure/spring-cloud/concept-understand-app-and-deployment).</p>
</div>
<div class="paragraph">
<p>If the deployment isn&#8217;t successful, configure the logs for troubleshooting as described in [Configure application logs](<a href="https://aka.ms/azure-spring-cloud-configure-logs" class="bare">aka.ms/azure-spring-cloud-configure-logs</a>). The logs will likely have useful information to diagnose and resolve the problem.</p>
</div>
</li>
<li>
<p>When the app has been successfully deployed, you can use <code>curl</code> to verify the Key Vault integration is working. Because you specified <code>--is-public</code>, the default URL for your service is <code><a href="https://&lt;your" class="bare">&lt;your</a> Azure Spring Cloud instance name&gt;-&lt;your app name&gt;.azuremicroservices.io/</code>. The following command shows an example where the service instance name is <code>contososvc</code> and the app name is <code>contosoascsapp</code>. The URL appends the value of the <code>@GetMapping</code> annotation.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">   curl https://contososvc-contosoascsapp.azuremicroservices.io/get</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output will show <code>jdbc:sqlserver://SERVER.database.windows.net:1433;database=DATABASE</code>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="summary-2"><a class="anchor" href="#summary-2"></a>1.3.9. Summary</h4>
<div class="paragraph">
<p>In this tutorial, you created a new Java web application using the Spring Initializr. You created an Azure Key Vault to store sensitive information, and then configured your application to retrieve information from your Key Vault. After testing it locally, you deployed the app to Azure App Service and Azure Spring Cloud.</p>
</div>
</div>
<div class="sect3">
<h4 id="clean-up-resources-2"><a class="anchor" href="#clean-up-resources-2"></a>1.3.10. Clean up resources</h4>
<div class="paragraph">
<p>When you&#8217;re finished with the Azure resources you created in this tutorial, you can delete them using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az group delete –name &lt;your resource group name&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="azure-key-vault-certificates"><a class="anchor" href="#azure-key-vault-certificates"></a>1.4. Azure Key Vault certificates</h3>
<div class="paragraph">
<p>This tutorial shows you how to secure your Spring Boot (including Azure Spring Cloud) apps with TLS/SSL certificates using Azure Key Vault and managed identities for Azure resources.</p>
</div>
<div class="paragraph">
<p>Production-grade Spring Boot applications, whether in the cloud or on-premises, require end-to-end encryption for network traffic using standard TLS protocols. Most TLS/SSL certificates you come across are discoverable from a public root certificate authority (CA). Sometimes, however, this discovery isn&#8217;t possible. When certificates aren&#8217;t discoverable, the app must have some way to load such certificates, present them to inbound network connections, and accept them from outbound network connections.</p>
</div>
<div class="paragraph">
<p>Spring Boot apps typically enable TLS by installing the certificates. The certificates are installed into the local key store of the JVM that&#8217;s running the Spring Boot app. With Spring on Azure, certificates are not installed locally. Instead, Spring integration for Microsoft Azure provides a secure and frictionless way to enable TLS with help from Azure Key Vault and managed identity for Azure resources.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/160548968-523cbb6d-fffe-44a7-9dd7-563ffe6610db.png" alt="Azure KeyVault Certificates"></span></p>
</div>
<div class="paragraph">
<p>In this tutorial, you learn how to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a GNU/Linux VM with system-assigned managed identity</p>
</li>
<li>
<p>Create an Azure Key Vault</p>
</li>
<li>
<p>Create a self-signed TLS/SSL certificate</p>
</li>
<li>
<p>Store the self-signed TLS/SSL certificate in the Azure Key Vault</p>
</li>
<li>
<p>Run a Spring Boot application where the TLS/SSL certificate for inbound connection comes from Azure Key Vault</p>
</li>
<li>
<p>Run a Spring Boot application where the TLS/SSL certificate for outbound connection comes from Azure Key Vault</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="prerequisites-3"><a class="anchor" href="#prerequisites-3"></a>1.4.1. Prerequisites</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If you don&#8217;t have an <a href="https://docs.microsoft.com/azure/guides/developer/azure-developer-guide#understanding-accounts-subscriptions-and-billing">Azure subscription</a>, create a <a href="https://azure.microsoft.com/free/?ref=microsoft.com&amp;utm_source=microsoft.com&amp;utm_medium=docs&amp;utm_campaign=visualstudio">free account</a> before you begin.</p>
</li>
<li>
<p>The curl command. Most UNIX-like operating systems have this command pre-installed. OS-specific clients are available at <a href="https://curl.se/">the official curl website</a>.</p>
</li>
<li>
<p>The jq command. Most UNIX-like operating systems have this command pre-installed. OS-specific clients are available at <a href="https://stedolan.github.io/jq/">the official jq website</a>.</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli">Azure CLI</a>, version 2.14.1 or later</p>
</li>
<li>
<p>A supported Java Development Kit (JDK). For more information, see Java support on <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli">Azure and Azure Stack</a>.</p>
</li>
<li>
<p><a href="https://maven.apache.org/">Apache Maven</a>, version 3.0 or later.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Spring Boot version 2.5 or 2.6 is required to complete the steps in this article.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="create-a-gnulinux-vm-with-system-assigned-managed-identity"><a class="anchor" href="#create-a-gnulinux-vm-with-system-assigned-managed-identity"></a>1.4.2. Create a GNU/Linux VM with system-assigned managed identity</h4>
<div class="paragraph">
<p>Use the following steps to create an Azure VM with a system-assigned managed identity and prepare it to run the Spring Boot application. For an overview of managed identities for Azure resources, see <a href="/azure/active-directory/managed-identities-azure-resources/overview">What are managed identities for Azure resources?</a>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open a Bash shell.</p>
</li>
<li>
<p>Sign out and delete some authentication files to remove any lingering credentials.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az logout
rm ~/.azure/accessTokens.json
rm ~/.azure/azureProfile.json</code></pre>
</div>
</div>
</li>
<li>
<p>Sign in to your Azure CLI.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az login</code></pre>
</div>
</div>
</li>
<li>
<p>Set the subscription ID. Be sure to replace the placeholder with the appropriate value.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az account set -s &lt;your subscription ID&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Create an Azure resource group. Take note of the resource group name for later use.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az group create \
    --name &lt;your resource group name&gt; \
    --location &lt;your resource group region&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Set default resource group.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az configure --defaults group=&lt;your resource group name&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Create the VM instance with system-assigned managed identity enabled, using the image <code>UbuntuLTS</code> provided by <code>UbuntuServer</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az vm create \
    --name &lt;your VM name&gt; \
    --debug \
    --generate-ssh-keys \
    --assign-identity \
    --image UbuntuLTS \
    --admin-username azureuser</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the JSON output, note down the value of the <code>publicIpAddress</code> and <code>systemAssignedIdentity</code> properties. You&#8217;ll use these values later in the tutorial.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The name <code>UbuntuLTS</code> is a Uniform Resource Name (URN) alias, which is a shortened version created for popular images like <strong>UbuntuLTS</strong>. Run the following command to display a cached list of popular images in table format:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az vm image list --output table</code></pre>
</div>
</div>
</li>
<li>
<p>Install the Microsoft OpenJDK. For complete information about OpenJDK, see [Microsoft Build of OpenJDK](/java/openjdk).</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ssh azureuser@&lt;your VM public IP address&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the repository. Replace the version placeholder in following commands and execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">wget https://packages.microsoft.com/config/ubuntu/{version}/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
sudo dpkg -i packages-microsoft-prod.deb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Install the Microsoft Build of OpenJDK by running the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo apt install apt-transport-https
sudo apt update
sudo apt install msopenjdk-11</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Another, faster way to get set up the certified Azul Zulu for Azure – Enterprise Edition VM image, which can avoid the installation of Azure SDK. For complete information about Azul Zulu for Azure, see <a href="https://www.azul.com/downloads/azure-only/zulu/">Download Java for Azure</a> Run the following command to obtain the URN name.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az vm image list \
    --offer Zulu \
    --location &lt;your region&gt; \
    --all | grep urn</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command may take a while to complete. When the command completes, it produces output similar to the following lines. Select the value for JDK 11 on Ubuntu.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">"urn": "azul:azul-zulu11-ubuntu-2004:zulu-jdk11-ubtu2004:20.11.0",
...
"urn": "azul:azul-zulu8-ubuntu-2004:zulu-jdk8-ubtu2004:20.11.0",
"urn": "azul:azul-zulu8-windows-2019:azul-zulu8-windows2019:20.11.0",</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the following command to accept the terms for the image to allow the VM to be created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az vm image terms accept --urn azul:azul-zulu11-ubuntu-2004:zulu-jdk11-ubtu2004:20.11.0</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="create-and-configure-an-azure-key-vault"><a class="anchor" href="#create-and-configure-an-azure-key-vault"></a>1.4.3. Create and configure an Azure Key Vault</h4>
<div class="paragraph">
<p>Use the following steps to create an Azure Key Vault, and to grant permission for the VM&#8217;s system-assigned managed identity to access the Key Vault for certificates.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create an Azure Key Vault within the resource group.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az keyvault create \
    --name &lt;your Key Vault name&gt; \
    --location &lt;your resource group region&gt;
export KEY_VAULT_URI=$(az keyvault show --name &lt;your Key Vault name&gt; | jq -r '.properties.vaultUri')</code></pre>
</div>
</div>
<div class="paragraph">
<p>Take note of the <code>KEY_VAULT_URI</code> value. You&#8217;ll use it later.</p>
</div>
</li>
<li>
<p>Grant the VM permission to use the Key Vault for certificates.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az keyvault set-policy \
    --name &lt;your Key Vault name&gt; \
    --object-id &lt;your system-assigned identity&gt; \
    --secret-permissions get list \
    --certificate-permissions get list import</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="create-and-store-a-self-signed-tlsssl-certificate"><a class="anchor" href="#create-and-store-a-self-signed-tlsssl-certificate"></a>1.4.4. Create and store a self-signed TLS/SSL certificate</h4>
<div class="paragraph">
<p>The steps in this tutorial apply to any TLS/SSL certificate (including self-signed) stored directly in Azure Key Vault. Self-signed certificates aren&#8217;t suitable for use in production, but are useful for dev and test applications. This tutorial uses a self-signed certificate. To create the certificate, use the following command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az keyvault certificate create \
  –vault-name &lt;your Key Vault name&gt; \
  –name mycert \
  –policy "$(az keyvault certificate get-default-policy)"</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="run-a-spring-boot-application-with-secure-inbound-connections"><a class="anchor" href="#run-a-spring-boot-application-with-secure-inbound-connections"></a>1.4.5. Run a Spring Boot application with secure inbound connections</h4>
<div class="paragraph">
<p>In this section, you&#8217;ll create a Spring Boot starter application where the TLS/SSL certificate for inbound connection comes from Azure Key Vault.</p>
</div>
<div class="paragraph">
<p>To create the application, use the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Browse to <a href="https://start.spring.io/" class="bare">start.spring.io/</a>.</p>
</li>
<li>
<p>Select the choices as shown in the picture following this list.</p>
<div class="ulist">
<ul>
<li>
<p><strong>Project</strong>: <strong>Maven Project</strong></p>
</li>
<li>
<p><strong>Language</strong>: <strong>Java</strong></p>
</li>
<li>
<p><strong>Spring Boot</strong>: <strong>2.5.10</strong></p>
</li>
<li>
<p><strong>Group</strong>: <strong>com.contoso</strong> (You can put any valid Java package name here.)</p>
</li>
<li>
<p><strong>Artifact</strong>: <strong>ssltest</strong> (You can put any valid Java class name here.)</p>
</li>
<li>
<p><strong>Packaging</strong>: <strong>Jar</strong></p>
</li>
<li>
<p><strong>Java</strong>: <strong>11</strong></p>
</li>
</ul>
</div>
</li>
<li>
<p>Select <strong>Add Dependencies&#8230;&#8203;</strong>.</p>
</li>
<li>
<p>In the text field, type <strong>Spring Web</strong> and press Ctrl+Enter.</p>
</li>
<li>
<p>In the text field type <strong>Azure Support</strong> and press Enter. Your screen should look like the following.</p>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/160551580-c39b27ff-ad45-4f8a-8aca-98f1aa0fe8fd.png" alt="Basic Spring Initializr options"></span></p>
</div>
</li>
<li>
<p>At the bottom of the page, select <strong>Generate</strong>.</p>
</li>
<li>
<p>When prompted, download the project to a path on your local computer. This tutorial uses a <strong>ssltest</strong> directory in the current user&#8217;s home directory. The values above will give you an <strong>ssltest.zip</strong> file in that directory.</p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="enable-the-spring-boot-app-to-load-the-tlsssl-certificate"><a class="anchor" href="#enable-the-spring-boot-app-to-load-the-tlsssl-certificate"></a>Enable the Spring Boot app to load the TLS/SSL certificate</h5>
<div class="paragraph">
<p>To enable the app to load the certificate, use the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Unzip the <strong>ssltest.zip</strong> file.</p>
</li>
<li>
<p>Remove the <strong>test</strong> directory and its subdirectories. This tutorial ignores the test, so you can safely delete the directory.</p>
</li>
<li>
<p>Rename <strong>application.properties</strong> in <strong>src/main/resources</strong> to <strong>application.yml</strong>.</p>
</li>
<li>
<p>The file layout will look like the following.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">├── HELP.md
├── mvnw
├── mvnw.cmd
├── pom.xml
└── src
    └── main
        ├── java
        │   └── com
        │       └── contoso
        │           └── ssltest
        │               └── SsltestApplication.java
        └── resources
            ├── application.yml
            ├── static
            └── templates</code></pre>
</div>
</div>
</li>
<li>
<p>Modify the POM to add a dependency on <code>azure-spring-boot-starter-keyvault-certificates</code>. Add the following code to the <code>&lt;dependencies&gt;</code> section of the <strong>pom.xml</strong> file.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">&lt;dependency&gt;
  &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
  &lt;artifactId&gt;azure-spring-boot-starter-keyvault-certificates&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <strong>src/main/resources/application.yml</strong> file so that it has the following contents.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">server:
  ssl:
    key-alias: &lt;the name of the certificate in Azure Key Vault to use&gt;
    key-store-type: AzureKeyVault
    trust-store-type: AzureKeyVault
  port: 8443
azure:
  keyvault:
    uri: &lt;the URI of the Azure Key Vault to use&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>These values enable the Spring Boot app to perform the <strong>load</strong> action for the TLS/SSL certificate, as mentioned at the beginning of the tutorial. The following table describes the property values. Here is explanation of each property:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>server.port|The local TCP port on which to listen for HTTPS connections.</p>
</li>
<li>
<p>server.ssl.key-alias|The value of the <code>--name</code> argument you passed to <code>az keyvault certificate create</code>.</p>
</li>
<li>
<p>server.ssl.key-store-type|Must be <code>AzureKeyVault</code>.</p>
</li>
<li>
<p>server.ssl.trust-store-type|Must be <code>AzureKeyVault</code>.</p>
</li>
<li>
<p>azure.keyvault.uri|The <code>vaultUri</code> property in the return JSON from <code>az keyvault create</code>. You saved this value in an environment variable.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The only property specific to Key Vault is <code>azure.keyvault.uri</code>. The app is running on a VM whose system-assigned managed identity has been granted access to the Key Vault. Therefore, the app has also been granted access.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>These changes enable the Spring Boot app to load the TLS/SSL certificate. In the next section, you&#8217;ll enable the app to perform the <strong>accept</strong> action for the TLS/SSL certificate, as mentioned at the beginning of the tutorial.</p>
</div>
</div>
<div class="sect4">
<h5 id="create-a-spring-boot-rest-controller"><a class="anchor" href="#create-a-spring-boot-rest-controller"></a>Create a Spring Boot REST controller</h5>
<div class="paragraph">
<p>To create the REST controller, use the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Edit the <strong>src/main/java/com/contoso/ssltest/SsltestApplication.java</strong> file so that it has the following contents.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.contoso.ssltest;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@SpringBootApplication
@RestController
public class SsltestApplication {

    public static void main(String[] args) {
        SpringApplication.run(SsltestApplication.class, args);
    }

    @GetMapping(value = "/ssl-test")
    public String inbound(){
        return "Inbound TLS is working!!";
    }

    @GetMapping(value = "/exit")
    public void exit() {
        System.exit(0);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Calling <code>System.exit(0)</code> from within an unauthenticated REST GET call is only for demonstration purposes. Don&#8217;t use <code>System.exit(0)</code> in a real application.</p>
</div>
<div class="paragraph">
<p>This code illustrates the <strong>present</strong> action mentioned at the beginning of this tutorial. The following list highlights some details about this code:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>There&#8217;s now a <code>@RestController</code> annotation on the <code>SsltestApplication</code> class generated by Spring Initializr.</p>
</li>
<li>
<p>There&#8217;s a method annotated with <code>@GetMapping</code>, with a <code>value</code> for the HTTP call you&#8217;ll make.</p>
</li>
<li>
<p>The <code>inbound</code> method simply returns a greeting when a browser makes an HTTPS request to the <code>/ssl-test</code> path. The <code>inbound</code> method illustrates how the server presents the TLS/SSL certificate to the browser.</p>
</li>
<li>
<p>The <code>exit</code> method will cause the JVM to exit when invoked. This method is a convenience to make the sample easy to run in the context of this tutorial.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Open a new Bash shell and navigate to the <strong>ssltest</strong> directory. Run the following command.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn clean package</code></pre>
</div>
</div>
<div class="paragraph">
<p>Maven compiles the code and packages it up into an executable JAR file</p>
</div>
</li>
<li>
<p>Verify that the network security group created within <code>&lt;your resource group name&gt;</code> allows inbound traffic on ports 22 and 8443 from your IP address. To learn about configuring network security group rules to allow inbound traffic, see the [Work with security rules](/azure/virtual-network/manage-network-security-group#work-with-security-rules) section of [Create, change, or delete a network security group](/azure/virtual-network/manage-network-security-group).</p>
</li>
<li>
<p>Put the executable JAR file on the VM.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd target
sftp azureuser@&lt;your VM public IP address&gt;
put *.jar</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="run-the-app-on-the-server"><a class="anchor" href="#run-the-app-on-the-server"></a>Run the app on the server</h5>
<div class="paragraph">
<p>Now that you&#8217;ve built the Spring Boot app and uploaded it to the VM, use the following steps to run it on the VM and call the REST endpoint with curl.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use SSH to connect to the VM, then run the executable jar.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">set -o noglob
ssh azureuser@&lt;your VM public IP address&gt; "java -jar *.jar"</code></pre>
</div>
</div>
</li>
<li>
<p>Open a new Bash shell and execute the following command to verify that the server presents the TLS/SSL certificate.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl --insecure https://&lt;your VM public IP address&gt;:8443/ssl-test</code></pre>
</div>
</div>
</li>
<li>
<p>Invoke the <code>exit</code> path to kill the server and close the network sockets.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl --insecure https://&lt;your VM public IP address&gt;:8443/exit</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now that you&#8217;ve seen the <strong>load</strong> and <strong>present</strong> actions with a self-signed TLS/SSL certificate, you&#8217;ll make some trivial changes to the app to see the <strong>accept</strong> action as well.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="run-a-spring-boot-application-with-secure-outbound-connections"><a class="anchor" href="#run-a-spring-boot-application-with-secure-outbound-connections"></a>1.4.6. Run a Spring Boot application with secure outbound connections</h4>
<div class="paragraph">
<p>In this section, you&#8217;ll modify the code in the previous section so that the TLS/SSL certificate for outbound connection comes from Azure Key Vault. Therefore, the <strong>load</strong>, <strong>present</strong>, and <strong>accept</strong> actions are satisfied from the Azure Key Vault.</p>
</div>
<div class="sect4">
<h5 id="modify-the-ssltestapplication-to-illustrate-outbound-tls-connections"><a class="anchor" href="#modify-the-ssltestapplication-to-illustrate-outbound-tls-connections"></a>Modify the SsltestApplication to illustrate outbound TLS connections</h5>
<div class="paragraph">
<p>Use the following steps to modify the application:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add the dependency on Apache HTTP Client by adding the following code to the <code>&lt;dependencies&gt;</code> section of the <strong>pom.xml</strong> file.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
   &lt;groupId&gt;org.apache.httpcomponents&lt;/groupId&gt;
   &lt;artifactId&gt;httpclient&lt;/artifactId&gt;
   &lt;version&gt;4.5.13&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Add a new rest endpoint called <code>ssl-test-outbound</code>. This endpoint opens up a TLS socket to itself and verifies that the TLS connection accepts the TLS/SSL certificate.</p>
<div class="paragraph">
<p>Replace the contents of <strong>SsltestApplication.java</strong> with the following code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.contoso.ssltest;

import java.security.KeyStore;
import javax.net.ssl.HostnameVerifier;
import javax.net.ssl.SSLContext;
import javax.net.ssl.SSLSession;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import com.azure.security.keyvault.jca.KeyVaultLoadStoreParameter;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.http.client.HttpComponentsClientHttpRequestFactory;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

import org.apache.http.conn.ssl.SSLConnectionSocketFactory;
import org.apache.http.conn.ssl.TrustSelfSignedStrategy;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.ssl.SSLContexts;

@SpringBootApplication
@RestController
public class SsltestApplication {

    public static void main(String[] args) {
        SpringApplication.run(SsltestApplication.class, args);
    }

    @GetMapping(value = "/ssl-test")
    public String inbound(){
        return "Inbound TLS is working!!";
    }

    @GetMapping(value = "/ssl-test-outbound")
    public String outbound() throws Exception {
        KeyStore azureKeyVaultKeyStore = KeyStore.getInstance("AzureKeyVault");
        KeyVaultLoadStoreParameter parameter = new KeyVaultLoadStoreParameter(
            System.getProperty("azure.keyvault.uri"));
        azureKeyVaultKeyStore.load(parameter);
        SSLContext sslContext = SSLContexts.custom()
                                           .loadTrustMaterial(azureKeyVaultKeyStore, null)
                                           .build();

        HostnameVerifier allowAll = (String hostName, SSLSession session) -&gt; true;
        SSLConnectionSocketFactory csf = new SSLConnectionSocketFactory(sslContext, allowAll);

        CloseableHttpClient httpClient = HttpClients.custom()
            .setSSLSocketFactory(csf)
            .build();

        HttpComponentsClientHttpRequestFactory requestFactory =
            new HttpComponentsClientHttpRequestFactory();

        requestFactory.setHttpClient(httpClient);
        RestTemplate restTemplate = new RestTemplate(requestFactory);
        String sslTest = "https://localhost:8443/ssl-test";

        ResponseEntity&lt;String&gt; response
            = restTemplate.getForEntity(sslTest, String.class);

        return "Outbound TLS " +
            (response.getStatusCode() == HttpStatus.OK ? "is" : "is not")  + " Working!!";
    }

    @GetMapping(value = "/exit")
    public void exit() {
        System.exit(0);
    }

}</code></pre>
</div>
</div>
</li>
<li>
<p>Build the app.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd ssltest
mvn clean package</code></pre>
</div>
</div>
</li>
<li>
<p>Upload the app again using the same <code>sftp</code> command from earlier in this article.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd target
sftp &lt;your VM public IP address&gt;
put *.jar</code></pre>
</div>
</div>
</li>
<li>
<p>Run the app on the VM.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">set -o noglob
ssh azureuser@&lt;your VM public IP address&gt; "java -jar *.jar"</code></pre>
</div>
</div>
</li>
<li>
<p>After the server is running, verify that the server accepts the TLS/SSL certificate. In the same Bash shell where you issued the previous <code>curl</code> command, run the following command.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl --insecure https://&lt;your VM public IP address&gt;:8443/ssl-test-outbound</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see the message <code>Outbound TLS is working!!</code>.</p>
</div>
</li>
<li>
<p>Invoke the <code>exit</code> path to kill the server and close the network sockets.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">   curl --insecure https://&lt;your VM public IP address&gt;:8443/exit</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You&#8217;ve now observed a simple illustration of the <strong>load</strong>, <strong>present</strong>, and <strong>accept</strong> actions with a self-signed TLS/SSL certificate stored in Azure Key Vault.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="clean-up-resources-3"><a class="anchor" href="#clean-up-resources-3"></a>1.4.7. Clean up resources</h4>
<div class="paragraph">
<p>When you&#8217;re finished with the Azure resources you created in this tutorial, you can delete them using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az group delete –name &lt;your resource group name&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="azure-service-bus"><a class="anchor" href="#azure-service-bus"></a>1.5. Azure Service Bus</h3>
<div class="paragraph">
<p>This article demonstrates how to use Spring Boot Starter for Azure Service Bus JMS to send messages to and receive messages from Service Bus <code>queues</code> and <code>topics</code>.</p>
</div>
<div class="paragraph">
<p>Azure provides an asynchronous messaging platform called <a href="/azure/service-bus-messaging/service-bus-messaging-overview">Azure Service Bus</a> ("Service Bus") that is based on the <a href="http://www.amqp.org/">Advanced Message Queueing Protocol 1.0</a> ("AMQP 1.0") standard. Service Bus can be used across the range of supported Azure platforms.</p>
</div>
<div class="paragraph">
<p>The Spring Boot Starter for Azure Service Bus JMS provides Spring JMS integration with Service Bus.</p>
</div>
<div class="paragraph">
<p>The following video describes how to integrate Spring JMS applications with Azure Service Bus using JMS 2.0.</p>
</div>
<div class="videoblock">
<div class="content">
<video src="https://www.youtube.com/embed/9O3CALyoZHE?list=PLPeZXlCR7ew8LlhnSH63KcM0XhMKxT1k_" controls>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="sect3">
<h4 id="prerequisites-4"><a class="anchor" href="#prerequisites-4"></a>1.5.1. Prerequisites</h4>
<div class="paragraph">
<p>The following prerequisites are required for this article:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If you don&#8217;t have an <a href="https://docs.microsoft.com/azure/guides/developer/azure-developer-guide#understanding-accounts-subscriptions-and-billing">Azure subscription</a>, create a <a href="https://azure.microsoft.com/free/?ref=microsoft.com&amp;utm_source=microsoft.com&amp;utm_medium=docs&amp;utm_campaign=visualstudio">free account</a> before you begin.</p>
</li>
<li>
<p>A supported Java Development Kit (JDK). For more information, see Java support on <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli">Azure and Azure Stack</a>.</p>
</li>
<li>
<p><a href="https://maven.apache.org/">Apache Maven</a>, version 3.0 or later.</p>
</li>
<li>
<p>If you already have a configured Service Bus queue or topic, ensure that the Service Bus namespace meets the following requirements:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Allows access from all networks</p>
</li>
<li>
<p>Is Premium (or higher)</p>
</li>
<li>
<p>Has an access policy with read/write access for your queue and topic</p>
</li>
</ol>
</div>
</li>
<li>
<p>If you don&#8217;t have a configured Service Bus queue or topic, use the Azure portal to <a href="/azure/service-bus-messaging/service-bus-quickstart-portal">create a Service Bus queue</a> or <a href="/azure/service-bus-messaging/service-bus-quickstart-topics-subscriptions-portal">create a Service Bus topic</a>. Ensure that the namespace meets the requirements specified in the previous step. Also, make note of the connection string in the namespace as you need it for this tutorial&#8217;s test app.</p>
</li>
<li>
<p>If you don&#8217;t have a Spring Boot application, create a <strong>Maven</strong> project with the <a href="https://start.spring.io/">Spring Initializr</a>. Remember to select <strong>Maven Project</strong> and, under <strong>Dependencies</strong>, add the <strong>Web</strong> dependency, select <strong>8</strong> or <strong>11</strong> Java version.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Spring Boot version 2.5 or 2.6 is required to complete the steps in this article.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="use-the-azure-service-bus-jms-starter"><a class="anchor" href="#use-the-azure-service-bus-jms-starter"></a>1.5.2. Use the Azure Service Bus JMS starter</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Locate the <em>pom.xml</em> file in the parent directory of your app; for example: <code>C:\SpringBoot\servicebus\pom.xml</code>.</p>
</li>
<li>
<p>Open the <em>pom.xml</em> file in a text editor.</p>
</li>
<li>
<p>Add the Spring Boot Azure Service Bus JMS starter to the list of <code>&lt;dependencies&gt;</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">    &lt;dependency&gt;
      &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
      &lt;artifactId&gt;spring-cloud-azure-starter-servicebus-jms&lt;/artifactId&gt;
      &lt;version&gt;4.0.0&lt;/version&gt;
    &lt;/dependency&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Save and close the <strong>pom.xml</strong> file.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="configure-the-app-for-your-service-bus"><a class="anchor" href="#configure-the-app-for-your-service-bus"></a>1.5.3. Configure the app for your service bus</h4>
<div class="paragraph">
<p>In this section, you see how to configure your app to use either a Service Bus queue or topic.</p>
</div>
<div class="sect4">
<h5 id="use-a-service-bus-queue"><a class="anchor" href="#use-a-service-bus-queue"></a>Use a Service Bus queue</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Locate the <strong>application.properties</strong> in the <strong>resources</strong> directory of your app; for example:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>C:\SpringBoot\servicebus\application.properties</p>
</li>
<li>
<p>/users/example/home/servicebus/application.properties</p>
</li>
</ol>
</div>
</li>
<li>
<p>Open the <strong>application.properties</strong> file in a text editor.</p>
</li>
<li>
<p>Append the following code to the end of the <strong>application.properties</strong> file. Replace the placeholder values with the appropriate values for your service bus, and do not put quotes around the values.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">spring.jms.servicebus.connection-string=&lt;ServiceBusNamespaceConnectionString&gt;
spring.jms.servicebus.idle-timeout=&lt;IdleTimeout&gt;
spring.jms.servicebus.pricing-tier=&lt;ServiceBusPricingTier&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Field descriptions</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>spring.jms.servicebus.connection-string</code>: Specify the connection string you obtained in your Service Bus namespace from the Azure portal.</p>
</li>
<li>
<p><code>spring.jms.servicebus.idle-timeout</code>: Specify the duration for idle.</p>
</li>
<li>
<p><code>spring.jms.servicebus.pricing-tier</code>: Specify the pricing tier of your service bus. Supported values are <strong>premium</strong>, <strong>standard</strong>, and <strong>basic</strong>. Premium uses Java Message Service (JMS) 2.0, while standard and basic use JMS 1.0 to interact with Azure Service Bus.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Save and close the <strong>application.properties</strong> file.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="use-service-bus-topic"><a class="anchor" href="#use-service-bus-topic"></a>Use Service Bus topic</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Locate the <strong>application.properties</strong> in the <strong>resources</strong> directory of your app; for example:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>C:\SpringBoot\servicebus\application.properties</p>
</li>
<li>
<p>/users/example/home/servicebus/application.properties</p>
</li>
</ol>
</div>
</li>
<li>
<p>Open the <strong>application.properties</strong> file in a text editor.</p>
</li>
<li>
<p>Append the following code to the end of the <strong>application.properties</strong> file. Replace the placeholder values with the appropriate values for your service bus, and do not put quotes around the values.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">spring.jms.servicebus.connection-string=&lt;ServiceBusNamespaceConnectionString&gt;
spring.jms.servicebus.topic-client-id=&lt;ServiceBusSubscriptionID&gt;
spring.jms.servicebus.idle-timeout=&lt;IdleTimeout&gt;
spring.jms.servicebus.pricing-tier=&lt;ServiceBusPricingTier&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Field descriptions</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>spring.jms.servicebus.connection-string</code>: Specify the connection string you obtained in your Service Bus namespace from the Azure portal.</p>
</li>
<li>
<p><code>spring.jms.servicebus.topic-client-id</code>: Specify the JMS client ID, which is your Service Bus Subscription ID in the Azure portal.</p>
</li>
<li>
<p><code>spring.jms.servicebus.idle-timeout</code>: Specify the duration for idle.</p>
</li>
<li>
<p><code>spring.jms.servicebus.pricing-tier</code>: Specify the pricing tier of your service bus. Supported values are <strong>premium</strong>, <strong>standard</strong>, and <strong>basic</strong>. Premium uses Java Message Service (JMS) 2.0, while standard and basic use JMS 1.0 to interact with Azure Service Bus.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Save and close the <strong>application.properties</strong> file.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="implement-basic-service-bus-functionality"><a class="anchor" href="#implement-basic-service-bus-functionality"></a>1.5.4. Implement basic Service Bus functionality</h4>
<div class="paragraph">
<p>In this section, you create the necessary Java classes for sending messages to your Service Bus queue or topic and receive messages from your corresponding queue or topic subscription.</p>
</div>
<div class="sect4">
<h5 id="modify-the-main-application-class"><a class="anchor" href="#modify-the-main-application-class"></a>Modify the main application class</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Locate the main application Java file in the package directory of your app; for example:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>C:\SpringBoot\servicebus\src\main\java\com\wingtiptoys\servicebus\ServiceBusJmsStarterApplication.java</p>
</li>
<li>
<p>/users/example/home/servicebus/src/main/java/com/wingtiptoys/servicebus/ServiceBusJmsStarterApplication.java</p>
</li>
</ol>
</div>
</li>
<li>
<p>Open the main application Java file in a text editor.</p>
</li>
<li>
<p>Add the following code to the file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.wingtiptoys.servicebus;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class ServiceBusJmsStarterApplication {

    public static void main(String[] args) {
        SpringApplication.run(ServiceBusJmsStarterApplication.class, args);
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Save and close the file.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="define-a-test-java-class"><a class="anchor" href="#define-a-test-java-class"></a>Define a test Java class</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Using a text editor, create a Java file named <strong>User.java</strong> in the package directory of your app.</p>
</li>
<li>
<p>Define a generic user class that stores and retrieves user&#8217;s name:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.wingtiptoys.servicebus;

import java.io.Serializable;

// Define a generic User class.
public class User implements Serializable {

    private static final long serialVersionUID = -295422703255886286L;

    private String name;

    public User() {
    }

    public User(String name) {
        setName(name);
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Serializable</code> is implemented to use the <code>send</code> method in <code>JmsTemplate</code> in the Spring framework. Otherwise, a customized <code>MessageConverter</code> bean should be defined to serialize the content to json in text format. For more information about <code>MessageConverter</code>, see the official [Spring JMS starter project](<a href="https://spring.io/guides/gs/messaging-jms/" class="bare">spring.io/guides/gs/messaging-jms/</a>).</p>
</div>
</li>
<li>
<p>Save and close the <strong>User.java</strong> file.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="create-a-new-class-for-the-message-send-controller"><a class="anchor" href="#create-a-new-class-for-the-message-send-controller"></a>Create a new class for the message send controller</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Using a text editor, create a Java file named <strong>SendController.java</strong> in the package directory of your app</p>
</li>
<li>
<p>Add the following code to the new file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.wingtiptoys.servicebus;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jms.core.JmsTemplate;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class SendController {

    private static final String DESTINATION_NAME = "&lt;DestinationName&gt;";

    private static final Logger logger = LoggerFactory.getLogger(SendController.class);

    @Autowired
    private JmsTemplate jmsTemplate;

    @PostMapping("/messages")
    public String postMessage(@RequestParam String message) {
        logger.info("Sending message");
        jmsTemplate.convertAndSend(DESTINATION_NAME, new User(message));
        return message;
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Replace <code>&lt;DestinationName&gt;</code> with your own queue name or topic name configured in your Service Bus namespace.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Save and close the <strong>SendController.java</strong>.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="create-a-class-for-the-message-receive-controller"><a class="anchor" href="#create-a-class-for-the-message-receive-controller"></a>Create a class for the message receive controller</h5>
<div class="sect5">
<h6 id="receive-messages-from-a-service-bus-queue"><a class="anchor" href="#receive-messages-from-a-service-bus-queue"></a>Receive messages from a Service Bus queue</h6>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use a text editor to create a Java file named <strong>QueueReceiveController.java</strong> in the package directory of your app</p>
</li>
<li>
<p>Add the following code to the new file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    package com.wingtiptoys.servicebus;

    import org.slf4j.Logger;
    import org.slf4j.LoggerFactory;
    import org.springframework.jms.annotation.JmsListener;
    import org.springframework.stereotype.Component;

    @Component
    public class QueueReceiveController {

        private static final String QUEUE_NAME = "&lt;ServiceBusQueueName&gt;";

        private final Logger logger = LoggerFactory.getLogger(QueueReceiveController.class);

        @JmsListener(destination = QUEUE_NAME, containerFactory = "jmsListenerContainerFactory")
        public void receiveMessage(User user) {
            logger.info("Received message: {}", user.getName());
        }
    }</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Replace <code>&lt;ServiceBusQueueName&gt;</code> with your own queue name configured in your Service Bus namespace.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Save and close the <strong>QueueReceiveController.java</strong> file.</p>
</li>
</ol>
</div>
</div>
<div class="sect5">
<h6 id="receive-messages-from-a-service-bus-subscription"><a class="anchor" href="#receive-messages-from-a-service-bus-subscription"></a>Receive messages from a Service Bus subscription</h6>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Using a text editor, create a Java file named <strong>TopicReceiveController.java</strong> in the package directory of your app.</p>
</li>
<li>
<p>Add the following code to the new file. Replace the <code>&lt;ServiceBusTopicName&gt;</code> placeholder with your own topic name configured in your Service Bus namespace. Replace the <code>&lt;ServiceBusSubscriptionName&gt;</code> placeholder with your own subscription name for your Service Bus topic.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.wingtiptoys.servicebus;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.jms.annotation.JmsListener;
import org.springframework.stereotype.Component;

@Component
public class TopicReceiveController {

    private static final String TOPIC_NAME = "&lt;ServiceBusTopicName&gt;";

    private static final String SUBSCRIPTION_NAME = "&lt;ServiceBusSubscriptionName&gt;";

    private final Logger logger = LoggerFactory.getLogger(TopicReceiveController.class);

    @JmsListener(destination = TOPIC_NAME, containerFactory = "topicJmsListenerContainerFactory",
            subscription = SUBSCRIPTION_NAME)
    public void receiveMessage(User user) {
        logger.info("Received message: {}", user.getName());
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Save and close the <strong>TopicReceiveController.java</strong> file.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="optional-service-bus-functionality"><a class="anchor" href="#optional-service-bus-functionality"></a>1.5.5. Optional Service Bus Functionality</h4>
<div class="paragraph">
<p>You can use a customized <code>MessageConverter</code> bean to convert between Java objects and JMS messages.</p>
</div>
<div class="sect4">
<h5 id="set-the-content-type-of-messages"><a class="anchor" href="#set-the-content-type-of-messages"></a>Set the content-type of messages</h5>
<div class="paragraph">
<p>The following code example sets the <code>BytesMessage</code> content-type to <code>application/json</code>. For more information, see [Messages, payloads, and serialization](/azure/service-bus-messaging/service-bus-messages-payloads).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.wingtiptoys.servicebus;

import com.fasterxml.jackson.databind.ObjectWriter;
import org.apache.qpid.jms.message.JmsBytesMessage;
import org.apache.qpid.jms.provider.amqp.message.AmqpJmsMessageFacade;
import org.apache.qpid.proton.amqp.Symbol;
import org.springframework.jms.support.converter.MappingJackson2MessageConverter;
import org.springframework.jms.support.converter.MessageType;
import org.springframework.stereotype.Component;

import javax.jms.BytesMessage;
import javax.jms.JMSException;
import javax.jms.Session;
import java.io.IOException;

@Component
public class CustomMessageConverter extends MappingJackson2MessageConverter {

    private static final String TYPE_ID_PROPERTY = "_type";
    private static final Symbol CONTENT_TYPE = Symbol.valueOf("application/json");

    public CustomMessageConverter() {
        this.setTargetType(MessageType.BYTES);
        this.setTypeIdPropertyName(TYPE_ID_PROPERTY);
    }

    @Override
    protected BytesMessage mapToBytesMessage(Object object, Session session, ObjectWriter objectWriter)
        throws JMSException, IOException {
        final BytesMessage bytesMessage = super.mapToBytesMessage(object, session, objectWriter);
        JmsBytesMessage jmsBytesMessage = (JmsBytesMessage) bytesMessage;
        AmqpJmsMessageFacade facade = (AmqpJmsMessageFacade) jmsBytesMessage.getFacade();
        facade.setContentType(CONTENT_TYPE);
        return jmsBytesMessage;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information about <code>MessageConverter</code>, see the official <a href="https://spring.io/guides/gs/messaging-jms/">Spring JMS guide</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="set-session-id-in-jmstemplate"><a class="anchor" href="#set-session-id-in-jmstemplate"></a>Set session-id in JmsTemplate</h5>
<div class="paragraph">
<p>Entities that have session support enabled, such as a session-enabled Service Bus queue, can only receive messages that have the <code>SessionId</code> set to a valid value. To send messages to such entities, use the <code>JmsTemplate.convertAndSend</code> method to set the string property "JMSXGroupID", which is mapped to the <code>SessionId</code> property, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@RestController
public class QueueSendController {

    private static final String QUEUE_NAME = "&lt;DestinationName&gt;";
    private static final Logger LOGGER = LoggerFactory.getLogger(QueueSendController.class);

    @Autowired
    private JmsTemplate jmsTemplate;

    @PostMapping("/queue")
    public String postMessage(@RequestParam String message) {

        LOGGER.info("Sending message");

        jmsTemplate.convertAndSend(QUEUE_NAME, new User(message), jmsMessage -&gt; {
            jmsMessage.setStringProperty("JMSXGroupID", "xxxeee");
            return jmsMessage;
        });
        return message;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="build-and-test-your-application"><a class="anchor" href="#build-and-test-your-application"></a>1.5.6. Build and test your application</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open a command prompt and change directory to the location of your <em>pom.xml</em>; for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd C:\SpringBoot\servicebus</code></pre>
</div>
</div>
</li>
<li>
<p>Build your Spring Boot application with Maven and run it:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn clean spring-boot:run</code></pre>
</div>
</div>
</li>
<li>
<p>Once your application is running, you can use <em>curl</em> to test your application:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -X POST localhost:8080/messages?message=hello</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="clean-up-resources-4"><a class="anchor" href="#clean-up-resources-4"></a>1.5.7. Clean up resources</h4>
<div class="paragraph">
<p>When no longer needed, use the <a href="https://portal.azure.com/">Azure portal</a> to delete the resources created in this article to avoid unexpected charges.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-data"><a class="anchor" href="#spring-data"></a>2. Spring Data</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TODO: finish this content.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-security"><a class="anchor" href="#spring-security"></a>3. Spring Security</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TODO: finish this content.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-cloud"><a class="anchor" href="#spring-cloud"></a>4. Spring Cloud</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TODO: finish this content.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="azure-app-configuration"><a class="anchor" href="#azure-app-configuration"></a>5. Azure App Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TODO: finish this content.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-03-31 16:15:57 UTC
</div>
</div>
<script src="js/highlight/highlight.min.js"></script>
<script>
if (!hljs.initHighlighting.called) {
  hljs.initHighlighting.called = true
  ;[].slice.call(document.querySelectorAll('pre.highlight > code')).forEach(function (el) { hljs.highlightBlock(el) })
}
</script>
<script type="text/javascript" src="js/tocbot/tocbot.min.js"></script>
<script type="text/javascript" src="js/toc.js"></script>
</body>
</html>