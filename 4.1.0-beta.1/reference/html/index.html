<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>Spring Cloud Azure</title>
<link rel="stylesheet" href="css/spring.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<script type="text/javascript"> (function(c,l,a,r,i,t,y){ c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)}; t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i; y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y); })(window, document, "clarity", "script", "b9g1q6wz23"); </script>

<style>
.hidden {
	display: none;
}

.switch {
	border-width: 1px 1px 0 1px;
	border-style: solid;
	border-color: #7a2518;
	display: inline-block;
}

.switch--item {
	padding: 10px;
	background-color: #ffffff;
	color: #7a2518;
	display: inline-block;
	cursor: pointer;
}

.switch--item:not(:first-child) {
	border-width: 0 0 0 1px;
	border-style: solid;
	border-color: #7a2518;
}

.switch--item.selected {
	background-color: #7a2519;
	color: #ffffff;
}

</style>
<script type="text/javascript">
function addBlockSwitches() {
	for (var primary of document.querySelectorAll('.primary')) {
		var switchItem = createSwitchItem(primary, createBlockSwitch(primary));
		switchItem.item.classList.add("selected");
		var title = primary.querySelector('.title')
		title.remove();
	}
	for (var secondary of document.querySelectorAll('.secondary')) {
		var primary = findPrimary(secondary);
		if (primary === null) {
			console.error("Found secondary block with no primary sibling");
		}
		else {
			var switchItem = createSwitchItem(secondary, primary.querySelector('.switch'));
			switchItem.content.classList.add("hidden");
			primary.append(switchItem.content);
			secondary.remove();
		}
	}
}

function createElementFromHtml(html) {
	var template = document.createElement('template');
    template.innerHTML = html;
    return template.content.firstChild;
}

function createBlockSwitch(primary) {
    var blockSwitch = createElementFromHtml('<div class="switch"></div>');
    primary.prepend(blockSwitch)
	return blockSwitch;
}

function findPrimary(secondary) {
	var candidate = secondary.previousElementSibling;
	while (candidate != null && !candidate.classList.contains('primary')) {
		candidate = candidate.previousElementSibling;
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	var blockName = block.querySelector('.title').textContent;
	var content = block.querySelectorAll('.content').item(0);
	var colist = nextSibling(block, '.colist');
	if (colist != null) {
		content.append(colist);
	}
	var item = createElementFromHtml('<div class="switch--item">' + blockName + '</div>');
	item.dataset.blockName = blockName;
	content.dataset.blockName = blockName;
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

function nextSibling(element, selector) {
	var sibling = element.nextElementSibling;
	while (sibling) {
		if (sibling.matches(selector)) {
			return sibling;
		}
		sibling = sibling.nextElementSibling;
	}
}

function globalSwitch() {
	document.querySelectorAll(".switch--item").forEach(function(item) {
		var blockId = blockIdForSwitchItem(item);
		var handler = function(event) {
			selectedText = event.target.textContent;
			window.localStorage.setItem(blockId, selectedText);
			for (var switchItem of document.querySelectorAll(".switch--item")) {
				if (blockIdForSwitchItem(switchItem) === blockId && switchItem.textContent === selectedText) {
					select(switchItem);
				}
			}
		}
		item.addEventListener("click", handler);
		if (item.textContent === window.localStorage.getItem(blockId)) {
			select(item);
		}
	});
}

function select(selected) {
	for (var child of selected.parentNode.children) {
		child.classList.remove("selected");
	}
	selected.classList.add("selected");
	for (var child of selected.parentNode.parentNode.children) {
		if (child.classList.contains("content")) {
			if (selected.dataset.blockName === child.dataset.blockName) {
				child.classList.remove("hidden");
			}
			else {
				child.classList.add("hidden");
			}
		}
	}	
}

function blockIdForSwitchItem(item) {
	idComponents = []
	for (var switchItem of item.parentNode.querySelectorAll(".switch--item")) {
		idComponents.push(switchItem.textContent.toLowerCase());
	}
	return idComponents.sort().join("-")
}

window.onload = function() {
	addBlockSwitches();
	globalSwitch();
};

</script>

</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Spring Cloud Azure</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#getting-started-guides">Getting Started Guides</a>
<ul class="sectlevel1">
<li><a href="#spring-boot">1. Spring Boot</a>
<ul class="sectlevel2">
<li><a href="#spring-boot-2">1.1. Spring Boot</a>
<ul class="sectlevel3">
<li><a href="#azure-support">1.1.1. Azure Support</a></li>
<li><a href="#azure-active-directory">1.1.2. Azure Active Directory</a></li>
<li><a href="#azure-key-vault">1.1.3. Azure Key Vault</a></li>
<li><a href="#azure-storage">1.1.4. Azure Storage</a></li>
<li><a href="#application-insights">1.1.5. Application Insights</a></li>
</ul>
</li>
<li><a href="#azure-storage-2">1.2. Azure Storage</a>
<ul class="sectlevel3">
<li><a href="#prerequisites">1.2.1. Prerequisites</a></li>
<li><a href="#create-an-azure-storage-account-and-blob-container-for-your-application">1.2.2. Create an Azure Storage Account and blob container for your application</a></li>
<li><a href="#create-a-simple-spring-boot-application-with-the-spring-initializr">1.2.3. Create a simple Spring Boot application with the Spring Initializr</a></li>
<li><a href="#configure-your-spring-boot-app-to-use-the-azure-storage-blob-starter">1.2.4. Configure your Spring Boot app to use the Azure Storage Blob starter</a>
<ul class="sectlevel4">
<li><a href="#add-dependency-in-pom-xml">Add dependency in pom.xml</a></li>
<li><a href="#configure-property-in-application-yml">Configure property in application.yml</a></li>
</ul>
</li>
<li><a href="#add-sample-code-to-implement-basic-azure-storage-functionality">1.2.5. Add sample code to implement basic Azure storage functionality</a>
<ul class="sectlevel4">
<li><a href="#add-a-blob-controller-class">Add a blob controller class</a></li>
</ul>
</li>
<li><a href="#summary">1.2.6. Summary</a></li>
<li><a href="#clean-up-resources">1.2.7. Clean up resources</a></li>
</ul>
</li>
<li><a href="#azure-key-vault-secrets">1.3. Azure Key Vault Secrets</a>
<ul class="sectlevel3">
<li><a href="#prerequisites-2">1.3.1. Prerequisites</a></li>
<li><a href="#create-a-new-azure-key-vault">1.3.2. Create a new Azure Key Vault</a>
<ul class="sectlevel4">
<li><a href="#sign-in-to-azure-and-set-your-subscription">Sign in to Azure and set your subscription</a></li>
<li><a href="#create-a-service-principal">Create a service principal</a></li>
<li><a href="#create-the-key-vault-instance">Create the Key Vault instance</a></li>
</ul>
</li>
<li><a href="#create-the-app-with-spring-initializr">1.3.3. Create the app with Spring Initializr</a></li>
<li><a href="#create-the-app-without-spring-initializr">1.3.4. Create the app without Spring Initializr</a></li>
<li><a href="#add-key-vault-configuration-to-the-app">1.3.5. Add Key Vault configuration to the app</a></li>
<li><a href="#deploy-to-azure-app-service">1.3.6. Deploy to Azure App Service</a></li>
<li><a href="#redeploy-to-azure-app-service-and-use-managed-identities-for-azure-resources">1.3.7. Redeploy to Azure App Service and use managed identities for Azure resources</a></li>
<li><a href="#deploy-to-azure-spring-cloud">1.3.8. Deploy to Azure Spring Cloud</a></li>
<li><a href="#summary-2">1.3.9. Summary</a></li>
<li><a href="#clean-up-resources-2">1.3.10. Clean up resources</a></li>
</ul>
</li>
<li><a href="#azure-key-vault-certificates">1.4. Azure Key Vault certificates</a>
<ul class="sectlevel3">
<li><a href="#prerequisites-3">1.4.1. Prerequisites</a></li>
<li><a href="#create-a-gnulinux-vm-with-system-assigned-managed-identity">1.4.2. Create a GNU/Linux VM with system-assigned managed identity</a></li>
<li><a href="#create-and-configure-an-azure-key-vault">1.4.3. Create and configure an Azure Key Vault</a></li>
<li><a href="#create-and-store-a-self-signed-tlsssl-certificate">1.4.4. Create and store a self-signed TLS/SSL certificate</a></li>
<li><a href="#run-a-spring-boot-application-with-secure-inbound-connections">1.4.5. Run a Spring Boot application with secure inbound connections</a>
<ul class="sectlevel4">
<li><a href="#enable-the-spring-boot-app-to-load-the-tlsssl-certificate">Enable the Spring Boot app to load the TLS/SSL certificate</a></li>
<li><a href="#create-a-spring-boot-rest-controller">Create a Spring Boot REST controller</a></li>
<li><a href="#run-the-app-on-the-server">Run the app on the server</a></li>
</ul>
</li>
<li><a href="#run-a-spring-boot-application-with-secure-outbound-connections">1.4.6. Run a Spring Boot application with secure outbound connections</a>
<ul class="sectlevel4">
<li><a href="#modify-the-ssltestapplication-to-illustrate-outbound-tls-connections">Modify the SsltestApplication to illustrate outbound TLS connections</a></li>
</ul>
</li>
<li><a href="#clean-up-resources-3">1.4.7. Clean up resources</a></li>
</ul>
</li>
<li><a href="#azure-service-bus">1.5. Azure Service Bus</a>
<ul class="sectlevel3">
<li><a href="#prerequisites-4">1.5.1. Prerequisites</a></li>
<li><a href="#use-the-azure-service-bus-jms-starter">1.5.2. Use the Azure Service Bus JMS starter</a></li>
<li><a href="#configure-the-app-for-your-service-bus">1.5.3. Configure the app for your service bus</a>
<ul class="sectlevel4">
<li><a href="#use-a-service-bus-queue">Use a Service Bus queue</a></li>
<li><a href="#use-service-bus-topic">Use Service Bus topic</a></li>
</ul>
</li>
<li><a href="#implement-basic-service-bus-functionality">1.5.4. Implement basic Service Bus functionality</a>
<ul class="sectlevel4">
<li><a href="#modify-the-main-application-class">Modify the main application class</a></li>
<li><a href="#define-a-test-java-class">Define a test Java class</a></li>
<li><a href="#create-a-new-class-for-the-message-send-controller">Create a new class for the message send controller</a></li>
<li><a href="#create-a-class-for-the-message-receive-controller">Create a class for the message receive controller</a></li>
</ul>
</li>
<li><a href="#optional-service-bus-functionality">1.5.5. Optional Service Bus Functionality</a>
<ul class="sectlevel4">
<li><a href="#set-the-content-type-of-messages">Set the content-type of messages</a></li>
<li><a href="#set-session-id-in-jmstemplate">Set session-id in JmsTemplate</a></li>
</ul>
</li>
<li><a href="#build-and-test-your-application">1.5.6. Build and test your application</a></li>
<li><a href="#clean-up-resources-4">1.5.7. Clean up resources</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#spring-data">2. Spring Data</a></li>
<li><a href="#spring-security">3. Spring Security</a></li>
<li><a href="#spring-cloud">4. Spring Cloud</a></li>
<li><a href="#azure-app-configuration">5. Azure App Configuration</a></li>
</ul>
</li>
<li><a href="#tutorials">Tutorials</a>
<ul class="sectlevel1">
<li><a href="#deploy-to-app-service-and-azure-spring-cloud">6. Deploy to App Service and Azure Spring Cloud</a></li>
<li><a href="#deploy-to-kubernetes">7. Deploy to Kubernetes</a></li>
<li><a href="#deploy-to-web-app-for-containers">8. Deploy to Web App for Containers</a></li>
<li><a href="#azure-redis-cache">9. Azure Redis Cache</a></li>
<li><a href="#end-to-end-app-service-with-mysql">10. End-to-end App Service with MySQL</a></li>
</ul>
</li>
<li><a href="#sample">Sample</a>
<ul class="sectlevel1">
<li><a href="#to-do-list-with-cosmos-db">11. To Do List with Cosmos DB</a></li>
<li><a href="#to-do-list-with-mysql">12. To Do List with MySQL</a></li>
<li><a href="#spring-initializr">13. Spring Initializr</a></li>
</ul>
</li>
<li><a href="#reference">Reference</a>
<ul class="sectlevel1">
<li><a href="#getting-help">14. Getting Help</a></li>
<li><a href="#what-is-new-in-4-0-since-3-10-x">15. What Is New in 4.0 Since 3.10.x</a>
<ul class="sectlevel2">
<li><a href="#unified-development-experience">15.1. Unified Development Experience</a></li>
<li><a href="#simplified-dependency-management">15.2. Simplified Dependency Management</a></li>
<li><a href="#expanded-support-scope-of-azure-support-on-start-spring-io">15.3. Expanded Support Scope of Azure Support on start.spring.io</a></li>
<li><a href="#untethered-and-unrestrained">15.4. Untethered and Unrestrained</a></li>
<li><a href="#more-control-and-secure">15.5. More Control and Secure</a></li>
<li><a href="#more-options-exposed-in-a-spring-idiomatic-way">15.6. More Options Exposed in a Spring Idiomatic Way</a></li>
<li><a href="#more-production-ready">15.7. More Production Ready</a></li>
</ul>
</li>
<li><a href="#migration-guide-for-4-0">16. Migration Guide for 4.0</a></li>
<li><a href="#getting-started">17. Getting Started</a>
<ul class="sectlevel2">
<li><a href="#setting-up-dependencies">17.1. Setting up Dependencies</a>
<ul class="sectlevel3">
<li><a href="#bill-of-material-bom">17.1.1. Bill of Material (BOM)</a></li>
<li><a href="#starter-dependencies">17.1.2. Starter Dependencies</a></li>
</ul>
</li>
<li><a href="#learning-spring-cloud-azure">17.2. Learning Spring Cloud Azure</a></li>
</ul>
</li>
<li><a href="#configuration">18. Configuration</a></li>
<li><a href="#authentication">19. Authentication</a>
<ul class="sectlevel2">
<li><a href="#defaultazurecredential">19.1. DefaultAzureCredential</a></li>
<li><a href="#managed-identities">19.2. Managed Identities</a>
<ul class="sectlevel3">
<li><a href="#managed-identity-types">19.2.1. Managed Identity Types</a></li>
</ul>
</li>
<li><a href="#other-credential-types">19.3. Other Credential Types</a>
<ul class="sectlevel3">
<li><a href="#authentication-and-authorization-with-azure-active-directory">19.3.1. Authentication and Authorization with Azure Active Directory</a>
<ul class="sectlevel4">
<li><a href="#authenticate-with-azure-active-directory">Authenticate with Azure Active Directory</a></li>
<li><a href="#authorize-access-with-azure-active-directory">Authorize Access with Azure Active Directory</a></li>
</ul>
</li>
<li><a href="#sas-tokens">19.3.2. SAS tokens</a></li>
<li><a href="#connection-strings">19.3.3. Connection Strings</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#production-ready">20. Production Ready</a>
<ul class="sectlevel2">
<li><a href="#enable-health-indicator">20.1. Enable Health Indicator</a></li>
<li><a href="#enable-sleuth">20.2. Enable Sleuth</a></li>
</ul>
</li>
<li><a href="#autoconfigure-azure-sdk-clients">21. Autoconfigure Azure SDK Clients</a>
<ul class="sectlevel2">
<li><a href="#dependency-setup">21.1. Dependency Setup</a></li>
<li><a href="#configuration-2">21.2. Configuration</a></li>
<li><a href="#basic-usage">21.3. Basic Usage</a></li>
<li><a href="#samples">21.4. Samples</a></li>
</ul>
</li>
<li><a href="#resource-handling">22. Resource Handling</a>
<ul class="sectlevel2">
<li><a href="#dependency-setup-2">22.1. Dependency Setup</a></li>
<li><a href="#configuration-3">22.2. Configuration</a></li>
<li><a href="#basic-usage-2">22.3. Basic Usage</a>
<ul class="sectlevel3">
<li><a href="#get-a-resource">22.3.1. Get a Resource</a>
<ul class="sectlevel4">
<li><a href="#get-a-resource-with-value">Get a Resource with @Value</a></li>
<li><a href="#get-a-resource-with-resourceloader">Get a Resource with ResourceLoader</a></li>
<li><a href="#get-resources-by-searching-pattern">Get Resources by Searching Pattern</a></li>
</ul>
</li>
<li><a href="#handling-with-resource">22.3.2. Handling with Resource</a>
<ul class="sectlevel4">
<li><a href="#download-data-from-specific-resource">Download Data from Specific Resource</a></li>
<li><a href="#upload-data-to-specific-resource">Upload Data to Specific Resource</a></li>
</ul>
</li>
<li><a href="#multipart-upload">22.3.3. Multipart Upload</a></li>
</ul>
</li>
<li><a href="#samples-2">22.4. Samples</a></li>
</ul>
</li>
<li><a href="#secret-management">23. Secret Management</a>
<ul class="sectlevel2">
<li><a href="#dependency-setup-3">23.1. Dependency Setup</a></li>
<li><a href="#basic-usage-3">23.2. Basic Usage</a>
<ul class="sectlevel3">
<li><a href="#configuration-properties">23.2.1. Configuration Properties</a></li>
<li><a href="#java-code">23.2.2. Java Code</a></li>
</ul>
</li>
<li><a href="#advanced-usage">23.3. Advanced Usage</a>
<ul class="sectlevel3">
<li><a href="#special-characters-in-property-name">23.3.1. Special Characters in Property Name</a></li>
<li><a href="#case-sensitive">23.3.2. Case Sensitive</a></li>
<li><a href="#not-retrieve-all-secrets-in-key-vault">23.3.3. Not Retrieve All Secrets In Key Vault</a></li>
<li><a href="#setting-refresh-interval">23.3.4. Setting Refresh Interval</a></li>
<li><a href="#propertysource-priority">23.3.5. PropertySource Priority</a></li>
<li><a href="#all-configurable-properties">23.3.6. All Configurable Properties</a></li>
</ul>
</li>
<li><a href="#samples-3">23.4. Samples</a></li>
</ul>
</li>
<li><a href="#spring-data-support">24. Spring Data Support</a>
<ul class="sectlevel2">
<li><a href="#spring-data-cosmosdb-support">24.1. Spring Data CosmosDB Support</a></li>
<li><a href="#dependency-setup-4">24.2. Dependency Setup</a></li>
<li><a href="#configuration-4">24.3. Configuration</a></li>
<li><a href="#key-concepts">24.4. Key Concepts</a></li>
<li><a href="#basic-usage-4">24.5. Basic Usage</a>
<ul class="sectlevel3">
<li><a href="#use-private-key-to-access-cosmosdb">24.5.1. Use Private Key to Access CosmosDB</a></li>
<li><a href="#define-an-entity">24.5.2. Define an Entity</a></li>
<li><a href="#create-repositories">24.5.3. Create Repositories</a></li>
<li><a href="#create-an-application-class">24.5.4. Create an Application Class</a></li>
</ul>
</li>
<li><a href="#samples-4">24.6. Samples</a></li>
</ul>
</li>
<li><a href="#spring-security-support">25. Spring Security Support</a>
<ul class="sectlevel2">
<li><a href="#spring-security-with-azure-active-directory">25.1. Spring Security With Azure Active Directory</a>
<ul class="sectlevel3">
<li><a href="#accessing-a-web-application">25.1.1. Accessing a Web Application</a>
<ul class="sectlevel4">
<li><a href="#system-diagram">System Diagram</a></li>
<li><a href="#create-required-resources-in-azure">Create Required Resources in Azure</a></li>
<li><a href="#add-required-dependencies">Add Required Dependencies</a></li>
<li><a href="#add-required-properties">Add Required Properties</a></li>
<li><a href="#advanced-usages">Advanced Usages</a></li>
<li><a href="#samples-5">Samples</a></li>
</ul>
</li>
<li><a href="#web-application-accessing-resource-servers">25.1.2. Web Application Accessing Resource Servers</a>
<ul class="sectlevel4">
<li><a href="#system-diagram-2">System Diagram</a></li>
<li><a href="#create-required-resources-in-azure-2">Create Required Resources in Azure</a></li>
<li><a href="#add-required-dependencies-2">Add Required Dependencies</a></li>
<li><a href="#add-required-properties-2">Add Required Properties</a></li>
<li><a href="#use-oauth2authorizedclient-in-your-application">Use OAuth2AuthorizedClient in Your Application</a></li>
<li><a href="#advanced-usages-2">Advanced Usages</a></li>
<li><a href="#samples-6">Samples</a></li>
</ul>
</li>
<li><a href="#accessing-a-resource-server">25.1.3. Accessing a Resource Server</a>
<ul class="sectlevel4">
<li><a href="#system-diagram-3">System Diagram</a></li>
<li><a href="#create-required-resources-in-azure-3">Create Required Resources in Azure</a></li>
<li><a href="#add-required-dependencies-3">Add Required Dependencies</a></li>
<li><a href="#add-required-properties-3">Add Required Properties</a></li>
<li><a href="#advanced-usages-3">Advanced Usages</a></li>
<li><a href="#samples-7">Samples</a></li>
</ul>
</li>
<li><a href="#resource-server-visiting-other-resource-servers">25.1.4. Resource Server Visiting Other Resource Servers</a>
<ul class="sectlevel4">
<li><a href="#system-diagram-4">System Diagram</a></li>
<li><a href="#create-required-resources-in-azure-4">Create Required Resources in Azure</a></li>
<li><a href="#add-required-dependencies-4">Add Required Dependencies</a></li>
<li><a href="#add-required-properties-4">Add Required Properties</a></li>
<li><a href="#use-oauth2authorizedclient-in-your-application-2">Use OAuth2AuthorizedClient in Your Application</a></li>
<li><a href="#samples-8">Samples</a></li>
</ul>
</li>
<li><a href="#web-application-and-resource-server-in-one-application">25.1.5. Web Application and Resource Server in One Application</a>
<ul class="sectlevel4">
<li><a href="#create-required-resources-in-azure-5">Create Required Resources in Azure</a></li>
<li><a href="#add-required-dependencies-5">Add Required Dependencies</a></li>
<li><a href="#add-required-properties-5">Add Required Properties</a></li>
<li><a href="#define-securityconfigurationadapter">Define SecurityConfigurationAdapter</a></li>
</ul>
</li>
<li><a href="#configuration-5">25.1.6. Configuration</a>
<ul class="sectlevel4">
<li><a href="#application-type">Application Type</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#spring-security-with-azure-active-directory-b2c">25.2. Spring Security With Azure Active Directory B2C</a>
<ul class="sectlevel3">
<li><a href="#dependency-setup-5">25.2.1. Dependency Setup</a></li>
<li><a href="#configuration-6">25.2.2. Configuration</a></li>
<li><a href="#basic-usage-5">25.2.3. Basic Usage</a>
<ul class="sectlevel4">
<li><a href="#usage-1-accessing-a-web-application">Usage 1: Accessing a Web Application</a></li>
<li><a href="#usage-2-web-application-accessing-resource-servers">Usage 2: Web Application Accessing Resource Servers</a></li>
<li><a href="#usage-3-accessing-a-resource-server">Usage 3: Accessing a Resource Server</a></li>
<li><a href="#usage-4-resource-server-accessing-other-resource-servers">Usage 4: Resource Server Accessing Other Resource Servers</a></li>
</ul>
</li>
<li><a href="#samples-9">25.2.4. Samples</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#spring-integration-support">26. Spring Integration Support</a>
<ul class="sectlevel2">
<li><a href="#spring-integration-with-azure-event-hubs">26.1. Spring Integration with Azure Event Hubs</a>
<ul class="sectlevel3">
<li><a href="#key-concepts-2">26.1.1. Key Concepts</a>
<ul class="sectlevel4">
<li><a href="#consumer-group">Consumer Group</a></li>
<li><a href="#partitioning-support">Partitioning Support</a></li>
<li><a href="#batch-consumer-support">Batch Consumer Support</a></li>
</ul>
</li>
<li><a href="#dependency-setup-6">26.1.2. Dependency Setup</a></li>
<li><a href="#configuration-7">26.1.3. Configuration</a>
<ul class="sectlevel4">
<li><a href="#connection-configuration-properties">Connection Configuration Properties</a></li>
<li><a href="#checkpoint-configuration-properties">Checkpoint Configuration Properties</a></li>
<li><a href="#event-hub-processor-configuration-properties">Event Hub Processor Configuration Properties</a></li>
</ul>
</li>
<li><a href="#basic-usage-6">26.1.4. Basic Usage</a>
<ul class="sectlevel4">
<li><a href="#send-messages-to-azure-event-hubs">Send messages to Azure Event Hubs</a></li>
<li><a href="#receive-from-eh">Receive Messages from Azure Event Hubs</a></li>
<li><a href="#configure-eventhubsmessageconverter-to-customize-objectmapper">Configure EventHubsMessageConverter to Customize ObjectMapper</a></li>
<li><a href="#si-eh-batch">Batch Consumer Support</a></li>
<li><a href="#si-eh-headers">Event Hubs Message Headers</a></li>
</ul>
</li>
<li><a href="#samples-10">26.1.5. Samples</a></li>
</ul>
</li>
<li><a href="#spring-integration-with-azure-service-bus">26.2. Spring Integration with Azure Service Bus</a>
<ul class="sectlevel3">
<li><a href="#key-concepts-3">26.2.1. Key Concepts</a></li>
<li><a href="#dependency-setup-7">26.2.2. Dependency Setup</a></li>
<li><a href="#configuration-8">26.2.3. Configuration</a>
<ul class="sectlevel4">
<li><a href="#connection-configuration-properties-2">Connection Configuration Properties</a></li>
<li><a href="#service-bus-processor-configuration-properties">Service Bus Processor Configuration Properties</a></li>
</ul>
</li>
<li><a href="#basic-usage-7">26.2.4. Basic Usage</a>
<ul class="sectlevel4">
<li><a href="#send-messages-to-azure-service-bus">Send Messages to Azure Service Bus</a></li>
<li><a href="#receive-from-sb">Receive Messages from Azure Service Bus</a></li>
<li><a href="#configure-servicebusmessageconverter-to-customize-objectmapper">Configure ServiceBusMessageConverter to Customize ObjectMapper</a></li>
<li><a href="#si-sb-headers">Service Bus Message Headers</a></li>
<li><a href="#partition-key-support">Partition Key Support</a></li>
<li><a href="#session-support">Session Support</a></li>
</ul>
</li>
<li><a href="#samples-11">26.2.5. Samples</a></li>
</ul>
</li>
<li><a href="#spring-integration-with-azure-storage-queue">26.3. Spring Integration with Azure Storage Queue</a>
<ul class="sectlevel3">
<li><a href="#key-concepts-4">26.3.1. Key Concepts</a></li>
<li><a href="#dependency-setup-8">26.3.2. Dependency Setup</a></li>
<li><a href="#configuration-9">26.3.3. Configuration</a>
<ul class="sectlevel4">
<li><a href="#connection-configuration-properties-3">Connection Configuration Properties</a></li>
</ul>
</li>
<li><a href="#basic-usage-8">26.3.4. Basic Usage</a>
<ul class="sectlevel4">
<li><a href="#send-messages-to-azure-storage-queue">Send messages to Azure Storage Queue</a></li>
<li><a href="#receive-messages-from-azure-storage-queue">Receive Messages from Azure Storage Queue</a></li>
</ul>
</li>
<li><a href="#samples-12">26.3.5. Samples</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#spring-cloud-stream-support">27. Spring Cloud Stream Support</a>
<ul class="sectlevel2">
<li><a href="#spring-cloud-stream-binder-for-azure-event-hubs">27.1. Spring Cloud Stream Binder for Azure Event Hubs</a>
<ul class="sectlevel3">
<li><a href="#key-concepts-5">27.1.1. Key Concepts</a>
<ul class="sectlevel4">
<li><a href="#consumer-group-2">Consumer Group</a></li>
<li><a href="#partitioning-support-2">Partitioning Support</a></li>
<li><a href="#batch-consumer-support-2">Batch Consumer Support</a></li>
</ul>
</li>
<li><a href="#dependency-setup-9">27.1.2. Dependency Setup</a></li>
<li><a href="#configuration-10">27.1.3. Configuration</a>
<ul class="sectlevel4">
<li><a href="#eventhubs-connection-configuration">Connection Configuration Properties</a></li>
<li><a href="#checkpoint-configuration-properties-2">Checkpoint Configuration Properties</a></li>
<li><a href="#azure-event-hubs-binding-configuration-properties">Azure Event Hubs Binding Configuration Properties</a></li>
</ul>
</li>
<li><a href="#basic-usage-9">27.1.4. Basic Usage</a>
<ul class="sectlevel4">
<li><a href="#sending-and-receiving-messages-fromto-event-hubs">Sending and Receiving Messages from/to Event Hubs</a></li>
<li><a href="#partitioning-support-3">Partitioning Support</a></li>
<li><a href="#batch-consumer-support-3">Batch Consumer Support</a></li>
<li><a href="#error-channels">Error Channels</a></li>
<li><a href="#scs-eh-headers">Event Hubs Message Headers</a></li>
<li><a href="#multiple-binder-support">Multiple Binder Support</a></li>
<li><a href="#resource-provision">Resource Provision</a></li>
</ul>
</li>
<li><a href="#samples-13">27.1.5. Samples</a></li>
</ul>
</li>
<li><a href="#spring-cloud-stream-binder-for-azure-service-bus">27.2. Spring Cloud Stream Binder for Azure Service Bus</a>
<ul class="sectlevel3">
<li><a href="#key-concepts-6">27.2.1. Key Concepts</a>
<ul class="sectlevel4">
<li><a href="#scheduled-message">Scheduled Message</a></li>
<li><a href="#consumer-group-3">Consumer Group</a></li>
</ul>
</li>
<li><a href="#dependency-setup-10">27.2.2. Dependency Setup</a></li>
<li><a href="#configuration-11">27.2.3. Configuration</a>
<ul class="sectlevel4">
<li><a href="#servicebus-connection-configuration">Connection Configuration Properties</a></li>
<li><a href="#azure-service-bus-binding-configuration-properties">Azure Service Bus Binding Configuration Properties</a></li>
</ul>
</li>
<li><a href="#basic-usage-10">27.2.4. Basic Usage</a>
<ul class="sectlevel4">
<li><a href="#sending-and-receiving-messages-fromto-service-bus">Sending and Receiving Messages from/to Service Bus</a></li>
<li><a href="#partition-key-support-2">Partition Key Support</a></li>
<li><a href="#session-support-2">Session Support</a></li>
<li><a href="#error-channels-2">Error Channels</a></li>
<li><a href="#scs-sb-headers">Service Bus Message Headers</a></li>
<li><a href="#multiple-binder-support-2">Multiple Binder Support</a></li>
<li><a href="#resource-provision-2">Resource Provision</a></li>
</ul>
</li>
<li><a href="#samples-14">27.2.5. Samples</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#spring-jms-support">28. Spring JMS Support</a>
<ul class="sectlevel2">
<li><a href="#dependency-setup-11">28.1. Dependency Setup</a></li>
<li><a href="#configuration-12">28.2. Configuration</a></li>
<li><a href="#basic-usage-11">28.3. Basic Usage</a>
<ul class="sectlevel3">
<li><a href="#use-service-bus-connection-string">28.3.1. Use Service Bus Connection String</a></li>
</ul>
</li>
<li><a href="#samples-15">28.4. Samples</a></li>
</ul>
</li>
<li><a href="#kafka-support">29. Kafka Support</a>
<ul class="sectlevel2">
<li><a href="#dependency-setup-12">29.1. Dependency Setup</a></li>
<li><a href="#configuration-13">29.2. Configuration</a></li>
<li><a href="#basic-usage-12">29.3. Basic Usage</a>
<ul class="sectlevel3">
<li><a href="#use-event-hubs-connection-string">29.3.1. Use Event Hubs Connection String</a></li>
<li><a href="#use-azure-resource-manager-to-retrieve-connection-string">29.3.2. Use Azure Resource Manager to Retrieve Connection String</a></li>
</ul>
</li>
<li><a href="#samples-16">29.4. Samples</a></li>
</ul>
</li>
<li><a href="#redis-support">30. Redis Support</a>
<ul class="sectlevel2">
<li><a href="#dependency-setup-13">30.1. Dependency Setup</a></li>
<li><a href="#configuration-14">30.2. Configuration</a></li>
<li><a href="#basic-usage-13">30.3. Basic Usage</a></li>
<li><a href="#samples-17">30.4. Samples</a></li>
</ul>
</li>
<li><a href="#spring-cloud-azure-resourcemanager">31. Resource Manager</a>
<ul class="sectlevel2">
<li><a href="#dependency-setup-14">31.1. Dependency Setup</a></li>
<li><a href="#configuration-15">31.2. Configuration</a></li>
<li><a href="#resource-manager-basic-usage">31.3. Basic Usage</a></li>
<li><a href="#samples-18">31.4. Samples</a></li>
</ul>
</li>
<li><a href="#configuration-properties-2">32. Configuration Properties</a></li>
<li><a href="#appendix">33. Appendix</a>
<ul class="sectlevel2">
<li><a href="#configuration-properties-3">33.1. Configuration properties</a></li>
<li><a href="#migration-guide-for-4-0-2">33.2. Migration guide for 4.0</a></li>
<li><a href="#known-issues">33.3. Known issues</a></li>
</ul>
</li>
<li><a href="#spring-boot-3">34. Spring Boot</a></li>
<li><a href="#spring-project-references">35. Spring Project References</a></li>
<li><a href="#spring-boot-starters-for-azure">36. Spring Boot Starters for Azure</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<h1 id="getting-started-guides" class="sect0"><a class="anchor" href="#getting-started-guides"></a><a class="link" href="#getting-started-guides">Getting Started Guides</a></h1>
<div class="sect1">
<h2 id="spring-boot"><a class="anchor" href="#spring-boot"></a><a class="link" href="#spring-boot">1. Spring Boot</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="spring-boot-2"><a class="anchor" href="#spring-boot-2"></a><a class="link" href="#spring-boot-2">1.1. Spring Boot</a></h3>
<div class="paragraph">
<p>This article describes the various Spring Boot Starters for the <a href="https://start.spring.io/">Spring Initializr</a> that provide Java developers with integration features for working with Microsoft Azure.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/160522559-5922e09f-737b-4696-9329-f238adf9b150.png" alt="Configure Azure Spring Boot Starters with Initializr"></span></p>
</div>
<div class="paragraph">
<p>The following Spring Boot Starters are currently available for Azure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Azure Support</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Provides autoconfiguration support for Azure Services; e.g. Service Bus, Storage, Active Directory, etc.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Azure Active Directory</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Provides integration support for Spring Security with Azure Active Directory for authentication.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Azure Key Vault</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Provides Spring value annotation support for integration with Azure Key Vault Secrets.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Azure Storage</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Provides Spring Boot support for Azure Storage services.</p>
</div>
<div class="sect3">
<h4 id="azure-support"><a class="anchor" href="#azure-support"></a><a class="link" href="#azure-support">1.1.1. Azure Support</a></h4>
<div class="paragraph">
<p>This Spring Boot Starter provides autoconfiguration support for Azure Services; for example: Service Bus, Storage, Active Directory, Cosmos DB, Key Vault, etc.</p>
</div>
<div class="paragraph">
<p>For examples of how to use the various Azure features that are provided by this starter, see the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <a href="https://github.com/Azure-Samples/azure-spring-boot-samples">azure-spring-boot-samples</a> repo on GitHub.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When you add this starter to a Spring Boot project, the following changes are made to the <em>pom.xml</em> file:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The following property is added to <code>&lt;properties&gt;</code> element:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;properties&gt;
    &lt;!-- Other properties will be listed here --&gt;
    &lt;java.version&gt;1.8&lt;/java.version&gt;
    &lt;spring.cloud.azure.version&gt;4.0.0&lt;/azure.version&gt;
&lt;/properties&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The default <code>spring-boot-starter</code> dependency is replaced with the following:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The following section is added to the file:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">   &lt;dependencyManagement&gt;
      &lt;dependencies&gt;
         &lt;dependency&gt;
            &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-azure-dependencies&lt;/artifactId&gt;
            &lt;version&gt;${version.spring.cloud.azure}&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
         &lt;/dependency&gt;
      &lt;/dependencies&gt;
   &lt;/dependencyManagement&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For more information about using this bom, see <a href="https://microsoft.github.io/spring-cloud-azure/current/reference/html/index.html#setting-up-dependencies">reference doc</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="azure-active-directory"><a class="anchor" href="#azure-active-directory"></a><a class="link" href="#azure-active-directory">1.1.2. Azure Active Directory</a></h4>
<div class="paragraph">
<p>This Spring Boot Starter provides autoconfiguration support for Spring Security in order to provide integration with Azure Active Directory for authentication.</p>
</div>
<div class="paragraph">
<p>For examples of how to use the Azure Active Directory features that are provided by this starter, see the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.0/aad/spring-cloud-azure-starter-active-directory">spring-cloud-azure-starter-active-directory samples</a> repo on GitHub.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When you add this starter to a Spring Boot project, the following changes are made to the <em>pom.xml</em> file:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The following property is added to <code>&lt;properties&gt;</code> element:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">   &lt;properties&gt;
      &lt;!-- Other properties will be listed here --&gt;
      &lt;java.version&gt;1.8&lt;/java.version&gt;
      &lt;version.spring.cloud.azure&gt;4.0.0&lt;/version.spring.cloud.azure&gt;
   &lt;/properties&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The default <code>spring-boot-starter</code> dependency is replaced with the following:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-active-directory&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The following section is added to the file:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">   &lt;dependencyManagement&gt;
      &lt;dependencies&gt;
         &lt;dependency&gt;
            &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-azure-dependencies&lt;/artifactId&gt;
            &lt;version&gt;${version.spring.cloud.azure}&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
         &lt;/dependency&gt;
      &lt;/dependencies&gt;
   &lt;/dependencyManagement&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For more information about using this starter, see <a href="https://microsoft.github.io/spring-cloud-azure/current/reference/html/index.html#spring-security-support">Spring Security Support</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="azure-key-vault"><a class="anchor" href="#azure-key-vault"></a><a class="link" href="#azure-key-vault">1.1.3. Azure Key Vault</a></h4>
<div class="paragraph">
<p>This Spring Boot Starter provides Spring value annotation support for integration with Azure Key Vault Secrets.</p>
</div>
<div class="paragraph">
<p>For examples of how to use the Azure Key Vault features that are provided by this starter, see the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.0/keyvault/spring-cloud-azure-starter-keyvault-secrets">spring-cloud-azure-starter-keyvault-secrets samples</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When you add this starter to a Spring Boot project, the following changes are made to the <em>pom.xml</em> file:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The following property is added to <code>&lt;properties&gt;</code> element:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">   &lt;properties&gt;
      &lt;!-- Other properties will be listed here --&gt;
      &lt;java.version&gt;1.8&lt;/java.version&gt;
      &lt;version.spring.cloud.azure&gt;4.0.0&lt;/version.spring.cloud.azure&gt;
   &lt;/properties&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The default <code>spring-boot-starter</code> dependency is replaced with the following:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-keyvault-secrets&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The following section is added to the file:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">   &lt;dependencyManagement&gt;
      &lt;dependencies&gt;
         &lt;dependency&gt;
            &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-azure-dependencies&lt;/artifactId&gt;
            &lt;version&gt;${version.spring.cloud.azure}&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
         &lt;/dependency&gt;
      &lt;/dependencies&gt;
   &lt;/dependencyManagement&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For more information about using this starter, see <a href="https://microsoft.github.io/spring-cloud-azure/current/reference/html/index.html#secret-management">Secret Management</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="azure-storage"><a class="anchor" href="#azure-storage"></a><a class="link" href="#azure-storage">1.1.4. Azure Storage</a></h4>
<div class="paragraph">
<p>This Spring Boot Starter provides Spring Boot integration support for Azure Storage services.</p>
</div>
<div class="paragraph">
<p>For examples of how to use the Azure Storage features that are provided by this starter, see the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.0/storage/spring-cloud-azure-starter-integration-storage-queue">spring-cloud-azure-starter-integration-storage-queue samples</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When you add this starter to a Spring Boot project, the following changes are made to the <em>pom.xml</em> file:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The following property is added to <code>properties</code> element:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">   &lt;properties&gt;
      &lt;!-- Other properties will be listed here --&gt;
      &lt;java.version&gt;1.8&lt;/java.version&gt;
      &lt;version.spring.cloud.azure&gt;4.0.0&lt;/version.spring.cloud.azure&gt;
   &lt;/properties&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The default <code>spring-boot-starter</code> dependency is replaced with the following:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-integration-storage-queue&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The following section is added to the file:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">   &lt;dependencyManagement&gt;
      &lt;dependencies&gt;
         &lt;dependency&gt;
            &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-azure-dependencies&lt;/artifactId&gt;
            &lt;version&gt;${version.spring.cloud.azure}&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
         &lt;/dependency&gt;
      &lt;/dependencies&gt;
   &lt;/dependencyManagement&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For more information about using this starter, see <a href="https://microsoft.github.io/spring-cloud-azure/current/reference/html/index.html#spring-integration-with-azure-storage-queue">Spring Integration with Azure Storage Queue</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="application-insights"><a class="anchor" href="#application-insights"></a><a class="link" href="#application-insights">1.1.5. Application Insights</a></h4>
<div class="paragraph">
<p>Azure Monitor Application Insights can help you understand how your app is performing and how it&#8217;s being used. Application Insights uses the Java agent to enable the application monitor. There are no code changes needed, and you can enable the Java agent with just a couple of configuration changes. For instructions and more information, see <a href="/azure/azure-monitor/app/java-in-process-agent#configuration-options">Java codeless application monitoring Azure Monitor Application Insights</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="azure-storage-2"><a class="anchor" href="#azure-storage-2"></a><a class="link" href="#azure-storage-2">1.2. Azure Storage</a></h3>
<div class="paragraph">
<p>This article walks you through creating a custom application using the <strong>Spring Initializr</strong>, then adding the Azure Storage Blob starter to your application, and then using your application to upload a blob to your Azure storage account.</p>
</div>
<div class="sect3">
<h4 id="prerequisites"><a class="anchor" href="#prerequisites"></a><a class="link" href="#prerequisites">1.2.1. Prerequisites</a></h4>
<div class="paragraph">
<p>The following prerequisites are required in order to follow the steps in this article:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An Azure subscription; if you don&#8217;t already have an Azure subscription, you can activate your <a href="https://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/">MSDN subscriber benefits</a> or sign up for a <a href="https://azure.microsoft.com/pricing/free-trial/">free Azure account</a>.</p>
</li>
<li>
<p>The <a href="/cli/azure/index">Azure Command-Line Interface (CLI)</a>.</p>
</li>
<li>
<p>A supported Java Development Kit (JDK). For more information about the JDKs available for use when developing on Azure, see <a href="../fundamentals/java-support-on-azure.md">Java support on Azure and Azure Stack</a>.</p>
</li>
<li>
<p><a href="http://maven.apache.org/">Apache Maven</a>, version 3.0 or later.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Spring Boot version 2.5 or 2.6 is required to complete the steps in this article.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="create-an-azure-storage-account-and-blob-container-for-your-application"><a class="anchor" href="#create-an-azure-storage-account-and-blob-container-for-your-application"></a><a class="link" href="#create-an-azure-storage-account-and-blob-container-for-your-application">1.2.2. Create an Azure Storage Account and blob container for your application</a></h4>
<div class="paragraph">
<p>The following procedure creates an Azure storage account and container in the portal.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Browse to the Azure portal at <a href="https://portal.azure.com/" class="bare">portal.azure.com/</a> and sign in.</p>
</li>
<li>
<p>Select <strong>Create a resource</strong>, then <strong>Get started</strong>, and then select <strong>Storage Account</strong>.</p>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/160536881-a9e3cb9d-bee6-40bd-80ce-634b4d198373.png" alt="Azure portal, create a resource, search for storage accounts."></span></p>
</div>
</li>
<li>
<p>On the <strong>Create storage account</strong> page, enter the following information:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Select <strong>Subscription</strong>.</p>
</li>
<li>
<p>Select <strong>Resource group</strong>, or create a new resource group.</p>
</li>
<li>
<p>Enter a unique <strong>Storage account name</strong>, which will become part of the URI for your storage account. For example: if you entered <strong>wingtiptoysstorage</strong> for the <strong>Name</strong>, the URI would be <em>wingtiptoysstorage.core.windows.net</em>.</p>
</li>
<li>
<p>Specify the <strong>Location</strong> for your storage account.</p>
</li>
</ol>
</div>
</li>
<li>
<p>When you have specified the options listed above, select <strong>Review + create</strong>.</p>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/160536965-b233f379-dfd3-4de0-be5c-28ff4420bb42.png" alt="Azure portal, create a storage account."></span></p>
</div>
</li>
<li>
<p>Review the specification, then select <strong>Create</strong> to create your storage account.</p>
</li>
<li>
<p>When the deployment is complete, select <strong>Go to resource</strong>.</p>
</li>
<li>
<p>Select <strong>Containers</strong>.</p>
</li>
<li>
<p>Select <strong>Container</strong>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Name the container.</p>
</li>
<li>
<p>Select <em>Blob</em> from the drop-down list.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/160537009-7dfb622f-8d38-4ef1-ba08-a60f38dd2af1.png" alt="Azure portal, storage account, containers, new container pane."></span></p>
</div>
</li>
<li>
<p>The Azure portal will list your blob container after is has been created.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can also use Azure CLI to create an Azure storage account and container using the following steps. Remember to replace the placeholder values (in angle brackets) with your own values.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open a command prompt.</p>
</li>
<li>
<p>Sign in to your Azure account:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">   az login</code></pre>
</div>
</div>
</li>
<li>
<p>If you don&#8217;t have a resource group, create one using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">   az group create \
      --name &lt;resource-group&gt; \
      --location &lt;location&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Create a storage account by using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">    az storage account create \
      --name &lt;storage-account-name&gt; \
      --resource-group &lt;resource-group&gt; \
      --location &lt;location&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>To create a container, use the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">    az storage container create \
      --account-name &lt;storage-account-name&gt; \
      --name &lt;container-name&gt; \
      --auth-mode login</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="create-a-simple-spring-boot-application-with-the-spring-initializr"><a class="anchor" href="#create-a-simple-spring-boot-application-with-the-spring-initializr"></a><a class="link" href="#create-a-simple-spring-boot-application-with-the-spring-initializr">1.2.3. Create a simple Spring Boot application with the Spring Initializr</a></h4>
<div class="paragraph">
<p>The following procedure creates the Spring boot application.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Browse to <a href="https://start.spring.io/" class="bare">start.spring.io/</a>.</p>
</li>
<li>
<p>Specify the following options:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Generate a <strong>Maven</strong> project.</p>
</li>
<li>
<p>Specify <strong>Java 11</strong>.</p>
</li>
<li>
<p>Specify a <strong>Spring Boot</strong> version that is equal to <strong>2.5.10</strong>.</p>
</li>
<li>
<p>Specify the <strong>Group</strong> and <strong>Artifact</strong> names for your application.</p>
</li>
<li>
<p>Add the <strong>Spring Web</strong> dependency.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/160537746-5ccdfcb8-9dbc-4d35-a78e-61875958bb8a.png" alt="Basic Spring Initializr options"></span>
NOTE: The Spring Initializr uses the <strong>Group</strong> and <strong>Artifact</strong> names to create the package name; for example: <strong>com.wingtiptoys.storage</strong>.</p>
</div>
</li>
<li>
<p>When you have specified the options listed above, select <strong>GENERATE</strong>.</p>
</li>
<li>
<p>When prompted, download the project to a path on your local computer.</p>
</li>
<li>
<p>After you have extracted the files on your local system, your simple Spring Boot application will be ready to edit.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="configure-your-spring-boot-app-to-use-the-azure-storage-blob-starter"><a class="anchor" href="#configure-your-spring-boot-app-to-use-the-azure-storage-blob-starter"></a><a class="link" href="#configure-your-spring-boot-app-to-use-the-azure-storage-blob-starter">1.2.4. Configure your Spring Boot app to use the Azure Storage Blob starter</a></h4>
<div class="sect4">
<h5 id="add-dependency-in-pom-xml"><a class="anchor" href="#add-dependency-in-pom-xml"></a><a class="link" href="#add-dependency-in-pom-xml">Add dependency in pom.xml</a></h5>
<div class="paragraph">
<p>The following procedure configures the Spring boot application to use Azure storage.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Locate the <strong>pom.xml</strong> file in the root directory of your app; for example:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>C:\SpringBoot\storage\pom.xml</code></p>
</li>
<li>
<p><code>/users/example/home/storage/pom.xml</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Open the <strong>pom.xml</strong> file in a text editor, and add the Spring Cloud Azure Storage starter to the list of <code>&lt;dependencies&gt;</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">    &lt;dependency&gt;
      &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
      &lt;artifactId&gt;spring-cloud-azure-starter-storage-blob&lt;/artifactId&gt;
      &lt;version&gt;4.0.0&lt;/version&gt;
    &lt;/dependency&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Save and close the <strong>pom.xml</strong> file.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="configure-property-in-application-yml"><a class="anchor" href="#configure-property-in-application-yml"></a><a class="link" href="#configure-property-in-application-yml">Configure property in application.yml</a></h5>
<div class="paragraph">
<p>The following procedure configures the Spring boot application to use your Azure storage account.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Locate the <strong>application.yml</strong> in the <strong>resources</strong> directory of your app; for example:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>C:\SpringBoot\storage\src\main\resources\application.yml</code></p>
</li>
<li>
<p><code>/users/example/home/storage/src/main/resources/application.yml</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Open the <strong>application.yml</strong> file in a text editor, add the following lines, and then replace the sample values with the appropriate properties for your storage account:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      storage:
        blob:
          account-name: [storage-account-name]
          account-key: [storage-account-access-key]
          endpoint: [storage-blob-service-endpoint]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Spring Cloud Azure Storage Blob Properties</caption>
<colgroup>
<col style="width: 44.4444%;">
<col style="width: 44.4444%;">
<col style="width: 11.1112%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.storage.blob.account-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the Azure Storage account.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.storage.blob.account-key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The access key of the Azure Storage account.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.storage.blob.endpoint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The blob endpoint URL of the Azure Storage account.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>Save and close the <em>application.yml</em> file.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="add-sample-code-to-implement-basic-azure-storage-functionality"><a class="anchor" href="#add-sample-code-to-implement-basic-azure-storage-functionality"></a><a class="link" href="#add-sample-code-to-implement-basic-azure-storage-functionality">1.2.5. Add sample code to implement basic Azure storage functionality</a></h4>
<div class="paragraph">
<p>In this section, you will create the necessary Java classes for storing a blob in your Azure storage account.</p>
</div>
<div class="sect4">
<h5 id="add-a-blob-controller-class"><a class="anchor" href="#add-a-blob-controller-class"></a><a class="link" href="#add-a-blob-controller-class">Add a blob controller class</a></h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a new Java file named <em>BlobController.java</em> in the package directory of your app; for example:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>C:\SpringBoot\storage\src\main\java\com\wingtiptoys\storage\BlobController.java</code></p>
</li>
<li>
<p><code>/users/example/home/storage/src/main/java/com/wingtiptoys/storage/BlobController.java</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Open <code>BlobController.java</code> in a text editor, and add the following lines to the file. Replace the <code>your-resource-group</code>, <code>your-artifact-name</code>, <code>your-container-name</code>, and <code>your-blob-name</code> placeholders with your values.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.&lt;your-resource-group&gt;.&lt;your-artifact-name&gt;;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.core.io.Resource;
import org.springframework.core.io.WritableResource;
import org.springframework.util.StreamUtils;
import org.springframework.web.bind.annotation.*;

import java.io.IOException;
import java.io.OutputStream;
import java.nio.charset.Charset;

@RestController
@RequestMapping("blob")
public class BlobController {
    @Value("azure-blob://&lt;your-container-name&gt;/&lt;your-blob-name&gt;")
    private Resource blobFile;

    @GetMapping("/readBlobFile")
    public String readBlobFile() throws IOException {
        return StreamUtils.copyToString(
                this.blobFile.getInputStream(),
                Charset.defaultCharset());
    }

    @PostMapping("/writeBlobFile")
    public String writeBlobFile(@RequestBody String data) throws IOException {
        try (OutputStream os = ((WritableResource) this.blobFile).getOutputStream()) {
            os.write(data.getBytes());
        }
        return "file was updated";
    }

}</code></pre>
</div>
</div>
</li>
<li>
<p>Save and close the blob controller Java file.</p>
</li>
<li>
<p>Open a command prompt and change directory to the folder where your <em>pom.xml</em> file is located; for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"> cd C:\SpringBoot\storage</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">   cd /users/example/home/storage</code></pre>
</div>
</div>
</li>
<li>
<p>Build your Spring Boot application with Maven and run it; for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">   mvn clean package
   mvn spring-boot:run</code></pre>
</div>
</div>
</li>
<li>
<p>Once your application is running, you can use <em>curl</em> to test your application; for example:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Send a POST request to update a file&#8217;s contents:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl http://localhost:8080/blob/writeBlobFile -d "new message" -H "Content-Type: text/plain"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see a response that  <code>file was updated</code>.</p>
</div>
</li>
<li>
<p>Send a GET request to verify the file&#8217;s contents:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl -X GET http://localhost:8080/blob/readBlobFile</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see the "new message" text that you posted.</p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="summary"><a class="anchor" href="#summary"></a><a class="link" href="#summary">1.2.6. Summary</a></h4>
<div class="paragraph">
<p>In this tutorial, you created a new Java application using the <strong>Spring Initializr</strong>, added the Azure Storage Blob starter to your application, and then configured your application to upload a blob to your Azure storage account.</p>
</div>
</div>
<div class="sect3">
<h4 id="clean-up-resources"><a class="anchor" href="#clean-up-resources"></a><a class="link" href="#clean-up-resources">1.2.7. Clean up resources</a></h4>
<div class="paragraph">
<p>When no longer needed, use the <a href="https://portal.azure.com/">Azure portal</a> to delete the resources created in this article to avoid unexpected charges.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="azure-key-vault-secrets"><a class="anchor" href="#azure-key-vault-secrets"></a><a class="link" href="#azure-key-vault-secrets">1.3. Azure Key Vault Secrets</a></h3>
<div class="paragraph">
<p>This tutorial shows you how to create a Spring Boot app that reads a value from Azure Key Vault. After creating the app, you&#8217;ll deploy it to Azure App Service and Azure Spring Cloud.</p>
</div>
<div class="paragraph">
<p>Spring Boot applications externalize sensitive information such as usernames and passwords. Externalizing sensitive information enables better maintainability, testability, and security. Storing secrets outside of the code is better than hard coding the information, or inlining it at build time.</p>
</div>
<div class="paragraph">
<p>In this tutorial, you learn how to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create an Azure Key Vault and store a secret</p>
</li>
<li>
<p>Create an app with Spring Initializr</p>
</li>
<li>
<p>Add Key Vault integration to the app</p>
</li>
<li>
<p>Deploy to Azure App Service</p>
</li>
<li>
<p>Redeploy to Azure App Service with managed identities for Azure resources</p>
</li>
<li>
<p>Deploy to Azure Spring Cloud</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="prerequisites-2"><a class="anchor" href="#prerequisites-2"></a><a class="link" href="#prerequisites-2">1.3.1. Prerequisites</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If you don&#8217;t have an <a href="https://docs.microsoft.com/azure/guides/developer/azure-developer-guide#understanding-accounts-subscriptions-and-billing">Azure subscription</a>, create a <a href="https://azure.microsoft.com/free/?ref=microsoft.com&amp;utm_source=microsoft.com&amp;utm_medium=docs&amp;utm_campaign=visualstudio">free account</a> before you begin.</p>
</li>
<li>
<p>The curl command. Most UNIX-like operating systems have this command pre-installed. OS-specific clients are available at <a href="https://curl.se/">the official curl website</a>.</p>
</li>
<li>
<p>The jq command. Most UNIX-like operating systems have this command pre-installed. OS-specific clients are available at <a href="https://stedolan.github.io/jq/">the official jq website</a>.</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli">Azure CLI</a>, version 2.14.1 or later</p>
</li>
<li>
<p>A supported Java Development Kit (JDK). For more information, see Java support on <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli">Azure and Azure Stack</a>.</p>
</li>
<li>
<p><a href="https://maven.apache.org/">Apache Maven</a>, version 3.0 or later.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Spring Boot version 2.5 or 2.6 is required to complete the steps in this article.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="create-a-new-azure-key-vault"><a class="anchor" href="#create-a-new-azure-key-vault"></a><a class="link" href="#create-a-new-azure-key-vault">1.3.2. Create a new Azure Key Vault</a></h4>
<div class="paragraph">
<p>The following sections show you how to sign in to Azure and create an Azure Key Vault.</p>
</div>
<div class="sect4">
<h5 id="sign-in-to-azure-and-set-your-subscription"><a class="anchor" href="#sign-in-to-azure-and-set-your-subscription"></a><a class="link" href="#sign-in-to-azure-and-set-your-subscription">Sign in to Azure and set your subscription</a></h5>
<div class="paragraph">
<p>First, use the following steps to authenticate using the Azure CLI.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Optionally, sign out and delete some authentication files to remove any lingering credentials:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">az logout
rm ~/.azure/accessTokens.json
rm ~/.azure/azureProfile.json</code></pre>
</div>
</div>
</li>
<li>
<p>Sign in by using the Azure CLI:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">   az login</code></pre>
</div>
</div>
<div class="paragraph">
<p>Follow the instructions to complete the sign-in process.</p>
</div>
</li>
<li>
<p>List your subscriptions:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">   az account list</code></pre>
</div>
</div>
<div class="paragraph">
<p>Azure will return a list of your subscriptions. Copy the <code>id</code> value for the subscription that you want to use; for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">[
  {
    "cloudName": "AzureCloud",
    "id": "ssssssss-ssss-ssss-ssss-ssssssssssss",
    "name": "Converted Windows Azure MSDN - Visual Studio Ultimate",
    "state": "Enabled",
    "tenantId": "tttttttt-tttt-tttt-tttt-tttttttttttt",
    "user": {
      "name": "contoso@microsoft.com",
      "type": "user"
    }
  }
]</code></pre>
</div>
</div>
</li>
<li>
<p>Specify the GUID for the subscription you want to use with Azure; for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">az account set -s ssssssss-ssss-ssss-ssss-ssssssssssss</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="create-a-service-principal"><a class="anchor" href="#create-a-service-principal"></a><a class="link" href="#create-a-service-principal">Create a service principal</a></h5>
<div class="paragraph">
<p>Azure AD <strong>service principals</strong> provide access to Azure resources within your subscription. You can think of a service principal as a user identity for a service. "Service" is any application, service, or platform that needs to access Azure resources. You can configure a service principal with access rights scoped only to those resources you specify. Then, configure your application or service to use the service principal&#8217;s credentials to access those resources.</p>
</div>
<div class="paragraph">
<p>To create a service principal, use the following command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">az ad sp create-for-rbac –name contososp –role Contributor</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The value of the <code>--name</code> option must be unique within the Azure subscription. If you see an error log similar to <code>Found an existing instance of "&#8230;&#8203;", We will patch it. Insufficient privileges to complete operation</code>, that means the <code>name</code> value already exist in your subscription. Try another name.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Save aside the values returned from the command for use later in the tutorial. The return JSON will look similar to the following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
 "appId": "sample-app-id",
 "displayName": "contososp",
 "name": "http://contososp",
 "password": "sample-password",
 "tenant": "sample-tenant"
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="create-the-key-vault-instance"><a class="anchor" href="#create-the-key-vault-instance"></a><a class="link" href="#create-the-key-vault-instance">Create the Key Vault instance</a></h5>
<div class="paragraph">
<p>To create and initialize the Azure Key Vault, use the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Determine which Azure region will hold your resources.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>To see the list of regions and their locations, see [Azure geographies](<a href="https://azure.microsoft.com/regions/" class="bare">azure.microsoft.com/regions/</a>).</p>
</li>
<li>
<p>Use the <code>az account list-locations</code> command to find the correct <code>Name</code> for your chosen region.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">az account list-locations --output table</code></pre>
</div>
</div>
<div class="paragraph">
<p>This tutorial uses <code>eastus</code>.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Create a resource group to hold the Key Vault and the App Service app. The value must be unique within the Azure subscription. This tutorial uses <code>contosorg</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">az group create --name contosorg --location eastus</code></pre>
</div>
</div>
</li>
<li>
<p>Create a new Key Vault in the resource group.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">az keyvault create \
    --resource-group contosorg \
    --name contosokv \
    --enabled-for-deployment true \
    --enabled-for-disk-encryption true \
    --enabled-for-template-deployment true \
    --location eastus \
    --query properties.vaultUri \
    --sku standard</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The value of the <code>--name</code> option must be unique within the Azure subscription. If you see an error log similar to <code>Found an existing instance of "&#8230;&#8203;", We will patch it. Insufficient privileges to complete operation</code>, that means the <code>name</code> value already exist in your subscription. Try another name.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can refer to <a href="https://docs.microsoft.com/en-us/cli/azure/keyvault?view=azure-cli-latest#az-keyvault-create">az keyvault create command</a> to get more information about each parameter.
The Azure CLI will display the URI for Key Vault, which you&#8217;ll use later; for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">"https://contosokv.vault.azure.net/"</code></pre>
</div>
</div>
</li>
<li>
<p>Configure the Key Vault to allow <code>get</code> and <code>list</code> operations from that managed identity. The value of the <code>object-id</code> is the <code>appId</code> from the <code>az ad sp create-for-rbac</code> command above.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">az keyvault set-policy --name contosokv --spn http://contososp --secret-permissions get list</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output will be a JSON object full of information about the Key Vault. It will have a <code>type</code> entry with value <code>Microsoft.KeyVault/vaults</code>.
You can refer to <a href="https://docs.microsoft.com/cli/azure/keyvault?view=azure-cli-latest#az-keyvault-set-policy">az keyvault set-policy</a> to get more information about each parameter.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
While the principle of the least privilege recommends granting the smallest possible set of privileges to a resource, the design of the Key Vault integration requires at least <code>get</code> and <code>list</code>.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Store a secret in your new Key Vault. A common use case is to store a JDBC connection string. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">   az keyvault secret set --name "connectionString" \
       --vault-name "contosokv" \
       --value "jdbc:sqlserver://SERVER.database.windows.net:1433;database=DATABASE;"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can refer to <a href="https://docs.microsoft.com/en-us/cli/azure/keyvault/secret?view=azure-cli-latest#az-keyvault-secret-set">az keyvault secret set command</a> to get more information about each parameter.
The Azure CLI will display the results of your secret creation; for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "attributes": {
    "created": "2020-08-24T21:48:09+00:00",
    "enabled": true,
    "expires": null,
    "notBefore": null,
    "recoveryLevel": "Purgeable",
    "updated": "2020-08-24T21:48:09+00:00"
  },
  "contentType": null,
  "id": "https://contosokv.vault.azure.net/secrets/connectionString/sample-id",
  "kid": null,
  "managed": null,
  "tags": {
    "file-encoding": "utf-8"
  },
  "value": "jdbc:sqlserver://.database.windows.net:1433;database=DATABASE;"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that you&#8217;ve created a Key Vault and stored a secret, the next section will show you how to create an app with Spring Initializr.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-the-app-with-spring-initializr"><a class="anchor" href="#create-the-app-with-spring-initializr"></a><a class="link" href="#create-the-app-with-spring-initializr">1.3.3. Create the app with Spring Initializr</a></h4>
<div class="paragraph">
<p>This section shows how to use Spring Initializr to create and run a Spring Boot web application with key vault secrets included.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Browse to <a href="https://start.spring.io/" class="bare">start.spring.io/</a>.</p>
</li>
<li>
<p>Select the choices as shown in the picture following this list.</p>
<div class="ulist">
<ul>
<li>
<p><strong>Project</strong>: <strong>Maven Project</strong></p>
</li>
<li>
<p><strong>Language</strong>: <strong>Java</strong></p>
</li>
<li>
<p><strong>Spring Boot</strong>: <strong>2.5.10</strong></p>
</li>
<li>
<p><strong>Group</strong>: <strong>com.contoso</strong> (You can put any valid Java package name here.)</p>
</li>
<li>
<p><strong>Artifact</strong>: <strong>keyvault</strong> (You can put any valid Java class name here.)</p>
</li>
<li>
<p><strong>Packaging</strong>: <strong>Jar</strong></p>
</li>
<li>
<p><strong>Java</strong>: <strong>11</strong> (You can choose 8, but this tutorial was validated with 11.)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Select <strong>Add Dependencies&#8230;&#8203;</strong>.</p>
</li>
<li>
<p>In the text field, type <strong>Spring Web</strong> and press Ctrl+Enter.</p>
</li>
<li>
<p>In the text field type <strong>Azure Key Vault</strong> and press Enter. Your screen should look like the following.
<span class="image"><img src="https://user-images.githubusercontent.com/13167207/160542739-62ae6857-0229-4b4b-8a98-38df37747a6d.png" alt="Basic Spring Initializr options"></span></p>
</li>
<li>
<p>At the bottom of the page, select <strong>Generate</strong>.</p>
</li>
<li>
<p>When prompted, download the project to a path on your local computer. This tutorial uses a <strong>keyvault</strong> directory in the current user&#8217;s home directory. The values above will give you a <strong>keyvault.zip</strong> file in that directory.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Use the following steps to examine the application and run it locally.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Unzip the <strong>keyvault.zip</strong> file. The file layout will look like the following. This tutorial ignores the <strong>test</strong> directory and its contents.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-txt" data-lang="txt">├── HELP.md
├── mvnw
├── mvnw.cmd
├── pom.xml
└── src
   ├── main
   │   ├── java
   │   │   └── com
   │   │       └── contoso
   │   │           └── keyvault
   │   │               └── KeyvaultApplication.java
   │   └── resources
   │       ├── application.properties
   │       ├── static
   │       └── templates</code></pre>
</div>
</div>
</li>
<li>
<p>Open the <strong>KeyvaultApplication.java</strong> file in a text editor. Edit the file so that it has the following contents.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@SpringBootApplication
@RestController
public class KeyvaultApplication {

    public static void main(String[] args) {
        SpringApplication.run(KeyvaultApplication.class, args);
    }

    @GetMapping("get")
    public String get() {
        return connectionString;
    }

    private String connectionString = "defaultValue\n";

    public void run(String... varl) throws Exception {
        System.out.println(String.format("Connection String stored in Azure Key Vault:%s",connectionString));
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following list highlights some details about this code:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The class is annotated with <code>@RestController</code>. <code>@RestController</code> tells Spring Boot that the class can respond to RESTful HTTP requests.</p>
</li>
<li>
<p>The class has a method annotated with <code>@GetMapping(get)</code>. <code>@GetMapping</code> tells Spring Boot to send HTTP requests with the path <code>/get</code> to that method, allowing the response from that method to be returned to the HTTP client.</p>
</li>
<li>
<p>The class has a private instance variable <code>connectionString</code>. The value of this instance variable is returned from the <code>get()</code> method.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Open a Bash window and navigate to the top-level <strong>keyvault</strong> directory, where the <strong>pom.xml</strong> file is located.</p>
</li>
<li>
<p>Enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mvn spring-boot:run</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command outputs <code>Completed initialization</code>, which indicates that the server is ready.</p>
</div>
</li>
<li>
<p>In a separate Bash window, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl http://localhost:8080/get</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output will show <code>defaultValue</code>.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Kill the process that&#8217;s running from <code>mvn spring-boot:run</code>. You can type Ctrl-C, or you can use the <code>jps</code> command to get the pid of the <code>Launcher</code> process and kill it.</p>
</div>
</div>
<div class="sect3">
<h4 id="create-the-app-without-spring-initializr"><a class="anchor" href="#create-the-app-without-spring-initializr"></a><a class="link" href="#create-the-app-without-spring-initializr">1.3.4. Create the app without Spring Initializr</a></h4>
<div class="paragraph">
<p>This section shows how to include Azure Key Vault secrets to your existing Spring Boot project without using Spring Initializr.</p>
</div>
<div class="paragraph">
<p>To manually add the same the configuration that Spring Initializr generates, add the following configuration to your <strong>pom.xml</strong> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;project&gt;
    &lt;properties&gt;
         &lt;version.spring.cloud.azure&gt;4.0.0&lt;/version.spring.cloud.azure&gt;
    &lt;/properties&gt;
    &lt;dependencies&gt;
         &lt;dependency&gt;
             &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
             &lt;artifactId&gt;spring-cloud-azure-starter-keyvault-secrets&lt;/artifactId&gt;
         &lt;/dependency&gt;
    &lt;/dependencies&gt;
    &lt;dependencyManagement&gt;
         &lt;dependencies&gt;
             &lt;dependency&gt;
                 &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
                 &lt;artifactId&gt;spring-cloud-azure-dependencies&lt;/artifactId&gt;
                 &lt;version&gt;${version.spring.cloud.azure}&lt;/version&gt;
                 &lt;type&gt;pom&lt;/type&gt;
                 &lt;scope&gt;import&lt;/scope&gt;
             &lt;/dependency&gt;
         &lt;/dependencies&gt;
    &lt;/dependencyManagement&gt;
&lt;/project&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="add-key-vault-configuration-to-the-app"><a class="anchor" href="#add-key-vault-configuration-to-the-app"></a><a class="link" href="#add-key-vault-configuration-to-the-app">1.3.5. Add Key Vault configuration to the app</a></h4>
<div class="paragraph">
<p>This section shows you how to add Key Vault configuration to your locally running application by modifying the Spring Boot application <code>KeyvaultApplication</code>.</p>
</div>
<div class="paragraph">
<p>Just as Key Vault allows externalizing secrets from application code, Spring configuration allows externalizing configuration from code. The simplest form of Spring configuration is the <strong>application.properties</strong> file. In a Maven project, this file is located at <strong>src/main/resources/application.properties</strong>. Spring Initializr helpfully includes a zero length file at this location. Use the following steps to add the necessary configuration to this file.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Edit the <strong>src/main/resources/application.properties</strong> file so that it has the following contents, adjusting the values for your Azure subscription.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">spring.cloud.azure.keyvault.secret.property-source-enabled=true
spring.cloud.azure.keyvault.secret.property-sources[0].credential.client-id=&lt;your client ID&gt;
spring.cloud.azure.keyvault.secret.property-sources[0].credential.client-secret=&lt;your client key&gt;
spring.cloud.azure.keyvault.secret.property-sources[0].endpoint=https://contosokv.vault.azure.net/
spring.cloud.azure.keyvault.secret.property-sources[0].profile.tenant-id=&lt;your tenant ID&gt;</code></pre>
</div>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>spring.cloud.azure.keyvault.secret.property-source-enabled. Whether enable the property source feature of spring-cloud-azure-starter-keyvault-secrets. Default value is false.</p>
</li>
<li>
<p>spring.cloud.azure.keyvault.secret.property-sources[0].credential.client-id. The <code>appId</code> from the return JSON from <code>az ad sp create-for-rbac</code>.</p>
</li>
<li>
<p>spring.cloud.azure.keyvault.secret.property-sources[0].credential.client-secret. The <code>password</code> from the return JSON from <code>az ad sp create-for-rbac</code>.</p>
</li>
<li>
<p>spring.cloud.azure.keyvault.secret.property-sources[0].endpoint. The value output from the <code>az keyvault create</code> command above.</p>
</li>
<li>
<p>spring.cloud.azure.keyvault.secret.property-sources[0].profile.tenant-id. The <code>tenant</code> from the return JSON from <code>az ad sp create-for-rbac</code>.|.
For the complete list of properties, see [Spring Cloud Azure Reference doc appendix](<a href="https://microsoft.github.io/spring-cloud-azure/current/reference/html/appendix.html#_configuration_properties" class="bare">microsoft.github.io/spring-cloud-azure/current/reference/html/appendix.html#_configuration_properties</a>).</p>
</li>
</ol>
</div>
</li>
<li>
<p>Save the file and close it.</p>
</li>
<li>
<p>Open <strong>src/main/java/com/contoso/keyvault/KeyvaultApplication.java</strong> in an editor.</p>
</li>
<li>
<p>Add the following <code>import</code> statement.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.springframework.beans.factory.annotation.Value;</code></pre>
</div>
</div>
</li>
<li>
<p>Add the following annotation to the <code>connectionString</code> instance variable.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">   @Value("${connectionString}")
   private String connectionString;</code></pre>
</div>
</div>
</li>
<li>
<p>Open a Bash window and navigate to the top-level <strong>keyvault</strong> directory, where the <strong>pom.xml</strong> file is located.</p>
</li>
<li>
<p>Enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mvn clean package spring-boot:run</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command outputs <code>initialization completed</code>, which indicates that the server is ready.</p>
</div>
</li>
<li>
<p>In a separate Bash window, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl http://localhost:8080/get</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output will show <code>jdbc:sqlserver://SERVER.database.windows.net:1433;database=DATABASE</code> instead of <code>defaultValue</code>.</p>
</div>
</li>
<li>
<p>Kill the process that&#8217;s running from <code>mvn spring-boot:run</code>. You can type Ctrl-C, or you can use the <code>jps</code> command to get the pid of the <code>Launcher</code> process and kill it.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="deploy-to-azure-app-service"><a class="anchor" href="#deploy-to-azure-app-service"></a><a class="link" href="#deploy-to-azure-app-service">1.3.6. Deploy to Azure App Service</a></h4>
<div class="paragraph">
<p>The following steps show you how to deploy the <code>KeyvaultApplication</code> to Azure App Service.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the top-level <strong>keyvault</strong> directory, open the <strong>pom.xml</strong> file.</p>
</li>
<li>
<p>In the <code>&lt;build&gt;&lt;plugins&gt;</code> section, add the <code>azure-webapp-maven-plugin</code> by inserting the following XML.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;plugin&gt;
    &lt;groupId&gt;com.microsoft.azure&lt;/groupId&gt;
    &lt;artifactId&gt;azure-webapp-maven-plugin&lt;/artifactId&gt;
    &lt;version&gt;2.2.2&lt;/version&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Don&#8217;t worry about the formatting. The <code>azure-webapp-maven-plugin</code> will reformat the entire POM during this process.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Save and close the <strong>pom.xml</strong> file</p>
</li>
<li>
<p>At a command line, use the following command to invoke the <code>config</code> goal of the newly added plugin.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mvn azure-webapp:config</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Maven plugin will ask you some questions and edit the <strong>pom.xml</strong> file based on the answers. Use the following values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For <strong>Subscription</strong>, ensure you&#8217;ve selected the same subscription ID with the Key Vault you created.</p>
</li>
<li>
<p>For <strong>Web App</strong>, you can either select an existing Web App or select <code>&lt;create&gt;</code> to create a new one. If you select an existing Web App, it will jump directly to the last <strong>confirm</strong> step.</p>
</li>
<li>
<p>For <strong>OS</strong>, ensure <strong>linux</strong> is selected.</p>
</li>
<li>
<p>For <strong>javaVersion</strong>, ensure you select the Java version you chose in Spring Initializr. This tutorial uses version 11.</p>
</li>
<li>
<p>Accept the defaults for the remaining questions.</p>
</li>
<li>
<p>When asked to confirm, answer Y to continue or N to start answering the questions again. When the plugin completes running, you&#8217;re ready to edit the POM.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Next, open the modified <strong>pom.xml</strong> in an editor. The contents of the file should be similar to the following XML. Replace the following placeholders with the specified values if you didn&#8217;t already provide the value in the previous step.</p>
<div class="ulist">
<ul>
<li>
<p><code>YOUR_SUBSCRIPTION_ID</code>: This placeholder shows the location of the ID provided previously.</p>
</li>
<li>
<p><code>YOUR_RESOURCE_GROUP_NAME</code>: Replace this placeholder with the value that you specified when you created the Key Vault.</p>
</li>
<li>
<p><code>YOUR_APP_NAME</code>: Replace this placeholder with a sensible value that&#8217;s unique within your subscription.</p>
</li>
<li>
<p><code>YOUR_REGION</code>: Replace this placeholder with the value that you specified when you created the Key Vault.</p>
</li>
<li>
<p><code>APP_SETTINGS</code>: Copy the indicated <code>&lt;appSettings&gt;</code> element from the example and paste it into that location in your <strong>pom.xml</strong> file. This setting causes the server to listen on TCP port 80.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;plugins&gt;
  &lt;plugin&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
  &lt;/plugin&gt;
  &lt;plugin&gt;
    &lt;groupId&gt;com.microsoft.azure&lt;/groupId&gt;
    &lt;artifactId&gt;azure-webapp-maven-plugin&lt;/artifactId&gt;
    &lt;version&gt;2.2.2&lt;/version&gt;
    &lt;configuration&gt;
      &lt;schemaVersion&gt;V2&lt;/schemaVersion&gt;
      &lt;subscriptionId&gt;YOUR_SUBSCRIPTION_ID&lt;/subscriptionId&gt;
      &lt;resourceGroup&gt;YOUR_RESOURCE_GROUP_NAME&lt;/resourceGroup&gt;
      &lt;appName&gt;YOUR_APP_NAME&lt;/appName&gt;
      &lt;pricingTier&gt;P1v2&lt;/pricingTier&gt;
      &lt;region&gt;YOUR_REGION&lt;/region&gt;
      &lt;runtime&gt;
        &lt;os&gt;linux&lt;/os&gt;
        &lt;javaVersion&gt;java 11&lt;/javaVersion&gt;
        &lt;webContainer&gt;Java SE&lt;/webContainer&gt;
      &lt;/runtime&gt;
      &lt;!-- start of APP_SETTINGS --&gt;
      &lt;appSettings&gt;
        &lt;property&gt;
          &lt;name&gt;JAVA_OPTS&lt;/name&gt;
          &lt;value&gt;-Dserver.port=80&lt;/value&gt;
        &lt;/property&gt;
      &lt;/appSettings&gt;
      &lt;!-- end of APP_SETTINGS --&gt;
      &lt;deployment&gt;
        &lt;resources&gt;
          &lt;resource&gt;
            &lt;directory&gt;${project.basedir}/target&lt;/directory&gt;
            &lt;includes&gt;
              &lt;include&gt;*.jar&lt;/include&gt;
            &lt;/includes&gt;
          &lt;/resource&gt;
        &lt;/resources&gt;
      &lt;/deployment&gt;
    &lt;/configuration&gt;
  &lt;/plugin&gt;
&lt;/plugins&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Save and close the POM.</p>
</li>
<li>
<p>Use the following command to deploy the app to Azure App Service.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mvn -DskipTests clean package azure-webapp:deploy</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command may take several minutes, depending on many factors beyond your control. When you see output similar to the following example, you know your app has been successfully deployed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-tExt" data-lang="tExt">[INFO] Deploying the zip package contosokeyvault-22b7c1a3-b41b-4082-a9f0-9339723fa36a11893059035499017844.zip...
[INFO] Successfully deployed the artifact to https://contosokeyvault.azurewebsites.net
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  01:45 min
[INFO] Finished at: 2020-08-16T22:47:48-04:00
[INFO] ------------------------------------------------------------------------</code></pre>
</div>
</div>
</li>
<li>
<p>Wait three to five minutes to allow the deployment to complete. Then you may access the deployment with a <code>curl</code> command similar to the one shown previously, but this time using the hostname shown in your <code>BUILD SUCCESS</code> output. The following example uses <code>contosokeyvault</code> as shown in the output above.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl https://contosokeyvault.azurewebsites.net/get</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following output indicates success.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-txt" data-lang="txt">jdbc:sqlserver://SERVER.database.windows.net:1433;database=DATABASE;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ve now deployed your app to Azure App Service.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="redeploy-to-azure-app-service-and-use-managed-identities-for-azure-resources"><a class="anchor" href="#redeploy-to-azure-app-service-and-use-managed-identities-for-azure-resources"></a><a class="link" href="#redeploy-to-azure-app-service-and-use-managed-identities-for-azure-resources">1.3.7. Redeploy to Azure App Service and use managed identities for Azure resources</a></h4>
<div class="paragraph">
<p>This section describes how to associate an identity with the Azure resource for the app. This association is required so that Azure can apply security and track access.</p>
</div>
<div class="paragraph">
<p>One of the foundational principles of cloud computing is to pay for only the resources you use. Such fine-grained resource tracking is only possible if every resource is associated with an identity. Azure App Service and Azure Key Vault are two of the many Azure services that take advantage of managed identities for Azure resources. For more information about this important technology, see [What are managed identities for Azure resources?](/azure/active-directory/managed-identities-azure-resources/overview)</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
"Managed identities for Azure resources" is the new name for the service formerly known as Managed Service Identity (MSI).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Use the following steps to create the managed identity for the Azure App Service app and then allow that identity to access the Key Vault.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a managed identity for the App Service app. Replace the <code>&lt;your resource group name&gt;</code> and <code>&lt;your app name&gt;</code> placeholders with the values of the <code>&lt;resourceGroup&gt;</code> and <code>&lt;appName&gt;</code> elements from your <strong>pom.xml</strong> file.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">az webapp identity assign --resource-group &lt;your resource group name&gt; --name &lt;your app name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output will be similar to the following example. Note down the value of <code>principalId</code> for the next step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "principalId": "&lt;your principal ID&gt;",
  "tenantId": "&lt;your tenant ID&gt;",
  "type": "SystemAssigned",
  "userAssignedIdentities": null
}</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <strong>application.properties</strong> so that it names the managed identity for Azure resources created in the preceding step.</p>
<div class="ulist">
<ul>
<li>
<p>Remove the <code>spring.cloud.azure.keyvault.secret.property-sources[0].credential.client-secret</code>.</p>
</li>
<li>
<p>Update the <code>spring.cloud.azure.keyvault.secret.property-sources[0].credential.client-id</code> to have the value of the <code>principalId</code> from the preceding step. The completed file should now look like the following example.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">spring.cloud.azure.keyvault.secret.property-source-enabled=true
spring.cloud.azure.keyvault.secret.property-sources[0].credential.client-id=&lt;your principal ID&gt;
spring.cloud.azure.keyvault.secret.property-sources[0].credential.managed-identity-enabled=true
spring.cloud.azure.keyvault.secret.property-sources[0].profile.tenant-id=&lt;your tenant ID&gt;
spring.cloud.azure.keyvault.secret.property-sources[0].endpoint=https://contosokv.vault.azure.net/</code></pre>
</div>
</div>
</li>
<li>
<p>Configure the Key Vault to allow <code>get</code> and <code>list</code> operations from the managed identity. The value of the <code>object-id</code> is the <code>principalId</code> from the preceding output.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">az keyvault set-policy \
    --name &lt;your Key Vault name&gt; \
    --object-id &lt;your principal ID&gt; \
    --secret-permissions get list</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output will be a JSON object full of information about the Key Vault. It will have a <code>type</code> entry with value <code>Microsoft.KeyVault/vaults</code>. Here is the explanation of each property:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>name: The name of the Key Vault.</p>
</li>
<li>
<p>object-id: The <code>principalId</code> from the preceding command.</p>
</li>
<li>
<p>secret-permissions: The list of operations to allow from the named principal.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Package and redeploy the application.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mvn -DskipTests clean package azure-webapp:deploy</code></pre>
</div>
</div>
</li>
<li>
<p>For good measure, wait a few more minutes to allow the deployment to settle down. Then you may contact the deployment with a <code>curl</code> command similar to the one shown previously, but this time using the hostname shown in your <code>BUILD SUCCESS</code> output. The following example uses <code>contosokeyvault</code> as shown in the <code>BUILD SUCCESS</code> output from the previous section.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl https://contosokeyvault.azurewebsites.net/get</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following output indicates success.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">jdbc:sqlserver://SERVER.database.windows.net:1433;database=DATABASE;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of returning <code>defaultValue</code>, the app gets <code>connectionString</code> from the Key Vault.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="deploy-to-azure-spring-cloud"><a class="anchor" href="#deploy-to-azure-spring-cloud"></a><a class="link" href="#deploy-to-azure-spring-cloud">1.3.8. Deploy to Azure Spring Cloud</a></h4>
<div class="paragraph">
<p>In this section, you&#8217;ll deploy the app to Azure Spring Cloud.</p>
</div>
<div class="paragraph">
<p>Azure Spring Cloud is a fully managed platform for deploying and running your Spring Boot applications in Azure. For an overview of Azure Spring Cloud, see [What is Azure Spring Cloud?](/azure/spring-cloud/overview).</p>
</div>
<div class="paragraph">
<p>This section will use the Spring Boot app and Key Vault that you created previously with a new instance of Azure Spring Cloud.</p>
</div>
<div class="paragraph">
<p>The following steps will show how to create an Azure Spring Cloud resource and deploy the app to it. Make sure you&#8217;ve installed the Azure CLI extension for Azure Spring Cloud as shown in the [Prerequisites](#prerequisites).</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Decide on a name for the service instance. To use Azure Spring Cloud within your Azure subscription, you must create an Azure resource of type Azure Spring Cloud. As with all other Azure resources, the service instance must stay within a resource group. Use the resource group you already created to hold the service instance, and choose a name for your Azure Spring Cloud instance. Create the service instance with the following command.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">az spring-cloud create --resource-group &lt;your resource group name&gt; --name &lt;your Azure Spring Cloud instance name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command takes several minutes to complete.</p>
</div>
</li>
<li>
<p>Create a Spring Cloud App within the service.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">az spring-cloud app create \
    --resource-group &lt;your resource group name&gt; \
    --service &lt;your Azure Spring Cloud instance name&gt; \
    --name &lt;your app name&gt; \
    --assign-identity \
    --is-public true \
    --runtime-version Java_11 \</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the explanation of each property:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>resource-group: The name of the resource group where you created the existing service instance.</p>
</li>
<li>
<p>service: The name of the existing service.</p>
</li>
<li>
<p>name: The name of the app.</p>
</li>
<li>
<p>assign-identity:  Causes the service to create an identity for managed identities for Azure resources.</p>
</li>
<li>
<p>is-public:  Assign a public DNS domain name to the service.</p>
</li>
<li>
<p>runtime-version:  The Java runtime version. The value must match the value chosen in Spring Initializr above.</p>
<div class="paragraph">
<p>To understand the difference between <strong>service</strong> and <strong>app</strong>, see [App and deployment in Azure Spring Cloud](/azure/spring-cloud/concept-understand-app-and-deployment).</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Use the following command to get the managed identity for the Azure resource and use it to configure the existing Key Vault to allow access from this App.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">SERVICE_IDENTITY=$(az spring-cloud app show --resource-group "contosorg" --name "contosoascsapp" --service "contososvc" | jq -r '.identity.principalId')

az keyvault set-policy \
    --name &lt;your Key Vault name&gt; \
    --object-id &lt;the value of the environment variable SERVICE_IDENTITY&gt; \
    --secret-permissions set get list</code></pre>
</div>
</div>
</li>
<li>
<p>Because the existing Spring Boot app already has an <strong>application.properties</strong> file with the necessary configuration, we can deploy this app directly to Spring Cloud using the following command. Run the command in the directory containing the POM.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">az spring-cloud app deploy \
    --resource-group &lt;your resource group name&gt; \
    --name &lt;your Spring Cloud app name&gt; \
    --jar-path target/keyvault-0.0.1-SNAPSHOT.jar \
    --service &lt;your Azure Spring Cloud instance name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command creates a <strong>Deployment</strong> within the app, within the service. For more details on the concepts of service instances, apps, and Deployments see [App and deployment in Azure Spring Cloud](/azure/spring-cloud/concept-understand-app-and-deployment).</p>
</div>
<div class="paragraph">
<p>If the deployment isn&#8217;t successful, configure the logs for troubleshooting as described in [Configure application logs](<a href="https://aka.ms/azure-spring-cloud-configure-logs" class="bare">aka.ms/azure-spring-cloud-configure-logs</a>). The logs will likely have useful information to diagnose and resolve the problem.</p>
</div>
</li>
<li>
<p>When the app has been successfully deployed, you can use <code>curl</code> to verify the Key Vault integration is working. Because you specified <code>--is-public</code>, the default URL for your service is <code><a href="https://&lt;your" class="bare">&lt;your</a> Azure Spring Cloud instance name&gt;-&lt;your app name&gt;.azuremicroservices.io/</code>. The following command shows an example where the service instance name is <code>contososvc</code> and the app name is <code>contosoascsapp</code>. The URL appends the value of the <code>@GetMapping</code> annotation.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">   curl https://contososvc-contosoascsapp.azuremicroservices.io/get</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output will show <code>jdbc:sqlserver://SERVER.database.windows.net:1433;database=DATABASE</code>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="summary-2"><a class="anchor" href="#summary-2"></a><a class="link" href="#summary-2">1.3.9. Summary</a></h4>
<div class="paragraph">
<p>In this tutorial, you created a new Java web application using the Spring Initializr. You created an Azure Key Vault to store sensitive information, and then configured your application to retrieve information from your Key Vault. After testing it locally, you deployed the app to Azure App Service and Azure Spring Cloud.</p>
</div>
</div>
<div class="sect3">
<h4 id="clean-up-resources-2"><a class="anchor" href="#clean-up-resources-2"></a><a class="link" href="#clean-up-resources-2">1.3.10. Clean up resources</a></h4>
<div class="paragraph">
<p>When you&#8217;re finished with the Azure resources you created in this tutorial, you can delete them using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">az group delete –name &lt;your resource group name&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="azure-key-vault-certificates"><a class="anchor" href="#azure-key-vault-certificates"></a><a class="link" href="#azure-key-vault-certificates">1.4. Azure Key Vault certificates</a></h3>
<div class="paragraph">
<p>This tutorial shows you how to secure your Spring Boot (including Azure Spring Cloud) apps with TLS/SSL certificates using Azure Key Vault and managed identities for Azure resources.</p>
</div>
<div class="paragraph">
<p>Production-grade Spring Boot applications, whether in the cloud or on-premises, require end-to-end encryption for network traffic using standard TLS protocols. Most TLS/SSL certificates you come across are discoverable from a public root certificate authority (CA). Sometimes, however, this discovery isn&#8217;t possible. When certificates aren&#8217;t discoverable, the app must have some way to load such certificates, present them to inbound network connections, and accept them from outbound network connections.</p>
</div>
<div class="paragraph">
<p>Spring Boot apps typically enable TLS by installing the certificates. The certificates are installed into the local key store of the JVM that&#8217;s running the Spring Boot app. With Spring on Azure, certificates are not installed locally. Instead, Spring integration for Microsoft Azure provides a secure and frictionless way to enable TLS with help from Azure Key Vault and managed identity for Azure resources.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/160548968-523cbb6d-fffe-44a7-9dd7-563ffe6610db.png" alt="Azure KeyVault Certificates"></span></p>
</div>
<div class="paragraph">
<p>In this tutorial, you learn how to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a GNU/Linux VM with system-assigned managed identity</p>
</li>
<li>
<p>Create an Azure Key Vault</p>
</li>
<li>
<p>Create a self-signed TLS/SSL certificate</p>
</li>
<li>
<p>Store the self-signed TLS/SSL certificate in the Azure Key Vault</p>
</li>
<li>
<p>Run a Spring Boot application where the TLS/SSL certificate for inbound connection comes from Azure Key Vault</p>
</li>
<li>
<p>Run a Spring Boot application where the TLS/SSL certificate for outbound connection comes from Azure Key Vault</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="prerequisites-3"><a class="anchor" href="#prerequisites-3"></a><a class="link" href="#prerequisites-3">1.4.1. Prerequisites</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If you don&#8217;t have an <a href="https://docs.microsoft.com/azure/guides/developer/azure-developer-guide#understanding-accounts-subscriptions-and-billing">Azure subscription</a>, create a <a href="https://azure.microsoft.com/free/?ref=microsoft.com&amp;utm_source=microsoft.com&amp;utm_medium=docs&amp;utm_campaign=visualstudio">free account</a> before you begin.</p>
</li>
<li>
<p>The curl command. Most UNIX-like operating systems have this command pre-installed. OS-specific clients are available at <a href="https://curl.se/">the official curl website</a>.</p>
</li>
<li>
<p>The jq command. Most UNIX-like operating systems have this command pre-installed. OS-specific clients are available at <a href="https://stedolan.github.io/jq/">the official jq website</a>.</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli">Azure CLI</a>, version 2.14.1 or later</p>
</li>
<li>
<p>A supported Java Development Kit (JDK). For more information, see Java support on <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli">Azure and Azure Stack</a>.</p>
</li>
<li>
<p><a href="https://maven.apache.org/">Apache Maven</a>, version 3.0 or later.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Spring Boot version 2.5 or 2.6 is required to complete the steps in this article.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="create-a-gnulinux-vm-with-system-assigned-managed-identity"><a class="anchor" href="#create-a-gnulinux-vm-with-system-assigned-managed-identity"></a><a class="link" href="#create-a-gnulinux-vm-with-system-assigned-managed-identity">1.4.2. Create a GNU/Linux VM with system-assigned managed identity</a></h4>
<div class="paragraph">
<p>Use the following steps to create an Azure VM with a system-assigned managed identity and prepare it to run the Spring Boot application. For an overview of managed identities for Azure resources, see <a href="/azure/active-directory/managed-identities-azure-resources/overview">What are managed identities for Azure resources?</a>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open a Bash shell.</p>
</li>
<li>
<p>Sign out and delete some authentication files to remove any lingering credentials.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">az logout
rm ~/.azure/accessTokens.json
rm ~/.azure/azureProfile.json</code></pre>
</div>
</div>
</li>
<li>
<p>Sign in to your Azure CLI.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">az login</code></pre>
</div>
</div>
</li>
<li>
<p>Set the subscription ID. Be sure to replace the placeholder with the appropriate value.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">az account set -s &lt;your subscription ID&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Create an Azure resource group. Take note of the resource group name for later use.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">az group create \
    --name &lt;your resource group name&gt; \
    --location &lt;your resource group region&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Set default resource group.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">az configure --defaults group=&lt;your resource group name&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Create the VM instance with system-assigned managed identity enabled, using the image <code>UbuntuLTS</code> provided by <code>UbuntuServer</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">az vm create \
    --name &lt;your VM name&gt; \
    --debug \
    --generate-ssh-keys \
    --assign-identity \
    --image UbuntuLTS \
    --admin-username azureuser</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the JSON output, note down the value of the <code>publicIpAddress</code> and <code>systemAssignedIdentity</code> properties. You&#8217;ll use these values later in the tutorial.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The name <code>UbuntuLTS</code> is a Uniform Resource Name (URN) alias, which is a shortened version created for popular images like <strong>UbuntuLTS</strong>. Run the following command to display a cached list of popular images in table format:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">az vm image list --output table</code></pre>
</div>
</div>
</li>
<li>
<p>Install the Microsoft OpenJDK. For complete information about OpenJDK, see [Microsoft Build of OpenJDK](/java/openjdk).</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">ssh azureuser@&lt;your VM public IP address&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the repository. Replace the version placeholder in following commands and execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">wget https://packages.microsoft.com/config/ubuntu/{version}/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
sudo dpkg -i packages-microsoft-prod.deb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Install the Microsoft Build of OpenJDK by running the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">sudo apt install apt-transport-https
sudo apt update
sudo apt install msopenjdk-11</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Another, faster way to get set up the certified Azul Zulu for Azure – Enterprise Edition VM image, which can avoid the installation of Azure SDK. For complete information about Azul Zulu for Azure, see <a href="https://www.azul.com/downloads/azure-only/zulu/">Download Java for Azure</a> Run the following command to obtain the URN name.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">az vm image list \
    --offer Zulu \
    --location &lt;your region&gt; \
    --all | grep urn</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command may take a while to complete. When the command completes, it produces output similar to the following lines. Select the value for JDK 11 on Ubuntu.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">"urn": "azul:azul-zulu11-ubuntu-2004:zulu-jdk11-ubtu2004:20.11.0",
...
"urn": "azul:azul-zulu8-ubuntu-2004:zulu-jdk8-ubtu2004:20.11.0",
"urn": "azul:azul-zulu8-windows-2019:azul-zulu8-windows2019:20.11.0",</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the following command to accept the terms for the image to allow the VM to be created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">az vm image terms accept --urn azul:azul-zulu11-ubuntu-2004:zulu-jdk11-ubtu2004:20.11.0</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="create-and-configure-an-azure-key-vault"><a class="anchor" href="#create-and-configure-an-azure-key-vault"></a><a class="link" href="#create-and-configure-an-azure-key-vault">1.4.3. Create and configure an Azure Key Vault</a></h4>
<div class="paragraph">
<p>Use the following steps to create an Azure Key Vault, and to grant permission for the VM&#8217;s system-assigned managed identity to access the Key Vault for certificates.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create an Azure Key Vault within the resource group.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">az keyvault create \
    --name &lt;your Key Vault name&gt; \
    --location &lt;your resource group region&gt;
export KEY_VAULT_URI=$(az keyvault show --name &lt;your Key Vault name&gt; | jq -r '.properties.vaultUri')</code></pre>
</div>
</div>
<div class="paragraph">
<p>Take note of the <code>KEY_VAULT_URI</code> value. You&#8217;ll use it later.</p>
</div>
</li>
<li>
<p>Grant the VM permission to use the Key Vault for certificates.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">az keyvault set-policy \
    --name &lt;your Key Vault name&gt; \
    --object-id &lt;your system-assigned identity&gt; \
    --secret-permissions get list \
    --certificate-permissions get list import</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="create-and-store-a-self-signed-tlsssl-certificate"><a class="anchor" href="#create-and-store-a-self-signed-tlsssl-certificate"></a><a class="link" href="#create-and-store-a-self-signed-tlsssl-certificate">1.4.4. Create and store a self-signed TLS/SSL certificate</a></h4>
<div class="paragraph">
<p>The steps in this tutorial apply to any TLS/SSL certificate (including self-signed) stored directly in Azure Key Vault. Self-signed certificates aren&#8217;t suitable for use in production, but are useful for dev and test applications. This tutorial uses a self-signed certificate. To create the certificate, use the following command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">az keyvault certificate create \
  –vault-name &lt;your Key Vault name&gt; \
  –name mycert \
  –policy "$(az keyvault certificate get-default-policy)"</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="run-a-spring-boot-application-with-secure-inbound-connections"><a class="anchor" href="#run-a-spring-boot-application-with-secure-inbound-connections"></a><a class="link" href="#run-a-spring-boot-application-with-secure-inbound-connections">1.4.5. Run a Spring Boot application with secure inbound connections</a></h4>
<div class="paragraph">
<p>In this section, you&#8217;ll create a Spring Boot starter application where the TLS/SSL certificate for inbound connection comes from Azure Key Vault.</p>
</div>
<div class="paragraph">
<p>To create the application, use the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Browse to <a href="https://start.spring.io/" class="bare">start.spring.io/</a>.</p>
</li>
<li>
<p>Select the choices as shown in the picture following this list.</p>
<div class="ulist">
<ul>
<li>
<p><strong>Project</strong>: <strong>Maven Project</strong></p>
</li>
<li>
<p><strong>Language</strong>: <strong>Java</strong></p>
</li>
<li>
<p><strong>Spring Boot</strong>: <strong>2.5.10</strong></p>
</li>
<li>
<p><strong>Group</strong>: <strong>com.contoso</strong> (You can put any valid Java package name here.)</p>
</li>
<li>
<p><strong>Artifact</strong>: <strong>ssltest</strong> (You can put any valid Java class name here.)</p>
</li>
<li>
<p><strong>Packaging</strong>: <strong>Jar</strong></p>
</li>
<li>
<p><strong>Java</strong>: <strong>11</strong></p>
</li>
</ul>
</div>
</li>
<li>
<p>Select <strong>Add Dependencies&#8230;&#8203;</strong>.</p>
</li>
<li>
<p>In the text field, type <strong>Spring Web</strong> and press Ctrl+Enter.</p>
</li>
<li>
<p>In the text field type <strong>Azure Support</strong> and press Enter. Your screen should look like the following.</p>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/160551580-c39b27ff-ad45-4f8a-8aca-98f1aa0fe8fd.png" alt="Basic Spring Initializr options"></span></p>
</div>
</li>
<li>
<p>At the bottom of the page, select <strong>Generate</strong>.</p>
</li>
<li>
<p>When prompted, download the project to a path on your local computer. This tutorial uses a <strong>ssltest</strong> directory in the current user&#8217;s home directory. The values above will give you an <strong>ssltest.zip</strong> file in that directory.</p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="enable-the-spring-boot-app-to-load-the-tlsssl-certificate"><a class="anchor" href="#enable-the-spring-boot-app-to-load-the-tlsssl-certificate"></a><a class="link" href="#enable-the-spring-boot-app-to-load-the-tlsssl-certificate">Enable the Spring Boot app to load the TLS/SSL certificate</a></h5>
<div class="paragraph">
<p>To enable the app to load the certificate, use the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Unzip the <strong>ssltest.zip</strong> file.</p>
</li>
<li>
<p>Remove the <strong>test</strong> directory and its subdirectories. This tutorial ignores the test, so you can safely delete the directory.</p>
</li>
<li>
<p>Rename <strong>application.properties</strong> in <strong>src/main/resources</strong> to <strong>application.yml</strong>.</p>
</li>
<li>
<p>The file layout will look like the following.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">├── HELP.md
├── mvnw
├── mvnw.cmd
├── pom.xml
└── src
    └── main
        ├── java
        │   └── com
        │       └── contoso
        │           └── ssltest
        │               └── SsltestApplication.java
        └── resources
            ├── application.yml
            ├── static
            └── templates</code></pre>
</div>
</div>
</li>
<li>
<p>Modify the POM to add a dependency on <code>azure-spring-boot-starter-keyvault-certificates</code>. Add the following code to the <code>&lt;dependencies&gt;</code> section of the <strong>pom.xml</strong> file.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">&lt;dependency&gt;
  &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
  &lt;artifactId&gt;azure-spring-boot-starter-keyvault-certificates&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <strong>src/main/resources/application.yml</strong> file so that it has the following contents.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">server:
  ssl:
    key-alias: &lt;the name of the certificate in Azure Key Vault to use&gt;
    key-store-type: AzureKeyVault
    trust-store-type: AzureKeyVault
  port: 8443
azure:
  keyvault:
    uri: &lt;the URI of the Azure Key Vault to use&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>These values enable the Spring Boot app to perform the <strong>load</strong> action for the TLS/SSL certificate, as mentioned at the beginning of the tutorial. The following table describes the property values. Here is explanation of each property:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>server.port|The local TCP port on which to listen for HTTPS connections.</p>
</li>
<li>
<p>server.ssl.key-alias|The value of the <code>--name</code> argument you passed to <code>az keyvault certificate create</code>.</p>
</li>
<li>
<p>server.ssl.key-store-type|Must be <code>AzureKeyVault</code>.</p>
</li>
<li>
<p>server.ssl.trust-store-type|Must be <code>AzureKeyVault</code>.</p>
</li>
<li>
<p>azure.keyvault.uri|The <code>vaultUri</code> property in the return JSON from <code>az keyvault create</code>. You saved this value in an environment variable.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The only property specific to Key Vault is <code>azure.keyvault.uri</code>. The app is running on a VM whose system-assigned managed identity has been granted access to the Key Vault. Therefore, the app has also been granted access.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>These changes enable the Spring Boot app to load the TLS/SSL certificate. In the next section, you&#8217;ll enable the app to perform the <strong>accept</strong> action for the TLS/SSL certificate, as mentioned at the beginning of the tutorial.</p>
</div>
</div>
<div class="sect4">
<h5 id="create-a-spring-boot-rest-controller"><a class="anchor" href="#create-a-spring-boot-rest-controller"></a><a class="link" href="#create-a-spring-boot-rest-controller">Create a Spring Boot REST controller</a></h5>
<div class="paragraph">
<p>To create the REST controller, use the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Edit the <strong>src/main/java/com/contoso/ssltest/SsltestApplication.java</strong> file so that it has the following contents.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.contoso.ssltest;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@SpringBootApplication
@RestController
public class SsltestApplication {

    public static void main(String[] args) {
        SpringApplication.run(SsltestApplication.class, args);
    }

    @GetMapping(value = "/ssl-test")
    public String inbound(){
        return "Inbound TLS is working!!";
    }

    @GetMapping(value = "/exit")
    public void exit() {
        System.exit(0);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Calling <code>System.exit(0)</code> from within an unauthenticated REST GET call is only for demonstration purposes. Don&#8217;t use <code>System.exit(0)</code> in a real application.</p>
</div>
<div class="paragraph">
<p>This code illustrates the <strong>present</strong> action mentioned at the beginning of this tutorial. The following list highlights some details about this code:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>There&#8217;s now a <code>@RestController</code> annotation on the <code>SsltestApplication</code> class generated by Spring Initializr.</p>
</li>
<li>
<p>There&#8217;s a method annotated with <code>@GetMapping</code>, with a <code>value</code> for the HTTP call you&#8217;ll make.</p>
</li>
<li>
<p>The <code>inbound</code> method simply returns a greeting when a browser makes an HTTPS request to the <code>/ssl-test</code> path. The <code>inbound</code> method illustrates how the server presents the TLS/SSL certificate to the browser.</p>
</li>
<li>
<p>The <code>exit</code> method will cause the JVM to exit when invoked. This method is a convenience to make the sample easy to run in the context of this tutorial.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Open a new Bash shell and navigate to the <strong>ssltest</strong> directory. Run the following command.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mvn clean package</code></pre>
</div>
</div>
<div class="paragraph">
<p>Maven compiles the code and packages it up into an executable JAR file</p>
</div>
</li>
<li>
<p>Verify that the network security group created within <code>&lt;your resource group name&gt;</code> allows inbound traffic on ports 22 and 8443 from your IP address. To learn about configuring network security group rules to allow inbound traffic, see the [Work with security rules](/azure/virtual-network/manage-network-security-group#work-with-security-rules) section of [Create, change, or delete a network security group](/azure/virtual-network/manage-network-security-group).</p>
</li>
<li>
<p>Put the executable JAR file on the VM.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cd target
sftp azureuser@&lt;your VM public IP address&gt;
put *.jar</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="run-the-app-on-the-server"><a class="anchor" href="#run-the-app-on-the-server"></a><a class="link" href="#run-the-app-on-the-server">Run the app on the server</a></h5>
<div class="paragraph">
<p>Now that you&#8217;ve built the Spring Boot app and uploaded it to the VM, use the following steps to run it on the VM and call the REST endpoint with curl.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use SSH to connect to the VM, then run the executable jar.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">set -o noglob
ssh azureuser@&lt;your VM public IP address&gt; "java -jar *.jar"</code></pre>
</div>
</div>
</li>
<li>
<p>Open a new Bash shell and execute the following command to verify that the server presents the TLS/SSL certificate.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl --insecure https://&lt;your VM public IP address&gt;:8443/ssl-test</code></pre>
</div>
</div>
</li>
<li>
<p>Invoke the <code>exit</code> path to kill the server and close the network sockets.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl --insecure https://&lt;your VM public IP address&gt;:8443/exit</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now that you&#8217;ve seen the <strong>load</strong> and <strong>present</strong> actions with a self-signed TLS/SSL certificate, you&#8217;ll make some trivial changes to the app to see the <strong>accept</strong> action as well.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="run-a-spring-boot-application-with-secure-outbound-connections"><a class="anchor" href="#run-a-spring-boot-application-with-secure-outbound-connections"></a><a class="link" href="#run-a-spring-boot-application-with-secure-outbound-connections">1.4.6. Run a Spring Boot application with secure outbound connections</a></h4>
<div class="paragraph">
<p>In this section, you&#8217;ll modify the code in the previous section so that the TLS/SSL certificate for outbound connection comes from Azure Key Vault. Therefore, the <strong>load</strong>, <strong>present</strong>, and <strong>accept</strong> actions are satisfied from the Azure Key Vault.</p>
</div>
<div class="sect4">
<h5 id="modify-the-ssltestapplication-to-illustrate-outbound-tls-connections"><a class="anchor" href="#modify-the-ssltestapplication-to-illustrate-outbound-tls-connections"></a><a class="link" href="#modify-the-ssltestapplication-to-illustrate-outbound-tls-connections">Modify the SsltestApplication to illustrate outbound TLS connections</a></h5>
<div class="paragraph">
<p>Use the following steps to modify the application:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add the dependency on Apache HTTP Client by adding the following code to the <code>&lt;dependencies&gt;</code> section of the <strong>pom.xml</strong> file.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
   &lt;groupId&gt;org.apache.httpcomponents&lt;/groupId&gt;
   &lt;artifactId&gt;httpclient&lt;/artifactId&gt;
   &lt;version&gt;4.5.13&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Add a new rest endpoint called <code>ssl-test-outbound</code>. This endpoint opens up a TLS socket to itself and verifies that the TLS connection accepts the TLS/SSL certificate.</p>
<div class="paragraph">
<p>Replace the contents of <strong>SsltestApplication.java</strong> with the following code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.contoso.ssltest;

import java.security.KeyStore;
import javax.net.ssl.HostnameVerifier;
import javax.net.ssl.SSLContext;
import javax.net.ssl.SSLSession;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import com.azure.security.keyvault.jca.KeyVaultLoadStoreParameter;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.http.client.HttpComponentsClientHttpRequestFactory;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

import org.apache.http.conn.ssl.SSLConnectionSocketFactory;
import org.apache.http.conn.ssl.TrustSelfSignedStrategy;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.ssl.SSLContexts;

@SpringBootApplication
@RestController
public class SsltestApplication {

    public static void main(String[] args) {
        SpringApplication.run(SsltestApplication.class, args);
    }

    @GetMapping(value = "/ssl-test")
    public String inbound(){
        return "Inbound TLS is working!!";
    }

    @GetMapping(value = "/ssl-test-outbound")
    public String outbound() throws Exception {
        KeyStore azureKeyVaultKeyStore = KeyStore.getInstance("AzureKeyVault");
        KeyVaultLoadStoreParameter parameter = new KeyVaultLoadStoreParameter(
            System.getProperty("azure.keyvault.uri"));
        azureKeyVaultKeyStore.load(parameter);
        SSLContext sslContext = SSLContexts.custom()
                                           .loadTrustMaterial(azureKeyVaultKeyStore, null)
                                           .build();

        HostnameVerifier allowAll = (String hostName, SSLSession session) -&gt; true;
        SSLConnectionSocketFactory csf = new SSLConnectionSocketFactory(sslContext, allowAll);

        CloseableHttpClient httpClient = HttpClients.custom()
            .setSSLSocketFactory(csf)
            .build();

        HttpComponentsClientHttpRequestFactory requestFactory =
            new HttpComponentsClientHttpRequestFactory();

        requestFactory.setHttpClient(httpClient);
        RestTemplate restTemplate = new RestTemplate(requestFactory);
        String sslTest = "https://localhost:8443/ssl-test";

        ResponseEntity&lt;String&gt; response
            = restTemplate.getForEntity(sslTest, String.class);

        return "Outbound TLS " +
            (response.getStatusCode() == HttpStatus.OK ? "is" : "is not")  + " Working!!";
    }

    @GetMapping(value = "/exit")
    public void exit() {
        System.exit(0);
    }

}</code></pre>
</div>
</div>
</li>
<li>
<p>Build the app.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cd ssltest
mvn clean package</code></pre>
</div>
</div>
</li>
<li>
<p>Upload the app again using the same <code>sftp</code> command from earlier in this article.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cd target
sftp &lt;your VM public IP address&gt;
put *.jar</code></pre>
</div>
</div>
</li>
<li>
<p>Run the app on the VM.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">set -o noglob
ssh azureuser@&lt;your VM public IP address&gt; "java -jar *.jar"</code></pre>
</div>
</div>
</li>
<li>
<p>After the server is running, verify that the server accepts the TLS/SSL certificate. In the same Bash shell where you issued the previous <code>curl</code> command, run the following command.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl --insecure https://&lt;your VM public IP address&gt;:8443/ssl-test-outbound</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see the message <code>Outbound TLS is working!!</code>.</p>
</div>
</li>
<li>
<p>Invoke the <code>exit</code> path to kill the server and close the network sockets.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">   curl --insecure https://&lt;your VM public IP address&gt;:8443/exit</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You&#8217;ve now observed a simple illustration of the <strong>load</strong>, <strong>present</strong>, and <strong>accept</strong> actions with a self-signed TLS/SSL certificate stored in Azure Key Vault.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="clean-up-resources-3"><a class="anchor" href="#clean-up-resources-3"></a><a class="link" href="#clean-up-resources-3">1.4.7. Clean up resources</a></h4>
<div class="paragraph">
<p>When you&#8217;re finished with the Azure resources you created in this tutorial, you can delete them using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">az group delete –name &lt;your resource group name&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="azure-service-bus"><a class="anchor" href="#azure-service-bus"></a><a class="link" href="#azure-service-bus">1.5. Azure Service Bus</a></h3>
<div class="paragraph">
<p>This article demonstrates how to use Spring Boot Starter for Azure Service Bus JMS to send messages to and receive messages from Service Bus <code>queues</code> and <code>topics</code>.</p>
</div>
<div class="paragraph">
<p>Azure provides an asynchronous messaging platform called <a href="/azure/service-bus-messaging/service-bus-messaging-overview">Azure Service Bus</a> ("Service Bus") that is based on the <a href="http://www.amqp.org/">Advanced Message Queueing Protocol 1.0</a> ("AMQP 1.0") standard. Service Bus can be used across the range of supported Azure platforms.</p>
</div>
<div class="paragraph">
<p>The Spring Boot Starter for Azure Service Bus JMS provides Spring JMS integration with Service Bus.</p>
</div>
<div class="paragraph">
<p>The following video describes how to integrate Spring JMS applications with Azure Service Bus using JMS 2.0.</p>
</div>
<div class="videoblock">
<div class="content">
<video src="https://www.youtube.com/embed/9O3CALyoZHE?list=PLPeZXlCR7ew8LlhnSH63KcM0XhMKxT1k_" controls>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="sect3">
<h4 id="prerequisites-4"><a class="anchor" href="#prerequisites-4"></a><a class="link" href="#prerequisites-4">1.5.1. Prerequisites</a></h4>
<div class="paragraph">
<p>The following prerequisites are required for this article:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If you don&#8217;t have an <a href="https://docs.microsoft.com/azure/guides/developer/azure-developer-guide#understanding-accounts-subscriptions-and-billing">Azure subscription</a>, create a <a href="https://azure.microsoft.com/free/?ref=microsoft.com&amp;utm_source=microsoft.com&amp;utm_medium=docs&amp;utm_campaign=visualstudio">free account</a> before you begin.</p>
</li>
<li>
<p>A supported Java Development Kit (JDK). For more information, see Java support on <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli">Azure and Azure Stack</a>.</p>
</li>
<li>
<p><a href="https://maven.apache.org/">Apache Maven</a>, version 3.0 or later.</p>
</li>
<li>
<p>If you already have a configured Service Bus queue or topic, ensure that the Service Bus namespace meets the following requirements:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Allows access from all networks</p>
</li>
<li>
<p>Is Premium (or higher)</p>
</li>
<li>
<p>Has an access policy with read/write access for your queue and topic</p>
</li>
</ol>
</div>
</li>
<li>
<p>If you don&#8217;t have a configured Service Bus queue or topic, use the Azure portal to <a href="/azure/service-bus-messaging/service-bus-quickstart-portal">create a Service Bus queue</a> or <a href="/azure/service-bus-messaging/service-bus-quickstart-topics-subscriptions-portal">create a Service Bus topic</a>. Ensure that the namespace meets the requirements specified in the previous step. Also, make note of the connection string in the namespace as you need it for this tutorial&#8217;s test app.</p>
</li>
<li>
<p>If you don&#8217;t have a Spring Boot application, create a <strong>Maven</strong> project with the <a href="https://start.spring.io/">Spring Initializr</a>. Remember to select <strong>Maven Project</strong> and, under <strong>Dependencies</strong>, add the <strong>Web</strong> dependency, select <strong>8</strong> or <strong>11</strong> Java version.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Spring Boot version 2.5 or 2.6 is required to complete the steps in this article.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="use-the-azure-service-bus-jms-starter"><a class="anchor" href="#use-the-azure-service-bus-jms-starter"></a><a class="link" href="#use-the-azure-service-bus-jms-starter">1.5.2. Use the Azure Service Bus JMS starter</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Locate the <em>pom.xml</em> file in the parent directory of your app; for example: <code>C:\SpringBoot\servicebus\pom.xml</code>.</p>
</li>
<li>
<p>Open the <em>pom.xml</em> file in a text editor.</p>
</li>
<li>
<p>Add the Spring Boot Azure Service Bus JMS starter to the list of <code>&lt;dependencies&gt;</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">    &lt;dependency&gt;
      &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
      &lt;artifactId&gt;spring-cloud-azure-starter-servicebus-jms&lt;/artifactId&gt;
      &lt;version&gt;4.0.0&lt;/version&gt;
    &lt;/dependency&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Save and close the <strong>pom.xml</strong> file.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="configure-the-app-for-your-service-bus"><a class="anchor" href="#configure-the-app-for-your-service-bus"></a><a class="link" href="#configure-the-app-for-your-service-bus">1.5.3. Configure the app for your service bus</a></h4>
<div class="paragraph">
<p>In this section, you see how to configure your app to use either a Service Bus queue or topic.</p>
</div>
<div class="sect4">
<h5 id="use-a-service-bus-queue"><a class="anchor" href="#use-a-service-bus-queue"></a><a class="link" href="#use-a-service-bus-queue">Use a Service Bus queue</a></h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Locate the <strong>application.properties</strong> in the <strong>resources</strong> directory of your app; for example:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>C:\SpringBoot\servicebus\application.properties</p>
</li>
<li>
<p>/users/example/home/servicebus/application.properties</p>
</li>
</ol>
</div>
</li>
<li>
<p>Open the <strong>application.properties</strong> file in a text editor.</p>
</li>
<li>
<p>Append the following code to the end of the <strong>application.properties</strong> file. Replace the placeholder values with the appropriate values for your service bus, and do not put quotes around the values.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">spring.jms.servicebus.connection-string=&lt;ServiceBusNamespaceConnectionString&gt;
spring.jms.servicebus.idle-timeout=&lt;IdleTimeout&gt;
spring.jms.servicebus.pricing-tier=&lt;ServiceBusPricingTier&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Field descriptions</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>spring.jms.servicebus.connection-string</code>: Specify the connection string you obtained in your Service Bus namespace from the Azure portal.</p>
</li>
<li>
<p><code>spring.jms.servicebus.idle-timeout</code>: Specify the duration for idle.</p>
</li>
<li>
<p><code>spring.jms.servicebus.pricing-tier</code>: Specify the pricing tier of your service bus. Supported values are <strong>premium</strong>, <strong>standard</strong>, and <strong>basic</strong>. Premium uses Java Message Service (JMS) 2.0, while standard and basic use JMS 1.0 to interact with Azure Service Bus.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Save and close the <strong>application.properties</strong> file.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="use-service-bus-topic"><a class="anchor" href="#use-service-bus-topic"></a><a class="link" href="#use-service-bus-topic">Use Service Bus topic</a></h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Locate the <strong>application.properties</strong> in the <strong>resources</strong> directory of your app; for example:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>C:\SpringBoot\servicebus\application.properties</p>
</li>
<li>
<p>/users/example/home/servicebus/application.properties</p>
</li>
</ol>
</div>
</li>
<li>
<p>Open the <strong>application.properties</strong> file in a text editor.</p>
</li>
<li>
<p>Append the following code to the end of the <strong>application.properties</strong> file. Replace the placeholder values with the appropriate values for your service bus, and do not put quotes around the values.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">spring.jms.servicebus.connection-string=&lt;ServiceBusNamespaceConnectionString&gt;
spring.jms.servicebus.topic-client-id=&lt;ServiceBusSubscriptionID&gt;
spring.jms.servicebus.idle-timeout=&lt;IdleTimeout&gt;
spring.jms.servicebus.pricing-tier=&lt;ServiceBusPricingTier&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Field descriptions</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>spring.jms.servicebus.connection-string</code>: Specify the connection string you obtained in your Service Bus namespace from the Azure portal.</p>
</li>
<li>
<p><code>spring.jms.servicebus.topic-client-id</code>: Specify the JMS client ID, which is your Service Bus Subscription ID in the Azure portal.</p>
</li>
<li>
<p><code>spring.jms.servicebus.idle-timeout</code>: Specify the duration for idle.</p>
</li>
<li>
<p><code>spring.jms.servicebus.pricing-tier</code>: Specify the pricing tier of your service bus. Supported values are <strong>premium</strong>, <strong>standard</strong>, and <strong>basic</strong>. Premium uses Java Message Service (JMS) 2.0, while standard and basic use JMS 1.0 to interact with Azure Service Bus.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Save and close the <strong>application.properties</strong> file.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="implement-basic-service-bus-functionality"><a class="anchor" href="#implement-basic-service-bus-functionality"></a><a class="link" href="#implement-basic-service-bus-functionality">1.5.4. Implement basic Service Bus functionality</a></h4>
<div class="paragraph">
<p>In this section, you create the necessary Java classes for sending messages to your Service Bus queue or topic and receive messages from your corresponding queue or topic subscription.</p>
</div>
<div class="sect4">
<h5 id="modify-the-main-application-class"><a class="anchor" href="#modify-the-main-application-class"></a><a class="link" href="#modify-the-main-application-class">Modify the main application class</a></h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Locate the main application Java file in the package directory of your app; for example:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>C:\SpringBoot\servicebus\src\main\java\com\wingtiptoys\servicebus\ServiceBusJmsStarterApplication.java</p>
</li>
<li>
<p>/users/example/home/servicebus/src/main/java/com/wingtiptoys/servicebus/ServiceBusJmsStarterApplication.java</p>
</li>
</ol>
</div>
</li>
<li>
<p>Open the main application Java file in a text editor.</p>
</li>
<li>
<p>Add the following code to the file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.wingtiptoys.servicebus;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class ServiceBusJmsStarterApplication {

    public static void main(String[] args) {
        SpringApplication.run(ServiceBusJmsStarterApplication.class, args);
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Save and close the file.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="define-a-test-java-class"><a class="anchor" href="#define-a-test-java-class"></a><a class="link" href="#define-a-test-java-class">Define a test Java class</a></h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Using a text editor, create a Java file named <strong>User.java</strong> in the package directory of your app.</p>
</li>
<li>
<p>Define a generic user class that stores and retrieves user&#8217;s name:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.wingtiptoys.servicebus;

import java.io.Serializable;

// Define a generic User class.
public class User implements Serializable {

    private static final long serialVersionUID = -295422703255886286L;

    private String name;

    public User() {
    }

    public User(String name) {
        setName(name);
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Serializable</code> is implemented to use the <code>send</code> method in <code>JmsTemplate</code> in the Spring framework. Otherwise, a customized <code>MessageConverter</code> bean should be defined to serialize the content to json in text format. For more information about <code>MessageConverter</code>, see the official [Spring JMS starter project](<a href="https://spring.io/guides/gs/messaging-jms/" class="bare">spring.io/guides/gs/messaging-jms/</a>).</p>
</div>
</li>
<li>
<p>Save and close the <strong>User.java</strong> file.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="create-a-new-class-for-the-message-send-controller"><a class="anchor" href="#create-a-new-class-for-the-message-send-controller"></a><a class="link" href="#create-a-new-class-for-the-message-send-controller">Create a new class for the message send controller</a></h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Using a text editor, create a Java file named <strong>SendController.java</strong> in the package directory of your app</p>
</li>
<li>
<p>Add the following code to the new file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.wingtiptoys.servicebus;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jms.core.JmsTemplate;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class SendController {

    private static final String DESTINATION_NAME = "&lt;DestinationName&gt;";

    private static final Logger logger = LoggerFactory.getLogger(SendController.class);

    @Autowired
    private JmsTemplate jmsTemplate;

    @PostMapping("/messages")
    public String postMessage(@RequestParam String message) {
        logger.info("Sending message");
        jmsTemplate.convertAndSend(DESTINATION_NAME, new User(message));
        return message;
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Replace <code>&lt;DestinationName&gt;</code> with your own queue name or topic name configured in your Service Bus namespace.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Save and close the <strong>SendController.java</strong>.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="create-a-class-for-the-message-receive-controller"><a class="anchor" href="#create-a-class-for-the-message-receive-controller"></a><a class="link" href="#create-a-class-for-the-message-receive-controller">Create a class for the message receive controller</a></h5>
<div class="sect5">
<h6 id="receive-messages-from-a-service-bus-queue"><a class="anchor" href="#receive-messages-from-a-service-bus-queue"></a><a class="link" href="#receive-messages-from-a-service-bus-queue">Receive messages from a Service Bus queue</a></h6>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use a text editor to create a Java file named <strong>QueueReceiveController.java</strong> in the package directory of your app</p>
</li>
<li>
<p>Add the following code to the new file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    package com.wingtiptoys.servicebus;

    import org.slf4j.Logger;
    import org.slf4j.LoggerFactory;
    import org.springframework.jms.annotation.JmsListener;
    import org.springframework.stereotype.Component;

    @Component
    public class QueueReceiveController {

        private static final String QUEUE_NAME = "&lt;ServiceBusQueueName&gt;";

        private final Logger logger = LoggerFactory.getLogger(QueueReceiveController.class);

        @JmsListener(destination = QUEUE_NAME, containerFactory = "jmsListenerContainerFactory")
        public void receiveMessage(User user) {
            logger.info("Received message: {}", user.getName());
        }
    }</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Replace <code>&lt;ServiceBusQueueName&gt;</code> with your own queue name configured in your Service Bus namespace.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Save and close the <strong>QueueReceiveController.java</strong> file.</p>
</li>
</ol>
</div>
</div>
<div class="sect5">
<h6 id="receive-messages-from-a-service-bus-subscription"><a class="anchor" href="#receive-messages-from-a-service-bus-subscription"></a><a class="link" href="#receive-messages-from-a-service-bus-subscription">Receive messages from a Service Bus subscription</a></h6>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Using a text editor, create a Java file named <strong>TopicReceiveController.java</strong> in the package directory of your app.</p>
</li>
<li>
<p>Add the following code to the new file. Replace the <code>&lt;ServiceBusTopicName&gt;</code> placeholder with your own topic name configured in your Service Bus namespace. Replace the <code>&lt;ServiceBusSubscriptionName&gt;</code> placeholder with your own subscription name for your Service Bus topic.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.wingtiptoys.servicebus;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.jms.annotation.JmsListener;
import org.springframework.stereotype.Component;

@Component
public class TopicReceiveController {

    private static final String TOPIC_NAME = "&lt;ServiceBusTopicName&gt;";

    private static final String SUBSCRIPTION_NAME = "&lt;ServiceBusSubscriptionName&gt;";

    private final Logger logger = LoggerFactory.getLogger(TopicReceiveController.class);

    @JmsListener(destination = TOPIC_NAME, containerFactory = "topicJmsListenerContainerFactory",
            subscription = SUBSCRIPTION_NAME)
    public void receiveMessage(User user) {
        logger.info("Received message: {}", user.getName());
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Save and close the <strong>TopicReceiveController.java</strong> file.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="optional-service-bus-functionality"><a class="anchor" href="#optional-service-bus-functionality"></a><a class="link" href="#optional-service-bus-functionality">1.5.5. Optional Service Bus Functionality</a></h4>
<div class="paragraph">
<p>You can use a customized <code>MessageConverter</code> bean to convert between Java objects and JMS messages.</p>
</div>
<div class="sect4">
<h5 id="set-the-content-type-of-messages"><a class="anchor" href="#set-the-content-type-of-messages"></a><a class="link" href="#set-the-content-type-of-messages">Set the content-type of messages</a></h5>
<div class="paragraph">
<p>The following code example sets the <code>BytesMessage</code> content-type to <code>application/json</code>. For more information, see [Messages, payloads, and serialization](/azure/service-bus-messaging/service-bus-messages-payloads).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.wingtiptoys.servicebus;

import com.fasterxml.jackson.databind.ObjectWriter;
import org.apache.qpid.jms.message.JmsBytesMessage;
import org.apache.qpid.jms.provider.amqp.message.AmqpJmsMessageFacade;
import org.apache.qpid.proton.amqp.Symbol;
import org.springframework.jms.support.converter.MappingJackson2MessageConverter;
import org.springframework.jms.support.converter.MessageType;
import org.springframework.stereotype.Component;

import javax.jms.BytesMessage;
import javax.jms.JMSException;
import javax.jms.Session;
import java.io.IOException;

@Component
public class CustomMessageConverter extends MappingJackson2MessageConverter {

    private static final String TYPE_ID_PROPERTY = "_type";
    private static final Symbol CONTENT_TYPE = Symbol.valueOf("application/json");

    public CustomMessageConverter() {
        this.setTargetType(MessageType.BYTES);
        this.setTypeIdPropertyName(TYPE_ID_PROPERTY);
    }

    @Override
    protected BytesMessage mapToBytesMessage(Object object, Session session, ObjectWriter objectWriter)
        throws JMSException, IOException {
        final BytesMessage bytesMessage = super.mapToBytesMessage(object, session, objectWriter);
        JmsBytesMessage jmsBytesMessage = (JmsBytesMessage) bytesMessage;
        AmqpJmsMessageFacade facade = (AmqpJmsMessageFacade) jmsBytesMessage.getFacade();
        facade.setContentType(CONTENT_TYPE);
        return jmsBytesMessage;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information about <code>MessageConverter</code>, see the official <a href="https://spring.io/guides/gs/messaging-jms/">Spring JMS guide</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="set-session-id-in-jmstemplate"><a class="anchor" href="#set-session-id-in-jmstemplate"></a><a class="link" href="#set-session-id-in-jmstemplate">Set session-id in JmsTemplate</a></h5>
<div class="paragraph">
<p>Entities that have session support enabled, such as a session-enabled Service Bus queue, can only receive messages that have the <code>SessionId</code> set to a valid value. To send messages to such entities, use the <code>JmsTemplate.convertAndSend</code> method to set the string property "JMSXGroupID", which is mapped to the <code>SessionId</code> property, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@RestController
public class QueueSendController {

    private static final String QUEUE_NAME = "&lt;DestinationName&gt;";
    private static final Logger LOGGER = LoggerFactory.getLogger(QueueSendController.class);

    @Autowired
    private JmsTemplate jmsTemplate;

    @PostMapping("/queue")
    public String postMessage(@RequestParam String message) {

        LOGGER.info("Sending message");

        jmsTemplate.convertAndSend(QUEUE_NAME, new User(message), jmsMessage -&gt; {
            jmsMessage.setStringProperty("JMSXGroupID", "xxxeee");
            return jmsMessage;
        });
        return message;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="build-and-test-your-application"><a class="anchor" href="#build-and-test-your-application"></a><a class="link" href="#build-and-test-your-application">1.5.6. Build and test your application</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open a command prompt and change directory to the location of your <em>pom.xml</em>; for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cd C:\SpringBoot\servicebus</code></pre>
</div>
</div>
</li>
<li>
<p>Build your Spring Boot application with Maven and run it:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mvn clean spring-boot:run</code></pre>
</div>
</div>
</li>
<li>
<p>Once your application is running, you can use <em>curl</em> to test your application:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl -X POST localhost:8080/messages?message=hello</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="clean-up-resources-4"><a class="anchor" href="#clean-up-resources-4"></a><a class="link" href="#clean-up-resources-4">1.5.7. Clean up resources</a></h4>
<div class="paragraph">
<p>When no longer needed, use the <a href="https://portal.azure.com/">Azure portal</a> to delete the resources created in this article to avoid unexpected charges.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-data"><a class="anchor" href="#spring-data"></a><a class="link" href="#spring-data">2. Spring Data</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>TODO: finish this content.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-security"><a class="anchor" href="#spring-security"></a><a class="link" href="#spring-security">3. Spring Security</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>TODO: finish this content.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-cloud"><a class="anchor" href="#spring-cloud"></a><a class="link" href="#spring-cloud">4. Spring Cloud</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>TODO: finish this content.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="azure-app-configuration"><a class="anchor" href="#azure-app-configuration"></a><a class="link" href="#azure-app-configuration">5. Azure App Configuration</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>TODO: finish this content.</p>
</div>
</div>
</div>
<h1 id="tutorials" class="sect0"><a class="anchor" href="#tutorials"></a><a class="link" href="#tutorials">Tutorials</a></h1>
<div class="sect1">
<h2 id="deploy-to-app-service-and-azure-spring-cloud"><a class="anchor" href="#deploy-to-app-service-and-azure-spring-cloud"></a><a class="link" href="#deploy-to-app-service-and-azure-spring-cloud">6. <a href="https://spring.io/guides/gs/spring-boot-for-azure/">Deploy to App Service and Azure Spring Cloud</a></a></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="deploy-to-kubernetes"><a class="anchor" href="#deploy-to-kubernetes"></a><a class="link" href="#deploy-to-kubernetes">7. Deploy to Kubernetes</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>TODO: finish this content.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-to-web-app-for-containers"><a class="anchor" href="#deploy-to-web-app-for-containers"></a><a class="link" href="#deploy-to-web-app-for-containers">8. Deploy to Web App for Containers</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>TODO: finish this content.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="azure-redis-cache"><a class="anchor" href="#azure-redis-cache"></a><a class="link" href="#azure-redis-cache">9. Azure Redis Cache</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>TODO: finish this content.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="end-to-end-app-service-with-mysql"><a class="anchor" href="#end-to-end-app-service-with-mysql"></a><a class="link" href="#end-to-end-app-service-with-mysql">10. End-to-end App Service with MySQL</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>TODO: finish this content.</p>
</div>
</div>
</div>
<h1 id="sample" class="sect0"><a class="anchor" href="#sample"></a><a class="link" href="#sample">Sample</a></h1>
<div class="sect1">
<h2 id="to-do-list-with-cosmos-db"><a class="anchor" href="#to-do-list-with-cosmos-db"></a><a class="link" href="#to-do-list-with-cosmos-db">11. <a href="https://github.com/Microsoft/todo-app-java-on-azure/">To Do List with Cosmos DB</a></a></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="to-do-list-with-mysql"><a class="anchor" href="#to-do-list-with-mysql"></a><a class="link" href="#to-do-list-with-mysql">12. <a href="https://github.com/Azure-Samples/mysql-spring-boot-todo">To Do List with MySQL</a></a></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="spring-initializr"><a class="anchor" href="#spring-initializr"></a><a class="link" href="#spring-initializr">13. <a href="https://start.spring.io/">Spring Initializr</a></a></h2>
<div class="sectionbody">

</div>
</div>
<h1 id="reference" class="sect0"><a class="anchor" href="#reference"></a><a class="link" href="#reference">Reference</a></h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>This document is only for Spring Cloud Azure: <strong>4.1.0-beta.1</strong>. Please refer to <a href="https://github.com/Azure/azure-sdk-for-java/wiki/Spring-Versions-Mapping">Spring Versions Mapping</a> to get more information about supported versions.</p>
</div>
<div class="paragraph">
<p>&#169; 2016-2022 the original authors.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<em>Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically.</em>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Spring is an open-source application framework developed by VMware that provides a simplified, modular approach for creating Java applications. Spring Cloud Azure is an open-source project that provides seamless Spring integration with Azure services.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-help"><a class="anchor" href="#getting-help"></a><a class="link" href="#getting-help">14. Getting Help</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you have any questions about this document, please ask by creating GitHub issues. And Pull Request is welcome.</p>
</div>
<table class="tableblock frame-all grid-all fit-content stretch">
<caption class="title">Table 2. GitHub repositories</caption>
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">GitHub repositories</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/Azure/azure-sdk-for-java/tree/spring-cloud-azure-dependencies_4.1.0-beta.1/sdk/spring">Azure/azure-sdk-for-java</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This repository used to hold the source code.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/microsoft/spring-cloud-azure">microsoft/spring-cloud-azure</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This repository used to hold the document which is displaying in current page.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="what-is-new-in-4-0-since-3-10-x"><a class="anchor" href="#what-is-new-in-4-0-since-3-10-x"></a><a class="link" href="#what-is-new-in-4-0-since-3-10-x">15. What Is New in 4.0 Since 3.10.x</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This page covers changes made in 4.0 since 3.10. With this major release, we aim to bring better security, leaner dependencies, support for production readiness, and more.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To learn how to migrate to 4.0, please check <a href="appendix.html#migration-guide-for-4-0">the Appendix page</a>.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="unified-development-experience"><a class="anchor" href="#unified-development-experience"></a><a class="link" href="#unified-development-experience">15.1. Unified Development Experience</a></h3>
<div class="paragraph">
<p>We constantly challenge ourselves on how we can make things more consistent and easier to understand, so our customers are not confronted with haphazard development choices. This is a long and self-evolving journey as consistency is relative and there will be things that are outside our control. We now humbly take another step in this direction to improve our developer experience by unifying project name, artifact ID and properties.</p>
</div>
</div>
<div class="sect2">
<h3 id="simplified-dependency-management"><a class="anchor" href="#simplified-dependency-management"></a><a class="link" href="#simplified-dependency-management">15.2. Simplified Dependency Management</a></h3>
<div class="paragraph">
<p>Dependency management is one of the core value pillars that has helped Spring establish preeminence over to other Java frameworks. In that spirit, we have also been exploring ways to make dependency management easier for Spring developers on Azure. In this release, we have codified best practices and expertise from Spring experts and condensed all of our dependency BOMs into one, <code>spring-cloud-azure-dependencies</code>, which we believe will further bring down the learning curve and avoid ill-handling of dependencies.</p>
</div>
</div>
<div class="sect2">
<h3 id="expanded-support-scope-of-azure-support-on-start-spring-io"><a class="anchor" href="#expanded-support-scope-of-azure-support-on-start-spring-io"></a><a class="link" href="#expanded-support-scope-of-azure-support-on-start-spring-io">15.3. Expanded Support Scope of Azure Support on start.spring.io</a></h3>
<div class="paragraph">
<p>The Azure Support module in <a href="https://start.spring.io">Spring Initializr</a> provides auto-configuration of many Azure services.</p>
</div>
<div class="paragraph">
<p>In this release we have expanded the scope of Azure Support to cover the additional 4 more services:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Kafka</p>
</li>
<li>
<p>Event Hubs</p>
</li>
<li>
<p>Azure Cache for Redis</p>
</li>
<li>
<p>App Configuration</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Our journey does end here and over time we will bring even more Azure services into the fold.</p>
</div>
</div>
<div class="sect2">
<h3 id="untethered-and-unrestrained"><a class="anchor" href="#untethered-and-unrestrained"></a><a class="link" href="#untethered-and-unrestrained">15.4. Untethered and Unrestrained</a></h3>
<div class="paragraph">
<p>One feedback that we consistently hear is our Spring modules are unnecessarily stacked on top of too many layers of dependencies, which has prevented broader adoption. As an example, all of our early Spring modules rely on Spring Boot, and many of our customers are running Spring MVC apps in Tomcat, leveraging nothing but Spring Data, as an example, to communicate with data services. We now realize the flaw in our original design, and have rearchitected our Spring module dependencies from the ground up, untethered from layers of excess and entanglement.</p>
</div>
</div>
<div class="sect2">
<h3 id="more-control-and-secure"><a class="anchor" href="#more-control-and-secure"></a><a class="link" href="#more-control-and-secure">15.5. More Control and Secure</a></h3>
<div class="paragraph">
<p>At the heart of every real-world application, is identity and secret management. Support for managed identity has become an Azure fundamental that are getting mandated as a security baseline at individual services. We believe aligning on those guidelines will also benefit Spring developers at large, and have added Managed Identity support for App Configuration, Event Hub, Service Bus, Cosmos, Key Vault, Storage Blob, and Storage Queue. This enables building credential-free applications, which is a pattern that has picked up tremendous momentum both at Microsoft and in the community. In addition to Managed Identity, you can use any authentication methods supported in the underlying Azure SDK from our Spring libraries. For instance, you use SAS token and token credential to authenticate with Service Bus and Event Hubs. <a href="https://docs.microsoft.com/java/api/overview/azure/identity-readme?view=azure-java-stable#defaultazurecredential">Credential chain</a> is now enabled by default, allowing applications to obtain credentials from application properties, environment variables, managed identity, IDEs, etc. Lastly providing granular level access control at the resource level (i.e.: Service Bus queue), is often of paramount importance when it comes to meeting the needs of our enterprise customers. We’ve now unlocked these controls to our customers for better security governance and adherence to IT policies.</p>
</div>
</div>
<div class="sect2">
<h3 id="more-options-exposed-in-a-spring-idiomatic-way"><a class="anchor" href="#more-options-exposed-in-a-spring-idiomatic-way"></a><a class="link" href="#more-options-exposed-in-a-spring-idiomatic-way">15.6. More Options Exposed in a Spring Idiomatic Way</a></h3>
<div class="paragraph">
<p>Spring developers have long enjoyed the convenience of defining client options in application configuration files. We certainly do not want to take that privilege away and burden Spring developers with setting options via client objects. To that end, we’ve significantly improved autoconfiguration coverage of Azure SDK clients for both synchronous and asynchronous scenarios.</p>
</div>
</div>
<div class="sect2">
<h3 id="more-production-ready"><a class="anchor" href="#more-production-ready"></a><a class="link" href="#more-production-ready">15.7. More Production Ready</a></h3>
<div class="paragraph">
<p>Lastly all the above would be in vain if we do not have enough feature coverage to support our customers in production. Many things come to my mind to make an application production-ready, but observability often arrives at the top. We’ve added health indicators for App Configuration, Event Hubs, Cosmos, Key Vault, Storage Blob, Storage Queue, Storage File, as well as Spring Cloud Sleuth support for all HTTP-based Azure SDKs. As an example, you now can prob if storage blob is up or down via Spring Boot actuator endpoint, as well as track dependencies and latencies going from your application to Cosmos DB.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="migration-guide-for-4-0"><a class="anchor" href="#migration-guide-for-4-0"></a><a class="link" href="#migration-guide-for-4-0">16. Migration Guide for 4.0</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>To learn how to migrate to 4.0, please check <a href="appendix.html#migration-guide-for-4-0">the Appendix page</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-started"><a class="anchor" href="#getting-started"></a><a class="link" href="#getting-started">17. Getting Started</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="setting-up-dependencies"><a class="anchor" href="#setting-up-dependencies"></a><a class="link" href="#setting-up-dependencies">17.1. Setting up Dependencies</a></h3>
<div class="sect3">
<h4 id="bill-of-material-bom"><a class="anchor" href="#bill-of-material-bom"></a><a class="link" href="#bill-of-material-bom">17.1.1. Bill of Material (BOM)</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependencyManagement&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
      &lt;artifactId&gt;spring-cloud-azure-dependencies&lt;/artifactId&gt;
      &lt;version&gt;version&lt;/version&gt; <i class="conum" data-value="1"></i><b>(1)</b>
      &lt;type&gt;pom&lt;/type&gt;
      &lt;scope&gt;import&lt;/scope&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The version for spring-cloud-azure-dependencies is 4.1.0-beta.1.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="starter-dependencies"><a class="anchor" href="#starter-dependencies"></a><a class="link" href="#starter-dependencies">17.1.2. Starter Dependencies</a></h4>
<div class="paragraph">
<p>Spring Cloud Azure Starters are a set of convenient dependency descriptors to include in your application. Each starter includes all the dependencies and transitive dependencies needed to begin using its corresponding Spring Cloud Azure module. They boost your Spring Boot application development with Azure services.</p>
</div>
<div class="paragraph">
<p>For example, if you want to get started using Azure Cosmos DB for data persistence, include the <code>spring-cloud-azure-starter-cosmos</code> dependency in your project.</p>
</div>
<div class="paragraph">
<p>Spring Cloud Azure provides the following starters under the <code>com.azure.spring</code> group:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Spring Cloud Azure starters</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core starter, including autoconfiguration support</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-active-directory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Active Directory with Spring Security</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-active-directory-b2c</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Active Directory B2C with Spring Security</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-appconfiguration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure App Configuration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-cosmos</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Cosmos DB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-eventhubs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Event Hubs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-keyvault-secrets</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Key Vault Secrets</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-servicebus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Service Bus</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-servicebus-jms</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Service Bus and JMS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-storage-blob</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Storage Blob</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-storage-file-share</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Storage File Share</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-storage-queue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Storage Queue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-actuator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Spring Boot’s Actuator which provides production ready features</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Below are starters for <strong>Spring Data</strong> support:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Spring Data related starters</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-data-cosmos</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Cosmos DB and Spring Data Cosmos DB</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Below are starters for <strong>Spring Integration</strong> support:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Spring Integration related starters</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-integration-eventhubs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Event Hubs and Spring Integration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-integration-servicebus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Service Bus and Spring Integration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-integration-storage-queue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Storage Queue and Spring Integration</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Below are starters for <strong>Spring Cloud Stream</strong> support:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. Spring Cloud Stream related starters</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-stream-eventhubs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starters for using Azure Event Hubs and Spring Cloud Stream Binder</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-stream-servicebus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starter for using Azure Service Bus and Spring Cloud Stream Binder</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="learning-spring-cloud-azure"><a class="anchor" href="#learning-spring-cloud-azure"></a><a class="link" href="#learning-spring-cloud-azure">17.2. Learning Spring Cloud Azure</a></h3>
<div class="paragraph">
<p>We prepared a full list of samples to show the usages, can be found at <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.1.0-beta.1">Spring Cloud Azure Samples</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration"><a class="anchor" href="#configuration"></a><a class="link" href="#configuration">18. Configuration</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Most of Azure SDKs could be divided into two categories by transport type, HTTP-based and AMQP-based. There are properties that are common to all SDKs such as authentication principals and Azure environment settings. Or common to HTTP-based clients, such as logging level to log HTTP requests and responses. Spring Cloud Azure 4.0 provides five common categories of configuration properties, which could be specified to each Azure service.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. Service common properties</caption>
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong><em>&lt;azure-service&gt;</em>.client</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure the transport clients underneath one Azure service SDK.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong><em>&lt;azure-service&gt;</em>.credential</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure how to authenticate with Azure Active Directory for one Azure service SDK.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong><em>&lt;azure-service&gt;</em>.profile</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure the Azure cloud environment for one Azure service SDK.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong><em>&lt;azure-service&gt;</em>.proxy</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure the proxy options for one Azure service SDK.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong><em>&lt;azure-service&gt;</em>.retry</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure the retry options apply to one Azure service SDK. The retry options has supported part of the SDKs, there&#8217;s no <code>spring.cloud.azure.cosmos.retry</code>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>There are some properties that could be shared among different Azure services, for example using the same service principal to access Azure Cosmos DB and Azure Event Hubs. Spring Cloud Azure 4.0 allows application developers to specify properties that apply to all Azure SDKs with the prefix <code>spring.cloud.azure</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Global properties</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>client</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure the transport clients apply to all Azure SDKs by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>credential</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure how to authenticate with Azure Active Directory for all Azure SDKs by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>profile</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure the Azure cloud environment for all Azure SDKs by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>proxy</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure the proxy options apply to all Azure SDK clients by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>retry</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To configure the retry options apply to all Azure SDK clients by default.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Properties configured under each Azure service will override the global configurations.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Spring Cloud Azure unifies configuration properties' prefixes to <code>spring.cloud.azure</code> since 4.0, which will make configuration properties more consistent and more intuitive. Here&#8217;s a quick review of the serivce specific properties.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. Service specific properties</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Azure Service</th>
<th class="tableblock halign-left valign-top">Configuration Property Prefix</th>
<th class="tableblock halign-left valign-top">Configuration Properties Link</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure App Configuration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>appconfiguration</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="appendix.html#_azure_app_configuration_proeprties">App Configuration Properties</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Cosmos DB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>cosmos</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="appendix.html#_azure_cosmos_proeprties">Cosmos Properties</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Event Hubs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>eventhubs</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="appendix.html#_azure_event_hubs_proeprties">Event Hubs Properties</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Key Vault Certificates</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>keyvault.certificate</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="appendix.html#_azure_key_vault_certificates_proeprties">Key Vault Certificates Properties</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Key Vault Secrets</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>keyvault.secret</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="appendix.html#_azure_key_vault_secrets_proeprties">Key Vault Secrets Properties</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Service Bus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>servicebus</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="appendix.html#_azure_service_bus_proeprties">Service Bus Properties</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Storage Blob</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>storage.blob</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="appendix.html#_azure_storage_blob_proeprties">Storage Blob Properties</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Storage File Share</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>storage.fileshare</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="appendix.html#_azure_storage_file_share_proeprties">Storage File Share Properties</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Storage Queue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.azure.<strong>storage.queue</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="appendix.html#_azure_storage_queue_proeprties">Storage Queue Properties</a></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="authentication"><a class="anchor" href="#authentication"></a><a class="link" href="#authentication">19. Authentication</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="defaultazurecredential"><a class="anchor" href="#defaultazurecredential"></a><a class="link" href="#defaultazurecredential">19.1. DefaultAzureCredential</a></h3>
<div class="paragraph">
<p>The <code>DefaultAzureCredential</code> is appropriate for most scenarios where the application is intended to be run in the Azure Cloud. This is because the DefaultAzureCredential combines credentials commonly used to authenticate when deployed, with credentials used to authenticate in a development environment.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
DefaultAzureCredential is intended to simplify getting started with the SDK by handling common scenarios with reasonable default behaviors. Developers who want more control or whose scenario isn&#8217;t served by the default settings should use other credential types.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>DefaultAzureCredential</code> will attempt to authenticate via the following mechanisms in order.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://user-images.githubusercontent.com/13167207/143148654-f3a37180-85e2-4360-a47d-c1af2da8fada.png" alt="DefaultAzureCredential">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Environment - The <code>DefaultAzureCredential</code> will read account information specified via environment variables and use it to authenticate.</p>
</li>
<li>
<p>Managed Identity - If the application is deployed to an Azure host with Managed Identity enabled, the <code>DefaultAzureCredential</code> will authenticate with that account.</p>
</li>
<li>
<p>IntelliJ - If the developer has authenticated via Azure Toolkit for IntelliJ, the <code>DefaultAzureCredential</code> will authenticate with that account.</p>
</li>
<li>
<p>Visual Studio Code - If the developer has authenticated via the Visual Studio Code Azure Account plugin, the <code>DefaultAzureCredential</code> will authenticate with that account.</p>
</li>
<li>
<p>Azure CLI - If the developer has authenticated an account via the Azure CLI az login command, the <code>DefaultAzureCredential</code> will authenticate with that account.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="managed-identities"><a class="anchor" href="#managed-identities"></a><a class="link" href="#managed-identities">19.2. Managed Identities</a></h3>
<div class="paragraph">
<p>A common challenge for developers is the management of secrets and credentials used to secure communication between different components making up a solution. Managed identities eliminate the need for developers to manage credentials. Managed identities provide an identity for applications to use when connecting to resources that support Azure Active Directory (Azure AD) authentication. Applications may use the managed identity to obtain Azure AD tokens. For example, an application may use a managed identity to access resources like Azure Key Vault where developers can store credentials in a secure manner or to access storage accounts.</p>
</div>
<div class="paragraph">
<p>We encourage using managed identity instead of using connection string or key in your application for it&#8217;s more secure and will save the trouble of managing secrets and credentials. In this case, <code>DefaultAzureCredential</code> could better serve the scenario of developing locally using account information stored locally and deploying the application to Azure Cloud and using Managed Identity.</p>
</div>
<div class="sect3">
<h4 id="managed-identity-types"><a class="anchor" href="#managed-identity-types"></a><a class="link" href="#managed-identity-types">19.2.1. Managed Identity Types</a></h4>
<div class="paragraph">
<p>There are two types of managed identities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>System-assigned</strong> Some Azure services allow you to enable a managed identity directly on a service instance. When you enable a system-assigned managed identity an identity is created in Azure AD that&#8217;s tied to the lifecycle of that service instance. So when the resource is deleted, Azure automatically deletes the identity for you. By design, only that Azure resource can use this identity to request tokens from Azure AD.</p>
</li>
<li>
<p><strong>User-assigned</strong> You may also create a managed identity as a standalone Azure resource. You can create a user-assigned managed identity and assign it to one or more instances of an Azure service. In the case of user-assigned managed identities, the identity is managed separately from the resources that use it.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When using a user-assigned managed identity, you can specify the client ID by <code>spring.cloud.azure.credential.client-id</code> or <code>spring.cloud.azure.&lt;azure-service&gt;.credential.client-id</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Please refer to <a href="https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/overview">What are managed identities for Azure resources?</a> for more details about managed identity.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="other-credential-types"><a class="anchor" href="#other-credential-types"></a><a class="link" href="#other-credential-types">19.3. Other Credential Types</a></h3>
<div class="paragraph">
<p>Developers who want more control or whose scenario isn&#8217;t served by the <code>DefaultAzureCredential</code> or whose scenario isn&#8217;t served by the default settings should use other credential types.</p>
</div>
<div class="sect3">
<h4 id="authentication-and-authorization-with-azure-active-directory"><a class="anchor" href="#authentication-and-authorization-with-azure-active-directory"></a><a class="link" href="#authentication-and-authorization-with-azure-active-directory">19.3.1. Authentication and Authorization with Azure Active Directory</a></h4>
<div class="paragraph">
<p>With Azure AD, you can use Azure role-based access control (Azure RBAC) to grant permissions to a security principal, which may be a user or an application service principal. When a security principal (a user, or an application) attempts to access an Azure resource, for example, an Event Hubs resource, the request must be authorized. With Azure AD, access to a resource is a two-step process.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First, the security principal&#8217;s identity is authenticated, and an OAuth 2.0 token is returned.</p>
</li>
<li>
<p>Next, the token is passed as part of a request to the Azure service to authorize access to the specified resource.</p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="authenticate-with-azure-active-directory"><a class="anchor" href="#authenticate-with-azure-active-directory"></a><a class="link" href="#authenticate-with-azure-active-directory">Authenticate with Azure Active Directory</a></h5>
<div class="paragraph">
<p>For applications want to connect to resources that support Azure AD authentication, below configurations could be set with prefix <code>spring.cloud.azure.credential</code> or <code>spring.cloud.azure.&lt;azure-service&gt;.credential</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 10. Authentication properties</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">client-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client id to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">client-secret</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client secret to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">client-certificate-path</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path of a PEM certificate file to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">client-certificate-password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password of the certificate file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Username to use when performing username/password authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password to use when performing username/password authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">managed-identity-enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to enable managed identity.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To see the list of all Spring Cloud Azure related configuration properties please check <a href="appendix.html">the Appendix page</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="authorize-access-with-azure-active-directory"><a class="anchor" href="#authorize-access-with-azure-active-directory"></a><a class="link" href="#authorize-access-with-azure-active-directory">Authorize Access with Azure Active Directory</a></h5>
<div class="paragraph">
<p>The authorization step requires that one or more Azure roles be assigned to the security principal. The roles that are assigned to a security principal decide the permissions that the principal will have.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To see the list of all Azure built-in roles please check <a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles">Azure built-in roles</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Following are the Azure built-in roles for authorizing access to Azure services supported in Spring Cloud Azure:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 11. Azure built-in roles</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Role</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#app-configuration-data-owner">App Configuration Data Owner</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows full access to App Configuration data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#app-configuration-data-reader">App Configuration Data Reader</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows read access to App Configuration data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#azure-event-hubs-data-owner">Azure Event Hubs Data Owner</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows for full access to Azure Event Hubs resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#azure-event-hubs-data-receiver">Azure Event Hubs Data Receiver</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows receive access to Azure Event Hubs resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#azure-event-hubs-data-send">Azure Event Hubs Data Sender</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows send access to Azure Event Hubs resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#azure-service-bus-data-owner">Azure Service Bus Data Owner</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows for full access to Azure Service Bus resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#azure-service-bus-data-receiver">Azure Service Bus Data Receiver</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows for receive access to Azure Service Bus resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#azure-service-bus-data-sender">Azure Service Bus Data Sender</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows for send access to Azure Service Bus resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#storage-blob-data-owner">Storage Blob Data Owner</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides full access to Azure Storage blob containers and data, including assigning POSIX access control.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#storage-blob-data-reader">Storage Blob Data Reader</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read and list Azure Storage containers and blobs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#storage-queue-data-reader">Storage Queue Data Reader</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read and list Azure Storage queues and queue messages.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#redis-cache-contributor">Redis Cache Contributor</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Manage Redis caches.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When using Spring Cloud Azure Resource Manager to get the connection strings of Event Hubs, Service Bus, and Storage Queue, or properties of Cache for Redis, assign the Azure built-in role <code>Contributor</code>. Azure Cache for Redis is special, and you can also assign the <code>Redis Cache Contributor</code> role to get the Redis properties.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A Key Vault access policy determines whether a given security principal, namely a user, application or user group, can perform different operations on Key Vault secrets, keys, and certificates. You can assign access policies using the Azure portal, the Azure CLI, or Azure PowerShell. Check <a href="https://docs.microsoft.com/azure/key-vault/general/assign-access-policy">here</a> for more details.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Azure Cosmos DB exposes 2 built-in role definitions: <code>Cosmos DB Built-in Data Reader</code> and <code>Cosmos DB Built-in Data Contributor</code>. However, Azure portal support for role management isn&#8217;t available yet. Check <a href="https://docs.microsoft.com/azure/cosmos-db/how-to-setup-rbac">here</a> for more details about the permission model, role definitions, and role assignment.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sas-tokens"><a class="anchor" href="#sas-tokens"></a><a class="link" href="#sas-tokens">19.3.2. SAS tokens</a></h4>
<div class="paragraph">
<p>It&#8217;s also configurable for services support authenticating with Shared Access Signature (SAS). <code>spring.cloud.azure.&lt;azure-service&gt;.sas-token</code> is the property to configure. For example, using <code>spring.cloud.azure.storage.blob.sas-token</code> to authenticate to Storage Blob service.</p>
</div>
</div>
<div class="sect3">
<h4 id="connection-strings"><a class="anchor" href="#connection-strings"></a><a class="link" href="#connection-strings">19.3.3. Connection Strings</a></h4>
<div class="paragraph">
<p>Connection strings are supported by some Azure services to provide connection information as well as credentials. To connect to those Azure services using a connection string, just configure <code>spring.cloud.azure.&lt;azure-service&gt;.connection-string</code> will do. For example, <code>spring.cloud.azure.eventhubs.connection-string</code> to connect to Event Hubs service.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="production-ready"><a class="anchor" href="#production-ready"></a><a class="link" href="#production-ready">20. Production Ready</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Cloud Azure 4.0 supports health indicators for App Configuration, Event Hubs, Cosmos, Key Vault Certificate, Key Vault Secret, Storage Blob, Storage Queue, and Storage File Share. It also provides integrations with Spring Cloud Sleuth for all HTTP-based Azure SDKs. As an example, you now can prob if storage blob is up or down via Spring Boot actuator endpoint, as well as track dependencies and latencies going from your application to Key Vault.</p>
</div>
<div class="sect2">
<h3 id="enable-health-indicator"><a class="anchor" href="#enable-health-indicator"></a><a class="link" href="#enable-health-indicator">20.1. Enable Health Indicator</a></h3>
<div class="paragraph">
<p>Add the Spring Cloud Azure Actuator Starter dependency. This dependency will also include the <code>spring-boot-starter-actuator</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-actuator&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 12. Configurable properties to enable or disable health indicators for each Azure service</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Azure Service</th>
<th class="tableblock halign-left valign-top">Property</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">App Configuration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">management.health.<strong>azure-appconfiguration</strong>.enabled</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cosmos DB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">management.health.<strong>azure-cosmos</strong>.enabled</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event Hubs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">management.health.<strong>azure-eventhubs</strong>.enabled</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key Vault Certificate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">management.health.<strong>azure-keyvault-certificate</strong>.enabled</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key Vault Secret</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">management.health.<strong>azure-keyvault-secret</strong>.enabled</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage Blob</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">management.health.<strong>azure-storage-blob</strong>.enabled</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage File Share</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">management.health.<strong>azure-storage-fileshare</strong>.enabled</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage Queue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">management.health.<strong>azure-storage-queue</strong>.enabled</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Calling the health endpoint of Azure services may cause extra charge. For example, calling <code><a href="http://HOST_NAME:{port}/actuator/health/cosmos" class="bare">HOST_NAME:{port}/actuator/health/cosmos</a></code> to get the Cosmos DB health info, it will calculate <a href="https://docs.microsoft.com/azure/cosmos-db/request-units">RUs</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="enable-sleuth"><a class="anchor" href="#enable-sleuth"></a><a class="link" href="#enable-sleuth">20.2. Enable Sleuth</a></h3>
<div class="paragraph">
<p>Add the Spring Cloud Azure Trace Sleuth dependency when you want to trace Azure SDK activities with using Spring Cloud Sleuth.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-trace-sleuth&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Only HTTP-based Azure SDK clients are supported now, for example, Eventhub and ServiceBus with AMQP transport are currently not supported, we recommend to use <a href="https://docs.microsoft.com/azure/azure-monitor/app/app-insights-overview">Azure Application Insights</a> for such requirement.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="autoconfigure-azure-sdk-clients"><a class="anchor" href="#autoconfigure-azure-sdk-clients"></a><a class="link" href="#autoconfigure-azure-sdk-clients">21. Autoconfigure Azure SDK Clients</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Boot simplifies the Spring Cloud Azure development experience. Spring Cloud Azure starters are a set of convenient dependency descriptors to include in your application. They handle the object instantiation and configuration logic, so you don’t have to. Every starter depends on the <code>spring-cloud-azure-starter</code> to provide critical bits of configuration, like the Azure cloud environment and authentication information. You can configure these as properties in, for example, a yaml file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      profile:
        tenant-id: ${AZURE_TENANT_ID}
        cloud-type: Azure <i class="conum" data-value="1"></i><b>(1)</b>
      credential:
        client-id: ${AZURE_CLIENT_ID}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>cloud-type</code> is optional for it has default value set to <code>Azure</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>These properties are optional and, if not specified, Spring Boot will try to automatically find them for you. For details on how Spring Boot finds these properties, refer to the documentation.</p>
</div>
<div class="sect2">
<h3 id="dependency-setup"><a class="anchor" href="#dependency-setup"></a><a class="link" href="#dependency-setup">21.1. Dependency Setup</a></h3>
<div class="paragraph">
<p>There are two ways to use Spring Cloud Azure starters. One is using Azure SDKs with this <code>spring-cloud-azure-starter</code> dependency. For example with Cosmos DB:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.azure&lt;/groupId&gt;
    &lt;artifactId&gt;azure-cosmos&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or including the Spring Cloud Azure starter directly without adding Azure SDK dependencies. For example with Cosmos DB:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-cosmos&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Please refer to <a href="index.html#starter-dependencies">Starter Dependencies</a> for the list of starters Spring Cloud Azure supports.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="configuration-2"><a class="anchor" href="#configuration-2"></a><a class="link" href="#configuration-2">21.2. Configuration</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Configuration properties for each Azure service are under prefix <code>spring.cloud.azure.&lt;azure-service&gt;</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To see the list of all Spring Cloud Azure related configuration properties please check <a href="appendix.html">the Appendix page</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="basic-usage"><a class="anchor" href="#basic-usage"></a><a class="link" href="#basic-usage">21.3. Basic Usage</a></h3>
<div class="paragraph">
<p>Adding below properties to your <code>application.yaml</code> will autoconfigure the Cosmos clients for you, both <code>CosmosClient</code> and <code>CosmosAsyncClient</code> are available in the context and could be autowired.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      cosmos:
        database: ${AZURE_COSMOS_DATABASE_NAME}
        endpoint: ${AZURE_COSMOS_ENDPOINT}
        consistency-level: eventual
        connection-mode: direct</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">class Demo {
    @Autowired
    private CosmosClient cosmosClient;

    @Override
    public void run() {
        User item = User.randomUser();
        CosmosContainer container = cosmosClient.getDatabase(databaseName).getContainer(containerName);
        container.createItem(item);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="samples"><a class="anchor" href="#samples"></a><a class="link" href="#samples">21.4. Samples</a></h3>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.1.0-beta.1">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="resource-handling"><a class="anchor" href="#resource-handling"></a><a class="link" href="#resource-handling">22. Resource Handling</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring project provides <a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#resources">Spring Resources</a> abstraction to access a number of low-level resources. It provides interfaces like <code>Resource</code>, <code>ResourceLoader</code> and <code>ResourcePatternResolver</code>. Spring Cloud Azure implements these interfaces for Azure Storage services which allows you to interact with Azure Storage Blob and File Share using Spring programming model. It provides <code>spring-cloud-azure-starter-storage-blob</code> and <code>spring-cloud-azure-starter-storage-file-share</code> to autoconfigure Azure Storage Blob and Azure Storage File Share.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 13. Azure Storage related libraries.</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 12.5%;">
<col style="width: 62.5%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Starter</th>
<th class="tableblock halign-left valign-top">Service</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-storage-blob</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Storage Blob</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows unstructured data to be stored and accessed at a massive scale in block blobs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-cloud-azure-starter-storage-file-share</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Storage File Share</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Offers fully managed cloud file shares that you can access from anywhere via the industry standard Server Message Block (SMB) protocol.</p></td>
</tr>
</tbody>
</table>
<div class="sect2">
<h3 id="dependency-setup-2"><a class="anchor" href="#dependency-setup-2"></a><a class="link" href="#dependency-setup-2">22.1. Dependency Setup</a></h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-storage-blob&lt;/artifactId&gt; <i class="conum" data-value="1"></i><b>(1)</b>
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-storage-file-share&lt;/artifactId&gt; <i class="conum" data-value="2"></i><b>(2)</b>
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Only required when you&#8217;re using Azure Storage Blob.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Only required when you&#8217;re using Azure Storage File Share.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="configuration-3"><a class="anchor" href="#configuration-3"></a><a class="link" href="#configuration-3">22.2. Configuration</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 14. Configurable properties of spring-cloud-azure-starter-storage-blob</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 11.1111%;">
<col style="width: 55.5556%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.blob</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to enable Azure Storage Blob.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.blob</strong>.endpoint</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Endpoint for Azure Storage Blob service.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.blob</strong>.account-key</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Private key to connect Azure Storage Blob.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.blob</strong>.account-name</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Storage Blob account name.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 15. Configurable properties of spring-cloud-azure-starter-storage-file-share</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 11.1111%;">
<col style="width: 55.5556%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.fileshare</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to enable Azure Storage File Share.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.fileshare</strong>.endpoint</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Endpoint for Azure Storage File Share service.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.fileshare</strong>.account-key</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Private key to connect Azure Storage File Share.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.fileshare</strong>.account-name</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Storage File Share account name.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="basic-usage-2"><a class="anchor" href="#basic-usage-2"></a><a class="link" href="#basic-usage-2">22.3. Basic Usage</a></h3>
<div class="paragraph">
<p>Provide the properties below in your configuration file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      storage:
        blob:
          account-name: ${STORAGE_ACCOUNT_NAME}
          account-key: ${STORAGE_ACCOUNT_KEY}
          endpoint: ${STORAGE_BLOB_ENDPOINT}
        fileshare:
          account-name: ${STORAGE_ACCOUNT_NAME}
          account-key: ${STORAGE_ACCOUNT_KEY}
          endpoint:  ${STORAGE_FILESHARE_ENDPOINT}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="get-a-resource"><a class="anchor" href="#get-a-resource"></a><a class="link" href="#get-a-resource">22.3.1. Get a Resource</a></h4>
<div class="sect4">
<h5 id="get-a-resource-with-value"><a class="anchor" href="#get-a-resource-with-value"></a><a class="link" href="#get-a-resource-with-value">Get a Resource with @Value</a></h5>
<div class="paragraph">
<p>You can use the annotation of <code>@Value("azure-blob://[your-container-name]/[your-blob-name]")</code> to autowire a blob resource.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Value("azure-blob://[your-container-name]/[your-blob-name]")
private Resource storageBlobResource;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use the annotation of @Value("azure-file://[your-fileshare-name]/[your-file-name]") to autowire a file resource.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Value("azure-file://[your-fileshare-name]/[your-file-name]")
private Resource storageFileResource;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="get-a-resource-with-resourceloader"><a class="anchor" href="#get-a-resource-with-resourceloader"></a><a class="link" href="#get-a-resource-with-resourceloader">Get a Resource with ResourceLoader</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Autowired
private ResourceLoader resourceLoader;
...
// get a BlobResource
Resource storageBlobResource = resourceLoader.getResource("azure-blob://[your-container-name]/[your-blob-name]");
// get a FileResource
Resource storageFileResource = resourceLoader.getResource("azure-file://[your-fileshare-name]/[your-file-name]");</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="get-resources-by-searching-pattern"><a class="anchor" href="#get-resources-by-searching-pattern"></a><a class="link" href="#get-resources-by-searching-pattern">Get Resources by Searching Pattern</a></h5>
<div class="paragraph">
<p>You can use implementation class of <code>ResourcePatternResolver</code> to search resources. Use <code>AzureStorageBlobProtocolResolver</code> to search <code>blob</code> resources, and <code>AzureStorageFileProtocolResolver</code> to search <code>file</code> resources.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pattern search, the <strong>searchPattern</strong> should start with <code>azure-blob://</code> or <code>azure-file://</code>. Such as <code>azure-blob://**/**</code>, it means list all blobs in all containers; <code>azure-blob://demo-container/**</code>, it means list all blobs in the demo-container container, including any sub-folders.</p>
</li>
<li>
<p>Location search, the <strong>searchLocation</strong> should start with <code>azure-blob://</code> or <code>azure-file://</code>, the remaining file path should exist, otherwise an exception will be thrown.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Autowired
private AzureStorageBlobProtocolResolver azureStorageBlobProtocolResolver;

@Autowired
private AzureStorageFileProtocolResolver azureStorageFileProtocolResolver;

// get all text blobs
Resource[] blobTextResources = azureStorageBlobProtocolResolver.getResources("azure-blob://[container-pattern]/*.txt");
// get all text files
Resource[] fileTextResources = azureStorageFileProtocolResolver.getResources("azure-file://[fileshare-pattern]/*.txt");</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="handling-with-resource"><a class="anchor" href="#handling-with-resource"></a><a class="link" href="#handling-with-resource">22.3.2. Handling with Resource</a></h4>
<div class="sect4">
<h5 id="download-data-from-specific-resource"><a class="anchor" href="#download-data-from-specific-resource"></a><a class="link" href="#download-data-from-specific-resource">Download Data from Specific Resource</a></h5>
<div class="paragraph">
<p>You can download a resource from Azure Stroage Blob or File Share with the <code>getInputStream()</code> method of <code>Resource</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Value("azure-blob://[your-container-name]/[your-blob-name]")
private Resource storageBlobResource;

@Value("azure-file://[your-fileshare-name]/[your-file-name]")
private Resource storageFileResource;

....

// download data as stream from blob resource
InputStream inputblobStream = storageBlobResource.getInputStream();
// download data as stream from file resource
InputStream inputfileStream = storageFileResource.getInputStream();</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="upload-data-to-specific-resource"><a class="anchor" href="#upload-data-to-specific-resource"></a><a class="link" href="#upload-data-to-specific-resource">Upload Data to Specific Resource</a></h5>
<div class="paragraph">
<p>You can upload to a resource to Azure Storage Blob or File Share by casting the Spring <code>Resource</code> to <code>WritableResource</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Value("azure-blob://[your-container-name]/[your-blob-name]")
private Resource storageBlobResource;

@Value("azure-file://[your-fileshare-name]/[your-file-name]")
private Resource storageFileResource;

String data = "sampledata";

// upload string data to blob
try (OutputStream blobos = ((WritableResource) this.storageBlobResource).getOutputStream()) {
  blobos.write(data.getBytes());
}
// upload string data to file
try (OutputStream fileos = ((WritableResource) this.storageFileResource).getOutputStream()) {
  fileos.write(data.getBytes());
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="multipart-upload"><a class="anchor" href="#multipart-upload"></a><a class="link" href="#multipart-upload">22.3.3. Multipart Upload</a></h4>
<div class="paragraph">
<p>Files larger than 4 MiB will be uploaded to Azure Storage in parallel.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="samples-2"><a class="anchor" href="#samples-2"></a><a class="link" href="#samples-2">22.4. Samples</a></h3>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.1.0-beta.1/storage/spring-cloud-azure-starter-storage-blob/storage-blob-sample">storage-blob-sample</a> and <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.1.0-beta.1/storage/spring-cloud-azure-starter-storage-file-share/storage-file-sample">storage-file-sample</a> for more details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="secret-management"><a class="anchor" href="#secret-management"></a><a class="link" href="#secret-management">23. Secret Management</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Cloud Azure construct <a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-property-source-abstraction">PropertySource</a> which holds secrets stored in Azure Key Vault Secrets.</p>
</div>
<div class="sect2">
<h3 id="dependency-setup-3"><a class="anchor" href="#dependency-setup-3"></a><a class="link" href="#dependency-setup-3">23.1. Dependency Setup</a></h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-keyvault-secrets&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="basic-usage-3"><a class="anchor" href="#basic-usage-3"></a><a class="link" href="#basic-usage-3">23.2. Basic Usage</a></h3>
<div class="paragraph">
<p>If you want to authenticate by <code>client-id</code> and <code>client-secret</code>, the following properties are required:</p>
</div>
<div class="sect3">
<h4 id="configuration-properties"><a class="anchor" href="#configuration-properties"></a><a class="link" href="#configuration-properties">23.2.1. Configuration Properties</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">spring:
  cloud:
    azure:
      keyvault:
        secret:
          property-sources:
            - name: key-vault-property-souece-1
              endpoint: ${ENDPOINT_1}
            - name: key-vault-property-souece-2
              endpoint: ${ENDPOINT_2}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="java-code"><a class="anchor" href="#java-code"></a><a class="link" href="#java-code">23.2.2. Java Code</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@SpringBootApplication
public class SampleApplication implements CommandLineRunner {

    @Value("${sampleProperty1}")
    private String sampleProperty1;
    @Value("${sampleProperty2}")
    private String sampleProperty2;
    @Value("${samplePropertyInMultipleKeyVault}")
    private String samplePropertyInMultipleKeyVault;

    public static void main(String[] args) {
        SpringApplication.run(SampleApplication.class, args);
    }

    public void run(String[] args) {
        System.out.println("sampleProperty1: " + sampleProperty1);
        System.out.println("sampleProperty2: " + sampleProperty2);
        System.out.println("samplePropertyInMultipleKeyVault: " + samplePropertyInMultipleKeyVault);
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="advanced-usage"><a class="anchor" href="#advanced-usage"></a><a class="link" href="#advanced-usage">23.3. Advanced Usage</a></h3>
<div class="sect3">
<h4 id="special-characters-in-property-name"><a class="anchor" href="#special-characters-in-property-name"></a><a class="link" href="#special-characters-in-property-name">23.3.1. Special Characters in Property Name</a></h4>
<div class="paragraph">
<p>Key Vault secret name only support characters in <code>[0-9a-zA-Z-]</code>. Refs: <a href="https://docs.microsoft.com/azure/key-vault/general/about-keys-secrets-certificates#vault-name-and-object-name">Vault-name and Object-name</a>. If your property name contains other characters, you can use these workarounds:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use <code>-</code> instead of <code>.</code> in secret name. <code>.</code> isn&#8217;t supported in secret name. If your application have property name which contains <code>.</code>, like <code>spring.datasource.url</code>, just replace <code>.</code> to <code>-</code> when save secret in Azure Key Vault. For example: Save <code>spring-datasource-url</code> in Azure Key Vault. In your application, you can still use <code>spring.datasource.url</code> to retrieve property value.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This method can not satisfy requirement like <code>spring.datasource-url</code>. When you save <code>spring-datasource-url</code> in Key Vault, only <code>spring.datasource.url</code> and <code>spring-datasource-url</code> is supported to retrieve property value, <code>spring.datasource-url</code> isn&#8217;t supported. To handle this case, please refer to the following option: Use property placeholders.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Use property placeholders. For example: setting this property in your application.properties: <code>property.with.special.character_=${propertyWithoutSpecialCharacter}</code>. The application will get  <code>propertyWithoutSpecialCharacter</code> key name and assign its value to <code>property.with.special.character_</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="case-sensitive"><a class="anchor" href="#case-sensitive"></a><a class="link" href="#case-sensitive">23.3.2. Case Sensitive</a></h4>
<div class="paragraph">
<p>By default, the secret names are case-insensitive. To enable case-sensitive mode, just set the following property: <code>spring.cloud.azure.keyvault.secret.property-sources[].case-sensitive=true</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="not-retrieve-all-secrets-in-key-vault"><a class="anchor" href="#not-retrieve-all-secrets-in-key-vault"></a><a class="link" href="#not-retrieve-all-secrets-in-key-vault">23.3.3. Not Retrieve All Secrets In Key Vault</a></h4>
<div class="paragraph">
<p>If you stored 1000 secrets in the Key Vault, and you just want to use 3 of them. You can list the 3 secret names by <code>spring.cloud.azure.keyvault.secret.property-sources[].secret-keys</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="setting-refresh-interval"><a class="anchor" href="#setting-refresh-interval"></a><a class="link" href="#setting-refresh-interval">23.3.4. Setting Refresh Interval</a></h4>
<div class="paragraph">
<p>By default, the secrets in <code>KeyVaultPropertySource</code> will refresh every 30 minutes. You can configure the time by <code>spring.cloud.azure.keyvault.secret.property-sources[].refresh-interval</code>. For example: <code>spring.cloud.azure.keyvault.secret.property-sources[].refresh-interval=60m</code> means refresh every 60 minutes. Set to <code>0</code> to disable auto refresh.</p>
</div>
</div>
<div class="sect3">
<h4 id="propertysource-priority"><a class="anchor" href="#propertysource-priority"></a><a class="link" href="#propertysource-priority">23.3.5. PropertySource Priority</a></h4>
<div class="paragraph">
<p>If key exists in multiple PropertySources, which will take effect is decided by the priority.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If there is no <code>SystemEnvironmentPropertySource</code> in PropertySource list, then <code>KeyVaultPropertySource</code> will take the highest priority.</p>
</li>
<li>
<p>If there is <code>SystemEnvironmentPropertySource</code> in PropertySource list, then <code>SystemEnvironmentPropertySource</code> have higher priority than KeyVaultPropertySource. Which means you can use environment variable to override the Key Vault secret value in your application.</p>
</li>
<li>
<p>If there are multiple KeyVaultPropertySource in PropertySource list, then the definition order is the priority order. Take above sample as example, <code>key-vault-property-souece-1</code> has higher priority than <code>key-vault-property-souece-2</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="all-configurable-properties"><a class="anchor" href="#all-configurable-properties"></a><a class="link" href="#all-configurable-properties">23.3.6. All Configurable Properties</a></h4>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 16. Configurable properties of Key Vault Secret PropertySource</caption>
<colgroup>
<col style="width: 45%;">
<col style="width: 5%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-source-enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to enable the Key Vault property source.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].name</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of this property source.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].endpoint</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Key Vault endpoint.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].case-sensitive</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the secret keys are case-sensitive.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].secret-keys</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The secret keys supported for this property source. All keys be retrieved if this property is missing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].refresh-interval</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">30m</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time interval to refresh all Key Vault secrets.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].service-version</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Secret service version used when making API requests.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].client</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client related properties.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].credential</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Credential related properties.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].profile</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Profile related properties.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].proxy</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Proxy related properties.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.keyvault.secret</strong>.property-sources[].retry</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retry related properties.</p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p>Please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the <a href="https://docs.microsoft.com/azure/active-directory/develop/app-objects-and-service-principals#service-principal-object">security principal</a> has been granted the sufficient permission to access the Azure Key Vault Secrets.</p>
</li>
<li>
<p>If common properties like <code>client</code>, <code>credential</code>, <code>profile</code>, <code>proxy</code>, <code>retry</code> aren&#8217;t configured in <code>spring.cloud.azure.keyvault.secret.property-sources[].xxx</code>, <code>spring.cloud.azure.xxx</code> will be used. Please refer to <a href="index.html#configuration">Configuration</a> to get more information about these common properties.</p>
</li>
<li>
<p>Please refer to <a href="appendix.html#_configuration_properties">Configuration Properties</a> to get more information about nested properties.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="samples-3"><a class="anchor" href="#samples-3"></a><a class="link" href="#samples-3">23.4. Samples</a></h3>
<div class="paragraph">
<p>Sample project: <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.1.0-beta.1/keyvault/spring-cloud-azure-starter-keyvault-secrets/property-source">property-source</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-data-support"><a class="anchor" href="#spring-data-support"></a><a class="link" href="#spring-data-support">24. Spring Data Support</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="spring-data-cosmosdb-support"><a class="anchor" href="#spring-data-cosmosdb-support"></a><a class="link" href="#spring-data-cosmosdb-support">24.1. Spring Data CosmosDB Support</a></h3>
<div class="paragraph">
<p><a href="https://azure.microsoft.com/services/cosmos-db/">Azure Cosmos DB</a> is a globally-distributed database service that allows developers to work with data using a variety of standard APIs, such as SQL, MongoDB, Graph, and Azure Table storage.</p>
</div>
</div>
<div class="sect2">
<h3 id="dependency-setup-4"><a class="anchor" href="#dependency-setup-4"></a><a class="link" href="#dependency-setup-4">24.2. Dependency Setup</a></h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
   &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
   &lt;artifactId&gt;spring-cloud-azure-starter-data-cosmos&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-4"><a class="anchor" href="#configuration-4"></a><a class="link" href="#configuration-4">24.3. Configuration</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 17. Configurable properties of spring-cloud-azure-starter-data-cosmos</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 16.6666%;">
<col style="width: 50.0001%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether Azure Cosmos Service is enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.database</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Cosmos DB database id.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.endpoint</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uri to connect Cosmos DB.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.key</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Private key to connect Cosmos DB.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.credential.client-certificate-password</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password of the certificate file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.credential.client-certificate-path</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path of a PEM certificate file to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.credential.client-id</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client id to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.credential.client-secret</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client secret to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.credential.managed-identity-enabled</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to enable managed identity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.credential.password</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password to use when performing username/password authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.credential.username</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Username to use when performing username/password authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.populate-query-metrics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Populate Diagnostics Strings and Query metrics.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.cosmos</strong>.consistency-level</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.microsoft.com/azure/cosmos-db/consistency-levels">Consistency levels</a> in Azure Cosmos DB.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="key-concepts"><a class="anchor" href="#key-concepts"></a><a class="link" href="#key-concepts">24.4. Key Concepts</a></h3>
<div class="ulist">
<ul>
<li>
<p>Spring Data CrudRepository and ReactiveCrudRepository basic CRUD functionality</p>
<div class="ulist">
<ul>
<li>
<p>save</p>
</li>
<li>
<p>findAll</p>
</li>
<li>
<p>findOne by Id</p>
</li>
<li>
<p>deleteAll</p>
</li>
<li>
<p>delete by Id</p>
</li>
<li>
<p>delete entity</p>
</li>
</ul>
</div>
</li>
<li>
<p>Spring Data <a href="https://github.com/spring-projects/spring-data-commons/blob/db62390de90c93a78743c97cc2cc9ccd964994a5/src/main/java/org/springframework/data/annotation/Id.java">@Id</a> annotation.
There&#8217;re 2 ways to map a field in domain class to <code>id</code> of Azure Cosmos DB document.</p>
<div class="ulist">
<ul>
<li>
<p>annotate a field in domain class with @Id, this field will be mapped to document <code>id</code> in Cosmos DB.</p>
</li>
<li>
<p>set name of this field to <code>id</code>, this field will be mapped to document <code>id</code> in Cosmos DB.
[Note] if both way applied,</p>
</li>
</ul>
</div>
</li>
<li>
<p>Custom collection Name.
By default, collection name will be class name of user domain class. To customize it, add annotation <code>@Document(collection="myCustomCollectionName")</code> to your domain class, that&#8217;s all.</p>
</li>
<li>
<p>Supports <a href="https://docs.microsoft.com/azure/cosmos-db/partitioning-overview">Azure Cosmos DB partition</a>. To specify a field of your domain class to be partition key field, just annotate it with <code>@PartitionKey</code>. When you do CRUD operation, please specify your partition value. For more sample on partition CRUD, please refer to <a href="https://github.com/Azure/azure-sdk-for-java/blob/main/sdk/cosmos/azure-spring-data-cosmos-test/src/test/java/com/azure/spring/data/cosmos/repository/integration/AddressRepositoryIT.java">test here</a></p>
</li>
<li>
<p>Supports <a href="https://docs.spring.io/spring-data/commons/docs/current/reference/html/#repositories.query-methods.details">Spring Data custom query</a> find operation.</p>
</li>
<li>
<p>Supports <a href="https://spring.io/projects/spring-data-rest">spring-boot-starter-data-rest</a>.</p>
</li>
<li>
<p>Supports List and nested type in domain class.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="basic-usage-4"><a class="anchor" href="#basic-usage-4"></a><a class="link" href="#basic-usage-4">24.5. Basic Usage</a></h3>
<div class="sect3">
<h4 id="use-private-key-to-access-cosmosdb"><a class="anchor" href="#use-private-key-to-access-cosmosdb"></a><a class="link" href="#use-private-key-to-access-cosmosdb">24.5.1. Use Private Key to Access CosmosDB</a></h4>
<div class="paragraph">
<p>The simplest way to connect CosmosDB with <code>spring-cloud-azure-starter-data-cosmos</code> is primary key, add below properties, and you are good to go.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      cosmos:
        key: ${AZURE_COSMOS_KEY}
        endpoint: ${AZURE_COSMOS_ENDPOINT}
        database: ${AZURE_COSMOS_DATABASE}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="define-an-entity"><a class="anchor" href="#define-an-entity"></a><a class="link" href="#define-an-entity">24.5.2. Define an Entity</a></h4>
<div class="paragraph">
<p>Define a simple entity as Document in Cosmos DB.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>@Container(containerName = "mycollection")
public class User {
    @Id
    private String id;
    private String firstName;
    @PartitionKey
    private String lastName;
    private String address;

    public User() {
    }

    public User(String id, String firstName, String lastName, String address) {
        this.id = id;
        this.firstName = firstName;
        this.lastName = lastName;
        this.address = address;
    }

    public String getId() {
        return id;
    }

    public void setId(String id) {
        this.id = id;
    }

    public String getFirstName() {
        return firstName;
    }

    public void setFirstName(String firstName) {
        this.firstName = firstName;
    }

    public String getLastName() {
        return lastName;
    }

    public void setLastName(String lastName) {
        this.lastName = lastName;
    }

    public String getAddress() {
        return address;
    }

    public void setAddress(String address) {
        this.address = address;
    }

    @Override
    public String toString() {
        return String.format("%s %s, %s", firstName, lastName, address);
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p><code>id</code> field will be used as document <code>id</code> in Azure Cosmos DB. Or you can annotate any field with <code>@Id</code> to map it to document <code>id</code>.</p>
</div>
<div class="paragraph">
<p>Annotation <code>@Container(containerName = "mycollection")</code> is used to specify the collection name of your document in Azure Cosmos DB.</p>
</div>
</div>
<div class="sect3">
<h4 id="create-repositories"><a class="anchor" href="#create-repositories"></a><a class="link" href="#create-repositories">24.5.3. Create Repositories</a></h4>
<div class="paragraph">
<p>Extends ReactiveCosmosRepository interface, which provides Spring Data repository support.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>@Repository
public interface UserRepository extends ReactiveCosmosRepository&lt;User, String&gt; {

    Flux&lt;User&gt; findByFirstName(String firstName);
}</pre>
</div>
</div>
<div class="paragraph">
<p>So far ReactiveCosmosRepository provides basic save, delete and find operations. More operations will be supported later.</p>
</div>
</div>
<div class="sect3">
<h4 id="create-an-application-class"><a class="anchor" href="#create-an-application-class"></a><a class="link" href="#create-an-application-class">24.5.4. Create an Application Class</a></h4>
<div class="paragraph">
<p>Here create an application class with all the components</p>
</div>
<div class="listingblock">
<div class="content">
<pre>@SpringBootApplication
public class CosmosSampleApplication implements CommandLineRunner {

   private static final Logger LOGGER = LoggerFactory.getLogger(CosmosSampleApplication.class);

    @Autowired
    private UserRepository repository;

    @Autowired
    private CosmosProperties properties;

    public static void main(String[] args) {
        SpringApplication.run(CosmosSampleApplication.class, args);
    }

    public void run(String... var1) {
        final User testUser = new User("testId", "testFirstName",
                "testLastName", "test address line one");

        // Save the User class to Azure Cosmos DB database.
        final Mono&lt;User&gt; saveUserMono = repository.save(testUser);

        final Flux&lt;User&gt; firstNameUserFlux = repository.findByFirstName("testFirstName");

        //  Nothing happens until we subscribe to these Monos.
        //  findById will not return the user as user is not present.
        final Mono&lt;User&gt; findByIdMono = repository.findById(testUser.getId());
        final User findByIdUser = findByIdMono.block();
        Assert.isNull(findByIdUser, "User must be null");

        final User savedUser = saveUserMono.block();
        Assert.state(savedUser != null, "Saved user must not be null");
        Assert.state(savedUser.getFirstName().equals(testUser.getFirstName()),
                "Saved user first name doesn't match");

        firstNameUserFlux.collectList().block();

        final Optional&lt;User&gt; optionalUserResult = repository.findById(testUser.getId()).blockOptional();
        Assert.isTrue(optionalUserResult.isPresent(), "Cannot find user.");

        final User result = optionalUserResult.get();
        Assert.state(result.getFirstName().equals(testUser.getFirstName()),
                "query result firstName doesn't match!");
        Assert.state(result.getLastName().equals(testUser.getLastName()),
                "query result lastName doesn't match!");
        LOGGER.info("findOne in User collection get result: {}", result.toString());

    }

    @PostConstruct
    public void setup() {
        // For this example, remove all of the existing records.
        this.repository.deleteAll().block();
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>Autowired UserRepository interface, then can do save, delete and find operations.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="samples-4"><a class="anchor" href="#samples-4"></a><a class="link" href="#samples-4">24.6. Samples</a></h3>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.1.0-beta.1/cosmos">azure-spring-boot-samples</a> for more details.</p>
</div>
<div class="paragraph">
<p>Apart from using the <code>spring-cloud-azure-starter-data-cosmos</code> library, you can directly use <code>azure-spring-data-cosmos</code> library for more complex scenarios. Please refer to <a href="https://github.com/Azure/azure-sdk-for-java/tree/spring-cloud-azure-dependencies_4.1.0-beta.1/sdk/cosmos/azure-spring-data-cosmos">Spring Data for Azure Cosmos DB</a> for more details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-security-support"><a class="anchor" href="#spring-security-support"></a><a class="link" href="#spring-security-support">25. Spring Security Support</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="spring-security-with-azure-active-directory"><a class="anchor" href="#spring-security-with-azure-active-directory"></a><a class="link" href="#spring-security-with-azure-active-directory">25.1. Spring Security With Azure Active Directory</a></h3>
<div class="paragraph">
<p>When you are building a web application, identity and access management will always be foundational pieces.</p>
</div>
<div class="paragraph">
<p>Azure offers a great platform to democratize your application development journey, as it not only offers a cloud-base identity service, but also deep integration with the rest of the Azure ecosystem.</p>
</div>
<div class="paragraph">
<p>Spring Security has made it easy to secure your Spring based applications with powerful abstractions and extensible interfaces. However, as powerful as the Spring framework can be, it is not tailored to a specific identity provider.</p>
</div>
<div class="paragraph">
<p>The <code>spring-cloud-azure-starter-active-directory</code> (<code>aad-starter</code> for short) provides the most optimal way to connect your <code>web application</code> to an Azure Active Directory (AAD for short) tenant and protect <code>resource server</code> with AAD. It uses the Oauth 2.0 protocol to protect <code>web applications</code> and <code>resource servers</code>.</p>
</div>
<div class="sect3">
<h4 id="accessing-a-web-application"><a class="anchor" href="#accessing-a-web-application"></a><a class="link" href="#accessing-a-web-application">25.1.1. Accessing a Web Application</a></h4>
<div class="paragraph">
<p>This scenario uses <a href="https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-auth-code-flow">The OAuth 2.0 authorization code grant</a> flow to log in a user with a Microsoft account.</p>
</div>
<div class="sect4">
<h5 id="system-diagram"><a class="anchor" href="#system-diagram"></a><a class="link" href="#system-diagram">System Diagram</a></h5>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142617664-f1704adb-db64-49e0-b1b6-078c62b6945b.png" alt="Standalone Web Application"></span></p>
</div>
</div>
<div class="sect4">
<h5 id="create-required-resources-in-azure"><a class="anchor" href="#create-required-resources-in-azure"></a><a class="link" href="#create-required-resources-in-azure">Create Required Resources in Azure</a></h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read <a href="https://docs.microsoft.com/azure/active-directory/develop/quickstart-register-app">MS docs about register an application with the Microsoft identity platform</a>.</p>
</li>
<li>
<p>Create app registration. Get <code>AZURE_TENANT_ID</code>, <code>AZURE_CLIENT_ID</code> and <code>AZURE_CLIENT_SECRET</code>.</p>
</li>
<li>
<p>Set <code>redirect URI</code> to <code>APPLICATION_BASE_URI/login/oauth2/code/</code>, for example <code><a href="http://localhost:8080/login/oauth2/code/" class="bare">localhost:8080/login/oauth2/code/</a></code>. The tailing <code>/</code> is required.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="add-required-dependencies"><a class="anchor" href="#add-required-dependencies"></a><a class="link" href="#add-required-dependencies">Add Required Dependencies</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-active-directory&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-oauth2-client&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="add-required-properties"><a class="anchor" href="#add-required-properties"></a><a class="link" href="#add-required-properties">Add Required Properties</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        profile:
          tenant-id: ${AZURE_TENANT_ID}
        credential:
          client-id: ${AZURE_CLIENT_ID}
          client-secret: ${AZURE_CLIENT_SECRET}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now start you application and access your application by browser, then you will be redirected into Microsoft login page.</p>
</div>
</div>
<div class="sect4">
<h5 id="advanced-usages"><a class="anchor" href="#advanced-usages"></a><a class="link" href="#advanced-usages">Advanced Usages</a></h5>
<div class="sect5">
<h6 id="add-extra-security-configurations"><a class="anchor" href="#add-extra-security-configurations"></a><a class="link" href="#add-extra-security-configurations">Add Extra Security Configurations</a></h6>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    @EnableWebSecurity
    @EnableGlobalMethodSecurity(prePostEnabled = true)
    public class AadOAuth2LoginSecurityConfig extends AadWebSecurityConfigurerAdapter {

        /**
         * Add configuration logic as needed.
         */
        @Override
        protected void configure(HttpSecurity http) throws Exception {
            super.configure(http);
            http.authorizeRequests()
                    .anyRequest().authenticated();
            // Do some custom configuration
        }
    }</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="authorize-access-by-app-roles"><a class="anchor" href="#authorize-access-by-app-roles"></a><a class="link" href="#authorize-access-by-app-roles">Authorize Access by App Roles</a></h6>
<div class="ulist">
<ul>
<li>
<p>Step 1: Create Required Resources in Azure</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read <a href="https://docs.microsoft.com/azure/active-directory/develop/howto-add-app-roles-in-azure-ad-apps">MS docs about Add app roles to your application and receive them in the token</a>.</p>
</li>
<li>
<p>Create an app role with the following parameters:</p>
<div class="ulist">
<ul>
<li>
<p>Display name: Admin</p>
</li>
<li>
<p>Allowed member types: Users/Groups</p>
</li>
<li>
<p>Value: Admin</p>
</li>
<li>
<p>Do you want to enable this app role: yes</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you want to use app role based access control, you can&#8217;t put group names in <code>role</code> claim . Refs: <a href="https://docs.microsoft.com/azure/active-directory/develop/active-directory-optional-claims#configuring-groups-optional-claims">Configuring groups optional claims</a>.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 2: Protect specific method.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>class Demo {
    @GetMapping("Admin")
    @ResponseBody
    @PreAuthorize("hasAuthority('APPROLE_Admin')")
    public String admin() {
        return "Admin message";
    }
}</pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="authorize-access-by-group-name-or-group-id"><a class="anchor" href="#authorize-access-by-group-name-or-group-id"></a><a class="link" href="#authorize-access-by-group-name-or-group-id">Authorize Access by Group Name Or Group ID</a></h6>
<div class="ulist">
<ul>
<li>
<p>Step 1: Add related configuration properties.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      active-directory:
        user-group:
          allowed-group-names: group1_name_1, group2_name_2
          # 1. If allowed-group-ids == all, then all group id will take effect.
          # 2. If "all" is used, we should not configure other group ids.
          # 3. "all" is only supported for allowed-group-ids, not supported for allowed-group-names.
          allowed-group-ids: group_id_1, group_id_2</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 2: Protect specific method.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>@Controller
public class RoleController {
    @GetMapping("group1")
    @ResponseBody
    @PreAuthorize("hasRole('ROLE_group1')")
    public String group1() {
        return "group1 message";
    }

    @GetMapping("group2")
    @ResponseBody
    @PreAuthorize("hasRole('ROLE_group2')")
    public String group2() {
        return "group2 message";
    }

    @GetMapping("group1Id")
    @ResponseBody
    @PreAuthorize("hasRole('ROLE_&lt;group1-id&gt;')")
    public String group1Id() {
        return "group1Id message";
    }

    @GetMapping("group2Id")
    @ResponseBody
    @PreAuthorize("hasRole('ROLE_&lt;group2-id&gt;')")
    public String group2Id() {
        return "group2Id message";
    }
}</pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="use-national-azure-instead-of-global-azure"><a class="anchor" href="#use-national-azure-instead-of-global-azure"></a><a class="link" href="#use-national-azure-instead-of-global-azure">Use National Azure Instead of Global Azure</a></h6>
<div class="paragraph">
<p>Now except global Azure cloud, Azure Active Directory is deployed in the following national clouds:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Azure Government</p>
</li>
<li>
<p>Azure China 21Vianet</p>
</li>
<li>
<p>Azure Germany</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is a sample of you want to use Azure China 21Vianet.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        base-uri: https://login.partner.microsoftonline.cn
        graph-base-uri: https://microsoftgraph.chinacloudapi.cn</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can refer to these MS doc to get more information from <a href="https://docs.microsoft.com/en-us/graph/deployments">MS docs about National cloud deployments</a>.</p>
</div>
</div>
<div class="sect5">
<h6 id="configure-redirect-uri-template"><a class="anchor" href="#configure-redirect-uri-template"></a><a class="link" href="#configure-redirect-uri-template">Configure Redirect URI Template</a></h6>
<div class="paragraph">
<p>Developers can customize the redirect-uri.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/149295662-072ca3d5-f9e1-4f25-bb0e-be7bb751e9af.png" alt="redirect-uri"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 1: Add <code>redirect-uri-template</code> properties in application.yml.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      active-directory
        redirect-uri-template: ${REDIRECT-URI-TEMPLATE}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 2: Update redirect-uri in Azure portal.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/149296913-a4259df9-e0c3-4e38-8d4e-77ee845de4ad.png" alt="web-application-config-redirect-uri"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 3: Update WebSecurityConfigurerAdapter</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After we set redirect-uri-template, we need to update <code>WebSecurityConfigurerAdapter</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class AadOAuth2LoginSecurityConfig extends AadWebSecurityConfigurerAdapter {
    /**
     * Add configuration logic as needed.
     */
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        super.configure(http);
        http.oauth2Login()
                .loginProcessingUrl("${REDIRECT-URI-TEMPLATE}")
                .and()
            .authorizeRequests()
                .anyRequest().authenticated();
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="samples-5"><a class="anchor" href="#samples-5"></a><a class="link" href="#samples-5">Samples</a></h5>
<div class="paragraph">
<p>Sample project: <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.1.0-beta.1/aad/spring-cloud-azure-starter-active-directory/web-client-access-resource-server/aad-web-application">aad-web-application</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="web-application-accessing-resource-servers"><a class="anchor" href="#web-application-accessing-resource-servers"></a><a class="link" href="#web-application-accessing-resource-servers">25.1.2. Web Application Accessing Resource Servers</a></h4>
<div class="sect4">
<h5 id="system-diagram-2"><a class="anchor" href="#system-diagram-2"></a><a class="link" href="#system-diagram-2">System Diagram</a></h5>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142617853-0526205f-fdef-47f9-ac01-77963f8c34be.png" alt="web-application-visiting-resource-servers.png"></span></p>
</div>
</div>
<div class="sect4">
<h5 id="create-required-resources-in-azure-2"><a class="anchor" href="#create-required-resources-in-azure-2"></a><a class="link" href="#create-required-resources-in-azure-2">Create Required Resources in Azure</a></h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read <a href="https://docs.microsoft.com/azure/active-directory/develop/quickstart-register-app">MS docs about register an application with the Microsoft identity platform</a>.</p>
</li>
<li>
<p>Create app registration. Get <code>AZURE_TENANT_ID</code>, <code>AZURE_CLIENT_ID</code> and <code>AZURE_CLIENT_SECRET</code>.</p>
</li>
<li>
<p>Set <code>redirect URI</code> to <code>APPLICATION_BASE_URI/login/oauth2/code/</code>, for example <code><a href="http://localhost:8080/login/oauth2/code/" class="bare">localhost:8080/login/oauth2/code/</a></code>. The tailing <code>/</code> is required.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="add-required-dependencies-2"><a class="anchor" href="#add-required-dependencies-2"></a><a class="link" href="#add-required-dependencies-2">Add Required Dependencies</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-active-directory&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-oauth2-client&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="add-required-properties-2"><a class="anchor" href="#add-required-properties-2"></a><a class="link" href="#add-required-properties-2">Add Required Properties</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        profile:
          tenant-id: ${AZURE_TENANT_ID}
        credential:
          client-id: ${AZURE_CLIENT_ID}
          client-secret: ${AZURE_CLIENT_SECRET}
        authorization-clients:
          graph:
            scopes: https://graph.microsoft.com/Analytics.Read, email</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, <code>graph</code> is the name of <code>OAuth2AuthorizedClient</code>, <code>scopes</code> means the scopes need to consent when login.</p>
</div>
</div>
<div class="sect4">
<h5 id="use-oauth2authorizedclient-in-your-application"><a class="anchor" href="#use-oauth2authorizedclient-in-your-application"></a><a class="link" href="#use-oauth2authorizedclient-in-your-application">Use OAuth2AuthorizedClient in Your Application</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class Demo {
    @GetMapping("/graph")
    @ResponseBody
    public String graph(
    @RegisteredOAuth2AuthorizedClient("graph") OAuth2AuthorizedClient graphClient) {
        // toJsonString() is just a demo.
        // oAuth2AuthorizedClient contains access_token. We can use this access_token to access resource server.
        return toJsonString(graphClient);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now start you application and access your application by browser, then you will be redirected into Microsoft login page.</p>
</div>
</div>
<div class="sect4">
<h5 id="advanced-usages-2"><a class="anchor" href="#advanced-usages-2"></a><a class="link" href="#advanced-usages-2">Advanced Usages</a></h5>
<div class="sect5">
<h6 id="client-credential-flow"><a class="anchor" href="#client-credential-flow"></a><a class="link" href="#client-credential-flow">Client Credential Flow</a></h6>
<div class="paragraph">
<p>The default flow is <a href="https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-auth-code-flow">authorization code flow</a>, if you want to use <a href="https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow">client credentials flow</a>, you can configure like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        profile:
          tenant-id: ${AZURE_TENANT_ID}
        credential:
          client-id: ${AZURE_CLIENT_ID}
          client-secret: ${AZURE_CLIENT_SECRET}
        authorization-clients:
          graph:
            authorization-grant-type: client_credentials # Change type to client_credentials
            scopes: https://graph.microsoft.com/Analytics.Read, email</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="access-multiple-resource-servers"><a class="anchor" href="#access-multiple-resource-servers"></a><a class="link" href="#access-multiple-resource-servers">Access Multiple Resource Servers</a></h6>
<div class="paragraph">
<p>In one web application, you can access multiple resource server by configuring like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        profile:
          tenant-id: ${AZURE_TENANT_ID}
        credential:
          client-id: ${AZURE_CLIENT_ID}
          client-secret: ${AZURE_CLIENT_SECRET}
        authorization-clients:
          resource-server-1:
            scopes: # Scopes for resource-server-1
          resource-server-2:
            scopes: # Scopes for resource-server-2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can use OAuth2AuthorizedClient in application like this</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class Demo {
    @GetMapping("/resource-server-1")
    @ResponseBody
    public String graph(
    @RegisteredOAuth2AuthorizedClient("resource-server-1") OAuth2AuthorizedClient client) {
        return callResourceServer1(client);
    }

    @GetMapping("/resource-server-2")
    @ResponseBody
    public String graph(
    @RegisteredOAuth2AuthorizedClient("resource-server-2") OAuth2AuthorizedClient client) {
        return callResourceServer2(client);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="incremental-consent"><a class="anchor" href="#incremental-consent"></a><a class="link" href="#incremental-consent">Incremental Consent</a></h6>
<div class="paragraph">
<p>In previous sample, all scopes will be consented when customer first login, no matter it&#8217;s belong to resource-server-1 or resource-server-2. If you don&#8217;t want to let customer consent all scopes, you can do like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        profile:
          tenant-id: ${AZURE_TENANT_ID}
        credential:
          client-id: ${AZURE_CLIENT_ID}
          client-secret: ${AZURE_CLIENT_SECRET}
        authorization-clients:
          resource-server-1:
            scopes: # Scopes for resource-server-1
          resource-server-2:
            on-demand: true  # means incremental consent
            scopes: # Scopes for resource-server-2</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="samples-6"><a class="anchor" href="#samples-6"></a><a class="link" href="#samples-6">Samples</a></h5>
<div class="paragraph">
<p>Sample project: <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.1.0-beta.1/aad/spring-cloud-azure-starter-active-directory/web-client-access-resource-server/aad-web-application">aad-web-application</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="accessing-a-resource-server"><a class="anchor" href="#accessing-a-resource-server"></a><a class="link" href="#accessing-a-resource-server">25.1.3. Accessing a Resource Server</a></h4>
<div class="paragraph">
<p>This scenario doesn&#8217;t support login, just protect the server by validating the access token. If the access token is valid, the server serves the request.</p>
</div>
<div class="sect4">
<h5 id="system-diagram-3"><a class="anchor" href="#system-diagram-3"></a><a class="link" href="#system-diagram-3">System Diagram</a></h5>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142617910-1ee3eb6a-ddc7-4b85-af4e-71344c91b248.png" alt="Standalone resource server usage"></span></p>
</div>
</div>
<div class="sect4">
<h5 id="create-required-resources-in-azure-3"><a class="anchor" href="#create-required-resources-in-azure-3"></a><a class="link" href="#create-required-resources-in-azure-3">Create Required Resources in Azure</a></h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read <a href="https://docs.microsoft.com/azure/active-directory/develop/quickstart-register-app">MS docs about register an application with the Microsoft identity platform</a>.</p>
</li>
<li>
<p>Create app registration. Get <code>AZURE_CLIENT_ID</code>.</p>
</li>
<li>
<p>Read <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-configure-app-expose-web-apis">MS docs about configure an application to expose a web API</a>.</p>
</li>
<li>
<p>Expose a web API with a scope named <code>Scope-1</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="add-required-dependencies-3"><a class="anchor" href="#add-required-dependencies-3"></a><a class="link" href="#add-required-dependencies-3">Add Required Dependencies</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-active-directory&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-oauth2-resource-server&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="add-required-properties-3"><a class="anchor" href="#add-required-properties-3"></a><a class="link" href="#add-required-properties-3">Add Required Properties</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        credential:
          client-id: ${AZURE_CLIENT_ID}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now start your application and access your application&#8217;s web api.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You will get 401 without an access token.</p>
</li>
<li>
<p>Access your application with an access token, the following claims in access token will be validated:</p>
<div class="ulist">
<ul>
<li>
<p><code>iss</code>: The access token must be issued by Azure AD.</p>
</li>
<li>
<p><code>nbf</code>: Current time can not before <code>nbf</code>.</p>
</li>
<li>
<p><code>exp</code>: Current time can not after <code>exp</code>.</p>
</li>
<li>
<p><code>aud</code>: If <code>spring.cloud.azure.active-directory.credential.client-id</code> or <code>spring.cloud.azure.active-directory.credential.app-id-uri</code> configured, the audience must equal to the configured <code>client-id</code> or <code>app-id-uri</code>. If the 2 properties are not configured, this claim will not be validated.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Refer to <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/access-tokens">MS docs about Microsoft identity platform access tokens</a> to get more information about access token.</p>
</div>
</div>
<div class="sect4">
<h5 id="advanced-usages-3"><a class="anchor" href="#advanced-usages-3"></a><a class="link" href="#advanced-usages-3">Advanced Usages</a></h5>
<div class="sect5">
<h6 id="add-extra-security-configurations-2"><a class="anchor" href="#add-extra-security-configurations-2"></a><a class="link" href="#add-extra-security-configurations-2">Add Extra Security Configurations</a></h6>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class AadOAuth2ResourceServerSecurityConfig extends AadResourceServerWebSecurityConfigurerAdapter {
    /**
     * Add configuration logic as needed.
     */
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        super.configure(http);
        http.authorizeRequests((requests) -&gt; requests.anyRequest().authenticated());
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="validate-permission-by-scopes"><a class="anchor" href="#validate-permission-by-scopes"></a><a class="link" href="#validate-permission-by-scopes">Validate Permission by Scopes</a></h6>
<div class="ulist">
<ul>
<li>
<p>Step 1: : Create Required Resources in Azure</p>
<div class="ulist">
<ul>
<li>
<p>Read <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-configure-app-expose-web-apis">MS docs about configure an application to expose a web API</a>.</p>
</li>
<li>
<p>Expose a web API with a scope named <code>Scope1</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Step 2: Protect specific method.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>class Demo {
    @GetMapping("scope1")
    @ResponseBody
    @PreAuthorize("hasAuthority('SCOPE_Scope1')")
    public String scope1() {
        return "Congratulations, you can access `scope1` endpoint.";
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>By doing this, when access <code>/scope1</code> endpoint, the following claims in access token will be validated:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>scp</code>: The value must contains <code>Scope1</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="validate-permission-by-app-roles"><a class="anchor" href="#validate-permission-by-app-roles"></a><a class="link" href="#validate-permission-by-app-roles">Validate Permission by App Roles</a></h6>
<div class="ulist">
<ul>
<li>
<p>Step 1: Create Required Resources in Azure</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read <a href="https://docs.microsoft.com/azure/active-directory/develop/howto-add-app-roles-in-azure-ad-apps">MS docs about Add app roles to your application and receive them in the token</a>.</p>
</li>
<li>
<p>Create an app role with the following parameters:</p>
<div class="ulist">
<ul>
<li>
<p>Display name: AppRole1</p>
</li>
<li>
<p>Allowed member types: Users/Groups</p>
</li>
<li>
<p>Value: AppRole1</p>
</li>
<li>
<p>Do you want to enable this app role: yes</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Step 2: Protect specific method.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>class Demo {
    @GetMapping("app-role1")
    @ResponseBody
    @PreAuthorize("hasAuthority('APPROLE_AppRole1')")
    public String appRole1() {
        return "Congratulations, you can access `app-role1` endpoint.";
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>By doing this, when access <code>/app-role1</code> endpoint, the following claims in access token will be validated:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>roles</code>: The value must contains <code>AppRole1</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="samples-7"><a class="anchor" href="#samples-7"></a><a class="link" href="#samples-7">Samples</a></h5>
<div class="paragraph">
<p>Sample project: <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.1.0-beta.1/aad/spring-cloud-azure-starter-active-directory/web-client-access-resource-server/aad-resource-server">aad-resource-server</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="resource-server-visiting-other-resource-servers"><a class="anchor" href="#resource-server-visiting-other-resource-servers"></a><a class="link" href="#resource-server-visiting-other-resource-servers">25.1.4. Resource Server Visiting Other Resource Servers</a></h4>
<div class="sect4">
<h5 id="system-diagram-4"><a class="anchor" href="#system-diagram-4"></a><a class="link" href="#system-diagram-4">System Diagram</a></h5>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142618294-aa546ced-d241-4fbd-97ac-fb06881503b1.png" alt="resource-server-visiting-other-resource-servers.png"></span></p>
</div>
</div>
<div class="sect4">
<h5 id="create-required-resources-in-azure-4"><a class="anchor" href="#create-required-resources-in-azure-4"></a><a class="link" href="#create-required-resources-in-azure-4">Create Required Resources in Azure</a></h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read <a href="https://docs.microsoft.com/azure/active-directory/develop/quickstart-register-app">MS docs about register an application with the Microsoft identity platform</a>.</p>
</li>
<li>
<p>Create app registration. Get <code>AZURE_TENANT_ID</code>, <code>AZURE_CLIENT_ID</code> and <code>AZURE_CLIENT_SECRET</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="add-required-dependencies-4"><a class="anchor" href="#add-required-dependencies-4"></a><a class="link" href="#add-required-dependencies-4">Add Required Dependencies</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-active-directory&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-oauth2-resource-server&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-oauth2-client&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="add-required-properties-4"><a class="anchor" href="#add-required-properties-4"></a><a class="link" href="#add-required-properties-4">Add Required Properties</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        profile:
          tenant-id: ${AZURE_TENANT_ID}
        credential:
          client-id: ${AZURE_CLIENT_ID}
          client-secret: ${AZURE_CLIENT_SECRET}
        authorization-clients:
          graph:
            scopes:
              - https://graph.microsoft.com/User.Read</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="use-oauth2authorizedclient-in-your-application-2"><a class="anchor" href="#use-oauth2authorizedclient-in-your-application-2"></a><a class="link" href="#use-oauth2authorizedclient-in-your-application-2">Use OAuth2AuthorizedClient in Your Application</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class SampleController {
    @GetMapping("call-graph")
    public String callGraph(@RegisteredOAuth2AuthorizedClient("graph") OAuth2AuthorizedClient graph) {
        return callMicrosoftGraphMeEndpoint(graph);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="samples-8"><a class="anchor" href="#samples-8"></a><a class="link" href="#samples-8">Samples</a></h5>
<div class="paragraph">
<p>Sample project: <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.1.0-beta.1/aad/spring-cloud-azure-starter-active-directory/web-client-access-resource-server/aad-resource-server-obo">aad-resource-server-obo</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="web-application-and-resource-server-in-one-application"><a class="anchor" href="#web-application-and-resource-server-in-one-application"></a><a class="link" href="#web-application-and-resource-server-in-one-application">25.1.5. Web Application and Resource Server in One Application</a></h4>
<div class="sect4">
<h5 id="create-required-resources-in-azure-5"><a class="anchor" href="#create-required-resources-in-azure-5"></a><a class="link" href="#create-required-resources-in-azure-5">Create Required Resources in Azure</a></h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read <a href="https://docs.microsoft.com/azure/active-directory/develop/quickstart-register-app">MS docs about register an application with the Microsoft identity platform</a>.</p>
</li>
<li>
<p>Create app registration. Get <code>AZURE_TENANT_ID</code>, <code>AZURE_CLIENT_ID</code> and <code>AZURE_CLIENT_SECRET</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="add-required-dependencies-5"><a class="anchor" href="#add-required-dependencies-5"></a><a class="link" href="#add-required-dependencies-5">Add Required Dependencies</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-active-directory&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-oauth2-resource-server&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-oauth2-client&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="add-required-properties-5"><a class="anchor" href="#add-required-properties-5"></a><a class="link" href="#add-required-properties-5">Add Required Properties</a></h5>
<div class="paragraph">
<p>Set property <code>spring.cloud.azure.active-directory.application-type</code> to <code>web_application_and_resource_server</code>, and specify the authorization type for each authorization client.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        profile:
          tenant-id: ${AZURE_TENANT_ID}
        credential:
          client-id: ${AZURE_CLIENT_ID}
          client-secret: ${AZURE_CLIENT_SECRET}
        app-id-uri: ${WEB_API_ID_URI}
        application-type: web_application_and_resource_server  # This is required.
        authorization-clients:
          graph:
            authorizationGrantType: authorization_code # This is required.
            scopes:
              - https://graph.microsoft.com/User.Read
              - https://graph.microsoft.com/Directory.Read.All</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="define-securityconfigurationadapter"><a class="anchor" href="#define-securityconfigurationadapter"></a><a class="link" href="#define-securityconfigurationadapter">Define SecurityConfigurationAdapter</a></h5>
<div class="paragraph">
<p>Configure multiple HttpSecurity instances, <code>AadWebApplicationAndResourceServerConfig</code> contain two security configurations for resource server and web application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class AadWebApplicationAndResourceServerConfig {

    @Order(1)
    @Configuration
    public static class ApiWebSecurityConfigurationAdapter extends AadResourceServerWebSecurityConfigurerAdapter {
        protected void configure(HttpSecurity http) throws Exception {
            super.configure(http);
            // All the paths that match `/api/**`(configurable) work as `Resource Server`, other paths work as `Web application`.
            http.antMatcher("/api/**")
                .authorizeRequests().anyRequest().authenticated();
        }
    }

    @Configuration
    public static class HtmlWebSecurityConfigurerAdapter extends AadWebSecurityConfigurerAdapter {

        @Override
        protected void configure(HttpSecurity http) throws Exception {
            super.configure(http);
            // @formatter:off
            http.authorizeRequests()
                    .antMatchers("/login").permitAll()
                    .anyRequest().authenticated();
            // @formatter:on
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-5"><a class="anchor" href="#configuration-5"></a><a class="link" href="#configuration-5">25.1.6. Configuration</a></h4>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 18. Configurable properties of spring-cloud-azure-starter-active-directory</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.app-id-uri</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">App ID URI which might be used in the "aud" claim of an id_token.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.application-type</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type of the AAD application.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.authenticate-additional-parameters</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add additional parameters to the Authorization URL.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.authorization-clients</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The OAuth2 authorization clients.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.credential.client-id</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client id to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.credential.client-secret</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client secret to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.jwk-set-cache-lifespan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>5</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The lifespan of the cached JWK set before it expires, default is 5 minutes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.jwk-set-cache-refresh-time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>5</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The refresh time of the cached JWK set before it expires, default is 5 minutes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.jwt-connect-timeout</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connection Timeout for the JWKSet Remote URL call.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.jwt-read-timeout</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read Timeout for the JWKSet Remote URL call.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.jwt-size-limit</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size limit in Bytes of the JWKSet Remote URL call.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.post-logout-redirect-uri</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The redirect uri after logout.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.profile.cloud-type</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the Azure cloud to connect to. Supported types are: AZURE, AZURE_CHINA, AZURE_GERMANY, AZURE_US_GOVERNMENT, OTHER.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.profile.environment</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Properties to Azure Active Directory endpoints.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.profile.tenant-id</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Tenant ID.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.redirect-uri-template</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{baseUrl}/login/oauth2/code/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Redirection Endpoint: Used by the authorization server to return responses containing authorization credentials to the client via the resource owner user-agent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.resource-server.claim-to-authority-prefix-map</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configure which claim will be used to build GrantedAuthority, and prefix of the GrantedAuthority&#8217;s string value. Default value is: "scp" &#8594; "SCOPE_", "roles" &#8594; "APPROLE_".</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.resource-server.principal-claim-name</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configure which claim in access token be returned in AuthenticatedPrincipal#getName. Default value is "sub".</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.session-stateless</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true activates the stateless auth filter AadAppRoleStatelessAuthenticationFilter. The default is false which activates AadAuthenticationFilter.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.user-group.allowed-group-ids</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The group ids can be used to construct GrantedAuthority.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.user-group.allowed-group-names</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The group names can be used to construct GrantedAuthority.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.user-group.use-transitive-members</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If "true", use "v1.0/me/transitiveMemberOf" to get members. Otherwise, use "v1.0/me/memberOf".</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory</strong>.user-name-attribute</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Decide which claim to be principal&#8217;s name.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Here are some examples about how to use these properties:</p>
</div>
<div class="sect4">
<h5 id="application-type"><a class="anchor" href="#application-type"></a><a class="link" href="#application-type">Application Type</a></h5>
<div class="paragraph">
<p>THe application type can be inferred from the dependencies: spring-security-oauth2-client or spring-security-oauth2-resource-server. If the inferred value is not the value you want, you can specify the application type. Here is the table about valid values and inferred value:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 19. Application type of spring-cloud-azure-starter-active-directory</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Has dependency: spring-security-oauth2-client</th>
<th class="tableblock halign-left valign-top">Has dependency: spring-security-oauth2-resource-server</th>
<th class="tableblock halign-left valign-top">Valid values of application type</th>
<th class="tableblock halign-left valign-top">Inferred value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>web_application</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>web_application</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resource_server</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resource_server</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>web_application</code>, <code>resource_server</code>, <code>resource_server_with_obo</code>, <code>web_application_and_resource_server</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>resource_server_with_obo</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="spring-security-with-azure-active-directory-b2c"><a class="anchor" href="#spring-security-with-azure-active-directory-b2c"></a><a class="link" href="#spring-security-with-azure-active-directory-b2c">25.2. Spring Security With Azure Active Directory B2C</a></h3>
<div class="paragraph">
<p>Azure Active Directory (Azure AD) B2C is an identity management service that enables you to customize and control how customers sign up, sign in, and manage their profiles when using your applications. Azure AD B2C enables these actions while protecting the identities of your customers at the same time.</p>
</div>
<div class="sect3">
<h4 id="dependency-setup-5"><a class="anchor" href="#dependency-setup-5"></a><a class="link" href="#dependency-setup-5">25.2.1. Dependency Setup</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-azure-starter-active-directory-b2c&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-6"><a class="anchor" href="#configuration-6"></a><a class="link" href="#configuration-6">25.2.2. Configuration</a></h4>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 20. Configurable properties of spring-cloud-azure-starter-active-directory-b2c</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.app-id-uri</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">App ID URI which might be used in the "aud" claim of a token.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.authenticate-additional-parameters</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Additional parameters for authentication.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.authorization-clients</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify client configuration.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.base-uri</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AAD B2C endpoint base uri.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.credential</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AAD B2C credential information.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.jwt-connect-timeout</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connection Timeout for the JWKSet Remote URL call.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.jwt-read-timeout</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read Timeout for the JWKSet Remote URL call.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.jwt-size-limit</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size limit in Bytes of the JWKSet Remote URL call.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.login-flow</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sign-up-or-sign-in</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the primary sign-in flow key.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.logout-success-url</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="http://localhost:8080/login" class="bare">localhost:8080/login</a></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Redirect url after logout.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.profile</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AAD B2C profile information.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.reply-url</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{baseUrl}/login/oauth2/code/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reply url after get authorization code.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.user-flows</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User flows.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.active-directory.b2c</strong>.user-name-attribute-name</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User name attribute name.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For full configurations, check <a href="appendix.html#migration-guide-for-4-0">the Appendix page</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="basic-usage-5"><a class="anchor" href="#basic-usage-5"></a><a class="link" href="#basic-usage-5">25.2.3. Basic Usage</a></h4>
<div class="paragraph">
<p>A <code>web application</code> is any web based application that allows user to login Azure AD, whereas a <code>resource server</code> will either accept or deny access after validating access_token obtained from Azure AD. We will cover 4 scenarios in this guide:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Accessing a web application.</p>
</li>
<li>
<p>Web application accessing resource servers.</p>
</li>
<li>
<p>Accessing a resource server.</p>
</li>
<li>
<p>Resource server accessing other resource servers.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142620440-f970b572-2646-4f50-9f77-db62d6e965f1.png" alt="B2C Web application &amp; Web Api Overall"></span></p>
</div>
<div class="sect4">
<h5 id="usage-1-accessing-a-web-application"><a class="anchor" href="#usage-1-accessing-a-web-application"></a><a class="link" href="#usage-1-accessing-a-web-application">Usage 1: Accessing a Web Application</a></h5>
<div class="paragraph">
<p>This scenario uses <a href="https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-auth-code-flow">The OAuth 2.0 authorization code grant</a> flow to log in a user with your Azure AD B2C user.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 1: Select <strong>Azure AD B2C</strong> from the portal menu, click <strong>Applications</strong>, and then click <strong>Add</strong>.</p>
</li>
<li>
<p>Step 2: Specify your application <strong>Name</strong>, we call it <code>webapp</code>, add <code><a href="http://localhost:8080/login/oauth2/code/" class="bare">localhost:8080/login/oauth2/code/</a></code> for the <strong>Reply URL</strong>, record the
<strong>Application ID</strong> as your <code>WEB_APP_AZURE_CLIENT_ID</code> and then click <strong>Save</strong>.</p>
</li>
<li>
<p>Step 3: Select <strong>Keys</strong> from your application, click <strong>Generate key</strong> to generate <code>WEB_APP_AZURE_CLIENT_SECRET</code> and then <strong>Save</strong>.</p>
</li>
<li>
<p>Step 4: Select <strong>User flows</strong> on your left, and then Click <strong>New user flow</strong>.</p>
</li>
<li>
<p>Step 5: Choose <strong>Sign up or in</strong>, <strong>Profile editing</strong> and <strong>Password reset</strong> to create user flows
respectively. Specify your user flow <strong>Name</strong> and <strong>User attributes and claims</strong>, click <strong>Create</strong>.</p>
</li>
<li>
<p>Step 6: Select <strong>API permissions</strong> &gt; <strong>Add a permission</strong> &gt; <strong>Microsoft APIs</strong>, select <strong><em>Microsoft Graph</em></strong>,
select <strong>Delegated permissions</strong>, check <strong>offline_access</strong> and <strong>openid</strong> permissions, select <strong>Add permission</strong> to complete the process.</p>
</li>
<li>
<p>Step 7: Grant admin consent for <strong><em>Graph</em></strong> permissions.
<span class="image"><img src="https://user-images.githubusercontent.com/13167207/142620491-8c8a82ea-c920-43a8-aa0a-dd028f1b8553.png" alt="Add Graph permissions"></span></p>
</li>
<li>
<p>Step 8: Add the following dependencies in your <em>pom.xml</em>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;azure-spring-boot-starter-active-directory-b2c&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.thymeleaf.extras&lt;/groupId&gt;
        &lt;artifactId&gt;thymeleaf-extras-springsecurity5&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 9: Add properties in <em>application.yml</em> using the values you created earlier, for example:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      active-directory:
        b2c:
          authenticate-additional-parameters:
            domain_hint: xxxxxxxxx         # optional
            login_hint: xxxxxxxxx          # optional
            prompt: [login,none,consent]   # optional
          base-uri: ${BASE_URI}
          credential:
            client-id: ${WEBAPP_AZURE_CLIENT_ID}
            client-secret: ${WEBAPP_AZURE_CLIENT_SECRET}
          login-flow: ${LOGIN_USER_FLOW_KEY}               # default to sign-up-or-sign-in, will look up the user-flows map with provided key.
          logout-success-url: ${LOGOUT_SUCCESS_URL}
          user-flows:
            ${YOUR_USER_FLOW_KEY}: ${USER_FLOW_NAME}
          user-name-attribute-name: ${USER_NAME_ATTRIBUTE_NAME}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 10: Write your Java code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Controller code can refer to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Controller
public class WebController {

    private void initializeModel(Model model, OAuth2AuthenticationToken token) {
        if (token != null) {
            final OAuth2User user = token.getPrincipal();
            model.addAllAttributes(user.getAttributes());
            model.addAttribute("grant_type", user.getAuthorities());
            model.addAttribute("name", user.getName());
        }
    }

    @GetMapping(value = { "/", "/home" })
    public String index(Model model, OAuth2AuthenticationToken token) {
        initializeModel(model, token);
        return "home";
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Security configuration code can refer to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@EnableWebSecurity
public class WebSecurityConfiguration extends WebSecurityConfigurerAdapter {

    private final AadB2cOidcLoginConfigurer configurer;

    public WebSecurityConfiguration(AadB2cOidcLoginConfigurer configurer) {
        this.configurer == configurer;
    }

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        // @formatter:off
        http.authorizeRequests()
                .anyRequest().authenticated()
                .and()
            .apply(configurer);
        // @formatter:off
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy the <em>home.html</em> from <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/blob/spring-cloud-azure_4.1.0-beta.1/aad/spring-cloud-azure-starter-active-directory-b2c/aad-b2c-web-application/src/main/resources/templates/home.html">aad-b2c-web-application sample</a>, and replace the <code>PROFILE_EDIT_USER_FLOW</code> and <code>PASSWORD_RESET_USER_FLOW</code> with your user flow name respectively that completed earlier.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 11: Build and test your app</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let <code>Webapp</code> run on port <em>8080</em>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>After your application is built and started by Maven, open <code><a href="http://localhost:8080/" class="bare">localhost:8080/</a></code> in a web browser; you should be redirected to login page.</p>
</li>
<li>
<p>Click link with the login user flow, you should be redirected Azure AD B2C to start the authentication process.</p>
</li>
<li>
<p>After you have logged in successfully, you should see the sample <code>home page</code> from the browser.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="usage-2-web-application-accessing-resource-servers"><a class="anchor" href="#usage-2-web-application-accessing-resource-servers"></a><a class="link" href="#usage-2-web-application-accessing-resource-servers">Usage 2: Web Application Accessing Resource Servers</a></h5>
<div class="paragraph">
<p>This scenario is based on <strong>Accessing a web application</strong> scenario to allow application to access other resources, that is [The OAuth 2.0 client credentials grant] flow.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 1: Select <strong>Azure AD B2C</strong> from the portal menu, click <strong>Applications</strong>, and then click <strong>Add</strong>.</p>
</li>
<li>
<p>Step 2: Specify your application <strong>Name</strong>, we call it <code>webApiA</code>, record the <strong>Application ID</strong> as your <code>WEB_API_A_AZURE_CLIENT_ID</code> and then click <strong>Save</strong>.</p>
</li>
<li>
<p>Step 3: Select <strong>Keys</strong> from your application, click <strong>Generate key</strong> to generate <code>WEB_API_A_AZURE_CLIENT_SECRET</code> and then <strong>Save</strong>.</p>
</li>
<li>
<p>Step 4: Select <strong>Expose an API</strong> on your left, and then Click the <strong>Set</strong> link,
record the <strong>Application ID URI</strong> as your <code>WEB_API_A_APP_ID_URL</code>, then <strong>Save</strong>.</p>
</li>
<li>
<p>Step 5: Select <strong>Manifest</strong> on your left, and then paste the below json segment into <code>appRoles</code> array,
record the <strong>Application ID URI</strong> as your <code>WEB_API_A_APP_ID_URL</code>, record the value of the app role as your <code>WEB_API_A_ROLE_VALUE</code>, then <strong>save</strong>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "allowedMemberTypes": [
    "Application"
  ],
  "description": "WebApiA.SampleScope",
  "displayName": "WebApiA.SampleScope",
  "id": "04989db0-3efe-4db6-b716-ae378517d2b7",
  "isEnabled": true,
  "value": "WebApiA.SampleScope"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142620567-59a91df7-7a97-4027-b525-1f422f25fb22.png" alt="Configure WebApiA appRoles"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 6: Select <strong>API permissions</strong> &gt; <strong>Add a permission</strong> &gt; <strong>My APIs</strong>, select <strong><em>WebApiA</em></strong> application name, select <strong>Application Permissions</strong>, select <strong>WebApiA.SampleScope</strong> permission, select <strong>Add permission</strong> to complete the process.</p>
</li>
<li>
<p>Step 7: Grant admin consent for <strong><em>WebApiA</em></strong> permissions.
<span class="image"><img src="https://user-images.githubusercontent.com/13167207/142620601-660400fa-7cff-4989-9d7f-2b32a9aa1244.png" alt="Add WebApiA permission"></span></p>
</li>
<li>
<p>Step 8: Add the following dependency on the basis of <strong>Accessing a web application</strong> scenario.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-webflux&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 9: Add the following configuration on the basis of <strong>Accessing a web application</strong> scenario.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      active-directory:
        b2c:
          base-uri: ${BASE_URI}             # Such as: https://xxxxb2c.b2clogin.com
          profile:
            tenant-id: ${AZURE_TENANT_ID}
          authorization-clients:
            ${RESOURCE_SERVER_A_NAME}:
              authorization-grant-type: client_credentials
              scopes: ${WEB_API_A_APP_ID_URL}/.default</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 10: Write your <code>Webapp</code> Java code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Controller code can refer to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">class Demo {
    /**
     * Access to protected data from Webapp to WebApiA through client credential flow. The access token is obtained by webclient, or
     * &lt;p&gt;@RegisteredOAuth2AuthorizedClient("webApiA")&lt;/p&gt;. In the end, these two approaches will be executed to
     * DefaultOAuth2AuthorizedClientManager#authorize method, get the access token.
     *
     * @return Respond to protected data from WebApi A.
     */
    @GetMapping("/webapp/webApiA")
    public String callWebApiA() {
        String body = webClient
            .get()
            .uri(LOCAL_WEB_API_A_SAMPLE_ENDPOINT)
            .attributes(clientRegistrationId("webApiA"))
            .retrieve()
            .bodyToMono(String.class)
            .block();
        LOGGER.info("Call callWebApiA(), request '/webApiA/sample' returned: {}", body);
        return "Request '/webApiA/sample'(WebApi A) returned a " + (body != null ? "success." : "failure.");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Security configuration code is the same with <strong>Accessing a web application</strong> scenario, another bean <code>webClient</code> is added as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class SampleConfiguration {
    @Bean
    public WebClient webClient(OAuth2AuthorizedClientManager oAuth2AuthorizedClientManager) {
        ServletOAuth2AuthorizedClientExchangeFilterFunction function =
            new ServletOAuth2AuthorizedClientExchangeFilterFunction(oAuth2AuthorizedClientManager);
        return WebClient.builder()
                        .apply(function.oauth2Configuration())
                        .build();
    }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 11: Please refer to <strong>Accessing a resource server</strong> section to write your <code>WebApiA</code> Java code.</p>
</li>
<li>
<p>Step 12: Build and test your app</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let <code>Webapp</code> and <code>WebApiA</code> run on port <em>8080</em> and <em>8081</em> respectively.
 Start <code>Webapp</code> and <code>WebApiA</code> application, return to the home page after logging successfully, you can access <code><a href="http://localhost:8080/webapp/webApiA" class="bare">localhost:8080/webapp/webApiA</a></code> to get <strong>WebApiA</strong> resource response.</p>
</div>
</div>
<div class="sect4">
<h5 id="usage-3-accessing-a-resource-server"><a class="anchor" href="#usage-3-accessing-a-resource-server"></a><a class="link" href="#usage-3-accessing-a-resource-server">Usage 3: Accessing a Resource Server</a></h5>
<div class="paragraph">
<p>This scenario not support login. Just protect the server by validating the access token, and if valid, serves the request.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 1: Refer to <a href="#usage-2-web-application-accessing-resource-servers">Usage 2: Web Application Accessing Resource Servers</a> to build your <code>WebApiA</code> permission.</p>
</li>
<li>
<p>Step 2: Add <code>WebApiA</code> permission and grant admin consent for your web application.</p>
</li>
<li>
<p>Step 3: Add the following dependencies in your <em>pom.xml</em>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
        &lt;artifactId&gt;azure-spring-boot-starter-active-directory-b2c&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 4: Add the following configuration.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      active-directory:
        b2c:
          base-uri: ${BASE_URI}             # Such as: https://xxxxb2c.b2clogin.com
          profile:
            tenant-id: ${AZURE_TENANT_ID}
          app-id-uri: ${APP_ID_URI}         # If you are using v1.0 token, please configure app-id-uri for `aud` verification
          credential:
            client-id: ${AZURE_CLIENT_ID}           # If you are using v2.0 token, please configure client-id for `aud` verification</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 5: Write your Java code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Controller code can refer to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">class Demo {
    /**
     * webApiA resource api for web app
     * @return test content
     */
    @PreAuthorize("hasAuthority('APPROLE_WebApiA.SampleScope')")
    @GetMapping("/webApiA/sample")
    public String webApiASample() {
        LOGGER.info("Call webApiASample()");
        return "Request '/webApiA/sample'(WebApi A) returned successfully.";
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Security configuration code can refer to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class ResourceServerConfiguration extends WebSecurityConfigurerAdapter {

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.authorizeRequests((requests) -&gt; requests.anyRequest().authenticated())
            .oauth2ResourceServer()
            .jwt()
            .jwtAuthenticationConverter(new AadJwtBearerTokenAuthenticationConverter());
    }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 6: Build and test your app</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let <code>WebApiA</code> run on port <em>8081</em>.
 Get the access token for <code>webApiA</code> resource and access <code><a href="http://localhost:8081/webApiA/sample" class="bare">localhost:8081/webApiA/sample</a></code>
 as the Bearer authorization header.</p>
</div>
</div>
<div class="sect4">
<h5 id="usage-4-resource-server-accessing-other-resource-servers"><a class="anchor" href="#usage-4-resource-server-accessing-other-resource-servers"></a><a class="link" href="#usage-4-resource-server-accessing-other-resource-servers">Usage 4: Resource Server Accessing Other Resource Servers</a></h5>
<div class="paragraph">
<p>This scenario is an upgrade of <strong>Accessing a resource server</strong>, supports access to other application resources, based on OAuth2 client credentials flow.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 1: Referring to the previous steps, we create a <code>WebApiB</code> application and expose an application permission <code>WebApiB.SampleScope</code>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    "allowedMemberTypes": [
        "Application"
    ],
    "description": "WebApiB.SampleScope",
    "displayName": "WebApiB.SampleScope",
    "id": "04989db0-3efe-4db6-b716-ae378517d2b7",
    "isEnabled": true,
    "lang": null,
    "origin": "Application",
    "value": "WebApiB.SampleScope"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/13167207/142620648-cfbf5220-9736-4050-a3ef-1370c522e672.png" alt="Configure WebApiB appRoles"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 2: Grant admin consent for <strong><em>WebApiB</em></strong> permissions.
<span class="image"><img src="https://user-images.githubusercontent.com/13167207/142620691-b1a7fcda-fc92-41af-9515-812139f26ee0.png" alt="Add WebApiB permission"></span></p>
</li>
<li>
<p>Step 3: On the basis of <strong>Accessing a resource server</strong>, add a dependency in your <em>pom.xml</em>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
 &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
 &lt;artifactId&gt;spring-boot-starter-webflux&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 4: Add the following configuration on the basis of <strong>Accessing a resource server</strong> scenario configuration.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      active-directory:
        b2c:
          credential:
            client-secret: ${WEB_API_A_AZURE_CLIENT_SECRET}
          authorization-clients:
            ${RESOURCE_SERVER_B_NAME}:
              authorization-grant-type: client_credentials
              scopes: ${WEB_API_B_APP_ID_URL}/.default</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 5: Write your Java code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>WebApiA controller code can refer to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class SampleController {
    /**
     * Access to protected data from WebApiA to WebApiB through client credential flow. The access token is obtained by webclient, or
     * &lt;p&gt;@RegisteredOAuth2AuthorizedClient("webApiA")&lt;/p&gt;. In the end, these two approaches will be executed to
     * DefaultOAuth2AuthorizedClientManager#authorize method, get the access token.
     *
     * @return Respond to protected data from WebApi B.
     */
    @GetMapping("/webApiA/webApiB/sample")
    @PreAuthorize("hasAuthority('APPROLE_WebApiA.SampleScope')")
    public String callWebApiB() {
        String body = webClient
            .get()
            .uri(LOCAL_WEB_API_B_SAMPLE_ENDPOINT)
            .attributes(clientRegistrationId("webApiB"))
            .retrieve()
            .bodyToMono(String.class)
            .block();
        LOGGER.info("Call callWebApiB(), request '/webApiB/sample' returned: {}", body);
        return "Request 'webApiA/webApiB/sample'(WebApi A) returned a " + (body != null ? "success." : "failure.");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>WebApiB controller code can refer to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class SampleController {
    /**
     * webApiB resource api for other web application
     * @return test content
     */
    @PreAuthorize("hasAuthority('APPROLE_WebApiB.SampleScope')")
    @GetMapping("/webApiB/sample")
    public String webApiBSample() {
        LOGGER.info("Call webApiBSample()");
        return "Request '/webApiB/sample'(WebApi B) returned successfully.";
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Security configuration code is the same with <strong>Accessing a resource server</strong> scenario, another bean <code>webClient</code> is added as follows</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class SampleConfiguration {
    @Bean
    public WebClient webClient(OAuth2AuthorizedClientManager oAuth2AuthorizedClientManager) {
        ServletOAuth2AuthorizedClientExchangeFilterFunction function =
            new ServletOAuth2AuthorizedClientExchangeFilterFunction(oAuth2AuthorizedClientManager);
        return WebClient.builder()
                        .apply(function.oauth2Configuration())
                        .build();
    }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 6: Build and test your app</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let <code>WebApiA</code> and <code>WebApiB</code> run on port <em>8081</em> and <em>8082</em> respectively.
 Start <code>WebApiA</code> and <code>WebApiB</code> application, get the access token for <code>webApiA</code> resource and access <code><a href="http://localhost:8081/webApiA/webApiB/sample" class="bare">localhost:8081/webApiA/webApiB/sample</a></code>
 as the Bearer authorization header.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="samples-9"><a class="anchor" href="#samples-9"></a><a class="link" href="#samples-9">25.2.4. Samples</a></h4>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.1.0-beta.1/aad/spring-cloud-azure-starter-active-directory-b2c">spring-cloud-azure-starter-active-directory-b2c samples</a> for more details.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-integration-support"><a class="anchor" href="#spring-integration-support"></a><a class="link" href="#spring-integration-support">26. Spring Integration Support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Integration Extension for Azure provides Spring Integration adapters for the various services provided by the <a href="https://github.com/Azure/azure-sdk-for-java/">Azure SDK for Java</a>. We provide Spring Integration support for these Azure services: Event Hubs, Service Bus, Storage Queue. Below is a list of supported adapters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>spring-cloud-azure-starter-integration-eventhubs</p>
</li>
<li>
<p>spring-cloud-azure-starter-integration-servicebus</p>
</li>
<li>
<p>spring-cloud-azure-starter-integration-storage-queue</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="spring-integration-with-azure-event-hubs"><a class="anchor" href="#spring-integration-with-azure-event-hubs"></a><a class="link" href="#spring-integration-with-azure-event-hubs">26.1. Spring Integration with Azure Event Hubs</a></h3>
<div class="sect3">
<h4 id="key-concepts-2"><a class="anchor" href="#key-concepts-2"></a><a class="link" href="#key-concepts-2">26.1.1. Key Concepts</a></h4>
<div class="paragraph">
<p>Azure Event Hubs is a big data streaming platform and event ingestion service. It can receive and process millions of events per second. Data sent to an event hub can be transformed and stored by using any real-time analytics provider or batching/storage adapters.</p>
</div>
<div class="paragraph">
<p>Spring Integration enables lightweight messaging within Spring-based applications and supports integration with external systems via declarative adapters. Those adapters provide a higher-level of abstraction over Spring’s support for remoting, messaging, and scheduling. The <strong>Spring Integration for Event Hubs</strong> extension project provides inbound and outbound channel adapters and gateways for Azure Event Hubs.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
RxJava support APIs are dropped from version 4.0.0.
Please refer to Javadoc for details.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="consumer-group"><a class="anchor" href="#consumer-group"></a><a class="link" href="#consumer-group">Consumer Group</a></h5>
<div class="paragraph">
<p>Event Hubs provides similar support of consumer group as Apache Kafka, but with slight different logic. While Kafka
stores all committed offsets in the broker, you have to store offsets of Event Hubs messages
being processed manually. Event Hubs SDK provides the function to store such offsets inside Azure Storage.</p>
</div>
</div>
<div class="sect4">
<h5 id="partitioning-support"><a class="anchor" href="#partitioning-support"></a><a class="link" href="#partitioning-support">Partitioning Support</a></h5>
<div class="paragraph">
<p>Event Hubs provides a similar concept of physical partition as Kafka. But unlike Kafka&#8217;s auto re-balancing between consumers and partitions, Event Hubs provides a kind of preemptive mode. The storage account acts as a lease to determine which partition is owned by which consumer. When a new consumer starts, it will try to steal some partitions
from most heavy-loaded consumers to achieve the workload balancing.</p>
</div>
<div class="paragraph">
<p>To specify the load balancing strategy, developers can use <code>EventHubsContainerProperties</code> for the configuration. See <a href="#receive-from-eh">the below section</a> for an example of how to configure <code>EventHubsContainerProperties</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="batch-consumer-support"><a class="anchor" href="#batch-consumer-support"></a><a class="link" href="#batch-consumer-support">Batch Consumer Support</a></h5>
<div class="paragraph">
<p>The <code>EventHubsInboundChannelAdapter</code> supports the batch-consuming mode. To enable it, users can specify the listener mode as <code>ListenerMode.BATCH</code> when constructing an <code>EventHubsInboundChannelAdapter</code> instance.
When enabled, an <strong>Message</strong> of which the payload is a list of batched events will be received and passed to the downstream channel. Each message header is also converted as a list, of which the content is the associated header value parsed from each event. For the communal headers of partition id, checkpointer and last enqueued properties, they are presented as a single value for the entire batch of events shares the same one. See <a href="#si-eh-headers">Event Hubs Message Headers</a> for more details.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The checkpoint header only exists when <strong>MANUAL</strong> checkpoint mode is used.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Checkpointing of batch consumer supports two modes: <code>BATCH</code> and <code>MANUAL</code>. <code>BATCH</code> mode is an auto checkpointing mode to checkpoint the entire batch of events together once they are received. <code>MANUAL</code> mode is to checkpoint the events by users. When used, the
<strong>Checkpointer</strong> will be passed into the message header, and users could use it to do checkpointing.</p>
</div>
<div class="paragraph">
<p>The batch consuming policy can be specified by properties of <code>max-size</code> and <code>max-wait-time</code>, where <code>max-size</code> is a necessary property while <code>max-wait-time</code> is optional.
To specify the batch consuming strategy, developers can use <code>EventHubsContainerProperties</code> for the configuration. See <a href="#receive-from-eh">the below section</a> for an example of how to configure <code>EventHubsContainerProperties</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dependency-setup-6"><a class="anchor" href="#dependency-setup-6"></a><a class="link" href="#dependency-setup-6">26.1.2. Dependency Setup</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-integration-eventhubs&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-7"><a class="anchor" href="#configuration-7"></a><a class="link" href="#configuration-7">26.1.3. Configuration</a></h4>
<div class="paragraph">
<p>This starter provides the following 3 parts of configuration options:</p>
</div>
<div class="sect4">
<h5 id="connection-configuration-properties"><a class="anchor" href="#connection-configuration-properties"></a><a class="link" href="#connection-configuration-properties">Connection Configuration Properties</a></h5>
<div class="paragraph">
<p>This section contains the configuration options used for connecting to Azure Event Hubs.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 21. Connection configurable properties of spring-cloud-azure-starter-integration-eventhubs</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether an Azure Event Hubs is enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.connection-string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event Hubs Namespace connection string value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.namespace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event Hubs Namespace value, which is the prefix of the FQDN. A FQDN should be composed of &lt;NamespaceName&gt;.&lt;DomainName&gt;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.domain-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Domain name of an Azure Event Hubs Namespace value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.custom-endpoint-address</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom Endpoint address.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.shared-connection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the underlying EventProcessorClient and EventHubProducerAsyncClient use the same connection. By
default, a new connection is constructed and used created for each Event Hub client created.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="checkpoint-configuration-properties"><a class="anchor" href="#checkpoint-configuration-properties"></a><a class="link" href="#checkpoint-configuration-properties">Checkpoint Configuration Properties</a></h5>
<div class="paragraph">
<p>This section contains the configuration options for the Storage Blobs service, which is used for persisting partition ownership and checkpoint information.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
From version 4.0.0, when the property of <strong>spring.cloud.azure.eventhubs.processor.checkpoint-store.create-container-if-not-exists</strong> is not enabled manually, no Storage container will be created automatically.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 22. Checkpointing configurable properties of spring-cloud-azure-starter-integration-eventhubs</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs.processor.checkpoint-store</strong>.create-container-if-not-exists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to allow creating containers if not exists.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs.processor.checkpoint-store</strong>.account-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name for the storage account.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs.processor.checkpoint-store</strong>.account-key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage account access key.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs.processor.checkpoint-store</strong>.container-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage container name.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Common Azure Service SDK configuration options are configurable for Storage Blob checkpoint store as well. The supported configuration options are introduced in <a href="configuration.html">the Configuration page</a>, and could be configured with either the unified prefix <code>spring.cloud.azure.</code> or the prefix of <code>spring.cloud.azure.eventhubs.processor.checkpoint-store</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="event-hub-processor-configuration-properties"><a class="anchor" href="#event-hub-processor-configuration-properties"></a><a class="link" href="#event-hub-processor-configuration-properties">Event Hub Processor Configuration Properties</a></h5>
<div class="paragraph">
<p>The <code>EventHubsInboundChannelAdapter</code> uses the <code>EventProcessorClient</code> to consume messages from an event hub, to configure the overall properties of an <code>EventProcessorClient</code>,
developers can use <code>EventHubsContainerProperties</code> for the configuration. See <a href="#receive-from-eh">the below section</a> about how to work with <code>EventHubsInboundChannelAdapter</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="basic-usage-6"><a class="anchor" href="#basic-usage-6"></a><a class="link" href="#basic-usage-6">26.1.4. Basic Usage</a></h4>
<div class="sect4">
<h5 id="send-messages-to-azure-event-hubs"><a class="anchor" href="#send-messages-to-azure-event-hubs"></a><a class="link" href="#send-messages-to-azure-event-hubs">Send messages to Azure Event Hubs</a></h5>
<div class="paragraph">
<p>Step 1. Fill the credential configuration options.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as connection string, configure below properties in <code>application.yml</code>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      eventhubs:
        connection-string: ${AZURE_SERVICE_BUS_CONNECTION_STRING}
        processor:
          checkpoint-store:
            container-name: ${CHECKPOINT-CONTAINER}
            account-name: ${CHECKPOINT-STORAGE-ACCOUNT}
            account-key: ${CHECKPOINT-ACCESS-KEY}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as managed identities, configure below properties in <code>application.yml</code>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      credential:
        managed-identity-enabled: true
        client-id: ${AZURE_CLIENT_ID}
      eventhubs:
        namespace: ${AZURE_SERVICE_BUS_NAMESPACE}
        processor:
          checkpoint-store:
            container-name: ${CONTAINER_NAME}
            account-name: ${ACCOUNT_NAME}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as service principal, configure below properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      credential:
        client-id: ${AZURE_CLIENT_ID}
        client-secret: ${AZURE_CLIENT_SECRET}
      profile:
        tenant-id: ${AZURE_TENANT_ID}
      eventhubs:
        namespace: ${AZURE_SERVICE_BUS_NAMESPACE}
        processor:
          checkpoint-store:
            container-name: ${CONTAINER_NAME}
            account-name: ${ACCOUNT_NAME}</pre>
</div>
</div>
<div class="paragraph">
<p>Step 2. Create <code>DefaultMessageHandler</code> with the bean of <code>EventHubsTemplate</code> to send messages to Event Hubs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">class Demo {
    private static final String OUTPUT_CHANNEL = "output";
    private static final String EVENTHUB_NAME = "eh1";

    @Bean
    @ServiceActivator(inputChannel = OUTPUT_CHANNEL)
    public MessageHandler messageSender(EventHubsTemplate eventHubsTemplate) {
        DefaultMessageHandler handler = new DefaultMessageHandler(EVENTHUB_NAME, eventHubsTemplate);
        handler.setSendCallback(new ListenableFutureCallback&lt;Void&gt;() {
            @Override
            public void onSuccess(Void result) {
                LOGGER.info("Message was sent successfully.");
            }
            @Override
            public void onFailure(Throwable ex) {
                LOGGER.error("There was an error sending the message.", ex);
            }
        });
        return handler;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 3. Create a message gateway binding with the above message handler via a message channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">class Demo {
    @Autowired
    EventHubOutboundGateway messagingGateway;

    @MessagingGateway(defaultRequestChannel = OUTPUT_CHANNEL)
    public interface EventHubOutboundGateway {
        void send(String text);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 4. Send messages using the gateway.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">class Demo {
    public void demo() {
        this.messagingGateway.send(message);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="receive-from-eh"><a class="anchor" href="#receive-from-eh"></a><a class="link" href="#receive-from-eh">Receive Messages from Azure Event Hubs</a></h5>
<div class="paragraph">
<p>Step 1. Fill the credential configuration options.</p>
</div>
<div class="paragraph">
<p>Step 2. Create a bean of message channel as the input channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Configuration
class Demo {
    @Bean
    public MessageChannel input() {
        return new DirectChannel();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 3. Create <code>EventHubsInboundChannelAdapter</code> with the bean of <code>EventHubsMessageListenerContainer</code> to receive messages from Event Hubs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Configuration
class Demo {
    private static final String INPUT_CHANNEL = "input";
    private static final String EVENTHUB_NAME = "eh1";
    private static final String CONSUMER_GROUP = "$Default";

    @Bean
    public EventHubsInboundChannelAdapter messageChannelAdapter(
            @Qualifier(INPUT_CHANNEL) MessageChannel inputChannel,
            EventHubsMessageListenerContainer listenerContainer) {
        EventHubsInboundChannelAdapter adapter = new EventHubsInboundChannelAdapter(processorContainer);
        adapter.setOutputChannel(inputChannel);
        return adapter;
    }

    @Bean
    public EventHubsMessageListenerContainer messageListenerContainer(EventHubsProcessorFactory processorFactory) {
        EventHubsContainerProperties containerProperties = new EventHubsContainerProperties();
        containerProperties.setEventHubName(EVENTHUB_NAME);
        containerProperties.setConsumerGroup(CONSUMER_GROUP);
        containerProperties.setCheckpointConfig(new CheckpointConfig(CheckpointMode.MANUAL));
        return new EventHubsMessageListenerContainer(processorFactory, containerProperties);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 4. Create a message receiver binding with EventHubsInboundChannelAdapter via the message channel created before.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">class Demo {
    @ServiceActivator(inputChannel = INPUT_CHANNEL)
    public void messageReceiver(byte[] payload, @Header(AzureHeaders.CHECKPOINTER) Checkpointer checkpointer) {
        String message = new String(payload);
        LOGGER.info("New message received: '{}'", message);
        checkpointer.success()
                .doOnSuccess(s -&gt; LOGGER.info("Message '{}' successfully checkpointed", message))
                .doOnError(e -&gt; LOGGER.error("Error found", e))
                .block();
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-eventhubsmessageconverter-to-customize-objectmapper"><a class="anchor" href="#configure-eventhubsmessageconverter-to-customize-objectmapper"></a><a class="link" href="#configure-eventhubsmessageconverter-to-customize-objectmapper">Configure EventHubsMessageConverter to Customize ObjectMapper</a></h5>
<div class="paragraph">
<p><code>EventHubsMessageConverter</code> is made as a configurable bean to allow users to customize ObjectMapper.</p>
</div>
</div>
<div class="sect4">
<h5 id="si-eh-batch"><a class="anchor" href="#si-eh-batch"></a><a class="link" href="#si-eh-batch">Batch Consumer Support</a></h5>
<div class="paragraph">
<p>To consume messages from Event Hubs in batches is similar with the above sample, besides users should set the batch-consuming related configuration options for <code>EventHubsInboundChannelAdapter</code>.</p>
</div>
<div class="paragraph">
<p>When create <code>EventHubsInboundChannelAdapter</code>, the listener mode should be set as <code>BATCH</code>. When create bean of <code>EventHubsMessageListenerContainer</code>, set the checkpoint mode as either <code>MANUAL</code> or <code>BATCH</code>, and the batch options can be configured as needed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Configuration
class Demo {
    private static final String INPUT_CHANNEL = "input";
    private static final String EVENTHUB_NAME = "eh1";
    private static final String CONSUMER_GROUP = "$Default";

    @Bean
    public EventHubsInboundChannelAdapter messageChannelAdapter(
            @Qualifier(INPUT_CHANNEL) MessageChannel inputChannel,
            EventHubsMessageListenerContainer listenerContainer) {
        EventHubsInboundChannelAdapter adapter = new EventHubsInboundChannelAdapter(processorContainer, ListenerMode.BATCH);
        adapter.setOutputChannel(inputChannel);
        return adapter;
    }

    @Bean
    public EventHubsMessageListenerContainer messageListenerContainer(EventHubsProcessorFactory processorFactory) {
        EventHubsContainerProperties containerProperties = new EventHubsContainerProperties();
        containerProperties.setEventHubName(EVENTHUB_NAME);
        containerProperties.setConsumerGroup(CONSUMER_GROUP);
        containerProperties.getBatch().setMaxSize(100);
        containerProperties.setCheckpointConfig(new CheckpointConfig(CheckpointMode.MANUAL));
        return new EventHubsMessageListenerContainer(processorFactory, containerProperties);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="si-eh-headers"><a class="anchor" href="#si-eh-headers"></a><a class="link" href="#si-eh-headers">Event Hubs Message Headers</a></h5>
<div class="paragraph">
<p>The following table illustrates how Event Hubs message properties are mapped to Spring message headers. For Azure Event Hubs, message is called as <code>event</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 23. Mapping between Event Hubs Message / Event Properties and Spring Message Headers in Record Listener Mode</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Event Hubs Event Properties</th>
<th class="tableblock halign-left valign-top">Spring Message Header Constants</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enqueued time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventHubsHeaders#ENQUEUED_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Instant</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The instant, in UTC, of when the event was enqueued in the Event Hub partition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Offset</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventHubsHeaders#OFFSET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The offset of the event when it was received from the associated Event Hub partition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Partition key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AzureHeaders#PARTITION_KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The partition hashing key if it was set when originally publishing the event.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Partition id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AzureHeaders#RAW_PARTITION_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The partition id of the Event Hub.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sequence number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventHubsHeaders#SEQUENCE_NUMBER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The sequence number assigned to the event when it was enqueued in the associated Event Hub partition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Last enqueued event properties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventHubsHeaders#LAST_ENQUEUED_EVENT_PROPERTIES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LastEnqueuedEventProperties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The properties of the last enqueued event in this partition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AzureHeaders#CHECKPOINTER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checkpointer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The header for checkpoint the specific message.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Users can parse the message headers for the related information of each event. To set a message header for the event, all customized headers will be put as an application property of an event, where the header is set as the property key. When events are received from Event Hubs, all application properties will be converted to the message header.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Message headers of partition key, enqueued time, offset and sequence number is not supported to be set manually.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When the batch-consumer mode is enabled, the specific headers of batched messages are listed as below, which contains a list of values from each single Event Hubs event.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 24. Mapping between Event Hubs Message / Event Properties and Spring Message Headers in Batch Listener Mode</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Event Hubs Event Properties</th>
<th class="tableblock halign-left valign-top">Spring Batch Message Header Constants</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enqueued time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventHubsHeaders#ENQUEUED_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of Instant</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of the instant, in UTC, of when each event was enqueued in the Event Hub partition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Offset</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventHubsHeaders#OFFSET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of the offset of each event when it was received from the associated Event Hub partition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Partition key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AzureHeaders#PARTITION_KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of the partition hashing key if it was set when originally publishing each event.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sequence number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventHubsHeaders#SEQUENCE_NUMBER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of the sequence number assigned to each event when it was enqueued in the associated Event Hub partition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">System properties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventHubsHeaders#BATCH_CONVERTED_SYSTEM_PROPERTIES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of Map</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of the system properties of each event.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Application properties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventHubsHeaders#BATCH_CONVERTED_APPLICATION_PROPERTIES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of Map</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of the application properties of each event, where all customized message headers or event properties are placed.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When publish messages, all the above batch headers will be removed from the messages if exist.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="samples-10"><a class="anchor" href="#samples-10"></a><a class="link" href="#samples-10">26.1.5. Samples</a></h4>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.1.0-beta.1/eventhubs/spring-cloud-azure-starter-integration-eventhubs/eventhubs-integration">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="spring-integration-with-azure-service-bus"><a class="anchor" href="#spring-integration-with-azure-service-bus"></a><a class="link" href="#spring-integration-with-azure-service-bus">26.2. Spring Integration with Azure Service Bus</a></h3>
<div class="sect3">
<h4 id="key-concepts-3"><a class="anchor" href="#key-concepts-3"></a><a class="link" href="#key-concepts-3">26.2.1. Key Concepts</a></h4>
<div class="paragraph">
<p>Spring Integration enables lightweight messaging within Spring-based applications and supports integration with external systems via declarative adapters.</p>
</div>
<div class="paragraph">
<p>The Spring Integration for Azure Service Bus extension project provides inbound and outbound channel adapters for Azure Service Bus.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
CompletableFuture support APIs have been deprecated from version 2.10.0, and is replaced by Reactor Core from version 4.0.0.
Please refer to Javadoc for details.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="dependency-setup-7"><a class="anchor" href="#dependency-setup-7"></a><a class="link" href="#dependency-setup-7">26.2.2. Dependency Setup</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-integration-servicebus&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-8"><a class="anchor" href="#configuration-8"></a><a class="link" href="#configuration-8">26.2.3. Configuration</a></h4>
<div class="paragraph">
<p>This starter provides the following 2 parts of configuration options:</p>
</div>
<div class="sect4">
<h5 id="connection-configuration-properties-2"><a class="anchor" href="#connection-configuration-properties-2"></a><a class="link" href="#connection-configuration-properties-2">Connection Configuration Properties</a></h5>
<div class="paragraph">
<p>This section contains the configuration options used for connecting to Azure Service Bus.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 25. Connection configurable properties of spring-cloud-azure-starter-integration-servicebus</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.servicebus</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether an Azure Service Bus is enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.servicebus</strong>.connection-string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service Bus Namespace connection string value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.servicebus</strong>.namespace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service Bus Namespace value, which is the prefix of the FQDN. A FQDN should be composed of &lt;NamespaceName&gt;.&lt;DomainName&gt;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.servicebus</strong>.domain-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Domain name of an Azure Service Bus Namespace value.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="service-bus-processor-configuration-properties"><a class="anchor" href="#service-bus-processor-configuration-properties"></a><a class="link" href="#service-bus-processor-configuration-properties">Service Bus Processor Configuration Properties</a></h5>
<div class="paragraph">
<p>The <code>ServiceBusInboundChannelAdapter</code> uses the <code>ServiceBusProcessorClient</code> to consume messages, to configure the overall properties of an <code>ServiceBusProcessorClient</code>,
developers can use <code>ServiceBusContainerProperties</code> for the configuration. See <a href="#receive-from-sb">the below section</a> about how to work with <code>ServiceBusInboundChannelAdapter</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="basic-usage-7"><a class="anchor" href="#basic-usage-7"></a><a class="link" href="#basic-usage-7">26.2.4. Basic Usage</a></h4>
<div class="sect4">
<h5 id="send-messages-to-azure-service-bus"><a class="anchor" href="#send-messages-to-azure-service-bus"></a><a class="link" href="#send-messages-to-azure-service-bus">Send Messages to Azure Service Bus</a></h5>
<div class="paragraph">
<p>Step 1. Fill the credential configuration options.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as connection string, configure below properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      servicebus:
        connection-string: ${AZURE_SERVICE_BUS_CONNECTION_STRING}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as managed identities, configure below properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      credential:
        managed-identity-enabled: true
        client-id: ${AZURE_CLIENT_ID}
      profile:
        tenant-id: ${AZURE_TENANT_ID}
      servicebus:
        namespace: ${AZURE_SERVICE_BUS_NAMESPACE}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as service principal, configure below properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      credential:
        client-id: ${AZURE_CLIENT_ID}
        client-secret: ${AZURE_CLIENT_SECRET}
      profile:
        tenant-id: ${AZURE_TENANT_ID}
      servicebus:
        namespace: ${AZURE_SERVICE_BUS_NAMESPACE}</pre>
</div>
</div>
<div class="paragraph">
<p>Step 2. Create <code>DefaultMessageHandler</code> with the bean of <code>ServiceBusTemplate</code> to send messages to Service Bus,
set the entity type for the ServiceBusTemplate. This sample takes Service Bus Queue as example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">class Demo {
    private static final String OUTPUT_CHANNEL = "queue.output";

    @Bean
    @ServiceActivator(inputChannel = OUTPUT_CHANNEL)
    public MessageHandler queueMessageSender(ServiceBusTemplate serviceBusTemplate) {
        serviceBusTemplate.setDefaultEntityType(ServiceBusEntityType.QUEUE);
        DefaultMessageHandler handler = new DefaultMessageHandler(QUEUE_NAME, serviceBusTemplate);
        handler.setSendCallback(new ListenableFutureCallback&lt;Void&gt;() {
            @Override
            public void onSuccess(Void result) {
                LOGGER.info("Message was sent successfully.");
            }

            @Override
            public void onFailure(Throwable ex) {
                LOGGER.info("There was an error sending the message.");
            }
        });

        return handler;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 3. Create a message gateway binding with the above message handler via a message channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">class Demo {
    @Autowired
    QueueOutboundGateway messagingGateway;

    @MessagingGateway(defaultRequestChannel = OUTPUT_CHANNEL)
    public interface QueueOutboundGateway {
        void send(String text);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 4. Send messages using the gateway.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">class Demo {
    public void demo() {
        this.messagingGateway.send(message);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="receive-from-sb"><a class="anchor" href="#receive-from-sb"></a><a class="link" href="#receive-from-sb">Receive Messages from Azure Service Bus</a></h5>
<div class="paragraph">
<p>Step 1. Fill the credential configuration options.</p>
</div>
<div class="paragraph">
<p>Step 2. Create a bean of message channel as the input channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Configuration
class Demo {
    private static final String INPUT_CHANNEL = "input";

    @Bean
    public MessageChannel input() {
        return new DirectChannel();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 3. Create <code>ServiceBusInboundChannelAdapter</code> with the bean of <code>ServiceBusMessageListenerContainer</code> to receive messages to Service Bus. This sample takes Service Bus Queue as example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Configuration
class Demo {
    private static final String QUEUE_NAME = "queue1";

    @Bean
    public ServiceBusMessageListenerContainer messageListenerContainer(ServiceBusProcessorFactory processorFactory) {
        ServiceBusContainerProperties containerProperties = new ServiceBusContainerProperties();
        containerProperties.setEntityName(QUEUE_NAME);
        containerProperties.setAutoComplete(false);
        return new ServiceBusMessageListenerContainer(processorFactory, containerProperties);
    }

    @Bean
    public ServiceBusInboundChannelAdapter queueMessageChannelAdapter(
        @Qualifier(INPUT_CHANNEL) MessageChannel inputChannel,
        ServiceBusMessageListenerContainer listenerContainer) {
        ServiceBusInboundChannelAdapter adapter = new ServiceBusInboundChannelAdapter(listenerContainer);
        adapter.setOutputChannel(inputChannel);
        return adapter;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 4. Create a message receiver binding with ServiceBusInboundChannelAdapter via the message channel we created before.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">class Demo {
    @ServiceActivator(inputChannel = INPUT_CHANNEL)
    public void messageReceiver(byte[] payload, @Header(AzureHeaders.CHECKPOINTER) Checkpointer checkpointer) {
        String message = new String(payload);
        LOGGER.info("New message received: '{}'", message);
        checkpointer.success()
                .doOnSuccess(s -&gt; LOGGER.info("Message '{}' successfully checkpointed", message))
                .doOnError(e -&gt; LOGGER.error("Error found", e))
                .block();
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-servicebusmessageconverter-to-customize-objectmapper"><a class="anchor" href="#configure-servicebusmessageconverter-to-customize-objectmapper"></a><a class="link" href="#configure-servicebusmessageconverter-to-customize-objectmapper">Configure ServiceBusMessageConverter to Customize ObjectMapper</a></h5>
<div class="paragraph">
<p><code>ServiceBusMessageConverter</code> is made as a configurable bean to allow users to customize ObjectMapper.</p>
</div>
</div>
<div class="sect4">
<h5 id="si-sb-headers"><a class="anchor" href="#si-sb-headers"></a><a class="link" href="#si-sb-headers">Service Bus Message Headers</a></h5>
<div class="paragraph">
<p>For some Service Bus headers that can be mapped to multiple Spring header constants, the priority of different Spring headers is listed.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 26. Mapping between Service Bus Headers and Spring Headers</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Service Bus Message Headers and Properties</th>
<th class="tableblock halign-left valign-top">Spring Message Header Constants</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Configurable</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Content type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MessageHeaders#CONTENT_TYPE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The RFC2045 Content-Type descriptor of the message.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Correlation id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#CORRELATION_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The correlation id of the message</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#MESSAGE_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The message id of the message, this header has higher priority than <code>MessageHeaders#ID</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MessageHeaders#ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UUID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The message id of the message, this header has lower priority than <code>ServiceBusMessageHeaders#MESSAGE_ID</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Partition key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#PARTITION_KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The partition key for sending the message to a partitioned entity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reply to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MessageHeaders#REPLY_CHANNEL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The address of an entity to send replies to.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reply to session id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#REPLY_TO_SESSION_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ReplyToGroupId property value of the message.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Scheduled enqueue time utc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#SCHEDULED_ENQUEUE_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OffsetDateTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The datetime at which the message should be enqueued in Service Bus, this header has higher priority than <code>AzureHeaders#SCHEDULED_ENQUEUE_MESSAGE</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Scheduled enqueue time utc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AzureHeaders#SCHEDULED_ENQUEUE_MESSAGE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The datetime at which the message should be enqueued in Service Bus, this header has lower priority than <code>ServiceBusMessageHeaders#SCHEDULED_ENQUEUE_TIME</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Session id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#SESSION_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The session identifier for a session-aware entity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time to live</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#TIME_TO_LIVE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The duration of time before this message expires.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">To</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#TO</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The "to" address of the message, reserved for future use in routing scenarios and presently ignored by the broker itself.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Subject</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#SUBJECT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The subject for the message.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dead letter error description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#DEAD_LETTER_ERROR_DESCRIPTION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The description for a message that has been dead-lettered.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dead letter reason</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#DEAD_LETTER_REASON</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The reason a message was dead-lettered.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dead letter source</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#DEAD_LETTER_SOURCE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The entity in which the message was dead-lettered.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delivery count</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#DELIVERY_COUNT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of the times this message was delivered to clients.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enqueued sequence number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#ENQUEUED_SEQUENCE_NUMBER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The enqueued sequence number assigned to a message by Service Bus.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enqueued time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#ENQUEUED_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OffsetDateTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The datetime at which this message was enqueued in Service Bus.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Expires at</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#EXPIRES_AT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OffsetDateTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The datetime at which this message will expire.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lock token</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#LOCK_TOKEN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The lock token for the current message.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Locked until</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#LOCKED_UNTIL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OffsetDateTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The datetime at which the lock of this message expires.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sequence number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#SEQUENCE_NUMBER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The unique number assigned to a message by Service Bus.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">State</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageHeaders#STATE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusMessageState</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The state of the message, which can be Active, Deferred, or Scheduled.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="partition-key-support"><a class="anchor" href="#partition-key-support"></a><a class="link" href="#partition-key-support">Partition Key Support</a></h5>
<div class="paragraph">
<p>This starter supports <a href="https://docs.microsoft.com/azure/service-bus-messaging/service-bus-partitioning">Service Bus partitioning</a> by allowing setting partition key and session id in the message header. This section introduces how to set partition key for messages.</p>
</div>
<div class="paragraph">
<p><em>Recommended:</em> Use <code>ServiceBusMessageHeaders.PARTITION_KEY</code> as the key of the header.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class SampleController {
    @PostMapping("/messages")
    public ResponseEntity&lt;String&gt; sendMessage(@RequestParam String message) {
        LOGGER.info("Going to add message {} to Sinks.Many.", message);
        many.emitNext(MessageBuilder.withPayload(message)
                                    .setHeader(ServiceBusMessageHeaders.PARTITION_KEY, "Customize partition key")
                                    .build(), Sinks.EmitFailureHandler.FAIL_FAST);
        return ResponseEntity.ok("Sent!");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Not recommended but currently supported:</em> <code>AzureHeaders.PARTITION_KEY</code> as the key of the header.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class SampleController {
    @PostMapping("/messages")
    public ResponseEntity&lt;String&gt; sendMessage(@RequestParam String message) {
        LOGGER.info("Going to add message {} to Sinks.Many.", message);
        many.emitNext(MessageBuilder.withPayload(message)
                                    .setHeader(AzureHeaders.PARTITION_KEY, "Customize partition key")
                                    .build(), Sinks.EmitFailureHandler.FAIL_FAST);
        return ResponseEntity.ok("Sent!");
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When both <code>ServiceBusMessageHeaders.PARTITION_KEY</code> and <code>AzureHeaders.PARTITION_KEY</code> are set in the message headers,
<code>ServiceBusMessageHeaders.PARTITION_KEY</code> is preferred.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="session-support"><a class="anchor" href="#session-support"></a><a class="link" href="#session-support">Session Support</a></h5>
<div class="paragraph">
<p>This example demonstrates how to manually set the session id of a message in the application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class SampleController {
    @PostMapping("/messages")
    public ResponseEntity&lt;String&gt; sendMessage(@RequestParam String message) {
        LOGGER.info("Going to add message {} to Sinks.Many.", message);
        many.emitNext(MessageBuilder.withPayload(message)
                                    .setHeader(ServiceBusMessageHeaders.SESSION_ID, "Customize session id")
                                    .build(), Sinks.EmitFailureHandler.FAIL_FAST);
        return ResponseEntity.ok("Sent!");
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When the <code>ServiceBusMessageHeaders.SESSION_ID</code> is set in the message headers, and a different <code>ServiceBusMessageHeaders.PARTITION_KEY</code> (or <code>AzureHeaders.PARTITION_KEY</code>) header is also set,
the value of the session id will eventually be used to overwrite the value of the partition key.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="samples-11"><a class="anchor" href="#samples-11"></a><a class="link" href="#samples-11">26.2.5. Samples</a></h4>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.1.0-beta.1/servicebus/spring-cloud-azure-starter-integration-servicebus">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="spring-integration-with-azure-storage-queue"><a class="anchor" href="#spring-integration-with-azure-storage-queue"></a><a class="link" href="#spring-integration-with-azure-storage-queue">26.3. Spring Integration with Azure Storage Queue</a></h3>
<div class="sect3">
<h4 id="key-concepts-4"><a class="anchor" href="#key-concepts-4"></a><a class="link" href="#key-concepts-4">26.3.1. Key Concepts</a></h4>
<div class="paragraph">
<p>Azure Queue Storage is a service for storing large numbers of messages. You access messages from anywhere in the world via authenticated calls using HTTP or HTTPS. A queue message can be up to 64 KB in size. A queue may contain millions of messages, up to the total capacity limit of a storage account. Queues are commonly used to create a backlog of work to process asynchronously.</p>
</div>
</div>
<div class="sect3">
<h4 id="dependency-setup-8"><a class="anchor" href="#dependency-setup-8"></a><a class="link" href="#dependency-setup-8">26.3.2. Dependency Setup</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-integration-storage-queue&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-9"><a class="anchor" href="#configuration-9"></a><a class="link" href="#configuration-9">26.3.3. Configuration</a></h4>
<div class="paragraph">
<p>This starter provides the following configuration options:</p>
</div>
<div class="sect4">
<h5 id="connection-configuration-properties-3"><a class="anchor" href="#connection-configuration-properties-3"></a><a class="link" href="#connection-configuration-properties-3">Connection Configuration Properties</a></h5>
<div class="paragraph">
<p>This section contains the configuration options used for connecting to Azure Storage Queue.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 27. Connection configurable properties of spring-cloud-azure-starter-integration-storage-queue</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.queue</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether an Azure Storage Queue is enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.queue</strong>.connection-string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage Queue Namespace connection string value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.queue</strong>.accountName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage Queue account name.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.queue</strong>.accountKey</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage Queue account key.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.queue</strong>.endpoint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage Queue service endpoint.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.queue</strong>.sasToken</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sas token credential</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.queue</strong>.serviceVersion</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">QueueServiceVersion</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">QueueServiceVersion that is used when making API requests.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.storage.queue</strong>.messageEncoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Queue message encoding.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="basic-usage-8"><a class="anchor" href="#basic-usage-8"></a><a class="link" href="#basic-usage-8">26.3.4. Basic Usage</a></h4>
<div class="sect4">
<h5 id="send-messages-to-azure-storage-queue"><a class="anchor" href="#send-messages-to-azure-storage-queue"></a><a class="link" href="#send-messages-to-azure-storage-queue">Send messages to Azure Storage Queue</a></h5>
<div class="paragraph">
<p>Step 1. Fill the credential configuration options.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as connection string, configure below properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      storage:
        queue:
          connection-string: ${AZURE_SERVICE_BUS_CONNECTION_STRING}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as managed identities, configure below properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      credential:
        managed-identity-enabled: true
        client-id: ${AZURE_CLIENT_ID}
      profile:
        tenant-id: ${AZURE_TENANT_ID}
      storage:
        queue:
          namespace: ${AZURE_SERVICE_BUS_NAMESPACE}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as service principal, configure below properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      credential:
        client-id: ${AZURE_CLIENT_ID}
        client-secret: ${AZURE_CLIENT_SECRET}
      profile:
        tenant-id: ${AZURE_TENANT_ID}
      storage:
        queue:
          namespace: ${AZURE_SERVICE_BUS_NAMESPACE}</pre>
</div>
</div>
<div class="paragraph">
<p>Step 2. Create <code>DefaultMessageHandler</code> with the bean of <code>StorageQueueTemplate</code> to send messages to Storage Queue.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">class Demo {
    private static final String STORAGE_QUEUE_NAME = "example";
    private static final String OUTPUT_CHANNEL = "output";

    @Bean
    @ServiceActivator(inputChannel = OUTPUT_CHANNEL)
    public MessageHandler messageSender(StorageQueueTemplate storageQueueTemplate) {
        DefaultMessageHandler handler = new DefaultMessageHandler(STORAGE_QUEUE_NAME, storageQueueTemplate);
        handler.setSendCallback(new ListenableFutureCallback&lt;Void&gt;() {
            @Override
            public void onSuccess(Void result) {
                LOGGER.info("Message was sent successfully.");
            }

            @Override
            public void onFailure(Throwable ex) {
                LOGGER.info("There was an error sending the message.");
            }
        });
        return handler;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 3. Create a Message gateway binding with the above message handler via a message channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">class Demo {
    @Autowired
    StorageQueueOutboundGateway storageQueueOutboundGateway;

    @MessagingGateway(defaultRequestChannel = OUTPUT_CHANNEL)
    public interface StorageQueueOutboundGateway {
        void send(String text);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 4. Send messages using the gateway.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">class Demo {
    public void demo() {
        this.storageQueueOutboundGateway.send(message);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="receive-messages-from-azure-storage-queue"><a class="anchor" href="#receive-messages-from-azure-storage-queue"></a><a class="link" href="#receive-messages-from-azure-storage-queue">Receive Messages from Azure Storage Queue</a></h5>
<div class="paragraph">
<p>Step 1. Fill the credential configuration options.</p>
</div>
<div class="paragraph">
<p>Step 2. Create a bean of message channel as the input channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">class Demo {
    private static final String INPUT_CHANNEL = "input";

    @Bean
    public MessageChannel input() {
        return new DirectChannel();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 3. Create <code>StorageQueueMessageSource</code> with the bean of <code>StorageQueueTemplate</code> to receive messages to Storage Queue.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">class Demo {
    private static final String STORAGE_QUEUE_NAME = "example";

    @Bean
    @InboundChannelAdapter(channel = INPUT_CHANNEL, poller = @Poller(fixedDelay = "1000"))
    public StorageQueueMessageSource storageQueueMessageSource(StorageQueueTemplate storageQueueTemplate) {
        return new StorageQueueMessageSource(STORAGE_QUEUE_NAME, storageQueueTemplate);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 4. Create a message receiver binding with StorageQueueMessageSource created in the last step via the message channel we created before.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">class Demo {
    @ServiceActivator(inputChannel = INPUT_CHANNEL)
    public void messageReceiver(byte[] payload, @Header(AzureHeaders.CHECKPOINTER) Checkpointer checkpointer) {
        String message = new String(payload);
        LOGGER.info("New message received: '{}'", message);
        checkpointer.success()
            .doOnError(Throwable::printStackTrace)
            .doOnSuccess(t -&gt; LOGGER.info("Message '{}' successfully checkpointed", message))
            .block();
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="samples-12"><a class="anchor" href="#samples-12"></a><a class="link" href="#samples-12">26.3.5. Samples</a></h4>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.1.0-beta.1/storage/spring-cloud-azure-starter-integration-storage-queue">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-cloud-stream-support"><a class="anchor" href="#spring-cloud-stream-support"></a><a class="link" href="#spring-cloud-stream-support">27. Spring Cloud Stream Support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Cloud Stream is a framework for building highly scalable event-driven microservices connected with shared messaging systems.</p>
</div>
<div class="paragraph">
<p>The framework provides a flexible programming model built on already established and familiar Spring idioms and best practices, including support for persistent pub/sub semantics, consumer groups, and stateful partitions.</p>
</div>
<div class="paragraph">
<p>Current binder implementations include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>spring-cloud-azure-stream-binder-eventhubs</p>
</li>
<li>
<p>spring-cloud-azure-stream-binder-servicebus</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="spring-cloud-stream-binder-for-azure-event-hubs"><a class="anchor" href="#spring-cloud-stream-binder-for-azure-event-hubs"></a><a class="link" href="#spring-cloud-stream-binder-for-azure-event-hubs">27.1. Spring Cloud Stream Binder for Azure Event Hubs</a></h3>
<div class="sect3">
<h4 id="key-concepts-5"><a class="anchor" href="#key-concepts-5"></a><a class="link" href="#key-concepts-5">27.1.1. Key Concepts</a></h4>
<div class="paragraph">
<p>The Spring Cloud Stream Binder for Azure Event Hubs provides the binding implementation for the Spring Cloud Stream framework.
This implementation uses Spring Integration Event Hubs Channel Adapters at its foundation. From design&#8217;s perspective,
Event Hubs is similar as Kafka. Also, Event Hubs could be accessed via Kafka API. If your project has tight dependency
on Kafka API, you can try <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.1.0-beta.1/eventhubs/spring-cloud-azure-starter/spring-cloud-azure-sample-eventhubs-kafka">Events Hub with Kafka API Sample</a></p>
</div>
<div class="sect4">
<h5 id="consumer-group-2"><a class="anchor" href="#consumer-group-2"></a><a class="link" href="#consumer-group-2">Consumer Group</a></h5>
<div class="paragraph">
<p>Event Hubs provides similar support of consumer group as Apache Kafka, but with slight different logic. While Kafka
stores all committed offsets in the broker, you have to store offsets of Event Hubs messages
being processed manually. Event Hubs SDK provides the function to store such offsets inside Azure Storage.</p>
</div>
</div>
<div class="sect4">
<h5 id="partitioning-support-2"><a class="anchor" href="#partitioning-support-2"></a><a class="link" href="#partitioning-support-2">Partitioning Support</a></h5>
<div class="paragraph">
<p>Event Hubs provides a similar concept of physical partition as Kafka. But unlike Kafka&#8217;s auto re-balancing between consumers and partitions, Event Hubs provides a kind of preemptive mode. The storage account acts as a lease to determine which partition is owned by which consumer. When a new consumer starts, it will try to steal some partitions
from most heavy-loaded consumers to achieve the workload balancing.</p>
</div>
<div class="paragraph">
<p>To specify the load balancing strategy, properties of <code>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer.load-balancing.*</code> are provided. See <a href="#eventhubs-consumer-properties">the consumer properties</a> for more details.</p>
</div>
</div>
<div class="sect4">
<h5 id="batch-consumer-support-2"><a class="anchor" href="#batch-consumer-support-2"></a><a class="link" href="#batch-consumer-support-2">Batch Consumer Support</a></h5>
<div class="paragraph">
<p>Spring Cloud Azure Stream Event Hubs binder supports <a href="https://docs.spring.io/spring-cloud-stream/docs/current/reference/html/spring-cloud-stream.html#_batch_consumers">Spring Cloud Stream Batch Consumer feature</a>.</p>
</div>
<div class="paragraph">
<p>To work with the batch-consumer mode, the property of <code>spring.cloud.stream.bindings.&lt;binding-name&gt;.consumer.batch-mode</code> should be set as <code>true</code>. When enabled, an <strong>Message</strong> of which the payload is a list of batched events will be received and passed to the <code>Consumer</code> function. Each message header is also converted as a list, of which the content is the associated header value parsed from each event. For the communal headers of partition id, checkpointer and last enqueued properties, they are presented as a single value for the entire batch of events shares the same one. See <a href="#scs-eh-headers">Event Hubs Message Headers</a> for more details.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The checkpoint header only exists when <strong>MANUAL</strong> checkpoint mode is used.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Checkpointing of batch consumer supports two modes: <code>BATCH</code> and <code>MANUAL</code>. <code>BATCH</code> mode is an auto checkpointing mode to checkpoint the entire batch of events together once they are received by the binder. <code>MANUAL</code> mode is to checkpoint the events by users. When used, the
<strong>Checkpointer</strong> will be passed into the message header, and users could use it to do checkpointing.</p>
</div>
<div class="paragraph">
<p>The batch size can be specified by properties of <code>max-size</code> and <code>max-wait-time</code> with prefix as <code>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer.batch.</code>, where <code>max-size</code> is a necessary property while <code>max-wait-time</code> is optional. See <a href="#eventhubs-consumer-properties">the consumer properties</a> for more details.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dependency-setup-9"><a class="anchor" href="#dependency-setup-9"></a><a class="link" href="#dependency-setup-9">27.1.2. Dependency Setup</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-stream-binder-eventhubs&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can also use the Spring Cloud Azure Stream Event Hubs Starter, as shown in the following example for Maven:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-stream-eventhubs&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-10"><a class="anchor" href="#configuration-10"></a><a class="link" href="#configuration-10">27.1.3. Configuration</a></h4>
<div class="paragraph">
<p>The binder provides the following 3 parts of configuration options:</p>
</div>
<div class="sect4">
<h5 id="eventhubs-connection-configuration"><a class="anchor" href="#eventhubs-connection-configuration"></a><a class="link" href="#eventhubs-connection-configuration">Connection Configuration Properties</a></h5>
<div class="paragraph">
<p>This section contains the configuration options used for connecting to Azure Event Hubs.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 28. Connection configurable properties of spring-cloud-azure-stream-binder-eventhubs</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether an Azure Event Hubs is enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.connection-string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event Hubs Namespace connection string value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.namespace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event Hubs Namespace value, which is the prefix of the FQDN. A FQDN should be composed of &lt;NamespaceName&gt;.&lt;DomainName&gt;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.domain-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Domain name of an Azure Event Hubs Namespace value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.custom-endpoint-address</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom Endpoint address.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Common Azure Service SDK configuration options are configurable for the Spring Cloud Azure Stream Event Hubs binder as well. The supported configuration options are introduced in <a href="configuration.html">the Configuration page</a>, and could be configured with either the unified prefix <code>spring.cloud.azure.</code> or the prefix of <code>spring.cloud.azure.eventhubs.</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The binder also supports <a href="index.html#spring-cloud-azure-resourcemanager">Spring Could Azure Resource Manager</a> by default. To learn about how to retrieve the connection string with security principals that are not granted with <code>Data</code> related roles, please refer to the <a href="index.html#resource-manager-basic-usage">resource manager example</a> for details.</p>
</div>
</div>
<div class="sect4">
<h5 id="checkpoint-configuration-properties-2"><a class="anchor" href="#checkpoint-configuration-properties-2"></a><a class="link" href="#checkpoint-configuration-properties-2">Checkpoint Configuration Properties</a></h5>
<div class="paragraph">
<p>This section contains the configuration options for the Storage Blobs service, which is used for persisting partition ownership and checkpoint information.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
From version 4.0.0, when the property of <strong>spring.cloud.azure.eventhubs.processor.checkpoint-store.create-container-if-not-exists</strong> is not enabled manually, no Storage container will be created automatically with the name from <strong>spring.cloud.stream.bindings.&lt;binding-name&gt;.destination</strong>.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 29. Checkpointing configurable properties of spring-cloud-azure-stream-binder-eventhubs</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs.processor.checkpoint-store</strong>.create-container-if-not-exists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to allow creating containers if not exists.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs.processor.checkpoint-store</strong>.account-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name for the storage account.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs.processor.checkpoint-store</strong>.account-key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage account access key.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs.processor.checkpoint-store</strong>.container-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage container name.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Common Azure Service SDK configuration options are configurable for Storage Blob checkpoint store as well. The supported configuration options are introduced in <a href="configuration.html">the Configuration page</a>, and could be configured with either the unified prefix <code>spring.cloud.azure.</code> or the prefix of <code>spring.cloud.azure.eventhubs.processor.checkpoint-store</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="azure-event-hubs-binding-configuration-properties"><a class="anchor" href="#azure-event-hubs-binding-configuration-properties"></a><a class="link" href="#azure-event-hubs-binding-configuration-properties">Azure Event Hubs Binding Configuration Properties</a></h5>
<div class="paragraph">
<p>Below options are divided into four sections: Consumer Properties, Advanced Consumer
Configurations, Producer Properties and Advanced Producer Configurations.</p>
</div>
<div class="sect5">
<h6 id="eventhubs-consumer-properties"><a class="anchor" href="#eventhubs-consumer-properties"></a><a class="link" href="#eventhubs-consumer-properties">Consumer Properties</a></h6>
<div class="paragraph">
<p>These properties are exposed via <code>EventHubsConsumerProperties</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 30. Consumer configurable properties of spring-cloud-azure-stream-binder-eventhubs</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.checkpoint.mode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CheckpointMode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checkpoint mode used when consumer decide how to checkpoint message</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.checkpoint.count</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Decides the amount of message for each partition to do one checkpoint. Will take effect only when <code>PARTITION_COUNT</code> checkpoint mode is used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.checkpoint.interval</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Decides the time interval to do one checkpoint. Will take effect only when <code>TIME</code> checkpoint mode is used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.batch.max-size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of events in a batch. Required for the batch-consumer mode.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.batch.max-wait-time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum time duration for batch consuming. Will take effect only when the batch-consumer mode is enabled and is optional.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.load-balancing.update-interval</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The interval time duration for updating.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.load-balancing.strategy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LoadBalancingStrategy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The load balancing strategy.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.load-balancing.partition-ownership-expiration-interval</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The time duration after which the ownership of partition expires.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.track-last-enqueued-event-properties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the event processor should request information on the last enqueued event on its associated partition, and track that information as events are received.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.prefetch-count</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The count used by the consumer to control the number of events the Event Hub consumer will actively receive and queue locally.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer</strong>.initial-partition-event-position</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Map with the key as the partition id, and values of <code>StartPositionProperties</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The map containing the event position to use for each partition if a checkpoint for the partition does not exist in checkpoint store. This map is keyed off of the partition id.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>initial-partition-event-position</code> configuration accepts a <code>map</code> to specify the initial position for each event hub. Thus, its key is the partition id, and the value is of <code>StartPositionProperties</code> which includes properties of offset, sequence number, enqueued date time and whether inclusive. For example, you can set it as
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    stream:
      eventhubs:
        bindings:
          &lt;binding-name&gt;:
            consumer:
              initial-partition-event-position:
                0:
                  offset: earliest
                1:
                  sequence-number: 100
                2:
                  enqueued-date-time: 2022-01-12T13:32:47.650005Z
                4:
                  inclusive: false</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="advanced-consumer-configuration"><a class="anchor" href="#advanced-consumer-configuration"></a><a class="link" href="#advanced-consumer-configuration">Advanced Consumer Configuration</a></h6>
<div class="paragraph">
<p>The above <a href="#eventhubs-connection-configuration">connection</a>, <a href="#checkpoint-configuration-properties">checkpoint</a> and <a href="configuration.html#configuration">common Azure SDK client</a> configuration are supported to be customized for each binder consumer, which can be configured with the prefix <code>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.consumer.</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="producer-properties"><a class="anchor" href="#producer-properties"></a><a class="link" href="#producer-properties">Producer Properties</a></h6>
<div class="paragraph">
<p>These properties are exposed via <code>EventHubsProducerProperties</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 31. Producer configurable properties of spring-cloud-azure-stream-binder-eventhubs</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.producer</strong>.sync</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The switch flag for sync of producer. If true, the producer will wait for a response after a send operation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.producer</strong>.send-timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The amount of time to wait for a response after a send operation. Will take effect only when a sync producer is enabled.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="advanced-producer-configuration"><a class="anchor" href="#advanced-producer-configuration"></a><a class="link" href="#advanced-producer-configuration">Advanced Producer Configuration</a></h6>
<div class="paragraph">
<p>The above <a href="#eventhubs-connection-configuration">connection</a> and <a href="configuration.html#configuration">common Azure SDK client</a> configuration are supported to be customized for each binder producer, which can be configured with the prefix <code>spring.cloud.stream.eventhubs.bindings.&lt;binding-name&gt;.producer.</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="basic-usage-9"><a class="anchor" href="#basic-usage-9"></a><a class="link" href="#basic-usage-9">27.1.4. Basic Usage</a></h4>
<div class="sect4">
<h5 id="sending-and-receiving-messages-fromto-event-hubs"><a class="anchor" href="#sending-and-receiving-messages-fromto-event-hubs"></a><a class="link" href="#sending-and-receiving-messages-fromto-event-hubs">Sending and Receiving Messages from/to Event Hubs</a></h5>
<div class="paragraph">
<p>Step 1. Fill the configuration options with credential information.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as connection string, configure below properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      eventhubs:
        connection-string: ${EVENTHUB_NAMESPACE_CONNECTION_STRING}
        processor:
          checkpoint-store:
            container-name: ${CHECKPOINT_CONTAINER}
            account-name: ${CHECKPOINT_STORAGE_ACCOUNT}
            account-key: ${CHECKPOINT_ACCESS_KEY}
    stream:
      function:
        definition: consume;supply
      bindings:
        consume-in-0:
          destination: ${EVENTHUB_NAME}
          group: ${CONSUMER_GROUP}
        supply-out-0:
          destination: ${THE_SAME_EVENTHUB_NAME_AS_ABOVE}
      eventhubs:
        bindings:
          consume-in-0:
            consumer:
              checkpoint:
                mode: MANUAL</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as service principal, configure below properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      credential:
        client-id: ${AZURE_CLIENT_ID}
        client-secret: ${AZURE_CLIENT_SECRET}
      profile:
        tenant-id: ${AZURE_TENANT_ID}
      eventhubs:
        namespace: ${EVENTHUB_NAMESPACE}
        processor:
          checkpoint-store:
            container-name: ${CONTAINER_NAME}
            account-name: ${ACCOUNT_NAME}
    stream:
      function:
        definition: consume;supply
      bindings:
        consume-in-0:
          destination: ${EVENTHUB_NAME}
          group: ${CONSUMER_GROUP}
        supply-out-0:
          destination: ${THE_SAME_EVENTHUB_NAME_AS_ABOVE}
      eventhubs:
        bindings:
          consume-in-0:
            consumer:
              checkpoint:
                mode: MANUAL</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as managed identites, configure below properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      credential:
        managed-identity-enabled: true
        client-id: ${AZURE_MANAGED_IDENTITY_CLIENT_ID} # Only needed when using a user-assigned managed identity
      eventhubs:
        namespace: ${EVENTHUB_NAMESPACE}
        processor:
          checkpoint-store:
            container-name: ${CONTAINER_NAME}
            account-name: ${ACCOUNT_NAME}
    stream:
      function:
        definition: consume;supply
      bindings:
        consume-in-0:
          destination: ${EVENTHUB_NAME}
          group: ${CONSUMER_GROUP}
        supply-out-0:
          destination: ${THE_SAME_EVENTHUB_NAME_AS_ABOVE}

      eventhubs:
        bindings:
          consume-in-0:
            consumer:
              checkpoint:
                mode: MANUAL</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step2. Define supplier and consumer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Bean
public Consumer&lt;Message&lt;String&gt;&gt; consume() {
    return message -&gt; {
        Checkpointer checkpointer = (Checkpointer) message.getHeaders().get(CHECKPOINTER);
        LOGGER.info("New message received: '{}', partition key: {}, sequence number: {}, offset: {}, enqueued time: {}",
                message.getPayload(),
                message.getHeaders().get(EventHubsHeaders.PARTITION_KEY),
                message.getHeaders().get(EventHubsHeaders.SEQUENCE_NUMBER),
                message.getHeaders().get(EventHubsHeaders.OFFSET),
                message.getHeaders().get(EventHubsHeaders.ENQUEUED_TIME)
        );

        checkpointer.success()
                .doOnSuccess(success -&gt; LOGGER.info("Message '{}' successfully checkpointed", message.getPayload()))
                .doOnError(error -&gt; LOGGER.error("Exception found", error))
                .block();
    };
}

@Bean
public Supplier&lt;Message&lt;String&gt;&gt; supply() {
    return () -&gt; {
        LOGGER.info("Sending message, sequence " + i);
        return MessageBuilder.withPayload("Hello world, " + i++).build();
    };
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="partitioning-support-3"><a class="anchor" href="#partitioning-support-3"></a><a class="link" href="#partitioning-support-3">Partitioning Support</a></h5>
<div class="paragraph">
<p>A <code>PartitionSupplier</code> with user-provided partition information will be created to configure the partition information about the message to be sent, the following is the process of obtaining different priorities of the partition ID and key:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://user-images.githubusercontent.com/63028776/145347877-fa8afa90-ec28-4c0a-8277-63b9fdaa5d0f.png" alt="145347877 fa8afa90 ec28 4c0a 8277 63b9fdaa5d0f"></span></p>
</div>
</div>
<div class="sect4">
<h5 id="batch-consumer-support-3"><a class="anchor" href="#batch-consumer-support-3"></a><a class="link" href="#batch-consumer-support-3">Batch Consumer Support</a></h5>
<div class="paragraph">
<p>Step 1. Fill the batch configuration options</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    stream:
      function:
        definition: consume
      bindings:
        consume-in-0:
          destination: ${AZURE_EVENTHUB_NAME}
          group: ${AZURE_EVENTHUB_CONSUMER_GROUP}
          consumer:
            batch-mode: true
      eventhubs:
        bindings:
          consume-in-0:
            consumer:
              batch:
                max-batch-size: 10 # Required for batch-consumer mode
                max-wait-time: 1m # Optional, the default value is null
              checkpoint:
                mode: BATCH # or MANUAL as needed</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step2. Define supplier and consumer.</p>
</div>
<div class="paragraph">
<p>For checkpointing mode as <code>BATCH</code>, you can use below code to send messages and consume in batches.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Bean
public Consumer&lt;Message&lt;List&lt;String&gt;&gt;&gt; consume() {
    return message -&gt; {
            for (int i = 0; i &lt; message.getPayload().size(); i++) {
                LOGGER.info("New message received: '{}', partition key: {}, sequence number: {}, offset: {}, enqueued time: {}",
                        message.getPayload().get(i),
                        ((List&lt;Object&gt;) message.getHeaders().get(EventHubsHeaders.BATCH_CONVERTED_PARTITION_KEY)).get(i),
                        ((List&lt;Object&gt;) message.getHeaders().get(EventHubsHeaders.BATCH_CONVERTED_SEQUENCE_NUMBER)).get(i),
                        ((List&lt;Object&gt;) message.getHeaders().get(EventHubsHeaders.BATCH_CONVERTED_OFFSET)).get(i),
                        ((List&lt;Object&gt;) message.getHeaders().get(EventHubsHeaders.BATCH_CONVERTED_ENQUEUED_TIME)).get(i));
            }

        };
}

@Bean
public Supplier&lt;Message&lt;String&gt;&gt; supply() {
    return () -&gt; {
        LOGGER.info("Sending message, sequence " + i);
        return MessageBuilder.withPayload("\"test"+ i++ +"\"").build();
    };
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For checkpointing mode as <code>MANUAL</code>, you can use below code to send messages and consume/checkpoint in batches.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Bean
public Consumer&lt;Message&lt;List&lt;String&gt;&gt;&gt; consume() {
    return message -&gt; {
        for (int i = 0; i &lt; message.getPayload().size(); i++) {
            LOGGER.info("New message received: '{}', partition key: {}, sequence number: {}, offset: {}, enqueued time: {}",
                message.getPayload().get(i),
                ((List&lt;Object&gt;) message.getHeaders().get(EventHubHeaders.BATCH_CONVERTED_PARTITION_KEY)).get(i),
                ((List&lt;Object&gt;) message.getHeaders().get(EventHubHeaders.BATCH_CONVERTED_SEQUENCE_NUMBER)).get(i),
                ((List&lt;Object&gt;) message.getHeaders().get(EventHubHeaders.BATCH_CONVERTED_OFFSET)).get(i),
                ((List&lt;Object&gt;) message.getHeaders().get(EventHubHeaders.BATCH_CONVERTED_ENQUEUED_TIME)).get(i));
        }

        Checkpointer checkpointer = (Checkpointer) message.getHeaders().get(CHECKPOINTER);
        checkpointer.success()
                    .doOnSuccess(success -&gt; LOGGER.info("Message '{}' successfully checkpointed", message.getPayload()))
                    .doOnError(error -&gt; LOGGER.error("Exception found", error))
                    .block();
    };
}

@Bean
public Supplier&lt;Message&lt;String&gt;&gt; supply() {
    return () -&gt; {
        LOGGER.info("Sending message, sequence " + i);
        return MessageBuilder.withPayload("\"test"+ i++ +"\"").build();
    };
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In the batch-consuming mode, the default content type of Spring Cloud Stream binder is <code>application/json</code>, so make sure the message payload is aligned with the content type. For example, when using the default content type of <code>application/json</code> to receive messages with <code>String</code> payload, the payload should be JSON String, surrounded with double quotes for the original String text. While for <code>text/plain</code> content type, it can be a <code>String</code> object directly. For more details, please refer to the official doc of <a href="https://docs.spring.io/spring-cloud-stream/docs/current/reference/html/spring-cloud-stream.html#content-type-management">Spring Cloud Stream Content Type Negotiation</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="error-channels"><a class="anchor" href="#error-channels"></a><a class="link" href="#error-channels">Error Channels</a></h5>
<div class="ulist">
<ul>
<li>
<p>Consumer error channel</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This channel is open by default, you can handle the error message in this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// Replace destination with spring.cloud.stream.bindings.input.destination
// Replace group with spring.cloud.stream.bindings.input.group
@ServiceActivator(inputChannel = "{destination}.{group}.errors")
public void consumerError(Message&lt;?&gt; message) {
    LOGGER.error("Handling customer ERROR: " + message);
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Producer error channel</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This channel is not open by default. You need to add a configuration in your application.properties to enable it, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-properties" data-lang="properties">spring.cloud.stream.default.producer.errorChannelEnabled=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can handle the error message in this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// Replace destination with spring.cloud.stream.bindings.output.destination
@ServiceActivator(inputChannel = "{destination}.errors")
public void producerError(Message&lt;?&gt; message) {
    LOGGER.error("Handling Producer ERROR: " + message);
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Global default error channel</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A global error channel called "errorChannel" is created by default Spring Integration, which allows users to subscribe many endpoints to it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@ServiceActivator(inputChannel = "errorChannel")
public void producerError(Message&lt;?&gt; message) {
    LOGGER.error("Handling ERROR: " + message);
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scs-eh-headers"><a class="anchor" href="#scs-eh-headers"></a><a class="link" href="#scs-eh-headers">Event Hubs Message Headers</a></h5>
<div class="paragraph">
<p>See the <a href="#si-eh-headers">Event Hubs message headers</a> for the basic message headers supported.</p>
</div>
</div>
<div class="sect4">
<h5 id="multiple-binder-support"><a class="anchor" href="#multiple-binder-support"></a><a class="link" href="#multiple-binder-support">Multiple Binder Support</a></h5>
<div class="paragraph">
<p>Connection to multiple Event Hubs namespaces is also supported by using multiple binders.This sample takes connection string as example. Credentials of service principals and managed identities are also supported, users can set related properties in each binder&#8217;s environment settings.</p>
</div>
<div class="paragraph">
<p>Step 1. To use multiple binders of EventHubs, we need to configure below properties in application.yml</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    stream:
      function:
        definition: consume1;supply1;consume2;supply2
      bindings:
        consume1-in-0:
          destination: ${EVENTHUB_NAME_01}
          group: ${CONSUMER_GROUP_01}
        supply1-out-0:
          destination: ${THE_SAME_EVENTHUB_NAME_01_AS_ABOVE}
        consume2-in-0:
          binder: eventhub-2
          destination: ${EVENTHUB_NAME_02}
          group: ${CONSUMER_GROUP_02}
        supply2-out-0:
          binder: eventhub-2
          destination: ${THE_SAME_EVENTHUB_NAME_02_AS_ABOVE}
      binders:
        eventhub-1:
          type: eventhubs
          default-candidate: true
          environment:
            spring:
              cloud:
                azure:
                  eventhubs:
                    connection-string: ${EVENTHUB_NAMESPACE_01_CONNECTION_STRING}
                    processor:
                      checkpoint-store:
                        container-name: ${CHECKPOINT_CONTAINER_01}
                        account-name: ${CHECKPOINT_STORAGE_ACCOUNT}
                        account-key: ${CHECKPOINT_ACCESS_KEY}
        eventhub-2:
          type: eventhubs
          default-candidate: false
          environment:
            spring:
              cloud:
                azure:
                  eventhubs:
                    connection-string: ${EVENTHUB_NAMESPACE_02_CONNECTION_STRING}
                    processor:
                      checkpoint-store:
                        container-name: ${CHECKPOINT_CONTAINER_02}
                        account-name: ${CHECKPOINT_STORAGE_ACCOUNT}
                        account-key: ${CHECKPOINT_ACCESS_KEY}
      eventhubs:
        bindings:
          consume1-in-0:
            consumer:
              checkpoint:
                mode: MANUAL
          consume2-in-0:
            consumer:
              checkpoint:
                mode: MANUAL
      poller:
        initial-delay: 0
        fixed-delay: 1000</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 2. we need define two suppliers and two consumers</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Bean
public Supplier&lt;Message&lt;String&gt;&gt; supply1() {
    return () -&gt; {
        LOGGER.info("Sending message1, sequence1 " + i);
        return MessageBuilder.withPayload("Hello world1, " + i++).build();
    };
}

@Bean
public Supplier&lt;Message&lt;String&gt;&gt; supply2() {
    return () -&gt; {
        LOGGER.info("Sending message2, sequence2 " + j);
        return MessageBuilder.withPayload("Hello world2, " + j++).build();
    };
}

@Bean
public Consumer&lt;Message&lt;String&gt;&gt; consume1() {
    return message -&gt; {
        Checkpointer checkpointer = (Checkpointer) message.getHeaders().get(CHECKPOINTER);
        LOGGER.info("New message1 received: '{}'", message);
        checkpointer.success()
                .doOnSuccess(success -&gt; LOGGER.info("Message1 '{}' successfully checkpointed", message))
                .doOnError(error -&gt; LOGGER.error("Exception found", error))
                .block();
    };
}

@Bean
public Consumer&lt;Message&lt;String&gt;&gt; consume2() {
    return message -&gt; {
        Checkpointer checkpointer = (Checkpointer) message.getHeaders().get(CHECKPOINTER);
        LOGGER.info("New message2 received: '{}'", message);
        checkpointer.success()
                .doOnSuccess(success -&gt; LOGGER.info("Message2 '{}' successfully checkpointed", message))
                .doOnError(error -&gt; LOGGER.error("Exception found", error))
                .block();
    };
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="resource-provision"><a class="anchor" href="#resource-provision"></a><a class="link" href="#resource-provision">Resource Provision</a></h5>
<div class="paragraph">
<p>Event Hubs binder supports provisioning of event hub and consumer group, users could use below properties to enable provisioning.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      credential:
        tenant-id: ${AZURE_TENANT_ID}
      profile:
        subscription-id: ${AZURE_SUBSCRIPTION_ID}
      eventhubs:
        resource:
          resource-group: ${AZURE_EVENTHUBS_RESOURECE_GROUP}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="samples-13"><a class="anchor" href="#samples-13"></a><a class="link" href="#samples-13">27.1.5. Samples</a></h4>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.1.0-beta.1/eventhubs/spring-cloud-azure-stream-binder-eventhubs">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="spring-cloud-stream-binder-for-azure-service-bus"><a class="anchor" href="#spring-cloud-stream-binder-for-azure-service-bus"></a><a class="link" href="#spring-cloud-stream-binder-for-azure-service-bus">27.2. Spring Cloud Stream Binder for Azure Service Bus</a></h3>
<div class="sect3">
<h4 id="key-concepts-6"><a class="anchor" href="#key-concepts-6"></a><a class="link" href="#key-concepts-6">27.2.1. Key Concepts</a></h4>
<div class="paragraph">
<p>The Spring Cloud Stream Binder for Azure Service Bus provides the binding implementation for the Spring Cloud Stream Framework.
This implementation uses Spring Integration Service Bus Channel Adapters at its foundation.</p>
</div>
<div class="sect4">
<h5 id="scheduled-message"><a class="anchor" href="#scheduled-message"></a><a class="link" href="#scheduled-message">Scheduled Message</a></h5>
<div class="paragraph">
<p>This binder supports submitting messages to a topic for delayed processing. Users can send scheduled messages with header <code>x-delay</code>
expressing in milliseconds a delay time for the message. The message will be delivered to the respective topics after <code>x-delay</code> milliseconds.</p>
</div>
</div>
<div class="sect4">
<h5 id="consumer-group-3"><a class="anchor" href="#consumer-group-3"></a><a class="link" href="#consumer-group-3">Consumer Group</a></h5>
<div class="paragraph">
<p>Service Bus Topic provides similar support of consumer group as Apache Kafka, but with slight different logic.
This binder relies on <code>Subscription</code> of a topic to act as a consumer group.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dependency-setup-10"><a class="anchor" href="#dependency-setup-10"></a><a class="link" href="#dependency-setup-10">27.2.2. Dependency Setup</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-stream-binder-servicebus&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can also use the Spring Cloud Azure Stream Service Bus Starter, as shown in the following example for Maven:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-stream-servicebus&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-11"><a class="anchor" href="#configuration-11"></a><a class="link" href="#configuration-11">27.2.3. Configuration</a></h4>
<div class="paragraph">
<p>The binder provides the following 2 parts of configuration options:</p>
</div>
<div class="sect4">
<h5 id="servicebus-connection-configuration"><a class="anchor" href="#servicebus-connection-configuration"></a><a class="link" href="#servicebus-connection-configuration">Connection Configuration Properties</a></h5>
<div class="paragraph">
<p>This section contains the configuration options used for connecting to Azure Service Bus.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 32. Connection configurable properties of spring-cloud-azure-stream-binder-servicebus</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.servicebus</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether an Azure Service Bus is enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.servicebus</strong>.connection-string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service Bus Namespace connection string value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.servicebus</strong>.namespace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service Bus Namespace value, which is the prefix of the FQDN. A FQDN should be composed of &lt;NamespaceName&gt;.&lt;DomainName&gt;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.servicebus</strong>.domain-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Domain name of an Azure Service Bus Namespace value.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Common Azure Service SDK configuration options are configurable for the Spring Cloud Azure Stream Service Bus binder as well. The supported configuration options are introduced in <a href="configuration.html">the Configuration page</a>, and could be configured with either the unified prefix <code>spring.cloud.azure.</code> or the prefix of <code>spring.cloud.azure.servicebus.</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The binder also supports <a href="index.html#spring-cloud-azure-resourcemanager">Spring Could Azure Resource Manager</a> by default. To learn about how to retrieve the connection string with security principals that are not granted with <code>Data</code> related roles, please refer to the <a href="index.html#resource-manager-basic-usage">resource manager example</a> for details.</p>
</div>
</div>
<div class="sect4">
<h5 id="azure-service-bus-binding-configuration-properties"><a class="anchor" href="#azure-service-bus-binding-configuration-properties"></a><a class="link" href="#azure-service-bus-binding-configuration-properties">Azure Service Bus Binding Configuration Properties</a></h5>
<div class="paragraph">
<p>Below options are divided into four sections: Consumer Properties, Advanced Consumer
Configurations, Producer Properties and Advanced Producer Configurations.</p>
</div>
<div class="sect5">
<h6 id="consumer-properties"><a class="anchor" href="#consumer-properties"></a><a class="link" href="#consumer-properties">Consumer Properties</a></h6>
<div class="paragraph">
<p>These properties are exposed via <code>ServiceBusConsumerProperties</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 33. Consumer configurable properties of spring-cloud-azure-stream-binder-servicebus</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer</strong>.requeue-rejected</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the failed messages are routed to the DLQ.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer</strong>.max-concurrent-calls</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Max concurrent messages that the Service Bus processor client should process.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer</strong>.max-concurrent-sessions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of concurrent sessions to process at any given time.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer</strong>.session-enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether session is enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer</strong>.prefetch-count</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The prefetch count of the Service Bus processor client.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer</strong>.sub-queue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SubQueue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The type of the sub queue to connect to.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer</strong>.max-auto-lock-renew-duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5m</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The amount of time to continue auto-renewing the lock.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer</strong>.receive-mode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusReceiveMode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">peek_lock</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The receive mode of the Service Bus processor client.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer</strong>.auto-complete</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to settle messages automatically. If set as false, a message header of <code>Checkpointer</code> will be added
to enable developers to settle messages manually.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="advanced-consumer-configuration-2"><a class="anchor" href="#advanced-consumer-configuration-2"></a><a class="link" href="#advanced-consumer-configuration-2">Advanced Consumer Configuration</a></h6>
<div class="paragraph">
<p>The above <a href="#servicebus-connection-configuration">connection</a> and <a href="configuration.html#configuration">common Azure SDK client</a> configuration are supported to be customized for each binder consumer, which can be configured with the prefix <code>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer.</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="producer-properties-2"><a class="anchor" href="#producer-properties-2"></a><a class="link" href="#producer-properties-2">Producer Properties</a></h6>
<div class="paragraph">
<p>These properties are exposed via <code>ServiceBusProducerProperties</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 34. Producer configurable properties of spring-cloud-azure-stream-binder-servicebus</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.producer</strong>.sync</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Switch flag
for sync of producer.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.producer</strong>.send-timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout
value for sending of producer.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.producer</strong>.entity-type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ServiceBusEntityType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service Bus entity type of the producer, required for the binding producer.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When using the binding producer, property of <code>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.producer.entity-type</code> is required to be configured.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="advanced-producer-configuration-2"><a class="anchor" href="#advanced-producer-configuration-2"></a><a class="link" href="#advanced-producer-configuration-2">Advanced Producer Configuration</a></h6>
<div class="paragraph">
<p>The above <a href="#servicebus-connection-configuration">connection</a> and <a href="configuration.html#configuration">common Azure SDK client</a> configuration are supported to be customized for each binder producer, which can be configured with the prefix <code>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.producer.</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="basic-usage-10"><a class="anchor" href="#basic-usage-10"></a><a class="link" href="#basic-usage-10">27.2.4. Basic Usage</a></h4>
<div class="sect4">
<h5 id="sending-and-receiving-messages-fromto-service-bus"><a class="anchor" href="#sending-and-receiving-messages-fromto-service-bus"></a><a class="link" href="#sending-and-receiving-messages-fromto-service-bus">Sending and Receiving Messages from/to Service Bus</a></h5>
<div class="paragraph">
<p>Step 1. Fill the configuration options with credential information.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as connection string, configure below properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      servicebus:
        connection-string: ${SERVICEBUS_NAMESPACE_CONNECTION_STRING}
    stream:
      function:
        definition: consume;supply
      bindings:
        consume-in-0:
          destination: ${SERVICEBUS_ENTITY_NAME}
          # If you use Service Bus Topic, please add below configuration
          # group: ${SUBSCRIPTION_NAME}
        supply-out-0:
          destination: ${SERVICEBUS_ENTITY_NAME_SAME_AS_ABOVE}
      servicebus:
        bindings:
          consume-in-0:
            consumer:
              auto-complete: false
          supply-out-0:
            producer:
              entity-type: queue # set as "topic" if you use Service Bus Topic</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as service principal, configure below properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      credential:
        client-id: ${AZURE_CLIENT_ID}
        client-secret: ${AZURE_CLIENT_SECRET}
      profile:
        tenant-id: ${AZURE_TENANT_ID}
      servicebus:
        namespace: ${SERVICEBUS_NAMESPACE}
    stream:
      function:
        definition: consume;supply
      bindings:
        consume-in-0:
          destination: ${SERVICEBUS_ENTITY_NAME}
          # If you use Service Bus Topic, please add below configuration
          # group: ${SUBSCRIPTION_NAME}
        supply-out-0:
          destination: ${SERVICEBUS_ENTITY_NAME_SAME_AS_ABOVE}
      servicebus:
        bindings:
          consume-in-0:
            consumer:
              auto-complete: false
          supply-out-0:
            producer:
              entity-type: queue # set as "topic" if you use Service Bus Topic</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For credentials as managed identities, configure below properties in application.yml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    azure:
      credential:
        managed-identity-enabled: true
        client-id: ${MANAGED_IDENTITY_CLIENT_ID} # Only needed when using a user-assigned managed identity
      servicebus:
        namespace: ${SERVICEBUS_NAMESPACE}
    stream:
      function:
        definition: consume;supply
      bindings:
        consume-in-0:
          destination: ${SERVICEBUS_ENTITY_NAME}
          # If you use Service Bus Topic, please add below configuration
          # group: ${SUBSCRIPTION_NAME}
        supply-out-0:
          destination: ${SERVICEBUS_ENTITY_NAME_SAME_AS_ABOVE}
      servicebus:
        bindings:
          consume-in-0:
            consumer:
              auto-complete: false
          supply-out-0:
            producer:
              entity-type: queue # set as "topic" if you use Service Bus Topic</pre>
</div>
</div>
<div class="paragraph">
<p>Step 2. Define supplier and consumer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Bean
public Consumer&lt;Message&lt;String&gt;&gt; consume() {
    return message -&gt; {
        Checkpointer checkpointer = (Checkpointer) message.getHeaders().get(CHECKPOINTER);
        LOGGER.info("New message received: '{}', partition key: {}, sequence number: {}, offset: {}, enqueued time: {}",
                message.getPayload(),
                message.getHeaders().get(EventHubsHeaders.PARTITION_KEY),
                message.getHeaders().get(EventHubsHeaders.SEQUENCE_NUMBER),
                message.getHeaders().get(EventHubsHeaders.OFFSET),
                message.getHeaders().get(EventHubsHeaders.ENQUEUED_TIME)
        );

        checkpointer.success()
                .doOnSuccess(success -&gt; LOGGER.info("Message '{}' successfully checkpointed", message.getPayload()))
                .doOnError(error -&gt; LOGGER.error("Exception found", error))
                .block();
    };
}

@Bean
public Supplier&lt;Message&lt;String&gt;&gt; supply() {
    return () -&gt; {
        LOGGER.info("Sending message, sequence " + i);
        return MessageBuilder.withPayload("Hello world, " + i++).build();
    };
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="partition-key-support-2"><a class="anchor" href="#partition-key-support-2"></a><a class="link" href="#partition-key-support-2">Partition Key Support</a></h5>
<div class="paragraph">
<p>The binder supports <a href="https://docs.microsoft.com/azure/service-bus-messaging/service-bus-partitioning">Service Bus partitioning</a> by allowing setting partition key and session id in the message header. This section introduces how to set partition key for messages.</p>
</div>
<div class="paragraph">
<p>Spring Cloud Stream provides a partition key SpEL expression property <code>spring.cloud.stream.bindings.&lt;binding-name&gt;.producer.partition-key-expression</code>. For example, setting this property as <code>&quot;&#39;partitionKey-&#39; + headers[&lt;message-header-key&gt;]&quot;</code> and add a header called &lt;message-header-key&gt;. Spring Cloud Stream will use the value for this header when evaluating the above expression to assign a partition key. Here is an example producer code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Bean
public Supplier&lt;Message&lt;String&gt;&gt; generate() {
    return () -&gt; {
        String value = “random payload”;
        return MessageBuilder.withPayload(value)
            .setHeader("&lt;message-header-key&gt;", value.length() % 4)
            .build();
    };
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="session-support-2"><a class="anchor" href="#session-support-2"></a><a class="link" href="#session-support-2">Session Support</a></h5>
<div class="paragraph">
<p>The binder supports <a href="https://docs.microsoft.com/azure/service-bus-messaging/message-sessions">message sessions</a> of Service Bus. Session id of a message could be set via the message header.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Bean
public Supplier&lt;Message&lt;String&gt;&gt; generate() {
    return () -&gt; {
        String value = “random payload”;
        return MessageBuilder.withPayload(value)
            .setHeader(ServiceBusMessageHeaders.SESSION_ID, "Customize session id")
            .build();
    };
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
According to <a href="https://docs.microsoft.com/azure/service-bus-messaging/service-bus-partitioning">Service Bus partitioning</a>, session id has higher priority than partition key. So when both of <code>ServiceBusMessageHeaders#SESSION_ID</code> and <code>ServiceBusMessageHeaders#PARTITION_KEY</code> (or <code>AzureHeaders#PARTITION_KEY</code>) headers are set,
the value of the session id will eventually be used to overwrite the value of the partition key.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="error-channels-2"><a class="anchor" href="#error-channels-2"></a><a class="link" href="#error-channels-2">Error Channels</a></h5>
<div class="ulist">
<ul>
<li>
<p>Consumer error channel</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This channel is open by default, and a default consumer error channel handler is used to send failed messages to the dead-letter queue when <code>spring.cloud.stream.servicebus.bindings.&lt;binding-name&gt;.consumer.requeue-rejected</code> is enabled, otherwise the failed messages will be abandoned.</p>
</div>
<div class="paragraph">
<p>To customize the consumer error channel handler, you can register you own error handler to the related consumer error channel in this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// Replace destination with spring.cloud.stream.bindings.input.destination
// Replace group with spring.cloud.stream.bindings.input.group
@ServiceActivator(inputChannel = "{destination}.{group}.errors")
public void consumerError(Message&lt;?&gt; message) {
    LOGGER.error("Handling customer ERROR: " + message);
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Producer error channel</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This channel is not open by default. You need to add a configuration in your application.properties to enable it, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-properties" data-lang="properties">spring.cloud.stream.default.producer.errorChannelEnabled=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can handle the error message in this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// Replace destination with spring.cloud.stream.bindings.output.destination
@ServiceActivator(inputChannel = "{destination}.errors")
public void producerError(Message&lt;?&gt; message) {
    LOGGER.error("Handling Producer ERROR: " + message);
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Global default error channel</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A global error channel called "errorChannel" is created by default Spring Integration, which allows users to subscribe many endpoints to it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@ServiceActivator(inputChannel = "errorChannel")
public void producerError(Message&lt;?&gt; message) {
    LOGGER.error("Handling ERROR: " + message);
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scs-sb-headers"><a class="anchor" href="#scs-sb-headers"></a><a class="link" href="#scs-sb-headers">Service Bus Message Headers</a></h5>
<div class="paragraph">
<p>See the <a href="#si-sb-headers">Service Bus message headers</a> for the basic message headers supported.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When setting the partiton key, the priority of message header is higher than Spring Cloud Stream property. So <code>spring.cloud.stream.bindings.&lt;binding-name&gt;.producer.partition-key-expression</code> will take effect only when none of the headers of <code>ServiceBusMessageHeaders#SESSION_ID</code>, <code>ServiceBusMessageHeaders#PARTITION_KEY</code>, <code>AzureHeaders#PARTITION_KEY</code> is configured.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="multiple-binder-support-2"><a class="anchor" href="#multiple-binder-support-2"></a><a class="link" href="#multiple-binder-support-2">Multiple Binder Support</a></h5>
<div class="paragraph">
<p>Connection to multiple Service Bus namespaces is also supported by using multiple binders. This sample takes connection string as example. Credentials of service principals and managed identities are also supported, users can set related properties in each binder&#8217;s environment settings.</p>
</div>
<div class="paragraph">
<p>Step 1. To use multiple binders of ServiceBus, we need to configure below properties in application.yml</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    stream:
      function:
        definition: consume1;supply1;consume2;supply2
      bindings:
        consume1-in-0:
          destination: ${SERVICEBUS_TOPIC_NAME}
          group: ${SUBSCRIPTION_NAME}
        supply1-out-0:
          destination: ${SERVICEBUS_TOPIC_NAME_SAME_AS_ABOVE}
        consume2-in-0:
          binder: servicebus-2
          destination: ${SERVICEBUS_QUEUE_NAME}
        supply2-out-0:
          binder: servicebus-2
          destination: ${SERVICEBUS_QUEUE_NAME_SAME_AS_ABOVE}
      binders:
        servicebus-1:
          type: servicebus
          default-candidate: true
          environment:
            spring:
              cloud:
                azure:
                  servicebus:
                    connection-string: ${SERVICEBUS_NAMESPACE_01_CONNECTION_STRING}
        servicebus-2:
          type: servicebus
          default-candidate: false
          environment:
            spring:
              cloud:
                azure:
                  servicebus:
                    connection-string: ${SERVICEBUS_NAMESPACE_02_CONNECTION_STRING}
      servicebus:
        bindings:
          consume1-in-0:
            consumer:
              auto-complete: false
          supply1-out-0:
            producer:
              entity-type: topic
          consume2-in-0:
            consumer:
              auto-complete: false
          supply2-out-0:
            producer:
              entity-type: queue
      poller:
        initial-delay: 0
        fixed-delay: 1000</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step 2. we need define two suppliers and two consumers</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Bean
public Supplier&lt;Message&lt;String&gt;&gt; supply1() {
    return () -&gt; {
        LOGGER.info("Sending message1, sequence1 " + i);
        return MessageBuilder.withPayload("Hello world1, " + i++).build();
    };
}

@Bean
public Supplier&lt;Message&lt;String&gt;&gt; supply2() {
    return () -&gt; {
        LOGGER.info("Sending message2, sequence2 " + j);
        return MessageBuilder.withPayload("Hello world2, " + j++).build();
    };
}

@Bean
public Consumer&lt;Message&lt;String&gt;&gt; consume1() {
    return message -&gt; {
        Checkpointer checkpointer = (Checkpointer) message.getHeaders().get(CHECKPOINTER);
        LOGGER.info("New message1 received: '{}'", message);
        checkpointer.success()
                .doOnSuccess(s -&gt; LOGGER.info("Message '{}' successfully checkpointed", message.getPayload()))
                .doOnError(e -&gt; LOGGER.error("Error found", e))
                .block();
    };
}

@Bean
public Consumer&lt;Message&lt;String&gt;&gt; consume2() {
    return message -&gt; {
        Checkpointer checkpointer = (Checkpointer) message.getHeaders().get(CHECKPOINTER);
        LOGGER.info("New message2 received: '{}'", message);
        checkpointer.success()
                .doOnSuccess(s -&gt; LOGGER.info("Message '{}' successfully checkpointed", message.getPayload()))
                .doOnError(e -&gt; LOGGER.error("Error found", e))
                .block();
    };

}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="resource-provision-2"><a class="anchor" href="#resource-provision-2"></a><a class="link" href="#resource-provision-2">Resource Provision</a></h5>
<div class="paragraph">
<p>Service bus binder supports provisioning of queue, topic and subscription, users could use below properties to enable provisioning.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      credential:
        tenant-id: ${AZURE_TENANT_ID}
      profile:
        subscription-id: ${AZURE_SUBSCRIPTION_ID}
      servicebus:
        resource:
          resource-group: ${AZURE_SERVICEBUS_RESOURECE_GROUP}
    stream:
      servicebus:
        bindings:
          &lt;binding-name&gt;:
            consumer:
              entity-type: ${SERVICEBUS_CONSUMER_ENTITY_TYPE}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="samples-14"><a class="anchor" href="#samples-14"></a><a class="link" href="#samples-14">27.2.5. Samples</a></h4>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.1.0-beta.1/servicebus/spring-cloud-azure-stream-binder-servicebus">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-jms-support"><a class="anchor" href="#spring-jms-support"></a><a class="link" href="#spring-jms-support">28. Spring JMS Support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>To use Azure Service Bus by the JMS API integrated into the Spring JMS framework.
Azure Service Bus connection string have to be provided which is to be parsed into the login username, password and remote URI for the AMQP broker.</p>
</div>
<div class="sect2">
<h3 id="dependency-setup-11"><a class="anchor" href="#dependency-setup-11"></a><a class="link" href="#dependency-setup-11">28.1. Dependency Setup</a></h3>
<div class="paragraph">
<p>Adding below dependencies if you want to migrate your Spring JMS application to use Azure Service Bus.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-azure-starter-servicebus-jms&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-12"><a class="anchor" href="#configuration-12"></a><a class="link" href="#configuration-12">28.2. Configuration</a></h3>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 35. Configurable properties when using Spring JMS support</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.connection-string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Service Bus connection string. Should be provided when want to provide the connection string directly.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.topic-client-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JMS clientID. Only works for the bean of topicJmsListenerContainerFactory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.idle-timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The duration for idle.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.pricing-tier</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Azure Service Bus Price Tier.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.listener.reply-pub-sub-domain</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the reply destination type is topic.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.listener.phase</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the phase in which this container should be started and stopped.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.listener.reply-qos-settings</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configure the QosSettings to use when sending a reply.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.listener.subscription-durable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to make the subscription durable. Only works for the bean of topicJmsListenerContainerFactory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.listener.subscription-shared</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to make the subscription shared. Only works for the bean of topicJmsListenerContainerFactory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Login password of the AMQP broker</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.pool.block-if-full</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="jms-servicebus-pool-configuration"></a> Whether to block when a connection is requested and the pool is full.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.pool.block-if-full-timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Blocking period before throwing an exception if the pool is still full.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.pool.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether a JmsPoolConnectionFactory should be created, instead of a regularConnectionFactory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.pool.idle-timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connection idle timeout.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.pool.max-connections</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of pooled connections.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.pool.max-sessions-per-connection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of pooled sessions per connection in the pool.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.pool.time-between-expiration-check</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time to sleep between runs of the idle connection eviction thread.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.pool.use-anonymous-producers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to use only one anonymous "MessageProducer" instance.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.prefetch-policy.all</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fallback value for prefetch option in this Service Bus namespace.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.prefetch-policy.durable-topic-prefetch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of prefetch for durable topic.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.prefetch-policy.queue-browser-prefetch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of prefetch for queue browser.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.prefetch-policy.queue-prefetch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of prefetch for queue.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.prefetch-policy.topic-prefetch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of prefetch for topic.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.remote-url</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">URL of the AMQP broker.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.jms.servicebus</strong>.username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Login user of the AMQP broker.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Spring JMS general configuration is omited for short.
Please refer to <a href="https://docs.spring.io/spring-framework/docs/3.2.x/spring-framework-reference/html/jms.html">Spring JMS Document</a> for more details.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="basic-usage-11"><a class="anchor" href="#basic-usage-11"></a><a class="link" href="#basic-usage-11">28.3. Basic Usage</a></h3>
<div class="sect3">
<h4 id="use-service-bus-connection-string"><a class="anchor" href="#use-service-bus-connection-string"></a><a class="link" href="#use-service-bus-connection-string">28.3.1. Use Service Bus Connection String</a></h4>
<div class="paragraph">
<p>The simplest way to connect to Service Bus for Spring JMS application is with the connection string.</p>
</div>
<div class="paragraph">
<p>Add below properties and you are good to go.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  jms:
    servicebus:
      connection-string: ${AZURE_SERVICEBUS_CONNECTION_STRING}
      pricing-tier: ${PRICING_TIER}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The default enabled <code>ConnectionFactory</code> is the <code>CachingConnectionFactory</code> which adds Session caching as well MessageProducer caching. If you want to activate the connection pooling featured one of JmsPoolConnectionFactory, the property of <code>spring.jms.servicebus.pool.enabled</code> should be specified <code>true</code>. You can find other pooling configuration options (properties with prefix <code>spring.jms.servicebus.pool.</code>) from the above
<a href="#jms-servicebus-pool-configuration">Configuration</a> section.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="samples-15"><a class="anchor" href="#samples-15"></a><a class="link" href="#samples-15">28.4. Samples</a></h3>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.1.0-beta.1">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kafka-support"><a class="anchor" href="#kafka-support"></a><a class="link" href="#kafka-support">29. Kafka Support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Connect to Azure Event Hubs (<a href="https://azure.microsoft.com/pricing/details/event-hubs/#explore-pricing-options">Basic pricing tier is not supported</a>) using Spring Kafka libraries. There are two approaches to connect to Azure Event Hubs for Kafka, the first one is to provide the Azure Event Hubs connection string directly, the other is to use Azure Resource Manager to retrieve the connection string.</p>
</div>
<div class="sect2">
<h3 id="dependency-setup-12"><a class="anchor" href="#dependency-setup-12"></a><a class="link" href="#dependency-setup-12">29.1. Dependency Setup</a></h3>
<div class="paragraph">
<p>Adding below dependencies if you want to migrate your Apache Kafka application to use Azure Event Hubs for Kafka.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-azure-starter&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to retrieve the connection string using Azure Resource Manager, please also add below dependency</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-azure-resourcemanager&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-13"><a class="anchor" href="#configuration-13"></a><a class="link" href="#configuration-13">29.2. Configuration</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 36. Configurable properties when using Kafka support</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.kafka.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to enable the Azure Event Hubs Kafka support, default to true.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.connection-string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Event Hubs connection string. Should be provided when want to provide the connection string directly.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.namespace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Event Hubs namespace. Should be provided when want to retrieve the connection information through Azure Resource Manager.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.eventhubs</strong>.resource.resource-group</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The resource group of Azure Event Hubs namespace. Should be provided when want to retrieve the connection information through Azure Resource Manager.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure</strong>.profile.subscription-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The subscription id. Should be provided when want to retrieve the connection information through Azure Resource Manager.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Authentication information is also required for authenticating for Azure Resource Manager. The credential related configurations of Resource Manager should be configured under prefix <code>spring.cloud.azure</code>. Please refer to <a href="index.html#authentication">Authentication</a> for more details.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="basic-usage-12"><a class="anchor" href="#basic-usage-12"></a><a class="link" href="#basic-usage-12">29.3. Basic Usage</a></h3>
<div class="sect3">
<h4 id="use-event-hubs-connection-string"><a class="anchor" href="#use-event-hubs-connection-string"></a><a class="link" href="#use-event-hubs-connection-string">29.3.1. Use Event Hubs Connection String</a></h4>
<div class="paragraph">
<p>The simplest way to connect to Event Hubs for Kafka is with the connection string.</p>
</div>
<div class="paragraph">
<p>Add below properties and you are good to go.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      eventhubs:
        connection-string: ${AZURE_EVENTHUBS_CONNECTION_STRING}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="use-azure-resource-manager-to-retrieve-connection-string"><a class="anchor" href="#use-azure-resource-manager-to-retrieve-connection-string"></a><a class="link" href="#use-azure-resource-manager-to-retrieve-connection-string">29.3.2. Use Azure Resource Manager to Retrieve Connection String</a></h4>
<div class="paragraph">
<p>If you don&#8217;t want to configure connection string in your application, it&#8217;s also possible to use Azure Resource Manager to retrieve the connection string. And you could use credentials stored in Azure CLI or other local development tool, like Visual Studio Code or Intellij IDEA to authenticate with Azure Resource Manager. Or Managed Identity if your application is deployed to Azure Cloud. Just make sure the principal have sufficient permission to read resource metadata.</p>
</div>
<div class="paragraph">
<p>Add below properties and you are good to go.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      profile:
        subscription-id: ${AZURE_SUBSCRIPTION_ID}
      eventhubs:
        namespace: ${AZURE_EVENTHUBS_NAMESPACE}
        resource:
          resource-group: ${AZURE_EVENTHUBS_RESOURCE_GROUP}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="samples-16"><a class="anchor" href="#samples-16"></a><a class="link" href="#samples-16">29.4. Samples</a></h3>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.1.0-beta.1">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="redis-support"><a class="anchor" href="#redis-support"></a><a class="link" href="#redis-support">30. Redis Support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Connect to Azure Cache for Redis using Spring Redis libraries. With adding <code>spring-cloud-azure-starter</code> and <code>spring-cloud-azure-resourcemanager</code> to your application, it&#8217;s possible to read the Azure Cache for Redis connection information through Azure Resource Manager and auto-configure the Redis properties.</p>
</div>
<div class="sect2">
<h3 id="dependency-setup-13"><a class="anchor" href="#dependency-setup-13"></a><a class="link" href="#dependency-setup-13">30.1. Dependency Setup</a></h3>
<div class="paragraph">
<p>Adding below dependencies if you want to use the Spring Cloud Azure Redis support to your Spring Boot application using Redis.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
      &lt;artifactId&gt;spring-cloud-azure-starter&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
      &lt;artifactId&gt;spring-cloud-azure-resourcemanager&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-14"><a class="anchor" href="#configuration-14"></a><a class="link" href="#configuration-14">30.2. Configuration</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 37. Configurable properties when using Redis support</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default Value</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.redis</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Cache for Redis instance name.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.redis</strong>.name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Azure Cache for Redis instance name.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.redis</strong>.resource.resource-group</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The resource group of Azure Cache for Redis.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure</strong>.profile.subscription-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The subscription id.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Authentication information is also required for authenticating for Azure Resource Manager. The credential related configurations of Resource Manager should be configured under prefix <code>spring.cloud.azure</code>. Please refer to <a href="index.html#authentication">Authentication</a> for more details.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="basic-usage-13"><a class="anchor" href="#basic-usage-13"></a><a class="link" href="#basic-usage-13">30.3. Basic Usage</a></h3>
<div class="paragraph">
<p>Add below properties and you are good to go.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-properties" data-lang="properties">spring.cloud.azure.redis.name=${AZURE_CACHE_REDIS_NAME}
spring.cloud.azure.redis.resource.resource-group=${AZURE_CACHE_REDIS_RESOURCE_GROUP}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="samples-17"><a class="anchor" href="#samples-17"></a><a class="link" href="#samples-17">30.4. Samples</a></h3>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.1.0-beta.1">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-cloud-azure-resourcemanager"><a class="anchor" href="#spring-cloud-azure-resourcemanager"></a><a class="link" href="#spring-cloud-azure-resourcemanager">31. Resource Manager</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Azure Resource Manager (ARM) is the deployment and management service for Azure. It provides a management layer that enables you to create, update, and delete resources in your Azure account. Spring Cloud Azure Resourcemanger can help provision resources or retrieve resource metadata.</p>
</div>
<div class="sect2">
<h3 id="dependency-setup-14"><a class="anchor" href="#dependency-setup-14"></a><a class="link" href="#dependency-setup-14">31.1. Dependency Setup</a></h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-azure-resourcemanager&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-15"><a class="anchor" href="#configuration-15"></a><a class="link" href="#configuration-15">31.2. Configuration</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to use a security principal to authenticate and authorize with Azure Active Directory for accessing an Azure resource, please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the security principal has been granted the sufficient permission to access the Azure resource.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 38. Configurable properties of spring-cloud-azure-resourcemanager</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.resource-manager</strong>.enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the Resource Manager is enabled. Default is true.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.credential</strong>.client-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client id to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.credential</strong>.client-secret</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client secret to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.credential</strong>.client-certificate-path</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path of a PEM certificate file to use when performing service principal authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.credential</strong>.client-certificate-password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password of the certificate file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.credential</strong>.username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Username to use when performing username/password authentication with Azure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.credential</strong>.password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password to use when performing username/password authentication.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.credential</strong>.managed-identity-enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to enable managed identity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.profile</strong>.cloud-type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the Azure cloud to connect to.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.profile</strong>.environment.active-directory-endpoint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Azure Active Directory endpoint to connect to for authentication.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.profile</strong>.subscription-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Subscription id to use when connecting to Azure resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.profile</strong>.tenant-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tenant id for Azure resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.&lt;azure-service&gt;</strong>.namespace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The namespace of the Azure service to provision resources with.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>spring.cloud.azure.&lt;azure-service&gt;</strong>.resource.resource-group</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The resource group holding an Azure service resource.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="resource-manager-basic-usage"><a class="anchor" href="#resource-manager-basic-usage"></a><a class="link" href="#resource-manager-basic-usage">31.3. Basic Usage</a></h3>
<div class="paragraph">
<p>Spring Cloud Azure Resource Manager can work together with specific Spring Cloud Azure starters to retrieve connection information, such as connection strings, to connect to Azure services. It can also together with <code>spring-cloud-azure-starter</code> and third-party libraries to retrieve metadata like username/password, to complete authentication, such as: <a href="#kafka-support">Kafka Support</a>, <a href="#redis-support">Redis Support</a>.</p>
</div>
<div class="paragraph">
<p>For example, to retrieve the connection string of an Azure Service, developers can use a service principal as the credential to authenticate and retrieve the connection string. The configuration is listed as below. The provided service principal should
be assigned a role of <code>Contributor</code> of the associated namespace at least. Please refer to <a href="index.html#authorize-access-with-azure-active-directory">Authorize access with Azure AD</a> to make sure the principal has been granted the sufficient permission to access the Azure resource.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  cloud:
    azure:
      credential:
        client-id: ${AZURE_CLIENT_ID}
        client-secret: ${AZURE_CLIENT_SECRET}
      profile:
        tenant-id: ${AZURE_TENANT_ID}
        subscription-id: ${AZURE_SUBSCRIPTION_ID}
      &lt;azure-service&gt;:
        namespace: ${SERVICEBUS_NAMESPACE}
        resource:
          resource-group: ${RESOURCE_GROUP}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="samples-18"><a class="anchor" href="#samples-18"></a><a class="link" href="#samples-18">31.4. Samples</a></h3>
<div class="paragraph">
<p>Please refer to <a href="https://github.com/Azure-Samples/azure-spring-boot-samples/tree/spring-cloud-azure_4.1.0-beta.1">azure-spring-boot-samples</a> for more details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration-properties-2"><a class="anchor" href="#configuration-properties-2"></a><a class="link" href="#configuration-properties-2">32. Configuration Properties</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>To see the list of all Spring Cloud Azure related configuration properties please check <a href="appendix.html">the Appendix page</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix"><a class="anchor" href="#appendix"></a><a class="link" href="#appendix">33. Appendix</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="configuration-properties-3"><a class="anchor" href="#configuration-properties-3"></a><a class="link" href="#configuration-properties-3">33.1. <a href="appendix.html##configuration-properties">Configuration properties</a></a></h3>

</div>
<div class="sect2">
<h3 id="migration-guide-for-4-0-2"><a class="anchor" href="#migration-guide-for-4-0-2"></a><a class="link" href="#migration-guide-for-4-0-2">33.2. <a href="appendix.html#migration-guide-for-4-0">Migration guide for 4.0</a></a></h3>

</div>
<div class="sect2">
<h3 id="known-issues"><a class="anchor" href="#known-issues"></a><a class="link" href="#known-issues">33.3. <a href="appendix.html#known-issues">Known issues</a></a></h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-boot-3"><a class="anchor" href="#spring-boot-3"></a><a class="link" href="#spring-boot-3">34. <a href="https://projects.spring.io/spring-boot/">Spring Boot</a></a></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="spring-project-references"><a class="anchor" href="#spring-project-references"></a><a class="link" href="#spring-project-references">35. <a href="https://spring.io/projects">Spring Project References</a></a></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="spring-boot-starters-for-azure"><a class="anchor" href="#spring-boot-starters-for-azure"></a><a class="link" href="#spring-boot-starters-for-azure">36. <a href="https://github.com/Microsoft/azure-spring-boot/">Spring Boot Starters for Azure</a></a></h2>
<div class="sectionbody">

</div>
</div>
</div>
<script type="text/javascript" src="js/tocbot/tocbot.min.js"></script>
<script type="text/javascript" src="js/toc.js"></script>
</body>
</html>